{
    "title": "ç®€å•æ˜“æ‡‚çš„ç°ä»£é­”æ³•", 
    "description": "éº»ç“œçš„ä¸–ç•Œ", 
    "followers": [
        "https://www.zhihu.com/people/yan-jing-65-26", 
        "https://www.zhihu.com/people/mr03", 
        "https://www.zhihu.com/people/prideofu", 
        "https://www.zhihu.com/people/zhang-xiao-er-40", 
        "https://www.zhihu.com/people/fei007", 
        "https://www.zhihu.com/people/luo-jia-78-17", 
        "https://www.zhihu.com/people/EXHades", 
        "https://www.zhihu.com/people/Hashimoto_Makico", 
        "https://www.zhihu.com/people/zhang-nai-ge-33", 
        "https://www.zhihu.com/people/daraw", 
        "https://www.zhihu.com/people/zhao-chi-31-10", 
        "https://www.zhihu.com/people/Himself65", 
        "https://www.zhihu.com/people/li-zheng-cao-94", 
        "https://www.zhihu.com/people/ni-a-shi-ni", 
        "https://www.zhihu.com/people/meiko-73", 
        "https://www.zhihu.com/people/yinyun957", 
        "https://www.zhihu.com/people/mao-wei-yu-31", 
        "https://www.zhihu.com/people/nyarlathotep-58", 
        "https://www.zhihu.com/people/thewinged", 
        "https://www.zhihu.com/people/gaobo-92", 
        "https://www.zhihu.com/people/lxyPJ", 
        "https://www.zhihu.com/people/long-ze-7-35", 
        "https://www.zhihu.com/people/nuaalht", 
        "https://www.zhihu.com/people/yang-yang-yang-57-16", 
        "https://www.zhihu.com/people/zhang-wei-38-55", 
        "https://www.zhihu.com/people/wasd-20-22", 
        "https://www.zhihu.com/people/sakz", 
        "https://www.zhihu.com/people/stephen-52-29", 
        "https://www.zhihu.com/people/wang-00012", 
        "https://www.zhihu.com/people/fan-shuo-97", 
        "https://www.zhihu.com/people/wang-xin-21-61", 
        "https://www.zhihu.com/people/ttyuyu", 
        "https://www.zhihu.com/people/gao-xi-yu-44", 
        "https://www.zhihu.com/people/yd-guo", 
        "https://www.zhihu.com/people/li-xiao-zhi-90", 
        "https://www.zhihu.com/people/wu-yan-91", 
        "https://www.zhihu.com/people/bao-zi-96", 
        "https://www.zhihu.com/people/chen-zhang-xuan", 
        "https://www.zhihu.com/people/hua-luo-wu-sheng-62-16", 
        "https://www.zhihu.com/people/xuan-yuan-wu-si", 
        "https://www.zhihu.com/people/jamin-11-94", 
        "https://www.zhihu.com/people/szanlin", 
        "https://www.zhihu.com/people/lin-chao-95", 
        "https://www.zhihu.com/people/yincong", 
        "https://www.zhihu.com/people/dong-dong-46-64", 
        "https://www.zhihu.com/people/zhao-da-da-43", 
        "https://www.zhihu.com/people/bi-da-lian", 
        "https://www.zhihu.com/people/Neo_H", 
        "https://www.zhihu.com/people/kulkevan", 
        "https://www.zhihu.com/people/qiao-lei-19-29", 
        "https://www.zhihu.com/people/dian-wen-zi-xun-yan", 
        "https://www.zhihu.com/people/sgt-mr", 
        "https://www.zhihu.com/people/wuciren17", 
        "https://www.zhihu.com/people/zhao-jun-hao-5", 
        "https://www.zhihu.com/people/chasel-29-89", 
        "https://www.zhihu.com/people/love_spongebob", 
        "https://www.zhihu.com/people/shi-yi-nian-49", 
        "https://www.zhihu.com/people/wang-lang-96-64", 
        "https://www.zhihu.com/people/diamond007", 
        "https://www.zhihu.com/people/zhao-yu-73-75", 
        "https://www.zhihu.com/people/yan-jian-76-38", 
        "https://www.zhihu.com/people/fanshuzero", 
        "https://www.zhihu.com/people/xi-lan-de", 
        "https://www.zhihu.com/people/camark", 
        "https://www.zhihu.com/people/firstfu", 
        "https://www.zhihu.com/people/FuFaJuShi", 
        "https://www.zhihu.com/people/igeek", 
        "https://www.zhihu.com/people/po-xiao-68-17", 
        "https://www.zhihu.com/people/chen-jun-kun", 
        "https://www.zhihu.com/people/kang.ning", 
        "https://www.zhihu.com/people/tianzhen-66", 
        "https://www.zhihu.com/people/da-luo-tuo-97", 
        "https://www.zhihu.com/people/huang-ming-yu-72", 
        "https://www.zhihu.com/people/xie-ding-e-de-lao-hu", 
        "https://www.zhihu.com/people/mr-lin-82-68", 
        "https://www.zhihu.com/people/1024-10-45", 
        "https://www.zhihu.com/people/mou-dian-95", 
        "https://www.zhihu.com/people/lin-shao-wei-36", 
        "https://www.zhihu.com/people/gaozhongguoliu", 
        "https://www.zhihu.com/people/wang-lin-27-28", 
        "https://www.zhihu.com/people/sashay", 
        "https://www.zhihu.com/people/chen-shang-35", 
        "https://www.zhihu.com/people/ge-yao-76", 
        "https://www.zhihu.com/people/julytian", 
        "https://www.zhihu.com/people/greg-75", 
        "https://www.zhihu.com/people/li-lin-wei-36", 
        "https://www.zhihu.com/people/zhang-qiao-74-14-2", 
        "https://www.zhihu.com/people/xioxin", 
        "https://www.zhihu.com/people/30lao-diao", 
        "https://www.zhihu.com/people/samurai3701", 
        "https://www.zhihu.com/people/lailin", 
        "https://www.zhihu.com/people/ran-nuo-huang", 
        "https://www.zhihu.com/people/zhong-da-lao-hao-qiang-a", 
        "https://www.zhihu.com/people/zhao-qing-90-84", 
        "https://www.zhihu.com/people/sparks-46-32", 
        "https://www.zhihu.com/people/bewater-8", 
        "https://www.zhihu.com/people/obby-60", 
        "https://www.zhihu.com/people/isting321", 
        "https://www.zhihu.com/people/giant750-18", 
        "https://www.zhihu.com/people/ma-gong-tong", 
        "https://www.zhihu.com/people/wu-yue-xuan-qi", 
        "https://www.zhihu.com/people/ye-yue-92-27", 
        "https://www.zhihu.com/people/le-yi-90-69", 
        "https://www.zhihu.com/people/likelxl", 
        "https://www.zhihu.com/people/yu-sheng-hong-qiu-zao", 
        "https://www.zhihu.com/people/li-yan-liang-99", 
        "https://www.zhihu.com/people/li-cen-54-52", 
        "https://www.zhihu.com/people/wanglar-47", 
        "https://www.zhihu.com/people/zhihang-liu", 
        "https://www.zhihu.com/people/harry-fish", 
        "https://www.zhihu.com/people/hua-li-shu-bao", 
        "https://www.zhihu.com/people/jambalaya-63", 
        "https://www.zhihu.com/people/yh-ding", 
        "https://www.zhihu.com/people/zhu-yun-li-7", 
        "https://www.zhihu.com/people/lilijialiang", 
        "https://www.zhihu.com/people/ceng-yan-ying", 
        "https://www.zhihu.com/people/liang-yuan-36", 
        "https://www.zhihu.com/people/ticktock-47", 
        "https://www.zhihu.com/people/zhou-wen-bo-65", 
        "https://www.zhihu.com/people/lg-dong", 
        "https://www.zhihu.com/people/chen-guang-61-55", 
        "https://www.zhihu.com/people/wang-xiang-zhong-5", 
        "https://www.zhihu.com/people/liqiong", 
        "https://www.zhihu.com/people/linuxcpp", 
        "https://www.zhihu.com/people/laco", 
        "https://www.zhihu.com/people/ye-bu-yu-47", 
        "https://www.zhihu.com/people/yicat-80", 
        "https://www.zhihu.com/people/coco-yu-4-6", 
        "https://www.zhihu.com/people/xia-hou-xin-rong-16", 
        "https://www.zhihu.com/people/shan-hai-99-79", 
        "https://www.zhihu.com/people/jin-ai-zhu", 
        "https://www.zhihu.com/people/wu-se-hua", 
        "https://www.zhihu.com/people/akitomoya-4", 
        "https://www.zhihu.com/people/wu-jian-ye-78", 
        "https://www.zhihu.com/people/shifeichao", 
        "https://www.zhihu.com/people/xiang-xue-zhang", 
        "https://www.zhihu.com/people/bai-kai-shui-62-82", 
        "https://www.zhihu.com/people/ou-xian-xian-xian-sheng", 
        "https://www.zhihu.com/people/tifayq", 
        "https://www.zhihu.com/people/jorden-chang", 
        "https://www.zhihu.com/people/shuidf", 
        "https://www.zhihu.com/people/kee-yang-82", 
        "https://www.zhihu.com/people/onefanta", 
        "https://www.zhihu.com/people/fangmen", 
        "https://www.zhihu.com/people/zhang-xiong-46-98", 
        "https://www.zhihu.com/people/xu-yi-hang", 
        "https://www.zhihu.com/people/ming-ming-23-15"
    ], 
    "article": [
        {
            "url": "https://zhuanlan.zhihu.com/p/89679565", 
            "userName": "æ·±çº¢", 
            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
            "upvote": 10, 
            "title": "ä¸€æ¬¡ç¯å¢ƒå˜é‡å¼•å‘çš„è¡€æ¡ˆ", 
            "content": "<p>å…¬å¸æœ€è¿‘ä¸€ç›´åœ¨è¿ç§»é¡¹ç›®éƒ¨ç½²åˆ°é˜¿é‡Œäº‘çš„k8sï¼ŒæŸå¤©ä¸€æ—©æ¥åˆ°å…¬å¸åï¼Œç†Ÿç»ƒçš„å…‹éš†äº†ä¸€ä¸ªNodeé¡¹ç›®çš„éƒ¨ç½²é…ç½®ï¼Œå‡†å¤‡å¼€å§‹è¿ç§»è€é¡¹ç›®ã€‚æµ‹è¯•ç¯å¢ƒ(qaç¯å¢ƒ)å‘å¸ƒæ­£å¸¸åï¼Œæ»¡å¿ƒæ¬¢å–œçš„å¼€å§‹éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ(yzç¯å¢ƒ)ï¼Œç„¶è€Œå‘å¸ƒæ‰è¿‡äº†å‡ åˆ†é’Ÿï¼Œå°±å‘ç°pm2æŠ¥é”™: </p><figure data-size=\"normal\"><noscript><img src=\"https://pic4.zhimg.com/v2-177e0fb48072f577441a12f917245b7b_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"960\" data-rawheight=\"314\" class=\"origin_image zh-lightbox-thumb\" width=\"960\" data-original=\"https://pic4.zhimg.com/v2-177e0fb48072f577441a12f917245b7b_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;960&#39; height=&#39;314&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"960\" data-rawheight=\"314\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"960\" data-original=\"https://pic4.zhimg.com/v2-177e0fb48072f577441a12f917245b7b_r.jpg\" data-actualsrc=\"https://pic4.zhimg.com/v2-177e0fb48072f577441a12f917245b7b_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p><code>PM2 error: Trace: { Error: spawn E2BIG</code> è¿™ä¸ªæŠ¥é”™ä»¥å‰ä»æ¥æ²¡æœ‰è§è¿‡ï¼Œç½‘ä¸Šæœç´¢ä»¥åï¼Œå‘ç°å¤§å¤šæ•°<a href=\"https://link.zhihu.com/?target=https%3A//github.com/Unitech/pm2/issues/3271\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">å›ç­”</a>éƒ½åœ¨è¯´ç¯å¢ƒå˜é‡è¿‡å¤šå¯¼è‡´çš„ã€‚ç„¶è€Œqaç¯å¢ƒå’Œyzç¯å¢ƒæ˜¯ä¸€æ ·çš„dockerfileå¯åŠ¨é…ç½®ï¼Œä¸ºå•¥qaç¯å¢ƒå´å¯ä»¥æ­£å¸¸å¯åŠ¨ï¼Ÿ</p><p>ä¸ºäº†æ’é™¤æ˜¯è‡ªå·±é…ç½®å†™é”™çš„åŸå› ï¼Œæˆ‘é‡å¯äº†ä¸€ä¸ªå·²ç»æˆåŠŸè¿ç§»çš„é¡¹ç›®ï¼Œç„¶è€Œé¢„å‘å¸ƒç¯å¢ƒåŒæ ·å¼€å§‹æŠ¥é”™ï¼Œè¿™ä¸‹ç‚¸äº†é”…ï¼Œæ‰€æœ‰ä»¥å‰è¿ç§»çš„é¡¹ç›®ï¼Œyzç¯å¢ƒéƒ½å‘å¸ƒä¸äº†ï¼</p><p>å‘ç°äº‹æƒ…çš„ä¸¥é‡æ€§åï¼Œè¿…é€Ÿé—®äº†è¿ç»´éƒ¨é—¨çš„äººæ˜¯å¦æ›´æ”¹è¿‡yzç¯å¢ƒï¼Œç„¶è€Œå›ç­”æ˜¯æ²¡åŠ¨è¿‡ç¯å¢ƒã€‚</p><h3>é—®é¢˜æ’æŸ¥</h3><p>æ—¢ç„¶ç½‘ä¸Šè¯´æ˜¯ç¯å¢ƒå˜é‡è¿‡å¤šå¯¼è‡´ï¼Œäºæ˜¯æƒ³ç™»å…¥yzç¯å¢ƒçš„å®¹å™¨å†…éƒ¨çœ‹çœ‹ã€‚ä½†æ˜¯å› ä¸ºpm2æ— æ³•å¯åŠ¨æˆåŠŸï¼Œæ‰€ä»¥dockerä¸€ç›´åœ¨å°è¯•é‡å¯å®¹å™¨ï¼Œæ²¡åŠæ³•ç›´æ¥è¿›å…¥å®¹å™¨ã€‚</p><p>äºæ˜¯å†³å®šå…ˆå»qaç¯å¢ƒçš„å®¹å™¨é‡Œçœ‹çœ‹ã€‚è¿›å…¥å®¹å™¨åï¼Œè¾“å…¥<code>printenv | wc -l</code>ï¼Œå‘ç°ç¯å¢ƒå˜é‡çš„ç¡®éå¸¸å¤šï¼Œç«Ÿç„¶æœ‰1300å¤šä¸ªç¯å¢ƒå˜é‡ï¼</p><p><code>printenv</code>æ‰“å°å‡ºè¯¦ç»†ä¿¡æ¯:</p><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic4.zhimg.com/v2-2dd01ec91257137f0454535f387ba513_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1604\" data-rawheight=\"586\" class=\"origin_image zh-lightbox-thumb\" width=\"1604\" data-original=\"https://pic4.zhimg.com/v2-2dd01ec91257137f0454535f387ba513_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;1604&#39; height=&#39;586&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1604\" data-rawheight=\"586\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1604\" data-original=\"https://pic4.zhimg.com/v2-2dd01ec91257137f0454535f387ba513_r.jpg\" data-actualsrc=\"https://pic4.zhimg.com/v2-2dd01ec91257137f0454535f387ba513_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>è¿™äº›å˜é‡çœ‹å¾—æˆ‘ä¸€è„¸æ‡µé€¼ï¼Œéƒ½æ˜¯äº›éƒ¨é—¨çš„Javaé¡¹ç›®åç§°ã€‚é—®äº†ä¸‹è¿ç»´éƒ¨é—¨çš„åŒå­¦ï¼Œå› ä¸ºå…¬å¸ç”¨çš„æ˜¯<a href=\"https://link.zhihu.com/?target=https%3A//github.com/Qihoo360/wayne\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">Wayne</a>è¿™ä¸ªå¼€æºçš„k8sç®¡ç†å¹³å°ï¼Œå®ƒä¼šæŠŠæŸä¸ªå‘½åç©ºé—´ä¸‹æ‰€æœ‰é¡¹ç›®çš„k8sé…ç½®ï¼Œä»¥ç¯å¢ƒå˜é‡çš„å½¢å¼æ³¨å…¥åˆ°å®¹å™¨é‡Œã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘çš„nodeé¡¹ç›®å’Œjavaé¡¹ç›®å› ä¸ºæ”¾åœ¨äº†ä¸€ä¸ªå‘½åç©ºé—´ä¸‹ï¼Œæ‰€ä»¥90å¤šä¸ªjavaé¡¹ç›®çš„é…ç½®ä¹Ÿè¢«æ³¨å…¥åˆ°äº†æˆ‘çš„å®¹å™¨é‡Œï¼Œéšç€javaé¡¹ç›®éƒ¨ç½²çš„è¶Šæ¥è¶Šå¤šï¼Œæˆ‘å®¹å™¨é‡Œçš„ç¯å¢ƒå˜é‡ä¹Ÿè¶Šå˜è¶Šå¤§ï¼Œç›´åˆ°ä»Šå¤©ï¼Œç»ˆäºå¼•å‘äº†pm2çš„æŠ¥é”™ã€‚</p><p>ç„¶è€Œä¸ºå•¥qaç¯å¢ƒä¸‹pm2æ²¡æœ‰æŠ¥é”™å‘¢ï¼Ÿä»”ç»†å¯¹æ¯”äº†ä¸‹qaå’Œyzç¯å¢ƒä¸‹pm2çš„å¯åŠ¨è„šæœ¬ï¼Œå‘ç°æ˜¯å› ä¸ºï¼š</p><p>yzç¯å¢ƒä¸‹ä½¿ç”¨çš„æ˜¯pm2çš„clusteræ¨¡å¼ï¼Œ<a href=\"https://link.zhihu.com/?target=https%3A//github.com/Unitech/pm2/blob/master/lib/God/ClusterMode.js%23L48\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">æºç </a>é‡Œè¿™å¥:</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"nx\">clu</span> <span class=\"o\">=</span> <span class=\"nx\">cluster</span><span class=\"p\">.</span><span class=\"nx\">fork</span><span class=\"p\">({</span><span class=\"nx\">pm2_env</span><span class=\"o\">:</span> <span class=\"nx\">JSON</span><span class=\"p\">.</span><span class=\"nx\">stringify</span><span class=\"p\">(</span><span class=\"nx\">env_copy</span><span class=\"p\">),</span> <span class=\"nx\">windowsHide</span><span class=\"o\">:</span> <span class=\"kc\">true</span><span class=\"p\">});</span>\n</code></pre></div><p>ä¼šæŠŠå½“å‰çš„ç¯å¢ƒå˜é‡å¤åˆ¶ä¸€ä»½ç»™å­è¿›ç¨‹ï¼Œç„¶è€Œç¯å¢ƒå˜é‡å¤ªå¤§ï¼Œäºæ˜¯æŠ¥é”™ï¼</p><h3>è§£å†³æ–¹æ¡ˆ</h3><p>1.è¦æ±‚è¿ç»´åŒå­¦ä¼˜åŒ–éƒ¨ç½²æ–¹å¼ï¼Œä¸è¦æ³¨å…¥é¡¹ç›®ä»¥å¤–çš„å…¶ä»–ç¯å¢ƒå˜é‡ã€‚ä¸è¿‡è¿ç»´åŒå­¦è¯´æ˜¯k8sçš„æœºåˆ¶ï¼Œå’‹ä¹Ÿä¸æ‡‚ï¼Œä¹Ÿä¸æ•¢é—®ã€‚</p><p>2.ä¸ä½¿ç”¨pm2çš„clusteræ¨¡å¼ï¼Œåªç”¨forkæ¨¡å¼ã€‚å¦‚æœä»è¦åšæŒä½¿ç”¨clusteræ¨¡å¼ï¼Œåˆ™å…ˆè¿è¡Œä¸€æ®µshellè„šæœ¬ï¼Œå‰”é™¤ä¸éœ€è¦çš„ç¯å¢ƒå˜é‡ã€‚</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># éå†æ‰€æœ‰ç¯å¢ƒå˜é‡ï¼Œåˆ é™¤åŒ¹é…æ­£åˆ™çš„ç¯å¢ƒå˜é‡</span>\n<span class=\"k\">for</span> i in <span class=\"sb\">`</span>env <span class=\"p\">|</span> grep -E -i <span class=\"s1\">&#39;ECM_QA_|ECM_YZ_|ECM_PROD_&#39;</span> <span class=\"p\">|</span> sed <span class=\"s1\">&#39;s/=.*//&#39;</span><span class=\"sb\">`</span> <span class=\"p\">;</span> <span class=\"k\">do</span>\n    <span class=\"nb\">unset</span> <span class=\"nv\">$i</span>\n<span class=\"k\">done</span>\n\n<span class=\"c1\"># Dockerä¸­ä½¿ç”¨pm2-runtimeå‘½ä»¤</span>\npm2-runtime start app.json</code></pre></div><p>åœ¨è¿™é‡Œï¼Œæˆ‘æŠŠç¯å¢ƒå˜é‡åŒ…å«<code>ECM_QA_ ECM_YZ_ ECM_PPOD_</code>çš„å…¨éƒ¨åˆ é™¤ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€‰æ‹©ä¿®æ”¹pm2çš„æºç ï¼Œæ¯”å¦‚è¿™ä¸ª<a href=\"https://link.zhihu.com/?target=https%3A//github.com/Unitech/pm2/issues/3271%23issuecomment-512224470\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">è§£å†³æ–¹æ³•</a>ï¼Œä¸è¿‡å¹¶ä¸æ¨èã€‚</p><p>3.<b>ä¹Ÿè®¸ä½ å¹¶ä¸éœ€è¦PM2!</b></p><h3>k8sä¸‹çš„Nodeéƒ¨ç½²</h3><p>è€é¡¹ç›®å½“æ—¶é€‰æ‹©PM2çš„å¯åŠ¨æ–¹å¼ï¼Œæ˜¯å› ä¸ºPM2å¯ä»¥åå°è¿è¡ŒNodeé¡¹ç›®ï¼Œå¹¶ä¸”clusteræ¨¡å¼å¯ä»¥å¾ˆæ–¹ä¾¿çš„åˆ©ç”¨å¤šæ ¸æ€§èƒ½ã€‚ç„¶è€Œè¿™æ¬¡è¿ç§»ä½¿ç”¨äº†k8sæ–¹æ¡ˆï¼Œå…¶å®å¯ä»¥å®Œå…¨æŠ›å¼ƒä¹‹å‰çš„å¯åŠ¨æ–¹å¼ã€‚</p><p>åœ¨Dockerä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯pidä¸º1çš„è¿›ç¨‹ä¸€ç›´è¿è¡Œï¼Œå› æ­¤ä½¿ç”¨PM2æ—¶ï¼Œéœ€è¦ä½¿ç”¨<code>pm2-runtime</code>å‘½ä»¤ï¼Œä¿è¯ä¸ä¼šè‡ªåŠ¨é€€å‡ºã€‚å¦‚æœä½¿ç”¨åŸç”Ÿæ–¹å¼ï¼Œç›´æ¥<code>node app.js</code>ï¼Œåè€Œæ›´åŠ ç®€å•ã€‚</p><p>Nodeæ˜¯å•çº¿ç¨‹çš„ï¼Œä¸ºäº†å……åˆ†åˆ©ç”¨å¤šæ ¸cpuæ€§èƒ½ï¼Œæ‰ä½¿ç”¨äº†clusteræ¨¡å¼åˆ›å»ºå­è¿›ç¨‹ã€‚ç„¶è€ŒDockerçš„ç†å¿µæ˜¯ä¸€ä¸ªå®¹å™¨ä¸€ä¸ªè¿›ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå¤šä¸ªpodï¼ŒæŠŠé›†ç¾¤çš„è°ƒåº¦äº¤ç»™k8sæ¥ç®¡ç†ã€‚</p><p>å› æ­¤ï¼Œä½¿ç”¨k8sçš„æ–¹æ¡ˆä¸‹ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ç›´æ¥<code>node app.js</code>å¯åŠ¨ã€‚é‡å¯åº”ç”¨å’Œé›†ç¾¤è°ƒåº¦ï¼Œå…¨éƒ½äº¤ç»™k8sæ¥åšã€‚</p><h3>æ€»ç»“</h3><p>åœ¨è¿™æ¬¡äº‹æ•…ä¸­ï¼Œå‘ç°è‡ªå·±å¯¹äºLinuxï¼ŒDockerçš„éƒ¨ç½²çŸ¥è¯†ç›¸å½“åŒ®ä¹ï¼ŒLinuxçš„ä¸€äº›å¸¸ç”¨å‘½ä»¤ä¹Ÿååˆ†é™Œç”Ÿã€‚è™½ç„¶å‰ç«¯å·¥ç¨‹å¸ˆå¹³æ—¶æ¥è§¦åˆ°è¿™äº›æ–¹é¢æœ‰é™ï¼Œä½†æ˜¯å¦‚æœå®Œå…¨ä¸æ‡‚ï¼Œé‡åˆ°çº¿ä¸Šäº‹æ•…ï¼ŒçœŸçš„åªèƒ½å¹²çªçœ¼äº†ã€‚</p><h3>å‚è€ƒ</h3><p><a href=\"https://zhuanlan.zhihu.com/p/74056339\" class=\"internal\">è®°ä¸€æ¬¡NodeJSæµ‹è¯•é›†ç¾¤å…¨çº¿ç˜«ç—ªçš„è§£å†³æ€è·¯</a></p><p><a href=\"https://link.zhihu.com/?target=https%3A//stackoverflow.com/questions/51191378/what-is-the-point-of-using-pm2-and-docker-together\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">what is the point of using pm2 and docker together?</a></p>", 
            "topic": [
                {
                    "tag": "Docker", 
                    "tagLink": "https://api.zhihu.com/topics/19950993"
                }, 
                {
                    "tag": "Node.js", 
                    "tagLink": "https://api.zhihu.com/topics/19569535"
                }, 
                {
                    "tag": "Kubernetes", 
                    "tagLink": "https://api.zhihu.com/topics/20018384"
                }
            ], 
            "comments": [
                {
                    "userName": "eureka", 
                    "userLink": "https://www.zhihu.com/people/9d19637ce0639753886be28435b265db", 
                    "content": "é¼»è¡€æ¡ˆä¹ˆ", 
                    "likes": 1, 
                    "childComments": []
                }, 
                {
                    "userName": "æœˆè¿·æ´¥æ¸¡", 
                    "userLink": "https://www.zhihu.com/people/116bfae99bd7adc086b920a55ab6647a", 
                    "content": "æˆ‘ä»¬è¿™è¾¹å°±æ˜¯ç›´æ¥è£¸è·‘ node index.jsï¼ŒæŠŠå®ƒæ³¨å†Œæˆ system serviceï¼Œäº¤ç»™ systemd æ¥ç®¡ç†ã€‚", 
                    "likes": 1, 
                    "childComments": []
                }, 
                {
                    "userName": "tmomy", 
                    "userLink": "https://www.zhihu.com/people/5c5cf25dc7c8d1d2d490ea65849ff01c", 
                    "content": "è°¦è™šäº†å¤§ä½¬", 
                    "likes": 0, 
                    "childComments": []
                }, 
                {
                    "userName": "çŸ¥ä¹ç”¨æˆ·", 
                    "userLink": "https://www.zhihu.com/people/0", 
                    "content": "è€å“¥ï¼Œå›¾ç‰‡äº¤å‡ºæ¥[å‘å‘†]", 
                    "likes": 0, 
                    "childComments": []
                }
            ]
        }, 
        {
            "url": "https://zhuanlan.zhihu.com/p/84894157", 
            "userName": "æ·±çº¢", 
            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
            "upvote": 56, 
            "title": "å†™ç»™å‰ç«¯å·¥ç¨‹å¸ˆçœ‹çš„Dockeræ•™ç¨‹-å®æˆ˜ç¯‡", 
            "content": "<p>åœ¨<a href=\"https://zhuanlan.zhihu.com/p/84891860\" class=\"internal\">ä¸Šä¸€ç¯‡æ–‡ç« </a>é‡Œï¼Œæˆ‘ä»¬å­¦ä¹ äº†Dockerå¸¸ç”¨çš„å‘½ä»¤å’ŒåŸºæœ¬æ“ä½œï¼Œç°åœ¨å¯ä»¥å¼€å§‹å®æˆ˜äº†ã€‚</p><h3>å•é¡µåº”ç”¨</h3><p>å‰ç«¯å·¥ä½œä¸­æœ€å¸¸è§çš„å°±æ˜¯å•é¡µåº”ç”¨äº†ã€‚æˆ‘ä»¬é¦–å…ˆç”¨<code>create-react-app</code>å¿«é€Ÿåˆ›å»ºä¸€ä¸ªåº”ç”¨</p><div class=\"highlight\"><pre><code class=\"language-bash\">npm i create-react-app -g\ncreate-react-app react-app\n<span class=\"nb\">cd</span> react-app\nnpm run start</code></pre></div><p>å¯ä»¥çœ‹è§æ­£å¸¸å¯åŠ¨çš„é¡µé¢ã€‚</p><p>æ‰“åŒ…è¯•ä¸€ä¸‹</p><div class=\"highlight\"><pre><code class=\"language-text\">npm run build</code></pre></div><p>å¯ä»¥çœ‹åˆ°æœ¬åœ°ç”Ÿæˆäº†ä¸€ä¸ªbuildç›®å½•ï¼Œè¿™å°±æ˜¯æœ€åçº¿ä¸Šè¿è¡Œçš„ä»£ç ã€‚</p><p>æˆ‘ä»¬å…ˆåœ¨æœ¬åœ°è¿è¡Œä¸‹buildç›®å½•çœ‹çœ‹</p><div class=\"highlight\"><pre><code class=\"language-bash\">npm i http-server -g\nhttp-server -p <span class=\"m\">4444</span> ./build</code></pre></div><p>è®¿é—® http://localhost:4444 å³å¯çœ‹åˆ°æ‰“åŒ…åçš„é¡µé¢</p><h3>å•é¡µåº”ç”¨DockeråŒ–</h3><p>åœ¨<code>react-app</code>ç›®å½•ä¸‹æ–°å»º<code>Dockerfile</code> <code>.dockerignore</code>å’Œ<code>nginx.conf</code></p><p><code>.dockerignore</code></p><div class=\"highlight\"><pre><code class=\"language-text\">node_modules\nbuild</code></pre></div><p><code>dockerignore</code>æŒ‡å®šäº†å“ªäº›æ–‡ä»¶ä¸éœ€è¦è¢«æ‹·è´è¿›é•œåƒé‡Œï¼Œç±»ä¼¼<code>.gitignore</code>ã€‚</p><p>æˆ‘ä»¬çŸ¥é“å•é¡µåº”ç”¨çš„è·¯ç”±ä¸€èˆ¬éƒ½è¢«jsæ‰˜ç®¡ï¼Œæ‰€ä»¥å¯¹äºnginxéœ€è¦ç‰¹åˆ«é…ç½® </p><p><code>nginx.conf</code></p><div class=\"highlight\"><pre><code class=\"language-bash\">server <span class=\"o\">{</span>\n    listen       <span class=\"m\">80</span><span class=\"p\">;</span>\n    server_name  localhost<span class=\"p\">;</span>\n\n    location / <span class=\"o\">{</span>\n        root   /app/build<span class=\"p\">;</span> <span class=\"c1\"># æ‰“åŒ…çš„è·¯å¾„</span>\n        index  index.html index.htm<span class=\"p\">;</span>\n        try_files <span class=\"nv\">$uri</span> <span class=\"nv\">$uri</span>/ /index.html<span class=\"p\">;</span> <span class=\"c1\"># é˜²æ­¢é‡åˆ·æ–°è¿”å›404</span>\n    <span class=\"o\">}</span>\n\n    error_page   <span class=\"m\">500</span> <span class=\"m\">502</span> <span class=\"m\">503</span> <span class=\"m\">504</span>  /50x.html<span class=\"p\">;</span>\n    <span class=\"nv\">location</span> <span class=\"o\">=</span> /50x.html <span class=\"o\">{</span>\n        root   /usr/share/nginx/html<span class=\"p\">;</span>\n    <span class=\"o\">}</span>\n<span class=\"o\">}</span></code></pre></div><p><code>Dockerfile</code></p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># åŸºäºnode11</span>\nFROM node:11\n\n<span class=\"c1\"># è®¾ç½®ç¯å¢ƒå˜é‡</span>\nENV PROJECT_ENV production\nENV NODE_ENV production\n\n<span class=\"c1\"># å®‰è£…nginx</span>\nRUN apt-get update <span class=\"o\">&amp;&amp;</span> apt-get install -y nginx\n\n<span class=\"c1\"># æŠŠ package.json package-lock.json å¤åˆ¶åˆ°/appç›®å½•ä¸‹</span>\n<span class=\"c1\"># ä¸ºäº†npm installå¯ä»¥ç¼“å­˜</span>\nCOPY package*.json /app/\n\n<span class=\"c1\"># åˆ‡æ¢åˆ°appç›®å½•</span>\nWORKDIR /app\n\n<span class=\"c1\"># å®‰è£…ä¾èµ–</span>\nRUN npm install --registry<span class=\"o\">=</span>https://registry.npm.taobao.org\n\n<span class=\"c1\"># æŠŠæ‰€æœ‰æºä»£ç æ‹·è´åˆ°/app</span>\nCOPY . /app\n\n<span class=\"c1\"># æ‰“åŒ…æ„å»º</span>\nRUN npm run build\n\n<span class=\"c1\"># æ‹·è´é…ç½®æ–‡ä»¶åˆ°nginx</span>\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nEXPOSE <span class=\"m\">80</span>\n\n<span class=\"c1\"># å¯åŠ¨nginxï¼Œå…³é—­å®ˆæŠ¤å¼è¿è¡Œï¼Œå¦åˆ™å®¹å™¨å¯åŠ¨åä¼šç«‹åˆ»å…³é—­</span>\nCMD <span class=\"o\">[</span><span class=\"s2\">&#34;nginx&#34;</span>, <span class=\"s2\">&#34;-g&#34;</span>, <span class=\"s2\">&#34;daemon off;&#34;</span><span class=\"o\">]</span></code></pre></div><p>éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯:</p><div class=\"highlight\"><pre><code class=\"language-bash\">COPY package*.json /app/\nRUN npm install\nCOPY . /app</code></pre></div><p>æˆ‘ä»¬å•ç‹¬æŠŠ<code>package.json</code>æ–‡ä»¶å…ˆæ‹·è´åˆ°<code>app</code>ï¼Œå®‰è£…å®Œä¾èµ–ï¼Œç„¶åæ‰æŠŠæ‰€æœ‰çš„æ–‡ä»¶æ‹·è´åˆ°<code>app</code>ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p><p>è¿™æ˜¯ä¸ºäº†å……åˆ†åˆ©ç”¨dockerç¼“å­˜</p><div class=\"highlight\"><pre><code class=\"language-text\">COPY . /app\nRUN npm install</code></pre></div><p>å¦‚æœè¿™ä¹ˆå†™ï¼Œé‚£ä¹ˆæ¯ä¸€æ¬¡é‡æ–°æ„å»ºé•œåƒï¼Œéƒ½éœ€è¦ä¸‹è½½ä¸€æ¬¡npmåŒ…ï¼Œè¿™æ˜¯éå¸¸æµªè´¹æ—¶é—´çš„ï¼è€ŒæŠŠ<code>package.json</code>ä¸æºæ–‡ä»¶åˆ†éš”å¼€å†™å…¥é•œåƒï¼Œè¿™æ ·åªæœ‰å½“<code>package.json</code>å‘ç”Ÿæ”¹å˜äº†ï¼Œæ‰ä¼šé‡æ–°ä¸‹è½½npmåŒ…ã€‚</p><p>å½“ç„¶ç¼“å­˜æœ‰æ—¶å€™ä¹Ÿä¼šé€ æˆä¸€äº›éº»çƒ¦ï¼Œæ¯”å¦‚åœ¨è¿›è¡Œä¸€äº›shellæ“ä½œè¾“å‡ºå†…å®¹æ—¶ï¼Œç”±äºç¼“å­˜çš„å­˜åœ¨ï¼Œå¯¼è‡´æ–°æ„å»ºçš„é•œåƒé‡Œçš„å†…å®¹è¿˜æ˜¯æ—§ç‰ˆæœ¬çš„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æŒ‡å®šæ„å»ºé•œåƒæ—¶ä¸ä½¿ç”¨ç¼“å­˜</p><div class=\"highlight\"><pre><code class=\"language-bash\">docker build --no-cache -t deepred5/react-app .</code></pre></div><p>æœ€ä½³å®è·µæ˜¯åœ¨æ–‡ä»¶é¡¶éƒ¨æŒ‡å®šä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œå¦‚æœå¸Œæœ›ä¸ç”¨ç¼“å­˜ï¼Œåˆ™æ›´æ–°è¿™ä¸ªç¯å¢ƒå˜é‡å³å¯ï¼Œå› ä¸ºç¼“å­˜å¤±æ•ˆæ˜¯ä»ç¬¬ä¸€æ¡å‘ç”Ÿå˜åŒ–çš„æŒ‡ä»¤å¼€å§‹ã€‚</p><p><b>æ‰“åŒ…é•œåƒ</b></p><div class=\"highlight\"><pre><code class=\"language-bash\">docker build -t deepred5/react-app .</code></pre></div><p><b>å¯åŠ¨å®¹å™¨</b></p><div class=\"highlight\"><pre><code class=\"language-bash\">docker run -d --name my-react-app  -p <span class=\"m\">8888</span>:80 deepred5/react-app</code></pre></div><p>è®¿é—® http://localhost:8888 å³å¯çœ‹åˆ°é¡µé¢</p><p>è®¿é—® http://localhost:8888/deepred5, ä¹Ÿå¯ä»¥çœ‹è§é¡µé¢ï¼Œè¯´æ˜nginxé˜²åˆ·æ–°é…ç½®ç”Ÿæ•ˆäº†ï¼</p><h3>å¤šå±‚æ„å»º</h3><p>æˆ‘ä»¬ä¹‹å‰å†™çš„<code>Dockerfile</code>å…¶å®æ˜¯æœ‰äº›é—®é¢˜çš„: é•œåƒåŸºäºnode11ï¼Œä½†æ˜¯æ•´ä¸ªé•œåƒç”¨åˆ°nodeç¯å¢ƒçš„åœ°æ–¹åªæ˜¯ä¸ºäº†å‰ç«¯æ‰“åŒ…ï¼ŒçœŸæ­£å¯åŠ¨çš„æ˜¯Nginxã€‚é•œåƒé‡Œçš„é¡¹ç›®æºä»£ç ä»¥åŠ<code>node_modules</code>å…¶å®æ ¹æœ¬æ²¡æœ‰ç”¨ï¼Œè¿™äº›å†—ä½™æ–‡ä»¶é€ æˆäº†é•œåƒçš„ä½“ç§¯å˜å¾—éå¸¸åºå¤§ã€‚</p><p>è€Œæˆ‘ä»¬ä»…ä»…éœ€è¦æ‰“åŒ…å‡ºæ¥çš„é™æ€æ–‡ä»¶ä»¥åŠå¯åŠ¨ä¸€ä¸ªé™æ€æœåŠ¡å™¨Nginxå³å¯ã€‚</p><p>è¿™æ—¶å°±å¯ä»¥ä½¿ç”¨<a href=\"https://link.zhihu.com/?target=https%3A//docs.docker.com/develop/develop-images/multistage-build/\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">multi-stage</a>å¤šå±‚æ„å»ºã€‚</p><p>æ–°å»ºä¸€ä¸ª<code>Dockerfile.multi</code></p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># nodeé•œåƒä»…ä»…æ˜¯ç”¨æ¥æ‰“åŒ…æ–‡ä»¶</span>\nFROM node:alpine as builder\n\nENV PROJECT_ENV production\nENV NODE_ENV production\n\nCOPY package*.json /app/\n\nWORKDIR /app\n\nRUN npm install --registry<span class=\"o\">=</span>https://registry.npm.taobao.org\n\nCOPY . /app\n\nRUN npm run build\n\n<span class=\"c1\"># é€‰æ‹©æ›´å°ä½“ç§¯çš„åŸºç¡€é•œåƒ</span>\nFROM nginx:alpine\n\nCOPY nginx.conf /etc/nginx/conf.d/default.conf\n\nCOPY --from<span class=\"o\">=</span>builder /app/build /app/build</code></pre></div><p>è¿™ä¸ªæ–‡ä»¶é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸¤ä¸ª<code>FROM</code>åŸºç¡€é•œåƒï¼Œç¬¬ä¸€ä¸ª<code>node:alpine</code>ä»…ä»…ä½œä¸ºæ‰“åŒ…ç¯å¢ƒï¼ŒçœŸæ­£çš„åŸºç¡€é•œåƒæ˜¯<code>nginx:alpine</code></p><p><b>æ‰“åŒ…é•œåƒ</b></p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># -f æŒ‡å®šä½¿ç”¨Dockerfile.multiè¿›è¡Œæ„å»º</span>\ndocker build -t deepred5/react-app-multi .  -f Dockerfile.multi</code></pre></div><p><b>å¯åŠ¨å®¹å™¨</b></p><div class=\"highlight\"><pre><code class=\"language-bash\">docker run -d --name my-react-app-multi  -p <span class=\"m\">8889</span>:80 deepred5/react-app-multi</code></pre></div><p>è®¿é—® http://localhost:8889 å³å¯çœ‹åˆ°é¡µé¢</p><p><b>æŸ¥çœ‹é•œåƒå¤§å°</b></p><div class=\"highlight\"><pre><code class=\"language-bash\">docker images deepred5/react-app-multi\ndocker images deepred5/react-app</code></pre></div><p>å¯ä»¥å‘ç°ï¼Œä¸¤è€…çš„å¤§å°ç›¸å·®å·¨å¤§ã€‚</p><p><code>deepred5/react-app</code>é•œåƒæœ‰1Gå¤šï¼Œè€Œ<code>deepred5/react-app-multi</code>åªæœ‰20å¤šM</p><p>ä¸»è¦åŸå› æ˜¯ï¼š<code>deepred5/react-app</code>çš„åŸºç¡€é•œåƒ<code>node:11</code>å°±æœ‰900Mï¼Œè€Œ<code>deepred5/react-app-multi</code>çš„åŸºç¡€é•œåƒ<code>nginx:alpine</code>åªæœ‰20Mã€‚ç”±æ­¤å¯è§å¤šå±‚æ„å»ºå¯¹äºå‡å°‘é•œåƒå¤§å°æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ã€‚</p><h3>Nodeåº”ç”¨</h3><p>å‰ç«¯æœ‰æ—¶ä¹Ÿä¼šå‚ä¸åˆ°Node BFFå±‚çš„å¼€å‘ã€‚æˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªNodeç»“åˆRedisçš„ç®€å•é¡¹ç›®</p><div class=\"highlight\"><pre><code class=\"language-text\">mkdir node-redis\ncd node-redis\nnpm init -y\nnpm i koa koa-router ioredis\ntouch index.js</code></pre></div><p><code>node-redis/index.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">Koa</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;koa&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">Router</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;koa-router&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">Redis</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s2\">&#34;ioredis&#34;</span><span class=\"p\">);</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Koa</span><span class=\"p\">();</span>\n<span class=\"k\">const</span> <span class=\"nx\">router</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Router</span><span class=\"p\">();</span>\n<span class=\"k\">const</span> <span class=\"nx\">redis</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Redis</span><span class=\"p\">({</span>\n  <span class=\"nx\">port</span><span class=\"o\">:</span> <span class=\"mi\">6379</span><span class=\"p\">,</span>\n  <span class=\"nx\">host</span><span class=\"o\">:</span> <span class=\"s1\">&#39;127.0.0.1&#39;</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">router</span><span class=\"p\">.</span><span class=\"nx\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">,</span> <span class=\"nx\">next</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">body</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;hello world.&#39;</span><span class=\"p\">;</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">router</span><span class=\"p\">.</span><span class=\"nx\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;/api/json/get&#39;</span><span class=\"p\">,</span> <span class=\"kr\">async</span> <span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">,</span> <span class=\"nx\">next</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"k\">const</span> <span class=\"nx\">result</span> <span class=\"o\">=</span> <span class=\"kr\">await</span> <span class=\"nx\">redis</span><span class=\"p\">.</span><span class=\"nx\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;age&#39;</span><span class=\"p\">);</span>\n  <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">body</span> <span class=\"o\">=</span> <span class=\"nx\">result</span><span class=\"p\">;</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">router</span><span class=\"p\">.</span><span class=\"nx\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;/api/json/set&#39;</span><span class=\"p\">,</span> <span class=\"kr\">async</span> <span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">,</span> <span class=\"nx\">next</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"k\">const</span> <span class=\"nx\">result</span> <span class=\"o\">=</span> <span class=\"kr\">await</span> <span class=\"nx\">redis</span><span class=\"p\">.</span><span class=\"nx\">set</span><span class=\"p\">(</span><span class=\"s1\">&#39;age&#39;</span><span class=\"p\">,</span> <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">query</span><span class=\"p\">.</span><span class=\"nx\">age</span><span class=\"p\">);</span>\n  <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">body</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n    <span class=\"nx\">status</span><span class=\"o\">:</span> <span class=\"nx\">result</span><span class=\"p\">,</span>\n    <span class=\"nx\">age</span><span class=\"o\">:</span> <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">query</span><span class=\"p\">.</span><span class=\"nx\">age</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">app</span>\n  <span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"nx\">router</span><span class=\"p\">.</span><span class=\"nx\">routes</span><span class=\"p\">())</span>\n  <span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"nx\">router</span><span class=\"p\">.</span><span class=\"nx\">allowedMethods</span><span class=\"p\">());</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">listen</span><span class=\"p\">(</span><span class=\"mi\">3000</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;server start at localhost:3000&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">})</span>\n</code></pre></div><p>æˆ‘ä»¬é¦–å…ˆéœ€è¦æœ¬åœ°å®‰è£…Redisï¼Œç„¶åå¯åŠ¨redis</p><div class=\"highlight\"><pre><code class=\"language-text\">redis-server</code></pre></div><p>å¯åŠ¨Nodeé¡¹ç›®</p><div class=\"highlight\"><pre><code class=\"language-text\">node index.js</code></pre></div><p>è®¿é—® http://localhost:3000/ å³å¯çœ‹åˆ°é¡µé¢</p><p>è®¿é—® http://localhost:3000/api/json/set?age=2 ï¼Œæˆ‘ä»¬å°±å‘Redisé‡Œè®¾ç½®<code>age</code>çš„å€¼ä¸º2</p><p>è®¿é—® http://localhost:3000/api/json/get ï¼Œæˆ‘ä»¬å°±å–å¾—Redisé‡Œ<code>age</code>çš„å€¼</p><h3>Nodeåº”ç”¨DockeråŒ–</h3><p>é¦–å…ˆæˆ‘ä»¬æ¥æ€è€ƒä¸‹ï¼Œè¿™ä¸ªåç«¯åº”ç”¨æ¶‰åŠNodeå’ŒRedisã€‚å¦‚æœæˆ‘ä»¬è¦éƒ¨ç½²åˆ°Dockeré‡Œï¼Œåº”è¯¥æ€ä¹ˆæ„å»ºé•œåƒï¼Ÿ</p><ol><li>æ–¹æ¡ˆä¸€ï¼šåŸºäºä¸€ä¸ªæœ€åŸºç¡€çš„<code>ubuntu</code>é•œåƒï¼Œç„¶åæˆ‘ä»¬åœ¨å…¶ä¸­å®‰è£…Nodeå’ŒRedisï¼Œè¿™æ ·Nodeå’ŒRedisä¹‹é—´å°±å¯ä»¥è¿›è¡Œé€šä¿¡äº†ã€‚è¿™ç§æ–¹æ¡ˆåªéœ€è¦å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå› ä¸ºNodeå’ŒRediså·²ç»åœ¨è¿™ä¸ªå®¹å™¨é‡Œäº†ã€‚</li><li>æ–¹æ¡ˆäºŒï¼šæˆ‘ä»¬åŸºäº<code>Redis</code>é•œåƒå¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œä¸“é—¨ç”¨æ¥è·‘Redisã€‚åŸºäº<code>Node</code>é•œåƒå†å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œä¸“é—¨ç”¨æ¥è·‘Nodeã€‚</li></ol><p>Dockerçš„ç†å¿µæ›´å€¾å‘äºæ–¹æ¡ˆäºŒã€‚æˆ‘ä»¬å¸Œæœ›ä¸€ä¸ªé•œåƒä¸“æ³¨äºåšä¸€ä»¶äº‹ï¼Œç°åœ¨æµè¡Œçš„å¾®æœåŠ¡ï¼Œå¾®å‰ç«¯ä¹Ÿæ˜¯è¿™ç§æ€æƒ³ã€‚</p><p>æˆ‘ä»¬ä¹‹å‰è¯´è¿‡æ¯ä¸ªå®¹å™¨éƒ½æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œé€šè¿‡æ˜ å°„ç«¯å£æ‰èƒ½è®¿é—®å®¹å™¨é‡Œçš„ç½‘ç»œåº”ç”¨ã€‚ä½†æ˜¯å®¹å™¨å’Œå®¹å™¨ä¹‹é—´æ€ä¹ˆè¿›è¡Œé€šä¿¡å‘¢ï¼Ÿ</p><p>Dockeré‡Œä½¿ç”¨<code>Networking</code>è¿›è¡Œå®¹å™¨é—´çš„é€šä¿¡</p><h3>Networking</h3><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># åˆ›å»ºä¸€ä¸ªapp-testç½‘ç»œ</span>\ndocker network create app-test</code></pre></div><p>æˆ‘ä»¬åªéœ€è¦æŠŠéœ€è¦é€šä¿¡çš„å®¹å™¨éƒ½åŠ å…¥åˆ°<code>app-test</code>ç½‘ç»œé‡Œï¼Œä¹‹åå®¹å™¨é—´å°±å¯ä»¥äº’ç›¸è®¿é—®äº†ã€‚</p><div class=\"highlight\"><pre><code class=\"language-bash\">docker run -d --name redis-app --network app-test  -p <span class=\"m\">6389</span>:6379 redis \ndocker run -it --name node-app --network app-test node:11 /bin/bash</code></pre></div><p>æˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªå®¹å™¨ï¼Œè¿™ä¸¤ä¸ªå®¹å™¨éƒ½åœ¨<code>app-test</code>ç½‘ç»œé‡Œã€‚</p><p>æˆ‘ä»¬è¿›å…¥<code>node-app</code>å®¹å™¨é‡Œï¼Œç„¶å<code>ping redis-app</code>ï¼Œå‘ç°å¯ä»¥è®¿pingé€šï¼Œè¯´æ˜å®¹å™¨é—´å¯ä»¥é€šä¿¡äº†ï¼</p><p>æˆ‘ä»¬ä¿®æ”¹ä¹‹å‰çš„ä»£ç :</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">redis</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Redis</span><span class=\"p\">({</span>\n  <span class=\"nx\">port</span><span class=\"o\">:</span> <span class=\"mi\">6379</span><span class=\"p\">,</span>\n  <span class=\"nx\">host</span><span class=\"o\">:</span> <span class=\"s1\">&#39;db&#39;</span><span class=\"p\">,</span>\n<span class=\"p\">});</span>\n</code></pre></div><p>redisçš„<code>host</code>æ”¹ä¸º<code>db</code></p><p>æ–°å»ºä¸€ä¸ª<code>Dockerfile</code></p><div class=\"highlight\"><pre><code class=\"language-bash\">FROM node:11\nCOPY package*.json /app/ \nWORKDIR /app\nRUN npm install\nCOPY . /app\nEXPOSE <span class=\"m\">3000</span>\nCMD <span class=\"o\">[</span><span class=\"s2\">&#34;node&#34;</span>,<span class=\"s2\">&#34;index.js&#34;</span><span class=\"o\">]</span></code></pre></div><p><b>æ„å»ºé•œåƒ</b></p><div class=\"highlight\"><pre><code class=\"language-text\">docker build -t deepred5/node-redis-app .</code></pre></div><p><b>å¯åŠ¨å®¹å™¨</b></p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># åˆ›å»ºç½‘ç»œ</span>\ndocker network create app-test\n<span class=\"c1\"># å¯åŠ¨rediså®¹å™¨</span>\ndocker run -d --name db --network app-test  -p <span class=\"m\">6389</span>:6379 redis \n<span class=\"c1\"># å¯åŠ¨nodeå®¹å™¨</span>\ndocker run --name node-redis-app -p <span class=\"m\">4444</span>:3000 --network app-test -d deepred5/node-redis-app</code></pre></div><p>è®¿é—® http://localhost:4444/ å³å¯çœ‹åˆ°é¡µé¢</p><p>è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰åšçš„<code>react-app</code>å•é¡µåº”ç”¨å—ï¼Ÿæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªåº”ç”¨åŠ å…¥åˆ°<code>app-test</code>ç½‘ç»œé‡Œæ¥ï¼Œè¿™æ ·å‰ç«¯åº”ç”¨ä¹Ÿèƒ½è®¿é—®åç«¯äº†ï¼</p><p>ä¿®æ”¹<code>react-app</code>ç›®å½•ä¸‹çš„<code>nginx.conf</code></p><div class=\"highlight\"><pre><code class=\"language-bash\">server <span class=\"o\">{</span>\n    listen       <span class=\"m\">80</span><span class=\"p\">;</span>\n    server_name  localhost<span class=\"p\">;</span>\n\n    location / <span class=\"o\">{</span>\n        root   /app/build<span class=\"p\">;</span> <span class=\"c1\"># æ‰“åŒ…çš„è·¯å¾„</span>\n        index  index.html index.htm<span class=\"p\">;</span>\n        try_files <span class=\"nv\">$uri</span> <span class=\"nv\">$uri</span>/ /index.html<span class=\"p\">;</span> <span class=\"c1\"># é˜²æ­¢é‡åˆ·æ–°è¿”å›404</span>\n    <span class=\"o\">}</span>\n\n    location /api <span class=\"o\">{</span>\n        proxy_pass http://node-redis-app:3000<span class=\"p\">;</span> <span class=\"c1\">#åå°è½¬å‘åœ°å€</span>\n    <span class=\"o\">}</span>\n\n<span class=\"o\">}</span></code></pre></div><p>é‡æ–°æ„å»ºé•œåƒ</p><div class=\"highlight\"><pre><code class=\"language-bash\">docker build -t deepred5/react-app-multi .  -f Dockerfile.multi</code></pre></div><p>å¯åŠ¨å®¹å™¨</p><div class=\"highlight\"><pre><code class=\"language-text\">docker run -d --name my-react-app-multi --network app-test  -p 9999:80 deepred5/react-app-multi</code></pre></div><p>è®¿é—® http://localhost:9999/api/json/set?age=55 æˆåŠŸè¿”å›æ•°æ®</p><h3>Docker compose</h3><p>æˆ‘ä»¬ç°åœ¨è¿™ä¸ªé¡¹ç›®æœ‰3ä¸ªå¯åŠ¨é•œåƒ:  </p><p><code><i>deepred5/react-app-multi</i></code><i> å‰ç«¯å•é¡µåº”ç”¨ </i> </p><p><code>redis</code> æ•°æ®ç¼“å­˜ </p><p><code>deepred5/node-redis-app</code> åç«¯æœåŠ¡ï¼Œè®¿é—®redisï¼ŒåŒæ—¶ç»™å‰ç«¯æä¾›æ¥å£</p><p>å¦‚æœè¦æŠŠè¿™ä¸ªé¡¹ç›®å®Œæ•´çš„å¯åŠ¨èµ·æ¥ï¼ŒæŒ‰ç…§é¡ºåºéœ€è¦è¿™æ ·å¯åŠ¨ï¼š</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># å¯åŠ¨rediså®¹å™¨</span>\ndocker run -d --name db --network app-test  -p <span class=\"m\">6389</span>:6379 redis \n<span class=\"c1\"># å¯åŠ¨nodeå®¹å™¨</span>\ndocker run --name node-redis-app -p <span class=\"m\">4444</span>:3000 --network app-test -d deepred5/node-redis-app\n<span class=\"c1\"># å¯åŠ¨å‰ç«¯å®¹å™¨</span>\ndocker run -d --name my-react-app-multi --network app-test  -p <span class=\"m\">9999</span>:80 deepred5/react-app-multi</code></pre></div><p>è¿™è¿˜ä»…ä»…åªæ˜¯3ä¸ªå®¹å™¨çš„é¡¹ç›®ï¼Œå¦‚æœå®¹å™¨å†å¤šï¼Œå¯åŠ¨å°±å˜å¾—éå¸¸å¤æ‚äº†ï¼</p><p>è¿™æ—¶ï¼Œå°±éœ€è¦<code>docker compose</code>å‡ºåœºäº†ã€‚</p><p>é¦–å…ˆéœ€è¦å®‰è£…<a href=\"https://link.zhihu.com/?target=https%3A//docs.docker.com/compose/install/\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">docker compose</a>ï¼Œå®‰è£…å®Œæˆä¹‹å</p><p>æˆ‘ä»¬æ–°å»ºä¸€ä¸ª<code>my-all-app</code>ç›®å½•ï¼Œç„¶åæ–°å»º<code>docker-compose.yml</code></p><div class=\"highlight\"><pre><code class=\"language-bash\">mkdir my-all-app\n<span class=\"nb\">cd</span> my-all-app\ntouch docker-compose.yml</code></pre></div><p class=\"ztext-empty-paragraph\"><br/></p><div class=\"highlight\"><pre><code class=\"language-bash\">version: <span class=\"s1\">&#39;3.7&#39;</span>\n\nservices:\n  db:\n    image: redis\n    restart: always\n    ports:\n      - <span class=\"m\">6389</span>:6379\n    networks:\n      - app-test\n\n  node-redis-app:\n    image: deepred5/node-redis-app\n    restart: always\n    depends_on:\n      - db\n    ports:\n      - <span class=\"m\">4444</span>:3000\n    networks:\n      - app-test\n\n  react-app-multi:\n    image: deepred5/react-app-multi\n    restart: always\n    depends_on:\n      - node-redis-app\n    ports:\n      - <span class=\"m\">9999</span>:80\n    networks:\n      - app-test\n\nnetworks:\n  app-test:\n    driver: bridge</code></pre></div><p class=\"ztext-empty-paragraph\"><br/></p><div class=\"highlight\"><pre><code class=\"language-text\"># å¯åŠ¨æ‰€æœ‰å®¹å™¨\ndocker-compose up -d\n\n# åœæ­¢æ‰€æœ‰å®¹å™¨\ndocker-compose stop</code></pre></div><p>è®¿é—® http://localhost:9999 æŸ¥çœ‹å‰ç«¯é¡µé¢</p><p>è®¿é—® http://localhost:4444 æŸ¥çœ‹åç«¯æ¥å£</p><p>å¯ä»¥çœ‹è§ï¼Œä½¿ç”¨<code>docker-compose.yml</code>é…ç½®å®Œå¯åŠ¨æ­¥éª¤åï¼Œå¯åŠ¨å¤šä¸ªå®¹å™¨å°±å˜å¾—ååˆ†ç®€å•äº†ã€‚</p><h3>å‚è€ƒ</h3><ul><li><a href=\"https://link.zhihu.com/?target=https%3A//juejin.im/post/5c83cbaa6fb9a04a0f65fdaa\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">å¦‚ä½•ä½¿ç”¨dockeréƒ¨ç½²å‰ç«¯åº”ç”¨</a></li><li><a href=\"https://link.zhihu.com/?target=https%3A//book.douban.com/subject/26780404/\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">ç¬¬ä¸€æœ¬Dockerä¹¦ ä¿®è®¢ç‰ˆ</a></li></ul>", 
            "topic": [
                {
                    "tag": "å‰ç«¯å¼€å‘", 
                    "tagLink": "https://api.zhihu.com/topics/19550901"
                }, 
                {
                    "tag": "Docker", 
                    "tagLink": "https://api.zhihu.com/topics/19950993"
                }, 
                {
                    "tag": "Node.js", 
                    "tagLink": "https://api.zhihu.com/topics/19569535"
                }
            ], 
            "comments": [
                {
                    "userName": "åŸç®¡å¤§é˜Ÿé•¿", 
                    "userLink": "https://www.zhihu.com/people/b8b80d47e7e977a4aa19f59d3a99cb18", 
                    "content": "ç®€å•æ˜“æ‡‚[çˆ±]", 
                    "likes": 1, 
                    "childComments": []
                }, 
                {
                    "userName": "chao", 
                    "userLink": "https://www.zhihu.com/people/d0a16a671b2a362115248e44ca5301c6", 
                    "content": "<p>nginx ä¸ç‹¬ç«‹docker?</p>", 
                    "likes": 0, 
                    "childComments": [
                        {
                            "userName": "æ·±çº¢", 
                            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
                            "content": "nginxå’Œå‰ç«¯é™æ€èµ„æºæ‰“åŒ…åœ¨ä¸€ä¸ªé•œåƒé‡Œäº†ã€‚å¦‚æœnginxç‹¬ç«‹éƒ¨ç½²ï¼Œé‚£å‰ç«¯ç”¨dockerä»…ä»…ä¸ºäº†æ‰“ä¸ªåŒ…?", 
                            "likes": 0, 
                            "replyToAuthor": "chao"
                        }
                    ]
                }, 
                {
                    "userName": "AlexnL", 
                    "userLink": "https://www.zhihu.com/people/c75c901906f2ddf737841994a596da7a", 
                    "content": "<p>ä½ æŠŠä½ å›¾ç»™æˆ‘äº¤äº†</p>", 
                    "likes": 0, 
                    "childComments": []
                }, 
                {
                    "userName": "æå°å¿—", 
                    "userLink": "https://www.zhihu.com/people/e31119836b33876b011a571a631a0d97", 
                    "content": "<p>å†™çš„ç®€å•æ˜“æ‡‚ï¼ŒèµğŸ‘</p>", 
                    "likes": 0, 
                    "childComments": []
                }
            ]
        }, 
        {
            "url": "https://zhuanlan.zhihu.com/p/84891860", 
            "userName": "æ·±çº¢", 
            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
            "upvote": 179, 
            "title": "å†™ç»™å‰ç«¯å·¥ç¨‹å¸ˆçœ‹çš„Dockeræ•™ç¨‹-åŸºç¡€ç¯‡", 
            "content": "<p>æœ€è¿‘å…¬å¸åœ¨æ¨è¿›å®¹å™¨åŒ–å’Œk8sï¼Œé¡¹ç›®éƒ½è¦æ”¹æˆDockeréƒ¨ç½²ã€‚è´Ÿè´£çš„å·¥ç¨‹é‡Œæœ‰å‡ ä¸ªnodeé¡¹ç›®ï¼Œåªèƒ½ä»é›¶å¼€å§‹å­¦ä¹ Dockeräº†ã€‚</p><h3>å®‰è£…</h3><p>Dockeræ”¯æŒwindow, Mac, Linux, æ•™ç¨‹å‚è€ƒ <a href=\"https://link.zhihu.com/?target=https%3A//www.runoob.com/docker/ubuntu-docker-install.html\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">Dockerå®‰è£…æ•™ç¨‹</a> </p><p>å»ºè®®åœ¨Macå’ŒLinuxç³»ç»Ÿé‡Œä½¿ç”¨Dockerã€‚</p><p>æ—¥å¸¸å¼€å‘ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯vscodeç¼–è¾‘å™¨ï¼Œå¯ä»¥é¡ºä¾¿å®‰è£…dockeræ’ä»¶ã€‚åœ¨æ’ä»¶å•†åº—æœç´¢<code>docker</code>ï¼Œå®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„ç®¡ç†Dockeré•œåƒå’Œå®¹å™¨ã€‚</p><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"small\"><noscript><img src=\"https://pic4.zhimg.com/v2-0f01cc619a5436399700ffe01f0a12bf_b.jpg\" data-size=\"small\" data-rawwidth=\"714\" data-rawheight=\"784\" class=\"origin_image zh-lightbox-thumb\" width=\"714\" data-original=\"https://pic4.zhimg.com/v2-0f01cc619a5436399700ffe01f0a12bf_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;714&#39; height=&#39;784&#39;&gt;&lt;/svg&gt;\" data-size=\"small\" data-rawwidth=\"714\" data-rawheight=\"784\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"714\" data-original=\"https://pic4.zhimg.com/v2-0f01cc619a5436399700ffe01f0a12bf_r.jpg\" data-actualsrc=\"https://pic4.zhimg.com/v2-0f01cc619a5436399700ffe01f0a12bf_b.jpg\"/><figcaption>vscode dockeræ’ä»¶</figcaption></figure><p class=\"ztext-empty-paragraph\"><br/></p><h3>å¿«é€Ÿä½¿ç”¨</h3><p>é¦–å…ˆæˆ‘ä»¬æ¥ä½“éªŒä¸€ä¸‹Dockerã€‚</p><p>å¹³æ—¶å·¥ä½œä¸­ï¼Œå¦‚æœæˆ‘ä»¬ç”µè„‘çš„å¼€å‘ç¯å¢ƒæ˜¯Windows, æœ‰ä¸€å¤©å¸Œæœ›åœ¨Linuxç¯å¢ƒåšä¸€äº›äº‹æƒ…ï¼Œé‚£è¯¥æ€ä¹ˆåŠï¼Ÿ(æ²¡æœ‰äº‘æœåŠ¡å™¨çš„æƒ…å†µä¸‹)å¤§å¤šæ•°äººè¿™æ—¶ä¼šé€‰æ‹©å»ç”¨è™šæ‹Ÿæœºå®‰è£…ä¸€ä¸ªubuntuç³»ç»Ÿã€‚ä¸è¿‡å®‰è£…è™šæ‹Ÿæœºå‰ï¼Œä½ å¾—å…ˆå»ä¸‹è½½å‡ ä¸ªGçš„é•œåƒï¼Œç„¶ååœ¨VMwareé‡Œé…ç½®ä¸€äº›å‚æ•°ï¼Œæœ€åè¿˜è¦ç­‰å¾…æœ€å°‘åå‡ åˆ†é’Ÿçš„ç³»ç»Ÿå®‰è£…ã€‚ç­‰ä½ å®‰è£…å®Œä¸€ä¸ªubuntuç³»ç»Ÿï¼Œä¼°è®¡å·²ç»æµªè´¹äº†å‡ ä¸ªå°æ—¶ã€‚</p><p>ç„¶è€Œä½¿ç”¨Dockerï¼Œä½ åªéœ€è¦å‡ åˆ†é’Ÿï¼</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># æ‹‰å–ubuntué•œåƒ</span>\ndocker pull ubuntu\n<span class=\"c1\"># åˆ›å»ºä¸€ä¸ªubuntuå®¹å™¨å¹¶ä¸”ä½¿ç”¨ç»ˆç«¯è¿›è¡Œäº¤äº’</span>\ndocker run -it --name my-ubuntu --rm ubuntu /bin/bash</code></pre></div><p>åˆ›å»ºæˆåŠŸåï¼Œä½ å°±è¿›å…¥ä¸€ä¸ªubuntuç³»ç»Ÿé‡Œï¼Œç°åœ¨ä½ å¯ä»¥åœ¨å…¶ä¸­è¿›è¡Œä»»æ„çš„æ“ä½œäº†ã€‚</p><p><b>æ³¨æ„ï¼šè™½ç„¶å½“å‰å®¹å™¨é‡Œæ˜¯ubuntuç³»ç»Ÿï¼Œä½†æ˜¯ä½ åªèƒ½æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªç²¾ç®€ç‰ˆçš„ubuntuï¼Œå› æ­¤æœ‰å¾ˆå¤šå¸¸ç”¨å‘½ä»¤ï¼Œéœ€è¦è‡ªå·±å»å®‰è£…ã€‚</b></p><div class=\"highlight\"><pre><code class=\"language-bash\">curl -v bilibili.com</code></pre></div><p>ç›´æ¥è¿è¡Œ<code>curl</code>å‘½ä»¤ä¼šæç¤ºå‘½ä»¤ä¸å­˜åœ¨</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># å®‰è£…curl</span>\napt-get update\napt-get install -y curl</code></pre></div><p>å®‰è£…å®Œæˆåï¼Œæ‰èƒ½ä½¿ç”¨<code>curl</code>å‘½ä»¤</p><p>é€€å‡ºå®¹å™¨</p><div class=\"highlight\"><pre><code class=\"language-bash\">exit</code></pre></div><h3>åŸºæœ¬æ¦‚å¿µ</h3><ol><li>é•œåƒï¼ˆImageï¼‰ï¼šç±»ä¼¼äºè™šæ‹Ÿæœºä¸­çš„é•œåƒã€‚é•œåƒæœ‰ä¸¤ç§ï¼šåŸºç¡€é•œåƒå’Œä¸ªäººé•œåƒã€‚åŸºç¡€é•œåƒç”±å„å¤§å‚å•†æä¾›ï¼Œæ¯”å¦‚<code>ubuntu</code>é•œåƒï¼Œ<code>node</code>é•œåƒã€‚ä¸ªäººé•œåƒåˆ™æ˜¯ç”±ä¸ªäººå¼€å‘è€…æ„å»ºä¸Šä¼ ã€‚</li><li>å®¹å™¨ï¼ˆContainerï¼‰ï¼šç±»ä¼¼äºä¸€ä¸ªè½»é‡çº§çš„æ²™ç›’ã€‚å®¹å™¨æ˜¯åŸºäºé•œåƒæ¥åˆ›å»ºçš„ï¼Œ<code>ubuntu</code>é•œåƒå¹¶ä¸èƒ½å’Œæˆ‘ä»¬è¿›è¡Œå„ç§äº¤äº’ï¼Œæˆ‘ä»¬å¸Œæœ›æœ‰ä¸ªç¯å¢ƒèƒ½è¿è¡Œ<code>ubuntu</code>ï¼Œäºæ˜¯åŸºäº<code>ubuntu</code>é•œåƒåˆ›å»ºäº†ä¸€ä¸ªå®¹å™¨ã€‚</li><li>ä»“åº“ï¼ˆRepositoryï¼‰ï¼šç±»ä¼¼äºä»£ç ä»“åº“ï¼Œè¿™é‡Œæ˜¯é•œåƒä»“åº“ï¼Œæ˜¯Dockerç”¨æ¥é›†ä¸­å­˜æ”¾é•œåƒæ–‡ä»¶çš„åœ°æ–¹ã€‚</li></ol><p>æˆ‘ä»¬å¯ä»¥è¿™æ ·ç±»æ¯”ï¼š</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># ä¸‹è½½æºä»£ç </span>\ngit clone deepred5/app\n<span class=\"c1\"># å¯åŠ¨app</span>\nnpm run start</code></pre></div><p class=\"ztext-empty-paragraph\"><br/></p><div class=\"highlight\"><pre><code class=\"language-text\"># æ‹‰å–é•œåƒ\ndocker pull deepred5/app\n# åˆ›å»ºå®¹å™¨\ndocker run deepred5/app</code></pre></div><p>Dockeræ˜¯åŸºäºc/sæ¶æ„ï¼šæˆ‘ä»¬åœ¨Clientä¸­æ‰§è¡ŒDockerå‘½ä»¤ï¼Œæœ€ååˆ›å»ºçš„Containerå’ŒImageåˆ™ä¼šåœ¨Serverä¸­è¿è¡Œ</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># å¯ä»¥æŸ¥çœ‹serverå’Œclientä¿¡æ¯</span>\ndocker info</code></pre></div><h3>é•œåƒ(Image)</h3><p><b>å¸¸ç”¨å‘½ä»¤</b></p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># æŸ¥æ‰¾é•œåƒ</span>\ndocker search ubuntu\n\n<span class=\"c1\"># æ‹‰å–ç‰¹å®štagç‰ˆæœ¬çš„é•œåƒ(é»˜è®¤æ˜¯latest)</span>\ndocker pull ubuntu:18.0.4\n\n<span class=\"c1\"># æŸ¥çœ‹ä¸‹è½½çš„æ‰€æœ‰æœ¬åœ°é•œåƒ</span>\ndocker images\n\n<span class=\"c1\"># åˆ é™¤é•œåƒ</span>\ndocker rmi ubuntu:18.0.4</code></pre></div><p><b>æ„å»ºé•œåƒ</b></p><p>æˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯åŸºäºåŸºç¡€é•œåƒæ¥æ„å»ºä¸ªäººé•œåƒã€‚é•œåƒæ˜¯ç”±ä¸€æ¡æ¡æŒ‡ä»¤æ„å»ºå‡ºæ¥(Dockerfile)</p><p>æˆ‘ä»¬æ¥æ„å»ºä¸€ä¸ª<code>node-pm2</code>é•œåƒï¼Œè¿™ä¸ªé•œåƒè‡ªå¸¦nodeå’Œpm2:</p><p>åˆ›å»ºä¸€ä¸ª<code>node-pm2</code>ç›®å½•ï¼Œå¹¶æ–°å»ºä¸€ä¸ª<code>Dockerfile</code>æ–‡ä»¶</p><div class=\"highlight\"><pre><code class=\"language-bash\">mkdir node-pm2\n<span class=\"nb\">cd</span> node-pm2\ntouch Dockerfile</code></pre></div><p>ç¼–è¾‘<code>Dockerfile</code></p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># åŸºäºnode11åŸºç¡€é•œåƒ</span>\nFROM node:11\n\n<span class=\"c1\"># ä¸€äº›å…ƒæ•°æ®,æ¯”å¦‚ä½œè€…ä¿¡æ¯</span>\nLABEL <span class=\"nv\">maintainer</span><span class=\"o\">=</span><span class=\"s2\">&#34;deepred5 &lt;deepred5@gamil.com&gt;&#34;</span>\n\n<span class=\"c1\"># å®‰è£…pm2</span>\nRUN npm install pm2 -g --registry<span class=\"o\">=</span>https://registry.npm.taobao.org\n\n<span class=\"c1\"># æš´éœ²å®¹å™¨çš„ç«¯å£</span>\nEXPOSE <span class=\"m\">80</span> <span class=\"m\">443</span></code></pre></div><p>åŸºäºè¿™ä¸ª<code>Dockerfile</code>åˆ›å»ºæˆ‘ä»¬è‡ªå·±çš„é•œåƒ<code>deepred5/node-pm2</code></p><div class=\"highlight\"><pre><code class=\"language-bash\">docker build -t deepred5/node-pm2:1.0 .</code></pre></div><p>æ³¨æ„æœ€åæœ‰ä¸€ä¸ª<code>.</code></p><p>æŸ¥çœ‹æˆ‘ä»¬è‡ªå·±çš„é•œåƒ</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># å¯ä»¥çœ‹åˆ°deepred5/node-pm2é•œåƒäº†</span>\ndocker images</code></pre></div><p>åŸºäº<code>deepred5/node-pm2</code>é•œåƒå¯åŠ¨ä¸€ä¸ªå®¹å™¨</p><div class=\"highlight\"><pre><code class=\"language-bash\">docker run -it deepred5/node-pm2:1.0 /bin/bash</code></pre></div><p>è¿›å…¥å®¹å™¨åï¼Œæˆ‘ä»¬è¿è¡Œ<code>pm2 -v</code>ï¼Œå¯ä»¥çœ‹è§pm2å·²ç»å®‰è£…æˆåŠŸäº†</p><p><b>ä¸Šä¼ é•œåƒ</b></p><p>æˆ‘ä»¬æœ¬åœ°æ„å»ºçš„é•œåƒå¦‚æœå¸Œæœ›å¯ä»¥è¢«å…¶ä»–äººä½¿ç”¨ï¼Œå°±éœ€è¦æŠŠé•œåƒä¸Šä¼ åˆ°ä»“åº“ã€‚ç™»å½•<a href=\"https://link.zhihu.com/?target=http%3A//dockerhub.com/\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">dockerhub</a>ï¼Œæ³¨å†Œä¸€ä¸ªè´¦æˆ·ã€‚</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># ç™»å…¥è´¦æˆ·ï¼Œè¾“å…¥ç”¨æˆ·åå’Œå¯†ç </span>\ndocker login\n\n<span class=\"c1\"># ä¸Šä¼ é•œåƒ</span>\ndocker push deepred5/node-pm2:1.0</code></pre></div><p>æ³¨æ„ï¼š<code>deepred5/node-pm2</code>æ”¹æˆ<code>ä½ çš„ç”¨æˆ·å/node-pm2</code>ï¼Œä½ éœ€è¦é‡æ–°æ„å»ºä¸€ä¸ª<code>ä½ çš„ç”¨æˆ·å/node-pm2</code>çš„é•œåƒï¼Œç„¶åæ‰èƒ½ä¸Šä¼ åˆ°dockerhub</p><h3>å®¹å™¨(Container)</h3><p>æˆ‘ä»¬å¹³æ—¶åŸºæœ¬éƒ½æ˜¯åœ¨å’Œå®¹å™¨æ‰“äº¤é“ã€‚</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># åŸºäºubuntué•œåƒåˆ›å»ºmy-ubuntuå®¹å™¨ã€‚å¦‚æœæœ¬åœ°æ²¡æœ‰ubuntué•œåƒï¼Œä¼šå…ˆå»docker pullä¸‹è½½</span>\ndocker run -it ubuntu:latest --name my-ubuntu /bin/bash</code></pre></div><p>å‚æ•°è§£é‡Š:</p><p><code>-i</code>: å…è®¸ä½ å¯¹å®¹å™¨å†…çš„æ ‡å‡†è¾“å…¥ (STDIN) è¿›è¡Œäº¤äº’</p><p><code>-t</code>: åœ¨æ–°å®¹å™¨å†…æŒ‡å®šä¸€ä¸ªä¼ªç»ˆç«¯æˆ–ç»ˆç«¯ã€‚</p><p><code>--name</code>: å®¹å™¨çš„åå­—ï¼Œé»˜è®¤æ˜¯éšæœºçš„åå­—</p><p><code>/bin/bash</code>: å¯åŠ¨å®¹å™¨åç«‹å³æ‰§è¡Œçš„å‘½ä»¤</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># åœæ­¢å®¹å™¨</span>\ndocker stop my-ubuntu\n\n<span class=\"c1\"># å¯åŠ¨å®¹å™¨</span>\ndocker start my-ubuntu\n\n<span class=\"c1\"># åˆ é™¤å®¹å™¨</span>\ndocker rm my-ubuntu\n\n<span class=\"c1\"># åˆ é™¤æ‰€æœ‰å®¹å™¨</span>\ndocker rm <span class=\"sb\">`</span>docker ps -aq<span class=\"sb\">`</span>\n<span class=\"c1\"># æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨</span>\ndocker ps\n\n<span class=\"c1\"># æŸ¥çœ‹æ‰€æœ‰åˆ›å»ºè¿‡çš„å®¹å™¨(è¿è¡Œæˆ–è€…å…³é—­)</span>\ndocker ps -a</code></pre></div><p><code>docker start my-ubuntu</code>å¯åŠ¨çš„å®¹å™¨ï¼Œè™½ç„¶å®¹å™¨è¿è¡Œç€ï¼Œä½†æ˜¯æˆ‘ä»¬æ— æ³•è¿›å…¥åˆ°å®¹å™¨é‡Œã€‚</p><p>å¦‚ä½•å†æ¬¡è¿›å…¥åˆ°å®¹å™¨é‡Œï¼Ÿ</p><div class=\"highlight\"><pre><code class=\"language-bash\">docker <span class=\"nb\">exec</span> -it my-ubuntu /bin/bash</code></pre></div><p><b>å®¹å™¨è¿è¡Œçš„ä¸¤ç§æ–¹å¼</b> </p><ul><li>äº¤äº’å¼è¿è¡Œ ( -it )</li><li> å®ˆæŠ¤å¼è¿è¡Œ(æ²¡æœ‰äº¤äº’å¼ä¼šè¯ï¼Œé•¿æœŸè¿è¡Œï¼Œé€‚åˆè¿è¡Œåº”ç”¨ç¨‹åºå’ŒæœåŠ¡) ( -d )</li></ul><p>å¯ä»¥è¿™æ ·ç±»æ¯”:</p><p><code>node index.js</code>: äº¤äº’å¼è¿è¡Œ </p><p><code>pm2 start index.js</code>: å®ˆæŠ¤å¼è¿è¡Œ</p><p>å¤§éƒ¨åˆ†æƒ…å†µéƒ½æ˜¯è¿è¡Œå®ˆæŠ¤å¼å®¹å™¨(daemonized container)</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># å¯åŠ¨äº†å®¹å™¨ï¼Œç„¶åå®¹å™¨ç«‹å³å…³é—­</span>\ndocker run ubuntu /bin/bash\n\n<span class=\"c1\"># å¯åŠ¨äº†å®¹å™¨ï¼Œå¹¶å¼€å¯äº†äº¤äº’å¼çš„ç»ˆç«¯ï¼Œåªæœ‰è¾“å…¥exitæ‰é€€å‡ºç»ˆç«¯ï¼Œé€€å‡ºç»ˆç«¯åï¼Œå®¹å™¨ä»ç„¶åœ¨åå°è¿è¡Œ</span>\ndocker run -it ubuntu /bin/bash\n\n<span class=\"c1\"># å¯åŠ¨äº†å®¹å™¨ï¼Œå¹¶ä¸”åœ¨åå°ä¸€ç›´è¿è¡Œï¼Œæ¯éš”1sè¾“å‡ºhello world</span>\ndocker run -d ubuntu /bin/sh -c <span class=\"s2\">&#34;while true; do echo hello world; sleep 1; done&#34;</span></code></pre></div><p><b>æŸ¥çœ‹å®¹å™¨æ—¥å¿—</b></p><div class=\"highlight\"><pre><code class=\"language-bash\">docker run -d --name my_container ubuntu /bin/sh -c <span class=\"s2\">&#34;while true; do echo hello world; sleep 1; done&#34;</span>\n<span class=\"c1\"># æŸ¥çœ‹åå°è¿è¡Œçš„æ—¥å¿—</span>\ndocker logs my_container\n\n<span class=\"c1\"># å®æ—¶ç›‘æ§(ç±»ä¼¼tail -f)</span>\ndocker logs -f my_container\n\n<span class=\"c1\"># è·å–æœ€å10è¡Œ</span>\ndocker logs --tail <span class=\"m\">10</span> my_container\n\n<span class=\"c1\"># å®æ—¶æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—</span>\ndocker logs --tail <span class=\"m\">0</span> -f my_container\n\n<span class=\"c1\"># åŠ ä¸Šæ—¶é—´æˆ³</span>\ndocker logs -t my_container</code></pre></div><h3>Nginx</h3><p>å‰ç«¯æœ€å¸¸ä½¿ç”¨çš„é™æ€æœåŠ¡å™¨å°±æ˜¯Nginxäº†ã€‚</p><div class=\"highlight\"><pre><code class=\"language-bash\">docker run -d --name my-nginx -p <span class=\"m\">8888</span>:80 nginx</code></pre></div><p>è®¿é—® http://localhost:8888/ å³å¯çœ‹åˆ°ç†Ÿæ‚‰çš„æ¬¢è¿é¡µé¢</p><p>å‚æ•°è§£é‡Š: </p><p><code>-d</code>: å‰é¢å·²ç»è§£é‡Šè¿‡äº†ï¼Œå®ˆæŠ¤è¿è¡Œæ–¹å¼ </p><p><code>-p</code>: ç«¯å£æ˜ å°„ã€‚<code>8888:80</code>è¡¨ç¤ºæŠŠæœ¬åœ°çš„8888ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„80ç«¯å£</p><p>ä¸ºä»€ä¹ˆè¦æ˜ å°„ç«¯å£ï¼Ÿå› ä¸ºDockeré‡Œæ¯ä¸ªå®¹å™¨éƒ½æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ï¼Œæ‹¥æœ‰è‡ªå·±çš„å†…éƒ¨ipã€‚å®¹å™¨é‡Œè¿è¡Œçš„ä¸€äº›ç½‘ç»œåº”ç”¨ï¼Œè¦è®©å¤–éƒ¨ä¹Ÿå¯ä»¥è®¿é—®ï¼Œå°±éœ€è¦å°†ç«¯å£æ˜ å°„åˆ°å®¿ä¸»æœºä¸Šã€‚</p><div class=\"highlight\"><pre><code class=\"language-bash\">docker port my-nginx</code></pre></div><p><code>80/tcp -&gt; 0.0.0.0:8888</code>å³å¯çœ‹åˆ°æ˜ å°„çš„ç«¯å£äº†</p><p>å¦‚æœæˆ‘ä»¬å¸Œæœ›ä¿®æ”¹Nginxæ¬¢è¿é¡µçš„å†…å®¹ï¼Œæ€ä¹ˆåŠï¼Ÿ</p><p>æœ€å®¹æ˜“æƒ³åˆ°çš„æ–¹æ³•æ˜¯ï¼š</p><p>æˆ‘ä»¬è¿›å…¥åˆ°å®¹å™¨é‡Œï¼Œç„¶åä¿®æ”¹<code>/usr/share/nginx/html</code>ç›®å½•é‡Œçš„<code>index.html</code></p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># è¿›å…¥nginxå®¹å™¨é‡Œ</span>\ndocker <span class=\"nb\">exec</span> -it my-nginx /bin/bash</code></pre></div><p>ä¸è¿‡è¿™ç§æ–¹æ³•æ‹“å±•æ€§ä¸é«˜ï¼Œå‡å¦‚æœ‰å¤šä¸ªNginxå®¹å™¨ï¼Œéš¾é“æˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¸ªçš„è¿›å…¥å®¹å™¨å»ä¿®æ”¹ï¼Ÿ</p><p>è¿™æ—¶å°±è¦å¼•å‡ºæ•°æ®å·(Volume)çš„æ¦‚å¿µäº†ã€‚</p><h3>æ•°æ®å·(Volume)</h3><p>ç±»ä¼¼ç«¯å£æ˜ å°„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®¹å™¨å†…éƒ¨çš„ç›®å½•æ˜ å°„åˆ°å®¿ä¸»æœºçš„ç›®å½•ï¼Œå®ç°å®¹å™¨ä¹‹é—´å®ç°å…±äº«å’Œé‡ç”¨ã€‚</p><p>æ–°å»º<code>my-nginx</code>ç›®å½•ï¼Œæ–°å»º<code>index.html</code></p><div class=\"highlight\"><pre><code class=\"language-bash\">mkdir my-nginx\n<span class=\"nb\">cd</span> my-nginx\ntouch index.html</code></pre></div><p><code>index.html</code></p><div class=\"highlight\"><pre><code class=\"language-html\"><span class=\"cp\">&lt;!DOCTYPE html&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">html</span> <span class=\"na\">lang</span><span class=\"o\">=</span><span class=\"s\">&#34;en&#34;</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">head</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">meta</span> <span class=\"na\">charset</span><span class=\"o\">=</span><span class=\"s\">&#34;UTF-8&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">meta</span> <span class=\"na\">name</span><span class=\"o\">=</span><span class=\"s\">&#34;viewport&#34;</span> <span class=\"na\">content</span><span class=\"o\">=</span><span class=\"s\">&#34;width=device-width, initial-scale=1.0&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">meta</span> <span class=\"na\">http-equiv</span><span class=\"o\">=</span><span class=\"s\">&#34;X-UA-Compatible&#34;</span> <span class=\"na\">content</span><span class=\"o\">=</span><span class=\"s\">&#34;ie=edge&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">title</span><span class=\"p\">&gt;</span>Document<span class=\"p\">&lt;/</span><span class=\"nt\">title</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;/</span><span class=\"nt\">head</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">body</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">h1</span><span class=\"p\">&gt;</span>hello world<span class=\"p\">&lt;/</span><span class=\"nt\">h1</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;/</span><span class=\"nt\">body</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;/</span><span class=\"nt\">html</span><span class=\"p\">&gt;</span></code></pre></div><p class=\"ztext-empty-paragraph\"><br/></p><div class=\"highlight\"><pre><code class=\"language-bash\">docker run --name nginx-test <span class=\"se\">\\\n</span><span class=\"se\"></span>--rm -p <span class=\"m\">8888</span>:80 <span class=\"se\">\\\n</span><span class=\"se\"></span>-v <span class=\"nv\">$PWD</span>:/usr/share/nginx/html <span class=\"se\">\\\n</span><span class=\"se\"></span>-d nginx</code></pre></div><p><b>å°æŠ€å·§ï¼šå¦‚æœå‘½ä»¤è¡Œè¿‡é•¿ï¼Œå¯ä»¥ä½¿ç”¨\\ç¬¦å·å¤šè¡Œä¹¦å†™</b></p><p>è®¿é—® http://localhost:8888/ å·²ç»å‘ç”Ÿå˜åŒ–äº†ï¼</p><p>å‚æ•°è§£é‡Šï¼š</p><p><code>-v</code>: <code>$PWD:/usr/share/nginx/html</code>è¡¨ç¤ºæŠŠå®¹å™¨å†…çš„<code>/usr/share/nginx/html</code>æ˜ å°„åˆ°å½“å‰ç›®å½•ï¼Œä¹Ÿå°±æ˜¯<code>my-nginx</code>ç›®å½•ã€‚äºæ˜¯nginxè¿”å›çš„<code>index.html</code>ä¹Ÿå°±å˜æˆäº†æˆ‘ä»¬æœ¬åœ°çš„<code>index.html</code>äº†ã€‚</p><p>æˆ‘ä»¬å¯ä»¥è¯•ç€åœ¨æœ¬åœ°æ–°å»ºä¸€ä¸ª<code>1.html</code>ï¼Œç„¶åè®¿é—® http://localhost:8888/1.html ä¹Ÿå¯ä»¥çœ‹åˆ°è¾“å‡ºäº†å†…å®¹ã€‚</p><p>åŒç†ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›ä¿®æ”¹å®¹å™¨é‡ŒNginxçš„é…ç½®ï¼Œä¹Ÿå¯ä»¥æŠŠå®¹å™¨çš„<code>/etc/nginx/conf.d/</code>æ˜ å°„åˆ°æœ¬åœ°ï¼Œç„¶ååœ¨æœ¬åœ°æ–°å»ºé…ç½®<code>mydefault.conf</code></p><p>ä¸ºäº†å¤ä¹ ä¸€ä¸‹å‰é¢çš„å†…å®¹ï¼Œæˆ‘ä»¬å¸Œæœ›æ„å»ºä¸€ä¸ªæœ¬åœ°çš„é•œåƒï¼Œè¿™ä¸ªé•œåƒåŸºäºNginxï¼Œé»˜è®¤çš„æ¬¢è¿é¡µé¢å†…å®¹å°±æ˜¯æˆ‘ä»¬åˆšåˆšæ–°å»ºçš„index.html</p><p>åœ¨<code>my-nginx</code>ç›®å½•ï¼Œæ–°å»º<code>Dockerfile</code></p><div class=\"highlight\"><pre><code class=\"language-bash\">FROM nginx\n<span class=\"c1\"># å°†å½“å‰çš„index.htmlæ‹·è´åˆ°å®¹å™¨çš„/usr/share/nginx/html/index.html</span>\nCOPY ./index.html /usr/share/nginx/html/index.html\nEXPOSE <span class=\"m\">80</span></code></pre></div><p><code>docker build -t my-nginx .</code>æ„å»ºé•œåƒ</p><p><code>docker run -d  --rm -p 4445:80 my-nginx</code> åˆ›å»ºå®¹å™¨ï¼Œè®¿é—® http://localhost:4445 å¯ä»¥çœ‹åˆ°æ•ˆæœäº†ã€‚</p><h3>Redis</h3><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨Dockeré‡Œè¿è¡ŒRedisã€‚</p><div class=\"highlight\"><pre><code class=\"language-bash\">docker pull redis\ndocker run -d --name my-redis -p <span class=\"m\">6389</span>:6379 redis</code></pre></div><p>è¿›å…¥å®¹å™¨å¹¶ä¸”è¿æ¥åˆ°redis</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># è¿›å…¥my-rediså®¹å™¨é‡Œï¼Œå¹¶ä¸”åœ¨å®¹å™¨é‡Œæ‰§è¡Œredis-cliå‘½ä»¤</span>\ndocker <span class=\"nb\">exec</span> -it my-redis redis-cli</code></pre></div><p>äºæ˜¯æˆ‘ä»¬å°±è¿æ¥åˆ°redisé‡Œäº†ï¼Œå¹¶ä¸”å¯ä»¥æ‰§è¡Œç›¸åº”çš„rediså‘½ä»¤</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># è®¾ç½®name</span>\n<span class=\"nb\">set</span> name tc\n<span class=\"c1\"># è·å–name</span>\nget name</code></pre></div><p>å› ä¸ºæˆ‘ä»¬æŠŠå®¹å™¨çš„6379ç«¯å£æ˜ å°„åˆ°äº†æœ¬æœºçš„6389ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥åœ¨æœ¬åœ°è¿æ¥å®¹å™¨é‡Œçš„redis</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"c1\"># éœ€è¦ä½ æœ¬åœ°å®‰è£…äº†redis-cli</span>\nredis-cli -h <span class=\"m\">127</span>.0.0.1 -p <span class=\"m\">6389</span>\n\n<span class=\"c1\"># è¿”å›tc</span>\nget name</code></pre></div><h3>æ€»ç»“</h3><p>æˆ‘ä»¬ä¸»è¦å­¦ä¹ äº†Dockeré‡Œé•œåƒå’Œå®¹å™¨çš„åŸºæœ¬æ¦‚å¿µï¼ŒæŒæ¡äº†ç«¯å£æ˜ å°„(-p)å’Œç›®å½•æ˜ å°„(-v)çš„ç”¨æ³•ï¼ŒåŒæ—¶å­¦ä¹ äº†å¦‚ä½•åœ¨Dockeré‡Œä½¿ç”¨Nginxå’ŒRedisã€‚åœ¨<a href=\"https://zhuanlan.zhihu.com/p/84894157\" class=\"internal\">ä¸‹ä¸€ç¯‡æ–‡ç« </a>é‡Œï¼Œä¼šç»§ç»­ä»‹ç»Dockerå®æˆ˜ã€‚</p><h3>å‚è€ƒ</h3><ul><li><a href=\"https://zhuanlan.zhihu.com/p/23599229\" class=\"internal\">åªè¦ä¸€å°æ—¶ï¼Œé›¶åŸºç¡€å…¥é—¨Docker</a></li><li><a href=\"https://zhuanlan.zhihu.com/p/53260098\" class=\"internal\">10åˆ†é’Ÿçœ‹æ‡‚Dockerå’ŒK8S</a></li></ul>", 
            "topic": [
                {
                    "tag": "Docker", 
                    "tagLink": "https://api.zhihu.com/topics/19950993"
                }, 
                {
                    "tag": "Node.js", 
                    "tagLink": "https://api.zhihu.com/topics/19569535"
                }, 
                {
                    "tag": "å‰ç«¯å¼€å‘", 
                    "tagLink": "https://api.zhihu.com/topics/19550901"
                }
            ], 
            "comments": [
                {
                    "userName": "çŸ¥ä¹ç”¨æˆ·", 
                    "userLink": "https://www.zhihu.com/people/0", 
                    "content": "<p>å·å®Œé«˜é›„å§å¦¹çš„è‰²å›¾å°±èµ°ï¼Œä¸çœ‹ä¸€çœ¼æ–‡ç« å†…å®¹</p>", 
                    "likes": 18, 
                    "childComments": []
                }, 
                {
                    "userName": "handsomeman", 
                    "userLink": "https://www.zhihu.com/people/a1e8154663042eddab334ad7ae660628", 
                    "content": "è®²å‰ç«¯æ”¾æ¶©å›¾å“¦å–œæ¬¢", 
                    "likes": 1, 
                    "childComments": []
                }, 
                {
                    "userName": "ç¾Šæ´‹çƒŠ", 
                    "userLink": "https://www.zhihu.com/people/7a74b392bff29982e8cd068f4b941c1c", 
                    "content": "è¯·é—®ä»€ä¹ˆæ˜¯dockerï¼ŒèŒæ–°[å®³ç¾]", 
                    "likes": 0, 
                    "childComments": []
                }, 
                {
                    "userName": "çŸ¥ä¹ç”¨æˆ·", 
                    "userLink": "https://www.zhihu.com/people/0", 
                    "content": "<p>è¿™ä¸ªé…å›¾è®¤çœŸçš„å˜›ï¼Ÿ</p>", 
                    "likes": 0, 
                    "childComments": []
                }, 
                {
                    "userName": "çŸ¥ä¹ç”¨æˆ·", 
                    "userLink": "https://www.zhihu.com/people/0", 
                    "content": "<p>å·å®Œé«˜é›„å§å¦¹çš„è‰²å›¾å°±èµ°ï¼Œä¸çœ‹ä¸€çœ¼æ–‡ç« å†…å®¹</p>", 
                    "likes": 18, 
                    "childComments": []
                }, 
                {
                    "userName": "handsomeman", 
                    "userLink": "https://www.zhihu.com/people/a1e8154663042eddab334ad7ae660628", 
                    "content": "è®²å‰ç«¯æ”¾æ¶©å›¾å“¦å–œæ¬¢", 
                    "likes": 1, 
                    "childComments": []
                }, 
                {
                    "userName": "ç¾Šæ´‹çƒŠ", 
                    "userLink": "https://www.zhihu.com/people/7a74b392bff29982e8cd068f4b941c1c", 
                    "content": "è¯·é—®ä»€ä¹ˆæ˜¯dockerï¼ŒèŒæ–°[å®³ç¾]", 
                    "likes": 0, 
                    "childComments": []
                }, 
                {
                    "userName": "çŸ¥ä¹ç”¨æˆ·", 
                    "userLink": "https://www.zhihu.com/people/0", 
                    "content": "<p>è¿™ä¸ªé…å›¾è®¤çœŸçš„å˜›ï¼Ÿ</p>", 
                    "likes": 0, 
                    "childComments": []
                }
            ]
        }, 
        {
            "url": "https://zhuanlan.zhihu.com/p/82020042", 
            "userName": "æ·±çº¢", 
            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
            "upvote": 14, 
            "title": "ä½¿ç”¨Web Workerä¼˜åŒ–ä»£ç ", 
            "content": "<p>å‰æ®µæ—¶é—´æœ‰ä¸ªéœ€æ±‚ï¼Œéœ€è¦å‰ç«¯å¯¼å‡ºexcelã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¯¹äºå¯¼å‡ºå¤§é‡æ•°æ®çš„åŠŸèƒ½ï¼Œæœ€å¥½è¿˜æ˜¯äº¤ç»™åç«¯æ¥åšï¼Œç„¶è€Œåç«¯è€å“¥å¹¶ä¸æƒ³åš(æ’•Bå¤±è´¥)ï¼Œåªèƒ½è‡ªåŠ›æ›´ç”Ÿã€‚</p><p>å‰ç«¯å¯¼å‡ºexcelæœ¬èº«å·²ç»æœ‰å¾ˆæˆç†Ÿçš„åº“äº†ï¼Œæ¯”å¦‚<a href=\"https://link.zhihu.com/?target=https%3A//github.com/SheetJS/js-xlsx\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">js-xlsx</a>, <a href=\"https://link.zhihu.com/?target=https%3A//github.com/cuikangjie/js-export-excel\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">js-export-excel</a>ï¼Œæ‰€ä»¥å®ç°èµ·æ¥å¹¶ä¸éš¾ã€‚ä½†æ˜¯ï¼Œå½“å¯¼å‡ºçš„æ•°æ®è¾¾åˆ°å‡ ä¸‡æ¡æ—¶ï¼Œå°±ä¼šå‘ç°é¡µé¢äº§ç”Ÿäº†æ˜æ˜¾çš„å¡é¡¿ã€‚åŸå› ä¹Ÿå¾ˆç®€å•: ä¸€èˆ¬æˆ‘ä»¬éƒ½æ˜¯åŸºäºåç«¯è¿”å›çš„jsonæ•°æ®æ¥ç”Ÿæˆexcelï¼Œä½†æ˜¯åç«¯è¿”å›çš„æ•°æ®ä¸€èˆ¬éƒ½ä¸èƒ½ç›´æ¥ç”¨æ¥å¯¼å‡ºæ•°æ®ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿›è¡Œä¸€äº›æ ¼å¼åŒ–ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">list</span> <span class=\"o\">=</span> <span class=\"kr\">await</span> <span class=\"nx\">request</span><span class=\"p\">(</span><span class=\"s1\">&#39;/api/getExcelData&#39;</span><span class=\"p\">);</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">format</span> <span class=\"o\">=</span> <span class=\"nx\">list</span><span class=\"p\">.</span><span class=\"nx\">map</span><span class=\"p\">((</span><span class=\"nx\">item</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"c1\">// å¯¹è¿”å›çš„jsonæ•°æ®è¿›è¡Œæ ¼å¼åŒ–\n</span><span class=\"c1\"></span>  <span class=\"nx\">item</span><span class=\"p\">.</span><span class=\"nx\">time</span> <span class=\"o\">=</span> <span class=\"nx\">moment</span><span class=\"p\">(</span><span class=\"nx\">item</span><span class=\"p\">.</span><span class=\"nx\">time</span><span class=\"p\">).</span><span class=\"nx\">format</span><span class=\"p\">(</span><span class=\"s1\">&#39;YYYY-MM-DD HH:mm&#39;</span><span class=\"p\">);</span>\n  <span class=\"c1\">// ... çœç•¥å…¶ä»–å„ç§æ“ä½œ\n</span><span class=\"c1\"></span><span class=\"p\">});</span>\n\n<span class=\"c1\">// æ ¹æ®jsonç”Ÿæˆexcel\n</span><span class=\"c1\"></span><span class=\"k\">const</span> <span class=\"nx\">toExcel</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">ExportJsonExcel</span><span class=\"p\">(</span><span class=\"nx\">format</span><span class=\"p\">).</span><span class=\"nx\">saveExcel</span><span class=\"p\">();</span>\n</code></pre></div><p>å¡é¡¿å°±å‘ç”Ÿåœ¨å¯¹å¤§é‡æ•°æ®è¿›è¡Œ<code>map</code>æ“ä½œã€‚ç”±äºJSæ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œå¤§é‡å¤æ‚è¿ç®—æ—¶ä¼šç‹¬å ä¸»çº¿ç¨‹ï¼Œå¯¼è‡´é¡µé¢çš„å…¶ä»–äº‹ä»¶æ— æ³•åŠæ—¶å“åº”ï¼Œé€ æˆé¡µé¢å‡æ­»çš„ç°è±¡ã€‚</p><p>é‚£æˆ‘ä»¬èƒ½ä¸èƒ½æŠŠå¤æ‚çš„å¾ªç¯æ“ä½œå•ç‹¬æ”¾åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œå‘¢ï¼Ÿè¿™æ—¶å°±è¦è¯·å‡º<a href=\"https://link.zhihu.com/?target=https%3A//developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API/Using_web_workers\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">web worker</a>äº†</p><h3>Web Worker</h3><p>é¦–å…ˆçœ‹ä¸ªç®€å•çš„ä¾‹å­</p><div class=\"highlight\"><pre><code class=\"language-html\"><span class=\"p\">&lt;</span><span class=\"nt\">button</span> <span class=\"na\">id</span><span class=\"o\">=</span><span class=\"s\">&#34;btn1&#34;</span><span class=\"p\">&gt;</span>js<span class=\"p\">&lt;/</span><span class=\"nt\">button</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">button</span> <span class=\"na\">id</span><span class=\"o\">=</span><span class=\"s\">&#34;btn2&#34;</span><span class=\"p\">&gt;</span>worker<span class=\"p\">&lt;/</span><span class=\"nt\">button</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">input</span> <span class=\"na\">type</span><span class=\"o\">=</span><span class=\"s\">&#34;text&#34;</span><span class=\"p\">&gt;</span></code></pre></div><p><code>index.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">btn1</span> <span class=\"o\">=</span> <span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">getElementById</span><span class=\"p\">(</span><span class=\"s1\">&#39;btn1&#39;</span><span class=\"p\">);</span>\n\n<span class=\"nx\">btn1</span><span class=\"p\">.</span><span class=\"nx\">addEventListener</span><span class=\"p\">(</span><span class=\"s1\">&#39;click&#39;</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"kd\">let</span> <span class=\"nx\">total</span> <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n\n    <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"kd\">let</span> <span class=\"nx\">i</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span> <span class=\"nx\">i</span> <span class=\"o\">&lt;</span> <span class=\"mi\">5000000000</span><span class=\"p\">;</span> <span class=\"nx\">i</span><span class=\"o\">++</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"nx\">total</span> <span class=\"o\">+=</span> <span class=\"nx\">i</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">total</span><span class=\"p\">);</span>\n<span class=\"p\">})</span>\n</code></pre></div><p>ç‚¹å‡»btn1æ—¶ï¼Œjsä¼šè¿›è¡Œå¤§é‡è®¡ç®—ï¼Œä½ ä¼šå‘ç°é¡µé¢å¡æ­»äº†ï¼Œç‚¹å‡»inputä¸ä¼šæœ‰ä»»ä½•ååº”</p><p>æˆ‘ä»¬ä½¿ç”¨web workerä¼˜åŒ–ä»£ç :</p><p><code>worker.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"nx\">onmessage</span> <span class=\"o\">=</span> <span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">data</span> <span class=\"o\">===</span> <span class=\"s1\">&#39;total&#39;</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"kd\">let</span> <span class=\"nx\">total</span> <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n\n    <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"kd\">let</span> <span class=\"nx\">i</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span> <span class=\"nx\">i</span> <span class=\"o\">&lt;</span> <span class=\"mi\">5000000000</span><span class=\"p\">;</span> <span class=\"nx\">i</span><span class=\"o\">++</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"nx\">total</span> <span class=\"o\">+=</span> <span class=\"nx\">i</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n    <span class=\"nx\">postMessage</span><span class=\"p\">(</span><span class=\"nx\">total</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div><p><code>index.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nb\">window</span><span class=\"p\">.</span><span class=\"nx\">Worker</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">const</span> <span class=\"nx\">myWorker</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Worker</span><span class=\"p\">(</span><span class=\"s1\">&#39;worker.js&#39;</span><span class=\"p\">);</span>\n\n  <span class=\"nx\">myWorker</span><span class=\"p\">.</span><span class=\"nx\">onmessage</span> <span class=\"o\">=</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;total&#39;</span><span class=\"p\">,</span> <span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">data</span><span class=\"p\">);</span>\n  <span class=\"p\">};</span>\n\n  <span class=\"k\">const</span> <span class=\"nx\">btn1</span> <span class=\"o\">=</span> <span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">getElementById</span><span class=\"p\">(</span><span class=\"s1\">&#39;btn1&#39;</span><span class=\"p\">);</span>\n  <span class=\"k\">const</span> <span class=\"nx\">btn2</span> <span class=\"o\">=</span> <span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">getElementById</span><span class=\"p\">(</span><span class=\"s1\">&#39;btn2&#39;</span><span class=\"p\">);</span>\n\n  <span class=\"nx\">btn1</span><span class=\"p\">.</span><span class=\"nx\">addEventListener</span><span class=\"p\">(</span><span class=\"s1\">&#39;click&#39;</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"kd\">let</span> <span class=\"nx\">total</span> <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n\n    <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"kd\">let</span> <span class=\"nx\">i</span> <span class=\"o\">=</span> <span class=\"mi\">0</span><span class=\"p\">;</span> <span class=\"nx\">i</span> <span class=\"o\">&lt;</span> <span class=\"mi\">5000000000</span><span class=\"p\">;</span> <span class=\"nx\">i</span><span class=\"o\">++</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"nx\">total</span> <span class=\"o\">+=</span> <span class=\"nx\">i</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;total&#39;</span><span class=\"p\">,</span> <span class=\"nx\">total</span><span class=\"p\">);</span>\n  <span class=\"p\">})</span>\n\n  <span class=\"nx\">btn2</span><span class=\"p\">.</span><span class=\"nx\">addEventListener</span><span class=\"p\">(</span><span class=\"s1\">&#39;click&#39;</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"nx\">myWorker</span><span class=\"p\">.</span><span class=\"nx\">postMessage</span><span class=\"p\">(</span><span class=\"s1\">&#39;total&#39;</span><span class=\"p\">);</span>\n  <span class=\"p\">});</span>\n\n<span class=\"p\">}</span>\n</code></pre></div><p>ç‚¹å‡»btn2æ—¶ï¼Œé¡µé¢å¹¶ä¸ä¼šå¡æ­»ï¼Œä½ å¯ä»¥æ­£å¸¸çš„å¯¹inputè¿›è¡Œè¾“å…¥æ“ä½œ</p><p>æˆ‘ä»¬å¼€å¯äº†ä¸€ä¸ªå•ç‹¬çš„workerçº¿ç¨‹æ¥è¿›è¡Œå¤æ‚æ“ä½œï¼Œé€šè¿‡<code>postMessage</code>å’Œ<code>onmessage</code>æ¥è¿›è¡Œä¸¤ä¸ªçº¿ç¨‹é—´çš„é€šä¿¡ã€‚</p><h3>ä¼˜åŒ–å¯¼å‡ºexcelè¡¨æ ¼</h3><p>çœ‹è¿‡å‰é¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥åŒç†ä½¿ç”¨web workerè¿›è¡Œå¤æ‚çš„mapæ“ä½œ</p><p><code>worker.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"nx\">onmessage</span> <span class=\"o\">=</span> <span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">const</span> <span class=\"nx\">format</span> <span class=\"o\">=</span> <span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">data</span><span class=\"p\">.</span><span class=\"nx\">map</span><span class=\"p\">((</span><span class=\"nx\">item</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"c1\">// å¯¹è¿”å›çš„jsonæ•°æ®è¿›è¡Œæ ¼å¼åŒ–\n</span><span class=\"c1\"></span>  <span class=\"nx\">item</span><span class=\"p\">.</span><span class=\"nx\">time</span> <span class=\"o\">=</span> <span class=\"nx\">moment</span><span class=\"p\">(</span><span class=\"nx\">item</span><span class=\"p\">.</span><span class=\"nx\">time</span><span class=\"p\">).</span><span class=\"nx\">format</span><span class=\"p\">(</span><span class=\"s1\">&#39;YYYY-MM-DD HH:mm&#39;</span><span class=\"p\">);</span>\n  <span class=\"c1\">// ... çœç•¥å…¶ä»–å„ç§æ“ä½œ\n</span><span class=\"c1\"></span><span class=\"p\">});</span>\n\n<span class=\"nx\">postMessage</span><span class=\"p\">(</span><span class=\"nx\">format</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n<span class=\"k\">const</span> <span class=\"nx\">myWorker</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Worker</span><span class=\"p\">(</span><span class=\"s1\">&#39;worker.js&#39;</span><span class=\"p\">);</span>\n\n<span class=\"nx\">myWorker</span><span class=\"p\">.</span><span class=\"nx\">onmessage</span> <span class=\"o\">=</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"c1\">// æ ¹æ®jsonç”Ÿæˆexcel\n</span><span class=\"c1\"></span>  <span class=\"k\">const</span> <span class=\"nx\">toExcel</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">ExportJsonExcel</span><span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">data</span><span class=\"p\">).</span><span class=\"nx\">saveExcel</span><span class=\"p\">();</span>\n<span class=\"p\">};</span>\n<span class=\"k\">const</span> <span class=\"nx\">list</span> <span class=\"o\">=</span> <span class=\"kr\">await</span> <span class=\"nx\">request</span><span class=\"p\">(</span><span class=\"s1\">&#39;/api/getExcelData&#39;</span><span class=\"p\">);</span>\n<span class=\"nx\">myWorker</span><span class=\"p\">.</span><span class=\"nx\">postMessage</span><span class=\"p\">(</span><span class=\"nx\">list</span><span class=\"p\">);</span>\n</code></pre></div><p>å½“ç„¶å®é™…é¡¹ç›®ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯ç”¨webpackæ‰“åŒ…çš„ï¼Œè¿™æ—¶å°±è¦è¿›è¡Œä¸€äº›ç‰¹åˆ«å¤„ç†ï¼Œéœ€è¦ä½¿ç”¨<a href=\"https://link.zhihu.com/?target=https%3A//github.com/webpack-contrib/worker-loader\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">worker-loader</a>,å¯ä»¥å‚è€ƒ<a href=\"https://link.zhihu.com/?target=https%3A//juejin.im/post/5acf348151882579ef4f5a77\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">ã€Šæ€ä¹ˆåœ¨ ES6+Webpack ä¸‹ä½¿ç”¨ Web Workerã€‹</a>æ–‡ç« å­¦ä¹ ã€‚</p><h3>è¿›ä¸€æ­¥ä¼˜åŒ–</h3><p>åœ¨ä¸Šé¢çš„ä»£ç ä¿®æ”¹ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯ä¼˜åŒ–äº†ä¸šåŠ¡é€»è¾‘é‡Œé¢çš„mapæ“ä½œã€‚å› ä¸ºæˆ‘ä½¿ç”¨çš„jsåº“æ˜¯<code>js-export-excel</code>,ä»å®ƒçš„<a href=\"https://link.zhihu.com/?target=https%3A//github.com/cuikangjie/js-export-excel/blob/master/src/js-export-excel.js%23L123\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">æºç </a>é‡Œå¯ä»¥çœ‹è§ï¼Œå¯¹äºæˆ‘ä»¬ä¼ è¿›æ¥çš„æ•°æ®ï¼Œå®ƒè¿˜ä¼šå†ä¸€æ¬¡forEachå¾ªç¯æ“ä½œï¼Œè¿›è¡Œæ•°æ®çš„äºŒè¿›åˆ¶è½¬æ¢ã€‚å› æ­¤ï¼Œè¿™ä¸€æ­¥çš„forEachå¾ªç¯ï¼Œç†è®ºä¸Šä¹Ÿå¯ä»¥åœ¨web workeré‡Œé¢è¿›è¡Œæ“ä½œã€‚</p><p>æœ€ç®€å•æƒ³åˆ°çš„æ–¹æ³•æ˜¯: </p><p><code>worker.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"nx\">onmessage</span> <span class=\"o\">=</span> <span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">const</span> <span class=\"nx\">format</span> <span class=\"o\">=</span> <span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">data</span><span class=\"p\">.</span><span class=\"nx\">map</span><span class=\"p\">((</span><span class=\"nx\">item</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// å¯¹è¿”å›çš„jsonæ•°æ®è¿›è¡Œæ ¼å¼åŒ–\n</span><span class=\"c1\"></span>    <span class=\"nx\">item</span><span class=\"p\">.</span><span class=\"nx\">time</span> <span class=\"o\">=</span> <span class=\"nx\">moment</span><span class=\"p\">(</span><span class=\"nx\">item</span><span class=\"p\">.</span><span class=\"nx\">time</span><span class=\"p\">).</span><span class=\"nx\">format</span><span class=\"p\">(</span><span class=\"s1\">&#39;YYYY-MM-DD HH:mm&#39;</span><span class=\"p\">);</span>\n    <span class=\"c1\">// ... çœç•¥å…¶ä»–å„ç§æ“ä½œ\n</span><span class=\"c1\"></span>  <span class=\"p\">});</span>\n\n  <span class=\"c1\">// ç›´æ¥åœ¨workeré‡Œé¢ç”Ÿæˆexcel\n</span><span class=\"c1\"></span>  <span class=\"k\">const</span> <span class=\"nx\">toExcel</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">ExportJsonExcel</span><span class=\"p\">(</span><span class=\"nx\">format</span><span class=\"p\">).</span><span class=\"nx\">saveExcel</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>ç›´æ¥åœ¨<code>worker.js</code>é‡Œé¢ç”Ÿæˆexcelã€‚ç„¶è€Œï¼Œ<code>saveExcel</code>è¿™ä¸ªæ–¹æ³•éœ€è¦ç”¨åˆ°<code>document</code>å¯¹è±¡ï¼Œä½†æ˜¯åœ¨workeré‡Œï¼Œæˆ‘ä»¬ä¸èƒ½è®¿é—®ç±»ä¼¼<code>window</code> <code>document</code>çš„å…¨å±€å¯¹è±¡ã€‚</p><p>å› æ­¤ï¼Œåªèƒ½é­”æ”¹æºç äº†ã€‚ã€‚ã€‚</p><p>çœŸæ­£ç”¨åˆ°<code>document</code>å¯¹è±¡çš„æ˜¯<a href=\"https://link.zhihu.com/?target=https%3A//github.com/cuikangjie/js-export-excel/blob/master/src/js-export-excel.js%23L151\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">æºç </a>è¿™ä¸€å¥:</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"c1\">// saveAså’ŒBlobç”¨åˆ°äº†document\n</span><span class=\"c1\"></span><span class=\"nx\">saveAs</span><span class=\"p\">(</span>\n  <span class=\"k\">new</span> <span class=\"nx\">Blob</span><span class=\"p\">([</span><span class=\"nx\">s2ab</span><span class=\"p\">(</span><span class=\"nx\">wbout</span><span class=\"p\">)],</span> <span class=\"p\">{</span>\n    <span class=\"nx\">type</span><span class=\"o\">:</span> <span class=\"s2\">&#34;application/octet-stream&#34;</span>\n  <span class=\"p\">}),</span>\n  <span class=\"nx\">_options</span><span class=\"p\">.</span><span class=\"nx\">fileName</span> <span class=\"o\">+</span> <span class=\"s2\">&#34;.xlsx&#34;</span>\n<span class=\"p\">);</span>\n</code></pre></div><p><code>saveExcel</code>æ–¹æ³•åªéœ€æ”¹æˆ:</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"c1\">// ä¸ç”Ÿæˆexcelï¼Œåªè¿”å›æ•°æ®\n</span><span class=\"c1\"></span><span class=\"k\">return</span> <span class=\"nx\">s2ab</span><span class=\"p\">(</span><span class=\"nx\">wbout</span><span class=\"p\">);</span>\n</code></pre></div><p><code>worker.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"nx\">onmessage</span> <span class=\"o\">=</span> <span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">const</span> <span class=\"nx\">format</span> <span class=\"o\">=</span> <span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">data</span><span class=\"p\">.</span><span class=\"nx\">map</span><span class=\"p\">((</span><span class=\"nx\">item</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// å¯¹è¿”å›çš„jsonæ•°æ®è¿›è¡Œæ ¼å¼åŒ–\n</span><span class=\"c1\"></span>    <span class=\"nx\">item</span><span class=\"p\">.</span><span class=\"nx\">time</span> <span class=\"o\">=</span> <span class=\"nx\">moment</span><span class=\"p\">(</span><span class=\"nx\">item</span><span class=\"p\">.</span><span class=\"nx\">time</span><span class=\"p\">).</span><span class=\"nx\">format</span><span class=\"p\">(</span><span class=\"s1\">&#39;YYYY-MM-DD HH:mm&#39;</span><span class=\"p\">);</span>\n    <span class=\"c1\">// ... çœç•¥å…¶ä»–å„ç§æ“ä½œ\n</span><span class=\"c1\"></span>  <span class=\"p\">});</span>\n\n  <span class=\"c1\">// saveExcelåªè¿”å›blobæ•°æ®\n</span><span class=\"c1\"></span>  <span class=\"k\">const</span> <span class=\"nx\">blob</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">ExportJsonExcel</span><span class=\"p\">(</span><span class=\"nx\">format</span><span class=\"p\">).</span><span class=\"nx\">saveExcel</span><span class=\"p\">();</span>\n  <span class=\"nx\">postMessage</span><span class=\"p\">(</span><span class=\"nx\">blob</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div><p><code>index.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"nx\">myWorker</span><span class=\"p\">.</span><span class=\"nx\">onmessage</span> <span class=\"o\">=</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"c1\">// åœ¨ä¸»çº¿ç¨‹ç”Ÿæˆexcel\n</span><span class=\"c1\"></span>  <span class=\"nx\">saveAs</span><span class=\"p\">(</span>\n    <span class=\"k\">new</span> <span class=\"nx\">Blob</span><span class=\"p\">([</span><span class=\"nx\">e</span><span class=\"p\">.</span><span class=\"nx\">data</span><span class=\"p\">],</span> <span class=\"p\">{</span>\n      <span class=\"nx\">type</span><span class=\"o\">:</span> <span class=\"s2\">&#34;application/octet-stream&#34;</span>\n    <span class=\"p\">}),</span>\n   <span class=\"s2\">&#34;test.xlsx&#34;</span>\n  <span class=\"p\">);</span>\n<span class=\"p\">};</span>\n</code></pre></div><p>åŸç†å°±æ˜¯ï¼šæˆ‘ä»¬åªæŠŠæ•°æ®è½¬æ¢æ”¾åœ¨workeré‡Œï¼Œæœ€åç”Ÿæˆexcelä»ç„¶åœ¨ä¸»çº¿ç¨‹é‡Œå®Œæˆã€‚</p><p>è‡³æ­¤ï¼Œä¼˜åŒ–å®Œæˆäº†ï¼</p><h3>æ€»ç»“</h3><p>æˆ‘ä»¬å¯ä»¥æŠŠä¸€äº›è€—æ€§èƒ½çš„æ“ä½œæ”¾åœ¨workerçº¿ç¨‹é‡Œ(æ¯”å¦‚å¤§æ–‡ä»¶ä¸Šä¼ )ï¼Œè¿™æ ·ä¸»çº¿ç¨‹å°±èƒ½åŠæ—¶å“åº”ç”¨æˆ·æ“ä½œè€Œä¸ä¼šé€ æˆå¡é¡¿ç°è±¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨workeré‡Œè¿›è¡Œçš„å¤æ‚è®¡ç®—ï¼Œè¿è¡Œæ—¶é—´å¹¶ä¸ä¼šå˜çŸ­ï¼Œæœ‰æ—¶è€—è´¹æ—¶é—´ç”šè‡³æ›´é•¿ï¼Œæ¯•ç«Ÿå¼€å¯workerä¹Ÿéœ€è¦æ¶ˆè€—ä¸€å®šçš„æ€§èƒ½ã€‚</p>", 
            "topic": [
                {
                    "tag": "å‰ç«¯å¼€å‘", 
                    "tagLink": "https://api.zhihu.com/topics/19550901"
                }
            ], 
            "comments": [
                {
                    "userName": "å¤©è°´ä¸¶ä¹‹æœˆ", 
                    "userLink": "https://www.zhihu.com/people/4278e9c9bb071219f2025b4e19cf9193", 
                    "content": "<p>è€å“¥ä¸å®¹æ˜“</p>", 
                    "likes": 0, 
                    "childComments": []
                }, 
                {
                    "userName": "å´æµ©äº®", 
                    "userLink": "https://www.zhihu.com/people/cabd61eff8b9fb95c072826ec3e10523", 
                    "content": "<p>æ‰€ä»¥è¿™å…¶å®æ˜¯ä½ ä»¬åç«¯å¤§å“¥çš„é”…ï¼Œæ˜¯æœ‰å¤šæ‡’å¤šå¿™ï¼Œå¯¼å‡ºä¸ª excel çš„æ¥å£éƒ½ä¸ç»™æ•´ã€‚</p><a class=\"comment_sticker\" href=\"https://pic4.zhimg.com/v2-ba306425d0a7aee2c7260381f1bf7b97.gif\" data-width=\"\" data-height=\"\">[æ¬¢å‘¼]</a>", 
                    "likes": 1, 
                    "childComments": []
                }
            ]
        }, 
        {
            "url": "https://zhuanlan.zhihu.com/p/72727979", 
            "userName": "æ·±çº¢", 
            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
            "upvote": 12, 
            "title": "lernaç®¡ç†package", 
            "content": "<p>æœ€è¿‘å‘ç°å…¬å¸ä¸€ä¸ªé¡¹ç›®çš„ç›®å½•ç»„ç»‡æŒºå¥‡æ€ªçš„ï¼Œæ‰€æœ‰çš„å­é¡¹ç›®éƒ½æ”¾åœ¨äº†<code>packages</code>ç›®å½•é‡Œï¼Œè¿˜æœ‰è¿™ç§éªšæ“ä½œï¼Ÿç‰¹æ„æŸ¥äº†ä¸‹èµ„æ–™ï¼Œå‘ç°æ˜¯ä¸€ç§æ¯”è¾ƒæµè¡Œçš„<code>monorepo</code>é¡¹ç›®ç®¡ç†æ¨¡å¼ã€‚è¿‘å‡ å¹´æ¯”è¾ƒç«çš„React,Vue,Babeléƒ½æ˜¯ç”¨çš„è¿™ç§æ¨¡å¼:</p><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic2.zhimg.com/v2-ac287e793c275d58e7962b2b9a2b0581_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2112\" data-rawheight=\"1182\" class=\"origin_image zh-lightbox-thumb\" width=\"2112\" data-original=\"https://pic2.zhimg.com/v2-ac287e793c275d58e7962b2b9a2b0581_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;2112&#39; height=&#39;1182&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"2112\" data-rawheight=\"1182\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"2112\" data-original=\"https://pic2.zhimg.com/v2-ac287e793c275d58e7962b2b9a2b0581_r.jpg\" data-actualsrc=\"https://pic2.zhimg.com/v2-ac287e793c275d58e7962b2b9a2b0581_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>æˆ‘ä»¬å¹³å¸¸ä¸€èˆ¬é‡‡ç”¨çš„éƒ½æ˜¯<code>multiple repositories</code>çš„é¡¹ç›®ç®¡ç†æ¨¡å¼ï¼šæŠŠä¸€ä¸ªå¤§é¡¹ç›®æ‹†åˆ†æˆè‹¥å¹²ä¸ªå°é¡¹ç›®ï¼Œæ¯ä¸ªå°é¡¹ç›®éƒ½ç‹¬ç«‹çš„æ”¾åœ¨gitlabä¸Šã€‚è¿™ç§æ¨¡å¼å…¶å®ä¹Ÿæ²¡å•¥ä¸å¥½ï¼Œä½†æ˜¯æŸäº›æƒ…å†µä¸‹ï¼Œå­é¡¹ç›®Aä¾èµ–å­é¡¹ç›®Bï¼Œå¦‚æœå­é¡¹ç›®Bç»å¸¸æ”¹åŠ¨ï¼Œé‚£ä¹ˆæ¯æ¬¡Bæ”¹åŠ¨äº†ï¼Œéƒ½è¦ä¿®æ”¹Aï¼Œè¿™æ—¶å°±éå¸¸éº»çƒ¦ã€‚åœ¨å¼€å‘ä¸€ä¸ªå‰ç«¯æ¡†æ¶æˆ–è€…UIåº“æ—¶ï¼Œå°±ç»å¸¸ä¼šé‡åˆ°ä¸Šè¿°æƒ…å†µï¼Œè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥è€ƒè™‘ä¸‹<code>monorepo</code>ã€‚</p><p><code>monorepo</code>è¯´åˆ°åº•ä¹Ÿåªæ˜¯ä¸€ä¸ªç†å¿µï¼Œé‚£ä¹ˆæ€ä¹ˆæ‰èƒ½å®ç°è¿™ç§ä»£ç ç»„ç»‡å‘¢ï¼Ÿ</p><ul><li><a href=\"https://link.zhihu.com/?target=https%3A//lerna.js.org/\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">lerna</a></li><li>yarnä¸­çš„<a href=\"https://link.zhihu.com/?target=https%3A//yarnpkg.com/lang/zh-hans/docs/workspaces/\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">Workspace</a></li></ul><p>æœ¬æ–‡ä¸»è¦ä»‹ç»ä¸‹lernaçš„ä½¿ç”¨</p><p><a href=\"https://link.zhihu.com/?target=https%3A//github.com/deepred5/learn-lerna\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">æºç å‚è€ƒ</a></p><h3>lerna</h3><p>å…¨å±€å®‰è£…<a href=\"https://link.zhihu.com/?target=https%3A//lerna.js.org/\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">lerna</a></p><div class=\"highlight\"><pre><code class=\"language-text\">npm i lerna -g</code></pre></div><p>lernaæ˜¯åŸºäºgitçš„ï¼Œåœ¨githubä¸Šæ–°å»ºä¸€ä¸ªé¡¹ç›®<code>learn-lerna</code></p><div class=\"highlight\"><pre><code class=\"language-text\">git clone git@github.com:deepred5/learn-lerna.git\ncd learn-lerna</code></pre></div><p>åˆå§‹åŒ–é¡¹ç›®:</p><div class=\"highlight\"><pre><code class=\"language-text\">lerna init</code></pre></div><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic1.zhimg.com/v2-811ffb3753ddb61f7cf6d476855cba9c_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"240\" data-rawheight=\"133\" class=\"content_image\" width=\"240\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;240&#39; height=&#39;133&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"240\" data-rawheight=\"133\" class=\"content_image lazy\" width=\"240\" data-actualsrc=\"https://pic1.zhimg.com/v2-811ffb3753ddb61f7cf6d476855cba9c_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>lernaä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª<code>packages</code>ç›®å½•å¤¹ï¼Œæˆ‘ä»¬ä»¥åçš„é¡¹ç›®éƒ½æ–°å»ºåœ¨è¿™é‡Œé¢ã€‚åŒæ—¶è¿˜ä¼šåœ¨æ ¹ç›®å½•æ–°å»ºä¸€ä¸ª<code>lerna.json</code>é…ç½®æ–‡ä»¶</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"p\">{</span>\n  <span class=\"s2\">&#34;packages&#34;</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n    <span class=\"s2\">&#34;packages/*&#34;</span>\n  <span class=\"p\">],</span>\n  <span class=\"s2\">&#34;version&#34;</span><span class=\"o\">:</span> <span class=\"s2\">&#34;0.0.0&#34;</span> <span class=\"c1\">// å…±ç”¨çš„ç‰ˆæœ¬ï¼Œç”±lernaç®¡ç†\n</span><span class=\"c1\"></span><span class=\"p\">}</span>\n</code></pre></div><h3>åˆ›å»ºpackage</h3><p>æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªpackage:</p><div class=\"highlight\"><pre><code class=\"language-text\">cd packages\nmkdir prpr-lerna-core\ncd prpr-lerna-core\nnpm init -y\ncd packages\nmkdir prpr-lerna-popular\ncd prpr-lerna-popular\nnpm init -y</code></pre></div><p><b>æ³¨æ„ï¼šè¿™ä¸¤ä¸ªpackageæˆ‘ä»¬æœ€åéƒ½æ˜¯è¦å‘å¸ƒåˆ°npmä¸Šçš„ï¼Œæ‰€ä»¥åå­—è¯·å–ç‰¹æ®Šäº›ï¼Œä¸èƒ½è¢«äººç”¨è¿‡</b></p><h3>æ·»åŠ ä¾èµ–</h3><p><code>prpr-lerna-popular</code>ä¾èµ–<code>prpr-lerna-core</code>ï¼Œè¿™æ—¶æœ‰ä¸¤ç§æ–¹æ³•æ·»åŠ ä¾èµ–ï¼š</p><p>ç¬¬ä¸€ç§æ–¹æ³•æ˜¯ä¿®æ”¹<code>prpr-lerna-popular/package.json</code>ï¼Œæ·»åŠ </p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"p\">{</span>\n  <span class=\"s2\">&#34;dependencies&#34;</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"s2\">&#34;prpr-lerna-core&#34;</span><span class=\"o\">:</span> <span class=\"s2\">&#34;^1.0.0&#34;</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>ç„¶åè¿è¡Œ<code>lerna bootstrap</code></p><p>ç¬¬äºŒç§æ–¹æ³•æ˜¯ç›´æ¥ä½¿ç”¨å‘½ä»¤<code>add</code></p><div class=\"highlight\"><pre><code class=\"language-text\">lerna add prpr-lerna-core --scope=prpr-lerna-popular</code></pre></div><p>è¿è¡Œä¹‹åï¼Œæˆ‘ä»¬å‘ç°<code>prpr-lerna-popular</code>ç”Ÿæˆäº†<code>node_modules</code>ï¼Œè€Œ<code>node_modules</code>é‡Œç”Ÿæˆäº†æŒ‡å‘<code>prpr-lerna-core</code>çš„<b>è½¯é“¾</b>ï¼Œç±»ä¼¼<code>npm link</code>çš„æ•ˆæœ: </p><figure data-size=\"normal\"><noscript><img src=\"https://pic2.zhimg.com/v2-0d35dff7eb9ff446627495bc681d8575_b.png\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"695\" data-rawheight=\"112\" class=\"origin_image zh-lightbox-thumb\" width=\"695\" data-original=\"https://pic2.zhimg.com/v2-0d35dff7eb9ff446627495bc681d8575_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;695&#39; height=&#39;112&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"695\" data-rawheight=\"112\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"695\" data-original=\"https://pic2.zhimg.com/v2-0d35dff7eb9ff446627495bc681d8575_r.jpg\" data-actualsrc=\"https://pic2.zhimg.com/v2-0d35dff7eb9ff446627495bc681d8575_b.png\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>æ–°å»º<code>prpr-lerna-core/index.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">API</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;https://yande.re/post/popular_recent.json&#39;</span><span class=\"p\">;</span>\n\n<span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"nx\">API</span>\n<span class=\"p\">}</span>\n</code></pre></div><p><code>prpr-lerna-popular</code>é™¤äº†ä¾èµ–<code>prpr-lerna-core</code>ï¼Œè¿˜å¯ä»¥ä¾èµ–å…¶ä»–å¼€æºçš„åº“ï¼Œæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨<code>axios</code></p><div class=\"highlight\"><pre><code class=\"language-text\">lerna add axios --scope=prpr-lerna-popular</code></pre></div><p>æ–°å»º<code>prpr-lerna-popular/index.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"p\">{</span> <span class=\"nx\">API</span> <span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;prpr-lerna-core&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">axios</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;axios&#39;</span><span class=\"p\">);</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">getPopularImg</span> <span class=\"o\">=</span> <span class=\"p\">()</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">axios</span><span class=\"p\">.</span><span class=\"nx\">get</span><span class=\"p\">(</span><span class=\"nx\">API</span><span class=\"p\">)</span>\n\n<span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"nx\">getPopularImg</span><span class=\"p\">;</span>\n\n<span class=\"c1\">// æµ‹è¯•ä»£ç ï¼Œå‘å¸ƒæ—¶åˆ é™¤\n</span><span class=\"c1\"></span><span class=\"nx\">getPopularImg</span><span class=\"p\">().</span><span class=\"nx\">then</span><span class=\"p\">((</span><span class=\"nx\">res</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">data</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">));</span>\n</code></pre></div><p>æµ‹è¯•ä¸€ä¸‹: <code>node packages/prpr-lerna-popular/index.js</code> æ­£å¸¸æƒ…å†µä¸‹å¯ä»¥è¾“å‡ºç»“æœ</p><h3>å‘å¸ƒåˆ°npm</h3><p>é¦–å…ˆæŠŠæ‰€æœ‰çš„ä»£ç æäº¤</p><div class=\"highlight\"><pre><code class=\"language-text\">cd learn-lerna\ngit add .\ngit commit -m &#34;test publish&#34;</code></pre></div><p>æ³¨å†Œä¸€ä¸ª<a href=\"https://link.zhihu.com/?target=https%3A//www.npmjs.com/\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">npmjs</a>è´¦æˆ·</p><div class=\"highlight\"><pre><code class=\"language-text\">npm login</code></pre></div><p>ç™»å…¥ä½ çš„è´¦æˆ·ï¼Œå¦‚æœæœ¬åœ°npmæ˜¯æ·˜å®é•œåƒï¼Œä¸€å®šè¦æ¢å›<code>https://registry.npmjs.org/</code>åœ°å€ï¼ï¼ï¼</p><div class=\"highlight\"><pre><code class=\"language-text\">lerna publish</code></pre></div><p>è¿è¡Œ<code>publish</code>ï¼Œé€‰æ‹©å‘å¸ƒçš„ç‰ˆæœ¬å· </p><figure data-size=\"normal\"><noscript><img src=\"https://pic3.zhimg.com/v2-e38cbf464a99637e10eb819cfd81f7ce_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"994\" data-rawheight=\"496\" class=\"origin_image zh-lightbox-thumb\" width=\"994\" data-original=\"https://pic3.zhimg.com/v2-e38cbf464a99637e10eb819cfd81f7ce_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;994&#39; height=&#39;496&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"994\" data-rawheight=\"496\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"994\" data-original=\"https://pic3.zhimg.com/v2-e38cbf464a99637e10eb819cfd81f7ce_r.jpg\" data-actualsrc=\"https://pic3.zhimg.com/v2-e38cbf464a99637e10eb819cfd81f7ce_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>lernaå¯ä»¥å¸®æˆ‘ä»¬ç®¡ç†ç‰ˆæœ¬å·ï¼Œéå¸¸æ–¹ä¾¿!</p><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic1.zhimg.com/v2-5ad091e339404f302e4363f0d0db6f74_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"882\" data-rawheight=\"512\" class=\"origin_image zh-lightbox-thumb\" width=\"882\" data-original=\"https://pic1.zhimg.com/v2-5ad091e339404f302e4363f0d0db6f74_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;882&#39; height=&#39;512&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"882\" data-rawheight=\"512\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"882\" data-original=\"https://pic1.zhimg.com/v2-5ad091e339404f302e4363f0d0db6f74_r.jpg\" data-actualsrc=\"https://pic1.zhimg.com/v2-5ad091e339404f302e4363f0d0db6f74_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><h3>å¸¸ç”¨å‘½ä»¤</h3><div class=\"highlight\"><pre><code class=\"language-text\">lerna init #åˆå§‹åŒ–\nlerna bootstrap #ä¸‹è½½ä¾èµ–åŒ…æˆ–è€…ç”Ÿæˆæœ¬åœ°è½¯è¿æ¥\nlerna add axios #æ‰€æœ‰åŒ…éƒ½æ·»åŠ axios\nlerna add prpr-lerna-core --scope=prpr-lerna-popular #ç»™åŒ…prpr-lerna-popularxæ·»åŠ prpr-lerna-coreä¾èµ–\nlerna list\nlerna clean</code></pre></div><h3>å…¶ä»–äº‹é¡¹</h3><ul><li> lernaé»˜è®¤ä½¿ç”¨çš„æ˜¯é›†ä¸­ç‰ˆæœ¬ï¼Œæ‰€æœ‰çš„packageå…±ç”¨ä¸€ä¸ªversionã€‚å¦‚æœå¸Œæœ›ä¸åŒçš„packageæ‹¥æœ‰è‡ªå·±çš„ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨<a href=\"https://link.zhihu.com/?target=https%3A//github.com/lerna/lerna/%23independent-mode\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">Independent</a>æ¨¡å¼<br/> </li><li> å‘å¸ƒpackageçš„åå­—å¦‚æœæ˜¯ä»¥<code>@</code>å¼€å¤´çš„ï¼Œä¾‹å¦‚<code>@deepred/core</code>ï¼Œnpmé»˜è®¤ä»¥ä¸ºæ˜¯ç§äººå‘å¸ƒï¼Œéœ€è¦ä½¿ç”¨<code>npm publish --access public</code>å‘å¸ƒã€‚ä½†æ˜¯<code>lerna publish</code>ä¸æ”¯æŒè¯¥å‚æ•°ï¼Œè§£å†³æ–¹æ³•å‚è€ƒ: <a href=\"https://link.zhihu.com/?target=https%3A//github.com/lerna/lerna/issues/914\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">issues</a><br/> </li></ul><h3>å‚è€ƒ</h3><p><a href=\"https://link.zhihu.com/?target=http%3A//www.sohu.com/a/165037119_575744\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">æµ…è°ˆmonorepo</a></p>", 
            "topic": [
                {
                    "tag": "npm", 
                    "tagLink": "https://api.zhihu.com/topics/19625829"
                }, 
                {
                    "tag": "JavaScript", 
                    "tagLink": "https://api.zhihu.com/topics/19552521"
                }
            ], 
            "comments": [
                {
                    "userName": "æ‰©æ•£æ€§ç™¾ä¸‡å’¸é¢åŒ…", 
                    "userLink": "https://www.zhihu.com/people/9a4a1828b8fef55614661e5a6ac4ea2d", 
                    "content": "æˆ‘å–œæ¬¢ä½ çš„æ–‡ç«  ç‰¹åˆ«æ˜¯å°é¢[é…·]", 
                    "likes": 2, 
                    "childComments": []
                }, 
                {
                    "userName": "çŸ¥ä¹ç”¨æˆ·", 
                    "userLink": "https://www.zhihu.com/people/0", 
                    "content": "<p>è¦æ˜¯å¤´å›¾æ”¾ä¸ªçœŸäººå°±æ›´å¥½äº†ï¼</p>", 
                    "likes": 0, 
                    "childComments": []
                }, 
                {
                    "userName": "è°¢è°¢è°¢å¦–", 
                    "userLink": "https://www.zhihu.com/people/b03b701848270a513609327a76abc329", 
                    "content": "emmmmmmmmmmm", 
                    "likes": 0, 
                    "childComments": []
                }
            ]
        }, 
        {
            "url": "https://zhuanlan.zhihu.com/p/70985017", 
            "userName": "æ·±çº¢", 
            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
            "upvote": 33, 
            "title": "Koaæºç æµ…æ", 
            "content": "<p>Koaæºç ååˆ†ç²¾ç®€ï¼Œåªæœ‰ä¸åˆ°2kè¡Œçš„ä»£ç ï¼Œæ€»å…±ç”±4ä¸ªæ¨¡å—æ–‡ä»¶ç»„æˆï¼Œéå¸¸é€‚åˆæˆ‘ä»¬æ¥å­¦ä¹ ã€‚ </p><figure data-size=\"normal\"><noscript><img src=\"https://pic4.zhimg.com/v2-983d07e6357913e42cf75d67ec3af507_b.jpg\" data-size=\"normal\" data-rawwidth=\"259\" data-rawheight=\"227\" class=\"content_image\" width=\"259\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;259&#39; height=&#39;227&#39;&gt;&lt;/svg&gt;\" data-size=\"normal\" data-rawwidth=\"259\" data-rawheight=\"227\" class=\"content_image lazy\" width=\"259\" data-actualsrc=\"https://pic4.zhimg.com/v2-983d07e6357913e42cf75d67ec3af507_b.jpg\"/><figcaption>4ä¸ªæ–‡ä»¶</figcaption></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>å‚è€ƒä»£ç : <a href=\"https://link.zhihu.com/?target=https%3A//github.com/deepred5/learn-koa2\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">learn-koa2</a> </p><p>æˆ‘ä»¬å…ˆæ¥çœ‹æ®µåŸç”ŸNodeå®ç°ServeræœåŠ¡å™¨çš„ä»£ç ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">http</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;http&#39;</span><span class=\"p\">);</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">server</span> <span class=\"o\">=</span> <span class=\"nx\">http</span><span class=\"p\">.</span><span class=\"nx\">createServer</span><span class=\"p\">((</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">writeHead</span><span class=\"p\">(</span><span class=\"mi\">200</span><span class=\"p\">);</span>\n  <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">end</span><span class=\"p\">(</span><span class=\"s1\">&#39;hello world&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">server</span><span class=\"p\">.</span><span class=\"nx\">listen</span><span class=\"p\">(</span><span class=\"mi\">3000</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;server start at 3000&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n</code></pre></div><p>éå¸¸ç®€å•çš„å‡ è¡Œä»£ç ï¼Œå°±å®ç°äº†ä¸€ä¸ªæœåŠ¡å™¨Serverã€‚<code>createServer</code>æ–¹æ³•æ¥æ”¶çš„<code>callback</code>å›è°ƒå‡½æ•°ï¼Œå¯ä»¥å¯¹æ¯æ¬¡è¯·æ±‚çš„<code>req</code> <code>res</code>å¯¹è±¡è¿›è¡Œå„ç§æ“ä½œï¼Œæœ€åè¿”å›ç»“æœã€‚ä¸è¿‡å¼Šç«¯ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œ<code>callback</code>å‡½æ•°éå¸¸å®¹æ˜“éšç€ä¸šåŠ¡é€»è¾‘çš„å¤æ‚ä¹Ÿå˜å¾—è‡ƒè‚¿ï¼Œå³ä½¿æŠŠ<code>callback</code>å‡½æ•°æ‹†åˆ†æˆå„ä¸ªå°å‡½æ•°ï¼Œä¹Ÿä¼šåœ¨ç¹æ‚çš„å¼‚æ­¥å›è°ƒä¸­æ¸æ¸å¤±å»å¯¹æ•´ä¸ªæµç¨‹çš„æŠŠæ§ã€‚</p><p>å¦å¤–ï¼ŒNodeåŸç”Ÿæä¾›çš„ä¸€äº›APIï¼Œæœ‰æ—¶ä¹Ÿä¼šè®©å¼€å‘è€…ç–‘æƒ‘:</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">statusCode</span> <span class=\"o\">=</span> <span class=\"mi\">200</span><span class=\"p\">;</span>\n<span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">writeHead</span><span class=\"p\">(</span><span class=\"mi\">200</span><span class=\"p\">);</span>\n</code></pre></div><p>ä¿®æ”¹<code>res</code>çš„å±æ€§æˆ–è€…è°ƒç”¨<code>res</code>çš„æ–¹æ³•éƒ½å¯ä»¥æ”¹å˜<code>http</code>çŠ¶æ€ç ï¼Œè¿™åœ¨å¤šäººåä½œçš„é¡¹ç›®ä¸­ï¼Œå¾ˆå®¹æ˜“äº§ç”Ÿä¸åŒçš„ä»£ç é£æ ¼ã€‚</p><p>æˆ‘ä»¬å†æ¥çœ‹æ®µKoaå®ç°Server:</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">Koa</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;koa&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Koa</span><span class=\"p\">();</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"kr\">async</span> <span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">,</span> <span class=\"nx\">next</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;1-start&#39;</span><span class=\"p\">);</span>\n  <span class=\"kr\">await</span> <span class=\"nx\">next</span><span class=\"p\">();</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;1-end&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"kr\">async</span> <span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">,</span> <span class=\"nx\">next</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;2-start&#39;</span><span class=\"p\">);</span>\n  <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">status</span> <span class=\"o\">=</span> <span class=\"mi\">200</span><span class=\"p\">;</span>\n  <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">body</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;Hello World&#39;</span><span class=\"p\">;</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;2-end&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">listen</span><span class=\"p\">(</span><span class=\"mi\">3000</span><span class=\"p\">);</span>\n\n<span class=\"c1\">// æœ€åè¾“å‡ºå†…å®¹ï¼š\n</span><span class=\"c1\">// 1-start\n</span><span class=\"c1\">// 2-start\n</span><span class=\"c1\">// 2-end\n</span><span class=\"c1\">// 1-end\n</span></code></pre></div><p>Koaä½¿ç”¨äº†ä¸­é—´ä»¶çš„æ¦‚å¿µæ¥å®Œæˆå¯¹ä¸€ä¸ªhttpè¯·æ±‚çš„å¤„ç†ï¼ŒåŒæ—¶ï¼ŒKoaé‡‡ç”¨äº†asyncå’Œawaitçš„è¯­æ³•ä½¿å¾—å¼‚æ­¥æµç¨‹å¯ä»¥æ›´å¥½çš„æ§åˆ¶ã€‚<code>ctx</code>æ‰§è¡Œä¸Šä¸‹æ–‡ä»£ç†äº†åŸç”Ÿçš„<code>res</code>å’Œ<code>req</code>ï¼Œè¿™è®©å¼€å‘è€…é¿å…æ¥è§¦åº•å±‚ï¼Œè€Œæ˜¯é€šè¿‡ä»£ç†è®¿é—®å’Œè®¾ç½®å±æ€§ã€‚</p><p>çœ‹å®Œä¸¤è€…çš„å¯¹æ¯”åï¼Œæˆ‘ä»¬åº”è¯¥ä¼šæœ‰å‡ ä¸ªç–‘æƒ‘ï¼š  </p><ol><li><i><code>ctx.status</code>ä¸ºä»€ä¹ˆå°±å¯ä»¥ç›´æ¥è®¾ç½®çŠ¶æ€ç äº†ï¼Œä¸æ˜¯æ ¹æœ¬æ²¡çœ‹åˆ°<code>res</code>å¯¹è±¡å—ï¼Ÿ </i> </li><li>ä¸­é—´ä»¶ä¸­çš„<code>next</code>åˆ°åº•æ˜¯å•¥ï¼Ÿä¸ºä»€ä¹ˆæ‰§è¡Œ<code>next</code>å°±è¿›å…¥äº†ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Ÿ</li><li>æ‰€æœ‰ä¸­é—´ä»¶æ‰§è¡Œå®Œæˆåï¼Œä¸ºä»€ä¹ˆå¯ä»¥å†æ¬¡è¿”å›åŸæ¥çš„ä¸­é—´ä»¶(æ´‹è‘±æ¨¡å‹)ï¼Ÿ</li></ol><p>ç°åœ¨è®©æˆ‘ä»¬å¸¦ç€ç–‘æƒ‘ï¼Œè¿›è¡Œæºç è§£è¯»ï¼ŒåŒæ—¶è‡ªå·±å®ç°ä¸€ä¸ªç®€æ˜“ç‰ˆçš„<a href=\"https://link.zhihu.com/?target=https%3A//github.com/deepred5/learn-koa2/tree/master/kao\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">Koa</a>å§ï¼</p><h3>å°è£…http Server</h3><p>å‚è€ƒä»£ç : <a href=\"https://link.zhihu.com/?target=https%3A//github.com/deepred5/learn-koa2/tree/master/step-1\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">step-1</a></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"c1\">// Koaçš„ä½¿ç”¨æ–¹æ³•\n</span><span class=\"c1\"></span><span class=\"k\">const</span> <span class=\"nx\">Koa</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;koa&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Koa</span><span class=\"p\">();</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"kr\">async</span> <span class=\"nx\">ctx</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">body</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;Hello World&#39;</span><span class=\"p\">;</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">listen</span><span class=\"p\">(</span><span class=\"mi\">3000</span><span class=\"p\">);</span>\n</code></pre></div><p>æˆ‘ä»¬é¦–å…ˆæ¨¡ä»¿koaçš„ä½¿ç”¨æ–¹æ³•ï¼Œæ­å»ºä¸€ä¸ªæœ€ç®€æ˜“çš„éª¨æ¶ï¼š</p><p>æ–°å»º<code>kao/application.js</code>(ç‰¹æ„ä½¿ç”¨äº†<b>Kao</b>ï¼ŒåŒºåˆ«<code>Koa</code>ï¼Œå¹¶éç¬”è¯¯!!!)</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">http</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;http&#39;</span><span class=\"p\">);</span>\n\n<span class=\"k\">class</span> <span class=\"nx\">Application</span> <span class=\"p\">{</span>\n  <span class=\"nx\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">callbackFn</span> <span class=\"o\">=</span> <span class=\"kc\">null</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"nx\">fn</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">callbackFn</span> <span class=\"o\">=</span> <span class=\"nx\">fn</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">callback</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">callbackFn</span><span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">)</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">listen</span><span class=\"p\">(...</span><span class=\"nx\">args</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">const</span> <span class=\"nx\">server</span> <span class=\"o\">=</span> <span class=\"nx\">http</span><span class=\"p\">.</span><span class=\"nx\">createServer</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">callback</span><span class=\"p\">());</span>\n    <span class=\"k\">return</span> <span class=\"nx\">server</span><span class=\"p\">.</span><span class=\"nx\">listen</span><span class=\"p\">(...</span><span class=\"nx\">args</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"nx\">Application</span><span class=\"p\">;</span>\n</code></pre></div><p>æ–°å»ºæµ‹è¯•æ–‡ä»¶<code>kao/index.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">Kao</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;./application&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Kao</span><span class=\"p\">();</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"kr\">async</span> <span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">writeHead</span><span class=\"p\">(</span><span class=\"mi\">200</span><span class=\"p\">);</span>\n  <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">end</span><span class=\"p\">(</span><span class=\"s1\">&#39;hello world&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">listen</span><span class=\"p\">(</span><span class=\"mi\">3001</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;server start at 3001&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n</code></pre></div><p>æˆ‘ä»¬å·²ç»åˆæ­¥å°è£…å¥½http serverï¼šé€šè¿‡<code>new</code>å®ä¾‹ä¸€ä¸ªå¯¹è±¡ï¼Œ<code>use</code>æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œ<code>listen</code>å¯åŠ¨serverå¹¶ä¼ å…¥å›è°ƒã€‚</p><p>æ³¨æ„çš„æ˜¯ï¼šè°ƒç”¨<code>new</code>æ—¶ï¼Œå…¶å®æ²¡æœ‰å¼€å¯serveræœåŠ¡å™¨ï¼ŒçœŸæ­£å¼€å¯æ˜¯åœ¨<code>listen</code>è°ƒç”¨æ—¶ã€‚</p><p>ä¸è¿‡è¿™æ®µä»£ç æœ‰æ˜æ˜¾çš„ä¸è¶³: </p><p><i>useä¼ å…¥çš„å›è°ƒå‡½æ•°ï¼Œæ¥æ”¶çš„å‚æ•°ä¾æ—§æ˜¯åŸç”Ÿçš„<code>req</code>å’Œ<code>res</code></i> </p><p>å¤šæ¬¡è°ƒç”¨useï¼Œä¼šè¦†ç›–ä¸Šä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¹¶ä¸æ˜¯ä¾æ¬¡æ‰§è¡Œå¤šä¸ªä¸­é—´ä»¶</p><p>æˆ‘ä»¬å…ˆæ¥è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜</p><h3>å°è£…reqå’Œreså¯¹è±¡ï¼Œæ„é€ context</h3><p>å‚è€ƒä»£ç : <a href=\"https://link.zhihu.com/?target=https%3A//github.com/deepred5/learn-koa2/tree/master/step-2\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">step-2</a></p><p>å…ˆæ¥ä»‹ç»ä¸‹ES6ä¸­çš„getå’Œset <a href=\"https://link.zhihu.com/?target=https%3A//segmentfault.com/a/1190000009029639\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">å‚è€ƒ</a></p><p>åŸºäºæ™®é€šå¯¹è±¡çš„getå’Œset</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">demo</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"nx\">_name</span><span class=\"o\">:</span> <span class=\"s1\">&#39;&#39;</span><span class=\"p\">,</span>\n  <span class=\"nx\">get</span> <span class=\"nx\">name</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">_name</span><span class=\"p\">;</span>\n  <span class=\"p\">},</span>\n\n  <span class=\"nx\">set</span> <span class=\"nx\">name</span><span class=\"p\">(</span><span class=\"nx\">val</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">_name</span> <span class=\"o\">=</span> <span class=\"nx\">val</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">};</span>\n\n<span class=\"nx\">demo</span><span class=\"p\">.</span><span class=\"nx\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;deepred&#39;</span><span class=\"p\">;</span>\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">demo</span><span class=\"p\">.</span><span class=\"nx\">name</span><span class=\"p\">);</span>\n</code></pre></div><p>åŸºäº<code>Class</code>çš„getå’Œset</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">class</span> <span class=\"nx\">Demo</span> <span class=\"p\">{</span>\n  <span class=\"nx\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">_name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;&#39;</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">get</span> <span class=\"nx\">name</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">_name</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">set</span> <span class=\"nx\">name</span><span class=\"p\">(</span><span class=\"nx\">val</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">_name</span> <span class=\"o\">=</span> <span class=\"nx\">val</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">demo</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Demo</span><span class=\"p\">();</span>\n<span class=\"nx\">demo</span><span class=\"p\">.</span><span class=\"nx\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;deepred&#39;</span><span class=\"p\">;</span>\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">demo</span><span class=\"p\">.</span><span class=\"nx\">name</span><span class=\"p\">);</span>\n</code></pre></div><p>åŸºäºObject.definePropertyçš„getå’Œset</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">demo</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"nx\">_name</span><span class=\"o\">:</span> <span class=\"s1\">&#39;&#39;</span>\n<span class=\"p\">};</span>\n\n<span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">defineProperty</span><span class=\"p\">(</span><span class=\"nx\">demo</span><span class=\"p\">,</span> <span class=\"s1\">&#39;name&#39;</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n  <span class=\"nx\">get</span><span class=\"o\">:</span> <span class=\"kd\">function</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">_name</span>\n  <span class=\"p\">},</span>\n\n  <span class=\"nx\">set</span><span class=\"o\">:</span> <span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">val</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">_name</span> <span class=\"o\">=</span> <span class=\"nx\">val</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">});</span>\n</code></pre></div><p>åŸºäºProxyçš„getå’Œset</p><div class=\"highlight\"><pre><code class=\"language-text\">const demo = {\n  _name: &#39;&#39;\n}\n\nconst proxy = new Proxy(demo, {\n  get: function(target, name) {\n    return name === &#39;name&#39; ? target[&#39;_name&#39;] : undefined;\n  },\n\n  set function(target, name, val) {\n    name === &#39;name&#39; &amp;&amp; (target[&#39;_name&#39;] = val)\n  }\n});\n</code></pre></div><p>è¿˜æœ‰<code>__defineSetter__</code>å’Œ<code>__defineGetter__</code>çš„å®ç°ï¼Œä¸è¿‡ç°å·²åºŸå¼ƒã€‚</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">demo</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"nx\">_name</span><span class=\"o\">:</span> <span class=\"s1\">&#39;&#39;</span>\n<span class=\"p\">};</span>\n\n<span class=\"nx\">demo</span><span class=\"p\">.</span><span class=\"nx\">__defineGetter__</span><span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">,</span> <span class=\"kd\">function</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n  <span class=\"k\">return</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">_name</span><span class=\"p\">;</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">demo</span><span class=\"p\">.</span><span class=\"nx\">__defineSetter__</span><span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">,</span> <span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">val</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">_name</span> <span class=\"o\">=</span> <span class=\"nx\">val</span><span class=\"p\">;</span>\n<span class=\"p\">});</span>\n</code></pre></div><p>ä¸»è¦åŒºåˆ«æ˜¯ï¼Œ<code>Object.defineProperty  Proxy</code> <code>__defineSetter__</code>å¯ä»¥åŠ¨æ€è®¾ç½®å±æ€§ï¼Œè€Œå…¶ä»–æ–¹å¼åªèƒ½åœ¨å®šä¹‰æ—¶è®¾ç½®ã€‚</p><p>Koaæºç ä¸­ <code>request.js</code>å’Œ<code>response.js</code>å°±ä½¿ç”¨äº†å¤§é‡çš„<code>get</code>å’Œ<code>set</code>æ¥ä»£ç†</p><p>æ–°å»º<code>kao/request.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"nx\">get</span> <span class=\"nx\">header</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">headers</span><span class=\"p\">;</span>\n  <span class=\"p\">},</span>\n\n  <span class=\"nx\">set</span> <span class=\"nx\">header</span><span class=\"p\">(</span><span class=\"nx\">val</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">headers</span> <span class=\"o\">=</span> <span class=\"nx\">val</span><span class=\"p\">;</span>\n  <span class=\"p\">},</span>\n\n  <span class=\"nx\">get</span> <span class=\"nx\">url</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">url</span><span class=\"p\">;</span>\n  <span class=\"p\">},</span>\n\n  <span class=\"nx\">set</span> <span class=\"nx\">url</span><span class=\"p\">(</span><span class=\"nx\">val</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">url</span> <span class=\"o\">=</span> <span class=\"nx\">val</span><span class=\"p\">;</span>\n  <span class=\"p\">},</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>å½“è®¿é—®<code>request.url</code>æ—¶ï¼Œå…¶å®å°±æ˜¯åœ¨è®¿é—®åŸç”Ÿçš„<code>req.url</code>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>this.req</code>åŸç”Ÿå¯¹è±¡æ­¤æ—¶è¿˜æ²¡æœ‰æ³¨å…¥ï¼</p><p>åŒç†æ–°å»º<code>kao/response.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"nx\">get</span> <span class=\"nx\">status</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">statusCode</span><span class=\"p\">;</span>\n  <span class=\"p\">},</span>\n\n  <span class=\"nx\">set</span> <span class=\"nx\">status</span><span class=\"p\">(</span><span class=\"nx\">code</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">statusCode</span> <span class=\"o\">=</span> <span class=\"nx\">code</span><span class=\"p\">;</span>\n  <span class=\"p\">},</span>\n\n  <span class=\"nx\">get</span> <span class=\"nx\">body</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">_body</span><span class=\"p\">;</span>\n  <span class=\"p\">},</span>\n\n  <span class=\"nx\">set</span> <span class=\"nx\">body</span><span class=\"p\">(</span><span class=\"nx\">val</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// æºç é‡Œæœ‰å¯¹valç±»å‹çš„å„ç§åˆ¤æ–­ï¼Œè¿™é‡Œçœç•¥\n</span><span class=\"c1\"></span>    <span class=\"cm\">/* å¯èƒ½çš„ç±»å‹\n</span><span class=\"cm\">    1. string\n</span><span class=\"cm\">    2. Buffer\n</span><span class=\"cm\">    3. Stream\n</span><span class=\"cm\">    4. Object\n</span><span class=\"cm\">    */</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">_body</span> <span class=\"o\">=</span> <span class=\"nx\">val</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>è¿™é‡Œå¯¹bodyè¿›è¡Œæ“ä½œå¹¶æ²¡æœ‰ä½¿ç”¨åŸç”Ÿçš„this.res.endï¼Œå› ä¸ºåœ¨æˆ‘ä»¬ç¼–å†™koaä»£ç çš„æ—¶å€™ï¼Œä¼šå¯¹bodyè¿›è¡Œå¤šæ¬¡çš„è¯»å–å’Œä¿®æ”¹ï¼Œæ‰€ä»¥çœŸæ­£è¿”å›æµè§ˆå™¨ä¿¡æ¯çš„æ“ä½œæ˜¯åœ¨<code>application.js</code>é‡Œè¿›è¡Œå°è£…å’Œæ“ä½œ</p><p>åŒæ ·éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>this.res</code>åŸç”Ÿå¯¹è±¡æ­¤æ—¶è¿˜æ²¡æœ‰æ³¨å…¥ï¼</p><p>æ–°å»º<code>kao/context.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">delegate</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;delegates&#39;</span><span class=\"p\">);</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">proto</span> <span class=\"o\">=</span> <span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"c1\">// contextè‡ªèº«çš„æ–¹æ³•\n</span><span class=\"c1\"></span>  <span class=\"nx\">toJSON</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"p\">{</span>\n      <span class=\"nx\">request</span><span class=\"o\">:</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">request</span><span class=\"p\">.</span><span class=\"nx\">toJSON</span><span class=\"p\">(),</span>\n      <span class=\"nx\">response</span><span class=\"o\">:</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">response</span><span class=\"p\">.</span><span class=\"nx\">toJSON</span><span class=\"p\">(),</span>\n      <span class=\"nx\">app</span><span class=\"o\">:</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">toJSON</span><span class=\"p\">(),</span>\n      <span class=\"nx\">originalUrl</span><span class=\"o\">:</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">originalUrl</span><span class=\"p\">,</span>\n      <span class=\"nx\">req</span><span class=\"o\">:</span> <span class=\"s1\">&#39;&lt;original node req&gt;&#39;</span><span class=\"p\">,</span>\n      <span class=\"nx\">res</span><span class=\"o\">:</span> <span class=\"s1\">&#39;&lt;original node res&gt;&#39;</span><span class=\"p\">,</span>\n      <span class=\"nx\">socket</span><span class=\"o\">:</span> <span class=\"s1\">&#39;&lt;original node socket&gt;&#39;</span>\n    <span class=\"p\">};</span>\n  <span class=\"p\">},</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// delegates åŸç†å°±æ˜¯__defineGetter__å’Œ__defineSetter__\n</span><span class=\"c1\"></span>\n<span class=\"c1\">// methodæ˜¯å§”æ‰˜æ–¹æ³•ï¼Œgetterå§”æ‰˜getter,accesså§”æ‰˜getterå’Œsetterã€‚\n</span><span class=\"c1\"></span>\n<span class=\"c1\">// proto.status =&gt; proto.response.status\n</span><span class=\"c1\"></span><span class=\"nx\">delegate</span><span class=\"p\">(</span><span class=\"nx\">proto</span><span class=\"p\">,</span> <span class=\"s1\">&#39;response&#39;</span><span class=\"p\">)</span>\n  <span class=\"p\">.</span><span class=\"nx\">access</span><span class=\"p\">(</span><span class=\"s1\">&#39;status&#39;</span><span class=\"p\">)</span>\n  <span class=\"p\">.</span><span class=\"nx\">access</span><span class=\"p\">(</span><span class=\"s1\">&#39;body&#39;</span><span class=\"p\">)</span>\n\n\n<span class=\"c1\">// proto.url = proto.request.url\n</span><span class=\"c1\"></span><span class=\"nx\">delegate</span><span class=\"p\">(</span><span class=\"nx\">proto</span><span class=\"p\">,</span> <span class=\"s1\">&#39;request&#39;</span><span class=\"p\">)</span>\n  <span class=\"p\">.</span><span class=\"nx\">access</span><span class=\"p\">(</span><span class=\"s1\">&#39;url&#39;</span><span class=\"p\">)</span>\n  <span class=\"p\">.</span><span class=\"nx\">getter</span><span class=\"p\">(</span><span class=\"s1\">&#39;header&#39;</span><span class=\"p\">)</span>\n</code></pre></div><p><code>context.js</code>ä»£ç†äº†<code>request</code>å’Œ<code>response</code>ã€‚<code>ctx.body</code>æŒ‡å‘<code>ctx.response.body</code>ã€‚ä½†æ˜¯æ­¤æ—¶<code>ctx.response</code> <code>ctx.request</code>è¿˜æ²¡æ³¨å…¥ï¼</p><p>å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆ<code>response.js</code>å’Œ<code>request.js</code>ä½¿ç”¨<code>get set</code>ä»£ç†ï¼Œè€Œ<code>context.js</code>ä½¿ç”¨<code>delegate</code>ä»£ç†? åŸå› ä¸»è¦æ˜¯: <code>set</code>å’Œ<code>get</code>æ–¹æ³•é‡Œé¢è¿˜å¯ä»¥åŠ å…¥ä¸€äº›è‡ªå·±çš„é€»è¾‘å¤„ç†ã€‚è€Œ<code>delegate</code>å°±æ¯”è¾ƒçº¯ç²¹äº†ï¼Œåªä»£ç†å±æ€§ã€‚</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"p\">{</span>\n  <span class=\"nx\">get</span> <span class=\"nx\">length</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// è‡ªå·±çš„é€»è¾‘\n</span><span class=\"c1\"></span>    <span class=\"k\">const</span> <span class=\"nx\">len</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;Content-Length&#39;</span><span class=\"p\">);</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">len</span> <span class=\"o\">==</span> <span class=\"s1\">&#39;&#39;</span><span class=\"p\">)</span> <span class=\"k\">return</span><span class=\"p\">;</span>\n    <span class=\"k\">return</span> <span class=\"o\">~~</span><span class=\"nx\">len</span><span class=\"p\">;</span>\n  <span class=\"p\">},</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// ä»…ä»…ä»£ç†å±æ€§\n</span><span class=\"c1\"></span><span class=\"nx\">delegate</span><span class=\"p\">(</span><span class=\"nx\">proto</span><span class=\"p\">,</span> <span class=\"s1\">&#39;response&#39;</span><span class=\"p\">)</span>\n  <span class=\"p\">.</span><span class=\"nx\">access</span><span class=\"p\">(</span><span class=\"s1\">&#39;length&#39;</span><span class=\"p\">)</span>\n</code></pre></div><p>å› æ­¤<code>context.js</code>æ¯”è¾ƒé€‚åˆä½¿ç”¨<code>delegate</code>ï¼Œä»…ä»…æ˜¯ä»£ç†<code>request</code>å’Œ<code>response</code>çš„å±æ€§å’Œæ–¹æ³•ã€‚</p><p>çœŸæ­£æ³¨å…¥åŸç”Ÿå¯¹è±¡ï¼Œæ˜¯åœ¨<code>application.js</code>é‡Œçš„<code>createContext</code>æ–¹æ³•ä¸­æ³¨å…¥çš„ï¼ï¼ï¼</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">http</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;http&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">context</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;./context&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">request</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;./request&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">response</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;./response&#39;</span><span class=\"p\">);</span>\n\n<span class=\"k\">class</span> <span class=\"nx\">Application</span> <span class=\"p\">{</span>\n  <span class=\"nx\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">callbackFn</span> <span class=\"o\">=</span> <span class=\"kc\">null</span><span class=\"p\">;</span>\n    <span class=\"c1\">// æ¯ä¸ªKaoå®ä¾‹çš„context request respones\n</span><span class=\"c1\"></span>    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">context</span> <span class=\"o\">=</span> <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"nx\">context</span><span class=\"p\">);</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">request</span> <span class=\"o\">=</span> <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"nx\">request</span><span class=\"p\">);</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">response</span> <span class=\"o\">=</span> <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"nx\">response</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"nx\">fn</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">callbackFn</span> <span class=\"o\">=</span> <span class=\"nx\">fn</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">callback</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">const</span> <span class=\"nx\">handleRequest</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n      <span class=\"k\">const</span> <span class=\"nx\">ctx</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">createContext</span><span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">);</span>\n      <span class=\"k\">return</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">handleRequest</span><span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">)</span>\n    <span class=\"p\">};</span>\n\n    <span class=\"k\">return</span> <span class=\"nx\">handleRequest</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">handleRequest</span><span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">const</span> <span class=\"nx\">handleResponse</span> <span class=\"o\">=</span> <span class=\"p\">()</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">respond</span><span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">);</span>\n    <span class=\"c1\">// callbackFnæ˜¯ä¸ªasyncå‡½æ•°ï¼Œæœ€åè¿”å›promiseå¯¹è±¡\n</span><span class=\"c1\"></span>    <span class=\"k\">return</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">callbackFn</span><span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">).</span><span class=\"nx\">then</span><span class=\"p\">(</span><span class=\"nx\">handleResponse</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">createContext</span><span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// é’ˆå¯¹æ¯ä¸ªè¯·æ±‚ï¼Œéƒ½è¦åˆ›å»ºctxå¯¹è±¡\n</span><span class=\"c1\"></span>    <span class=\"c1\">// æ¯ä¸ªè¯·æ±‚çš„ctx request response\n</span><span class=\"c1\"></span>    <span class=\"c1\">// ctxä»£ç†åŸç”Ÿçš„req reså°±æ˜¯åœ¨è¿™é‡Œä»£ç†çš„\n</span><span class=\"c1\"></span>    <span class=\"kd\">let</span> <span class=\"nx\">ctx</span> <span class=\"o\">=</span> <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">context</span><span class=\"p\">);</span>\n    <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">request</span> <span class=\"o\">=</span> <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">request</span><span class=\"p\">);</span>\n    <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">response</span> <span class=\"o\">=</span> <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">response</span><span class=\"p\">);</span>\n    <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">req</span> <span class=\"o\">=</span> <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">request</span><span class=\"p\">.</span><span class=\"nx\">req</span> <span class=\"o\">=</span> <span class=\"nx\">req</span><span class=\"p\">;</span>\n    <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">res</span> <span class=\"o\">=</span> <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">response</span><span class=\"p\">.</span><span class=\"nx\">res</span> <span class=\"o\">=</span> <span class=\"nx\">res</span><span class=\"p\">;</span>\n    <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">request</span><span class=\"p\">.</span><span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">response</span><span class=\"p\">.</span><span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"p\">;</span>\n    <span class=\"k\">return</span> <span class=\"nx\">ctx</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">listen</span><span class=\"p\">(...</span><span class=\"nx\">args</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">const</span> <span class=\"nx\">server</span> <span class=\"o\">=</span> <span class=\"nx\">http</span><span class=\"p\">.</span><span class=\"nx\">createServer</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">callback</span><span class=\"p\">());</span>\n    <span class=\"k\">return</span> <span class=\"nx\">server</span><span class=\"p\">.</span><span class=\"nx\">listen</span><span class=\"p\">(...</span><span class=\"nx\">args</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"nx\">Application</span><span class=\"p\">;</span>\n\n<span class=\"kd\">function</span> <span class=\"nx\">respond</span><span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"c1\">// æ ¹æ®ctx.bodyçš„ç±»å‹ï¼Œè¿”å›æœ€åçš„æ•°æ®\n</span><span class=\"c1\"></span>  <span class=\"cm\">/* å¯èƒ½çš„ç±»å‹ï¼Œä»£ç åˆ å‡äº†éƒ¨åˆ†åˆ¤æ–­\n</span><span class=\"cm\">  1. string\n</span><span class=\"cm\">  2. Buffer\n</span><span class=\"cm\">  3. Stream\n</span><span class=\"cm\">  4. Object\n</span><span class=\"cm\">  */</span>\n  <span class=\"kd\">let</span> <span class=\"nx\">content</span> <span class=\"o\">=</span> <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">body</span><span class=\"p\">;</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"k\">typeof</span> <span class=\"nx\">content</span> <span class=\"o\">===</span> <span class=\"s1\">&#39;string&#39;</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">end</span><span class=\"p\">(</span><span class=\"nx\">content</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n  <span class=\"k\">else</span> <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"k\">typeof</span> <span class=\"nx\">content</span> <span class=\"o\">===</span> <span class=\"s1\">&#39;object&#39;</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">end</span><span class=\"p\">(</span><span class=\"nx\">JSON</span><span class=\"p\">.</span><span class=\"nx\">stringify</span><span class=\"p\">(</span><span class=\"nx\">content</span><span class=\"p\">));</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>ä»£ç ä¸­ä½¿ç”¨äº†<code>Object.create</code>çš„æ–¹æ³•åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ï¼Œé€šè¿‡åŸå‹é“¾ç»§æ‰¿åŸæ¥çš„å±æ€§ã€‚è¿™æ ·å¯ä»¥æœ‰æ•ˆçš„é˜²æ­¢æ±¡æŸ“åŸæ¥çš„å¯¹è±¡ã€‚</p><p><code>createContext</code>åœ¨æ¯æ¬¡httpè¯·æ±‚æ—¶éƒ½ä¼šè°ƒç”¨ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½æ–°ç”Ÿæˆä¸€ä¸ª<code>ctx</code>å¯¹è±¡ï¼Œå¹¶ä¸”ä»£ç†äº†è¿™æ¬¡httpè¯·æ±‚çš„åŸç”Ÿçš„å¯¹è±¡ã€‚</p><p><code>respond</code>æ‰æ˜¯æœ€åè¿”å›httpå“åº”çš„æ–¹æ³•ã€‚æ ¹æ®æ‰§è¡Œå®Œæ‰€æœ‰ä¸­é—´ä»¶å<code>ctx.body</code>çš„ç±»å‹ï¼Œè°ƒç”¨<code>res.end</code>ç»“æŸæ­¤æ¬¡httpè¯·æ±‚ã€‚</p><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic2.zhimg.com/v2-24e47e1e537b4b3aeb9846ae0764b239_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1435\" data-rawheight=\"926\" class=\"origin_image zh-lightbox-thumb\" width=\"1435\" data-original=\"https://pic2.zhimg.com/v2-24e47e1e537b4b3aeb9846ae0764b239_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;1435&#39; height=&#39;926&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1435\" data-rawheight=\"926\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1435\" data-original=\"https://pic2.zhimg.com/v2-24e47e1e537b4b3aeb9846ae0764b239_r.jpg\" data-actualsrc=\"https://pic2.zhimg.com/v2-24e47e1e537b4b3aeb9846ae0764b239_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>ç°åœ¨æˆ‘ä»¬å†æ¥æµ‹è¯•ä¸€ä¸‹: <code>kao/index.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">Kao</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;./application&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Kao</span><span class=\"p\">();</span>\n\n<span class=\"c1\">// ä½¿ç”¨ctxä¿®æ”¹çŠ¶æ€ç å’Œå“åº”å†…å®¹\n</span><span class=\"c1\"></span><span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"kr\">async</span> <span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">status</span> <span class=\"o\">=</span> <span class=\"mi\">200</span><span class=\"p\">;</span>\n  <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">body</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n    <span class=\"nx\">code</span><span class=\"o\">:</span> <span class=\"mi\">1</span><span class=\"p\">,</span>\n    <span class=\"nx\">message</span><span class=\"o\">:</span> <span class=\"s1\">&#39;ok&#39;</span><span class=\"p\">,</span>\n    <span class=\"nx\">url</span><span class=\"o\">:</span> <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">url</span>\n  <span class=\"p\">};</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">listen</span><span class=\"p\">(</span><span class=\"mi\">3001</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;server start at 3001&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n</code></pre></div><h3>ä¸­é—´ä»¶æœºåˆ¶</h3><p>å‚è€ƒä»£ç : <a href=\"https://link.zhihu.com/?target=https%3A//github.com/deepred5/learn-koa2/tree/master/step-3\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">step-3</a></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">greeting</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"nx\">firstName</span><span class=\"p\">,</span> <span class=\"nx\">lastName</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">firstName</span> <span class=\"o\">+</span> <span class=\"s1\">&#39; &#39;</span> <span class=\"o\">+</span> <span class=\"nx\">lastName</span>\n<span class=\"k\">const</span> <span class=\"nx\">toUpper</span> <span class=\"o\">=</span> <span class=\"nx\">str</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">str</span><span class=\"p\">.</span><span class=\"nx\">toUpperCase</span><span class=\"p\">()</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">fn</span> <span class=\"o\">=</span> <span class=\"nx\">compose</span><span class=\"p\">([</span><span class=\"nx\">toUpper</span><span class=\"p\">,</span> <span class=\"nx\">greeting</span><span class=\"p\">]);</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">result</span> <span class=\"o\">=</span> <span class=\"nx\">fn</span><span class=\"p\">(</span><span class=\"s1\">&#39;jack&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;smith&#39;</span><span class=\"p\">);</span>\n\n<span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">result</span><span class=\"p\">);</span>\n</code></pre></div><p>å‡½æ•°å¼ç¼–ç¨‹æœ‰ä¸ª<code>compose</code>çš„æ¦‚å¿µã€‚æ¯”å¦‚æŠŠ<code>greeting</code>å’Œ<code>toUpper</code>ç»„åˆæˆä¸€ä¸ªå¤åˆå‡½æ•°ã€‚è°ƒç”¨è¿™ä¸ªå¤åˆå‡½æ•°ï¼Œä¼šå…ˆè°ƒç”¨<code>greeting</code>ï¼Œç„¶åæŠŠè¿”å›å€¼ä¼ ç»™<code>toUpper</code>ç»§ç»­æ‰§è¡Œã€‚</p><p>å®ç°æ–¹å¼:</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"c1\">// å‘½ä»¤å¼ç¼–ç¨‹ï¼ˆé¢å‘è¿‡ç¨‹ï¼‰\n</span><span class=\"c1\"></span><span class=\"kd\">function</span> <span class=\"nx\">compose</span><span class=\"p\">(</span><span class=\"nx\">fns</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"kd\">let</span> <span class=\"nx\">length</span> <span class=\"o\">=</span> <span class=\"nx\">fns</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">;</span>\n  <span class=\"kd\">let</span> <span class=\"nx\">count</span> <span class=\"o\">=</span> <span class=\"nx\">length</span> <span class=\"o\">-</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n  <span class=\"kd\">let</span> <span class=\"nx\">result</span> <span class=\"o\">=</span> <span class=\"kc\">null</span><span class=\"p\">;</span>\n\n  <span class=\"k\">return</span> <span class=\"kd\">function</span> <span class=\"nx\">fn1</span><span class=\"p\">(...</span><span class=\"nx\">args</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">result</span> <span class=\"o\">=</span> <span class=\"nx\">fns</span><span class=\"p\">[</span><span class=\"nx\">count</span><span class=\"p\">].</span><span class=\"nx\">apply</span><span class=\"p\">(</span><span class=\"kc\">null</span><span class=\"p\">,</span> <span class=\"nx\">args</span><span class=\"p\">);</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">count</span> <span class=\"o\">&lt;=</span> <span class=\"mi\">0</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"k\">return</span> <span class=\"nx\">result</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"nx\">count</span><span class=\"o\">--</span><span class=\"p\">;</span>\n    <span class=\"k\">return</span> <span class=\"nx\">fn1</span><span class=\"p\">(</span><span class=\"nx\">result</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// å£°æ˜å¼ç¼–ç¨‹(å‡½æ•°å¼)\n</span><span class=\"c1\"></span><span class=\"kd\">function</span> <span class=\"nx\">compose</span><span class=\"p\">(</span><span class=\"nx\">funcs</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">return</span> <span class=\"nx\">funcs</span><span class=\"p\">.</span><span class=\"nx\">reduce</span><span class=\"p\">((</span><span class=\"nx\">a</span><span class=\"p\">,</span> <span class=\"nx\">b</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">(...</span><span class=\"nx\">args</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">a</span><span class=\"p\">(</span><span class=\"nx\">b</span><span class=\"p\">(...</span><span class=\"nx\">args</span><span class=\"p\">)))</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>Koaçš„ä¸­é—´ä»¶æœºåˆ¶ç±»ä¼¼ä¸Šé¢çš„<code>compose</code>ï¼ŒåŒæ ·æ˜¯æŠŠå¤šä¸ªå‡½æ•°åŒ…è£…æˆä¸€ä¸ªï¼Œä½†æ˜¯koaçš„ä¸­é—´ä»¶ç±»ä¼¼æ´‹è‘±æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯ä»Aä¸­é—´ä»¶æ‰§è¡Œåˆ°Bä¸­é—´ä»¶ï¼ŒBä¸­é—´ä»¶æ‰§è¡Œå®Œæˆä»¥åï¼Œä»ç„¶å¯ä»¥å†æ¬¡å›åˆ°Aä¸­é—´ä»¶ã€‚ </p><figure data-size=\"normal\"><noscript><img src=\"https://pic2.zhimg.com/v2-6a397981bcfa921e3399dbe94dd95b19_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"478\" data-rawheight=\"435\" class=\"origin_image zh-lightbox-thumb\" width=\"478\" data-original=\"https://pic2.zhimg.com/v2-6a397981bcfa921e3399dbe94dd95b19_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;478&#39; height=&#39;435&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"478\" data-rawheight=\"435\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"478\" data-original=\"https://pic2.zhimg.com/v2-6a397981bcfa921e3399dbe94dd95b19_r.jpg\" data-actualsrc=\"https://pic2.zhimg.com/v2-6a397981bcfa921e3399dbe94dd95b19_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>Koaä½¿ç”¨äº†<code>koa-compose</code>å®ç°äº†ä¸­é—´ä»¶æœºåˆ¶ï¼Œæºç éå¸¸ç²¾ç®€ï¼Œä½†æ˜¯æœ‰ç‚¹éš¾æ‡‚ã€‚å»ºè®®å…ˆçœ‹ä¸‹æˆ‘ä¹‹å‰å…³äºé€’å½’çš„æ–‡ç« ï¼š</p><a href=\"https://link.zhihu.com/?target=http%3A//anata.me/2018/07/30/%25E7%25AE%2580%25E5%258D%2595%25E6%2598%2593%25E6%2587%2582%25E7%259A%2584%25E7%258E%25B0%25E4%25BB%25A3%25E9%25AD%2594%25E6%25B3%2595-%25E9%2580%2592%25E5%25BD%2592/\" data-draft-node=\"block\" data-draft-type=\"link-card\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">ç®€å•æ˜“æ‡‚çš„ç°ä»£é­”æ³•-é€’å½’</a><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"kd\">function</span> <span class=\"nx\">compose</span> <span class=\"p\">(</span><span class=\"nx\">middleware</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"nb\">Array</span><span class=\"p\">.</span><span class=\"nx\">isArray</span><span class=\"p\">(</span><span class=\"nx\">middleware</span><span class=\"p\">))</span> <span class=\"k\">throw</span> <span class=\"k\">new</span> <span class=\"nx\">TypeError</span><span class=\"p\">(</span><span class=\"s1\">&#39;Middleware stack must be an array!&#39;</span><span class=\"p\">)</span>\n  <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"nx\">fn</span> <span class=\"k\">of</span> <span class=\"nx\">middleware</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"k\">typeof</span> <span class=\"nx\">fn</span> <span class=\"o\">!==</span> <span class=\"s1\">&#39;function&#39;</span><span class=\"p\">)</span> <span class=\"k\">throw</span> <span class=\"k\">new</span> <span class=\"nx\">TypeError</span><span class=\"p\">(</span><span class=\"s1\">&#39;Middleware must be composed of functions!&#39;</span><span class=\"p\">)</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"cm\">/**\n</span><span class=\"cm\">   * @param {Object} context\n</span><span class=\"cm\">   * @return {Promise}\n</span><span class=\"cm\">   * @api public\n</span><span class=\"cm\">   */</span>\n\n  <span class=\"k\">return</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">context</span><span class=\"p\">,</span> <span class=\"nx\">next</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// last called middleware #\n</span><span class=\"c1\"></span>    <span class=\"kd\">let</span> <span class=\"nx\">index</span> <span class=\"o\">=</span> <span class=\"o\">-</span><span class=\"mi\">1</span>\n    <span class=\"k\">return</span> <span class=\"nx\">dispatch</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n    <span class=\"kd\">function</span> <span class=\"nx\">dispatch</span> <span class=\"p\">(</span><span class=\"nx\">i</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"c1\">// ä¸€ä¸ªä¸­é—´ä»¶é‡Œå¤šæ¬¡è°ƒç”¨next\n</span><span class=\"c1\"></span>      <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">i</span> <span class=\"o\">&lt;=</span> <span class=\"nx\">index</span><span class=\"p\">)</span> <span class=\"k\">return</span> <span class=\"nb\">Promise</span><span class=\"p\">.</span><span class=\"nx\">reject</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"nb\">Error</span><span class=\"p\">(</span><span class=\"s1\">&#39;next() called multiple times&#39;</span><span class=\"p\">))</span>\n      <span class=\"nx\">index</span> <span class=\"o\">=</span> <span class=\"nx\">i</span>\n      <span class=\"c1\">// fnå°±æ˜¯å½“å‰çš„ä¸­é—´ä»¶\n</span><span class=\"c1\"></span>      <span class=\"kd\">let</span> <span class=\"nx\">fn</span> <span class=\"o\">=</span> <span class=\"nx\">middleware</span><span class=\"p\">[</span><span class=\"nx\">i</span><span class=\"p\">]</span>\n      <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">i</span> <span class=\"o\">===</span> <span class=\"nx\">middleware</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">)</span> <span class=\"nx\">fn</span> <span class=\"o\">=</span> <span class=\"nx\">next</span> <span class=\"c1\">// æœ€åä¸€ä¸ªä¸­é—´ä»¶å¦‚æœä¹Ÿnextæ—¶è¿›å…¥(ä¸€èˆ¬æœ€åä¸€ä¸ªä¸­é—´ä»¶æ˜¯ç›´æ¥æ“ä½œctx.bodyï¼Œå¹¶ä¸éœ€è¦nextäº†)\n</span><span class=\"c1\"></span>      <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"nx\">fn</span><span class=\"p\">)</span> <span class=\"k\">return</span> <span class=\"nb\">Promise</span><span class=\"p\">.</span><span class=\"nx\">resolve</span><span class=\"p\">()</span> <span class=\"c1\">// æ²¡æœ‰ä¸­é—´ä»¶ï¼Œç›´æ¥è¿”å›æˆåŠŸ\n</span><span class=\"c1\"></span>      <span class=\"k\">try</span> <span class=\"p\">{</span>\n\n        <span class=\"cm\">/* \n</span><span class=\"cm\">          * ä½¿ç”¨äº†bindå‡½æ•°è¿”å›æ–°çš„å‡½æ•°ï¼Œç±»ä¼¼ä¸‹é¢çš„ä»£ç \n</span><span class=\"cm\">          return Promise.resolve(fn(context, function next () {\n</span><span class=\"cm\">            return dispatch(i + 1)\n</span><span class=\"cm\">          }))\n</span><span class=\"cm\">        */</span>\n        <span class=\"c1\">// dispatch.bind(null, i + 1)å°±æ˜¯ä¸­é—´ä»¶é‡Œçš„nextå‚æ•°ï¼Œè°ƒç”¨å®ƒå°±å¯ä»¥è¿›å…¥ä¸‹ä¸€ä¸ªä¸­é—´ä»¶\n</span><span class=\"c1\"></span>\n        <span class=\"c1\">// fnå¦‚æœè¿”å›çš„æ˜¯Promiseå¯¹è±¡ï¼ŒPromise.resolveç›´æ¥æŠŠè¿™ä¸ªå¯¹è±¡è¿”å›\n</span><span class=\"c1\"></span>        <span class=\"c1\">// fnå¦‚æœè¿”å›çš„æ˜¯æ™®é€šå¯¹è±¡ï¼ŒPromise.resovleæŠŠå®ƒPromiseåŒ–\n</span><span class=\"c1\"></span>        <span class=\"k\">return</span> <span class=\"nb\">Promise</span><span class=\"p\">.</span><span class=\"nx\">resolve</span><span class=\"p\">(</span><span class=\"nx\">fn</span><span class=\"p\">(</span><span class=\"nx\">context</span><span class=\"p\">,</span> <span class=\"nx\">dispatch</span><span class=\"p\">.</span><span class=\"nx\">bind</span><span class=\"p\">(</span><span class=\"kc\">null</span><span class=\"p\">,</span> <span class=\"nx\">i</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">)));</span>\n      <span class=\"p\">}</span> <span class=\"k\">catch</span> <span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"c1\">// ä¸­é—´ä»¶æ˜¯asyncçš„å‡½æ•°ï¼ŒæŠ¥é”™ä¸ä¼šèµ°è¿™é‡Œï¼Œç›´æ¥åœ¨fnMiddlewareçš„catchä¸­æ•è·\n</span><span class=\"c1\"></span>        <span class=\"c1\">// æ•è·ä¸­é—´ä»¶æ˜¯æ™®é€šå‡½æ•°æ—¶çš„æŠ¥é”™,PromiseåŒ–ï¼Œè¿™æ ·æ‰èƒ½èµ°åˆ°fnMiddlewareçš„catchæ–¹æ³•\n</span><span class=\"c1\"></span>        <span class=\"k\">return</span> <span class=\"nb\">Promise</span><span class=\"p\">.</span><span class=\"nx\">reject</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">)</span>\n      <span class=\"p\">}</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"k\">const</span> <span class=\"nx\">context</span> <span class=\"o\">=</span> <span class=\"p\">{};</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">sleep</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"nx\">time</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"k\">new</span> <span class=\"nb\">Promise</span><span class=\"p\">(</span><span class=\"nx\">resolve</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">setTimeout</span><span class=\"p\">(</span><span class=\"nx\">resolve</span><span class=\"p\">,</span> <span class=\"nx\">time</span><span class=\"p\">));</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">test1</span> <span class=\"o\">=</span> <span class=\"kr\">async</span> <span class=\"p\">(</span><span class=\"nx\">context</span><span class=\"p\">,</span> <span class=\"nx\">next</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;1-start&#39;</span><span class=\"p\">);</span>\n  <span class=\"nx\">context</span><span class=\"p\">.</span><span class=\"nx\">age</span> <span class=\"o\">=</span> <span class=\"mi\">11</span><span class=\"p\">;</span>\n  <span class=\"kr\">await</span> <span class=\"nx\">next</span><span class=\"p\">();</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;1-end&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">};</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">test2</span> <span class=\"o\">=</span> <span class=\"kr\">async</span> <span class=\"p\">(</span><span class=\"nx\">context</span><span class=\"p\">,</span> <span class=\"nx\">next</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;2-start&#39;</span><span class=\"p\">);</span>\n  <span class=\"nx\">context</span><span class=\"p\">.</span><span class=\"nx\">name</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;deepred&#39;</span><span class=\"p\">;</span>\n  <span class=\"kr\">await</span> <span class=\"nx\">sleep</span><span class=\"p\">(</span><span class=\"mi\">2000</span><span class=\"p\">);</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;2-end&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">};</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">fn</span> <span class=\"o\">=</span> <span class=\"nx\">compose</span><span class=\"p\">([</span><span class=\"nx\">test1</span><span class=\"p\">,</span> <span class=\"nx\">test2</span><span class=\"p\">]);</span>\n\n<span class=\"nx\">fn</span><span class=\"p\">(</span><span class=\"nx\">context</span><span class=\"p\">).</span><span class=\"nx\">then</span><span class=\"p\">(()</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;end&#39;</span><span class=\"p\">);</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">context</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n</code></pre></div><p>é€’å½’è°ƒç”¨æ ˆçš„æ‰§è¡Œæƒ…å†µï¼š </p><figure data-size=\"normal\"><noscript><img src=\"https://pic2.zhimg.com/v2-06a8d59cfe2de9566712b9268bcfde91_b.gif\" data-size=\"normal\" data-rawwidth=\"312\" data-rawheight=\"466\" data-thumbnail=\"https://pic2.zhimg.com/v2-06a8d59cfe2de9566712b9268bcfde91_b.jpg\" class=\"content_image\" width=\"312\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;312&#39; height=&#39;466&#39;&gt;&lt;/svg&gt;\" data-size=\"normal\" data-rawwidth=\"312\" data-rawheight=\"466\" data-thumbnail=\"https://pic2.zhimg.com/v2-06a8d59cfe2de9566712b9268bcfde91_b.jpg\" class=\"content_image lazy\" width=\"312\" data-actualsrc=\"https://pic2.zhimg.com/v2-06a8d59cfe2de9566712b9268bcfde91_b.gif\"/><figcaption>è°ƒç”¨æ ˆé¡ºåº</figcaption></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>å¼„æ‡‚äº†ä¸­é—´ä»¶æœºåˆ¶ï¼Œæˆ‘ä»¬åº”è¯¥å¯ä»¥å›ç­”ä¹‹å‰çš„é—®é¢˜ï¼š</p><blockquote><code>next</code>åˆ°åº•æ˜¯å•¥ï¼Ÿæ´‹è‘±æ¨¡å‹æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</blockquote><p>nextå°±æ˜¯ä¸€ä¸ªåŒ…è£¹äº†dispatchçš„å‡½æ•°</p><p>åœ¨ç¬¬nä¸ªä¸­é—´ä»¶ä¸­æ‰§è¡Œnextï¼Œå°±æ˜¯æ‰§è¡Œdispatch(n+1)ï¼Œä¹Ÿå°±æ˜¯è¿›å…¥ç¬¬n+1ä¸ªä¸­é—´ä»¶</p><p>å› ä¸ºdispatchè¿”å›çš„éƒ½æ˜¯Promiseï¼Œæ‰€ä»¥åœ¨ç¬¬nä¸ªä¸­é—´ä»¶await next(); è¿›å…¥ç¬¬n+1ä¸ªä¸­é—´ä»¶ã€‚å½“ç¬¬n+1ä¸ªä¸­é—´ä»¶æ‰§è¡Œå®Œæˆåï¼Œå¯ä»¥è¿”å›ç¬¬nä¸ªä¸­é—´ä»¶</p><p>å¦‚æœåœ¨æŸä¸ªä¸­é—´ä»¶ä¸­ä¸å†è°ƒç”¨nextï¼Œé‚£ä¹ˆå®ƒä¹‹åçš„æ‰€æœ‰ä¸­é—´ä»¶éƒ½ä¸ä¼šå†è°ƒç”¨äº†</p><p>ä¿®æ”¹<code>kao/application.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">class</span> <span class=\"nx\">Application</span> <span class=\"p\">{</span>\n  <span class=\"nx\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">middleware</span> <span class=\"o\">=</span> <span class=\"p\">[];</span> <span class=\"c1\">// å­˜å‚¨ä¸­é—´ä»¶\n</span><span class=\"c1\"></span>    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">context</span> <span class=\"o\">=</span> <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"nx\">context</span><span class=\"p\">);</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">request</span> <span class=\"o\">=</span> <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"nx\">request</span><span class=\"p\">);</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">response</span> <span class=\"o\">=</span> <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"nx\">response</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"nx\">fn</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">middleware</span><span class=\"p\">.</span><span class=\"nx\">push</span><span class=\"p\">(</span><span class=\"nx\">fn</span><span class=\"p\">);</span> <span class=\"c1\">// å­˜å‚¨ä¸­é—´ä»¶\n</span><span class=\"c1\"></span>  <span class=\"p\">}</span>\n\n  <span class=\"nx\">compose</span> <span class=\"p\">(</span><span class=\"nx\">middleware</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"nb\">Array</span><span class=\"p\">.</span><span class=\"nx\">isArray</span><span class=\"p\">(</span><span class=\"nx\">middleware</span><span class=\"p\">))</span> <span class=\"k\">throw</span> <span class=\"k\">new</span> <span class=\"nx\">TypeError</span><span class=\"p\">(</span><span class=\"s1\">&#39;Middleware stack must be an array!&#39;</span><span class=\"p\">)</span>\n    <span class=\"k\">for</span> <span class=\"p\">(</span><span class=\"k\">const</span> <span class=\"nx\">fn</span> <span class=\"k\">of</span> <span class=\"nx\">middleware</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"k\">typeof</span> <span class=\"nx\">fn</span> <span class=\"o\">!==</span> <span class=\"s1\">&#39;function&#39;</span><span class=\"p\">)</span> <span class=\"k\">throw</span> <span class=\"k\">new</span> <span class=\"nx\">TypeError</span><span class=\"p\">(</span><span class=\"s1\">&#39;Middleware must be composed of functions!&#39;</span><span class=\"p\">)</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"cm\">/**\n</span><span class=\"cm\">     * @param {Object} context\n</span><span class=\"cm\">     * @return {Promise}\n</span><span class=\"cm\">     * @api public\n</span><span class=\"cm\">     */</span>\n\n    <span class=\"k\">return</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">context</span><span class=\"p\">,</span> <span class=\"nx\">next</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"c1\">// last called middleware #\n</span><span class=\"c1\"></span>      <span class=\"kd\">let</span> <span class=\"nx\">index</span> <span class=\"o\">=</span> <span class=\"o\">-</span><span class=\"mi\">1</span>\n      <span class=\"k\">return</span> <span class=\"nx\">dispatch</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n      <span class=\"kd\">function</span> <span class=\"nx\">dispatch</span> <span class=\"p\">(</span><span class=\"nx\">i</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">i</span> <span class=\"o\">&lt;=</span> <span class=\"nx\">index</span><span class=\"p\">)</span> <span class=\"k\">return</span> <span class=\"nb\">Promise</span><span class=\"p\">.</span><span class=\"nx\">reject</span><span class=\"p\">(</span><span class=\"k\">new</span> <span class=\"nb\">Error</span><span class=\"p\">(</span><span class=\"s1\">&#39;next() called multiple times&#39;</span><span class=\"p\">))</span>\n        <span class=\"nx\">index</span> <span class=\"o\">=</span> <span class=\"nx\">i</span>\n        <span class=\"kd\">let</span> <span class=\"nx\">fn</span> <span class=\"o\">=</span> <span class=\"nx\">middleware</span><span class=\"p\">[</span><span class=\"nx\">i</span><span class=\"p\">]</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">i</span> <span class=\"o\">===</span> <span class=\"nx\">middleware</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">)</span> <span class=\"nx\">fn</span> <span class=\"o\">=</span> <span class=\"nx\">next</span>\n        <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"nx\">fn</span><span class=\"p\">)</span> <span class=\"k\">return</span> <span class=\"nb\">Promise</span><span class=\"p\">.</span><span class=\"nx\">resolve</span><span class=\"p\">()</span>\n        <span class=\"k\">try</span> <span class=\"p\">{</span>\n          <span class=\"k\">return</span> <span class=\"nb\">Promise</span><span class=\"p\">.</span><span class=\"nx\">resolve</span><span class=\"p\">(</span><span class=\"nx\">fn</span><span class=\"p\">(</span><span class=\"nx\">context</span><span class=\"p\">,</span> <span class=\"nx\">dispatch</span><span class=\"p\">.</span><span class=\"nx\">bind</span><span class=\"p\">(</span><span class=\"kc\">null</span><span class=\"p\">,</span> <span class=\"nx\">i</span> <span class=\"o\">+</span> <span class=\"mi\">1</span><span class=\"p\">)));</span>\n        <span class=\"p\">}</span> <span class=\"k\">catch</span> <span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n          <span class=\"k\">return</span> <span class=\"nb\">Promise</span><span class=\"p\">.</span><span class=\"nx\">reject</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">)</span>\n        <span class=\"p\">}</span>\n      <span class=\"p\">}</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n\n\n  <span class=\"nx\">callback</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// åˆæˆæ‰€æœ‰ä¸­é—´ä»¶\n</span><span class=\"c1\"></span>    <span class=\"k\">const</span> <span class=\"nx\">fn</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">compose</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">middleware</span><span class=\"p\">);</span>\n\n    <span class=\"k\">const</span> <span class=\"nx\">handleRequest</span> <span class=\"o\">=</span> <span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n      <span class=\"k\">const</span> <span class=\"nx\">ctx</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">createContext</span><span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">);</span>\n      <span class=\"k\">return</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">handleRequest</span><span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">,</span> <span class=\"nx\">fn</span><span class=\"p\">)</span>\n    <span class=\"p\">};</span>\n\n    <span class=\"k\">return</span> <span class=\"nx\">handleRequest</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">handleRequest</span><span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">,</span> <span class=\"nx\">fnMiddleware</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">const</span> <span class=\"nx\">handleResponse</span> <span class=\"o\">=</span> <span class=\"p\">()</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">respond</span><span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">);</span>\n    <span class=\"c1\">// æ‰§è¡Œä¸­é—´ä»¶å¹¶æŠŠæœ€åçš„ç»“æœäº¤ç»™respond\n</span><span class=\"c1\"></span>    <span class=\"k\">return</span> <span class=\"nx\">fnMiddleware</span><span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">).</span><span class=\"nx\">then</span><span class=\"p\">(</span><span class=\"nx\">handleResponse</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">createContext</span><span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// é’ˆå¯¹æ¯ä¸ªè¯·æ±‚ï¼Œéƒ½è¦åˆ›å»ºctxå¯¹è±¡\n</span><span class=\"c1\"></span>    <span class=\"kd\">let</span> <span class=\"nx\">ctx</span> <span class=\"o\">=</span> <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">context</span><span class=\"p\">);</span>\n    <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">request</span> <span class=\"o\">=</span> <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">request</span><span class=\"p\">);</span>\n    <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">response</span> <span class=\"o\">=</span> <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">response</span><span class=\"p\">);</span>\n    <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">req</span> <span class=\"o\">=</span> <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">request</span><span class=\"p\">.</span><span class=\"nx\">req</span> <span class=\"o\">=</span> <span class=\"nx\">req</span><span class=\"p\">;</span>\n    <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">res</span> <span class=\"o\">=</span> <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">response</span><span class=\"p\">.</span><span class=\"nx\">res</span> <span class=\"o\">=</span> <span class=\"nx\">res</span><span class=\"p\">;</span>\n    <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">request</span><span class=\"p\">.</span><span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">response</span><span class=\"p\">.</span><span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"p\">;</span>\n    <span class=\"k\">return</span> <span class=\"nx\">ctx</span><span class=\"p\">;</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"nx\">listen</span><span class=\"p\">(...</span><span class=\"nx\">args</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">const</span> <span class=\"nx\">server</span> <span class=\"o\">=</span> <span class=\"nx\">http</span><span class=\"p\">.</span><span class=\"nx\">createServer</span><span class=\"p\">(</span><span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">callback</span><span class=\"p\">());</span>\n    <span class=\"k\">return</span> <span class=\"nx\">server</span><span class=\"p\">.</span><span class=\"nx\">listen</span><span class=\"p\">(...</span><span class=\"nx\">args</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"nx\">Application</span><span class=\"p\">;</span>\n\n<span class=\"kd\">function</span> <span class=\"nx\">respond</span><span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"kd\">let</span> <span class=\"nx\">content</span> <span class=\"o\">=</span> <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">body</span><span class=\"p\">;</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"k\">typeof</span> <span class=\"nx\">content</span> <span class=\"o\">===</span> <span class=\"s1\">&#39;string&#39;</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">end</span><span class=\"p\">(</span><span class=\"nx\">content</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n  <span class=\"k\">else</span> <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"k\">typeof</span> <span class=\"nx\">content</span> <span class=\"o\">===</span> <span class=\"s1\">&#39;object&#39;</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">end</span><span class=\"p\">(</span><span class=\"nx\">JSON</span><span class=\"p\">.</span><span class=\"nx\">stringify</span><span class=\"p\">(</span><span class=\"nx\">content</span><span class=\"p\">));</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>æµ‹è¯•ä¸€ä¸‹</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">Kao</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;./application&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Kao</span><span class=\"p\">();</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"kr\">async</span> <span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">,</span> <span class=\"nx\">next</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;1-start&#39;</span><span class=\"p\">);</span>\n  <span class=\"kr\">await</span> <span class=\"nx\">next</span><span class=\"p\">();</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;1-end&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">})</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"kr\">async</span> <span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;2-start&#39;</span><span class=\"p\">);</span>\n  <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">body</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;hello tc&#39;</span><span class=\"p\">;</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;2-end&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">listen</span><span class=\"p\">(</span><span class=\"mi\">3001</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;server start at 3001&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n\n<span class=\"c1\">// 1-start 2-start 2-end 1-end\n</span></code></pre></div><h3>é”™è¯¯å¤„ç†æœºåˆ¶</h3><p>å‚è€ƒä»£ç : <a href=\"https://link.zhihu.com/?target=https%3A//github.com/deepred5/learn-koa2/tree/master/step-4\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">step-4</a></p><p>å› ä¸º<code>compose</code>ç»„åˆä¹‹åçš„å‡½æ•°è¿”å›çš„ä»ç„¶æ˜¯Promiseå¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨<code>catch</code>æ•è·å¼‚å¸¸</p><p><code>kao/application.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"nx\">handleRequest</span><span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">,</span> <span class=\"nx\">fnMiddleware</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">const</span> <span class=\"nx\">handleResponse</span> <span class=\"o\">=</span> <span class=\"p\">()</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">respond</span><span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">);</span>\n  <span class=\"k\">const</span> <span class=\"nx\">onerror</span> <span class=\"o\">=</span> <span class=\"nx\">err</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">onerror</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">);</span>\n  <span class=\"c1\">// catchæ•è·ï¼Œè§¦å‘ctxçš„onerroræ–¹æ³•\n</span><span class=\"c1\"></span>  <span class=\"k\">return</span> <span class=\"nx\">fnMiddleware</span><span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">).</span><span class=\"nx\">then</span><span class=\"p\">(</span><span class=\"nx\">handleResponse</span><span class=\"p\">).</span><span class=\"k\">catch</span><span class=\"p\">(</span><span class=\"nx\">onerror</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div><p><code>kao/context.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">proto</span> <span class=\"o\">=</span> <span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"c1\">// contextè‡ªèº«çš„æ–¹æ³•\n</span><span class=\"c1\"></span>  <span class=\"nx\">onerror</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// ä¸­é—´ä»¶æŠ¥é”™æ•è·\n</span><span class=\"c1\"></span>    <span class=\"k\">const</span> <span class=\"p\">{</span> <span class=\"nx\">res</span> <span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"p\">;</span>\n\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"s1\">&#39;ENOENT&#39;</span> <span class=\"o\">==</span> <span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">code</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">status</span> <span class=\"o\">=</span> <span class=\"mi\">404</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n      <span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">status</span> <span class=\"o\">=</span> <span class=\"mi\">500</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">status</span> <span class=\"o\">=</span> <span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">status</span><span class=\"p\">;</span>\n    <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">end</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">message</span> <span class=\"o\">||</span> <span class=\"s1\">&#39;Internal error&#39;</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"k\">const</span> <span class=\"nx\">Kao</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;./application&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Kao</span><span class=\"p\">();</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"kr\">async</span> <span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"c1\">// æŠ¥é”™å¯ä»¥æ•è·\n</span><span class=\"c1\"></span>  <span class=\"nx\">a</span><span class=\"p\">.</span><span class=\"nx\">b</span><span class=\"p\">.</span><span class=\"nx\">c</span> <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n  <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">body</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;hello tc&#39;</span><span class=\"p\">;</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">listen</span><span class=\"p\">(</span><span class=\"mi\">3001</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;server start at 3001&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n</code></pre></div><p>ç°åœ¨æˆ‘ä»¬å·²ç»å®ç°äº†ä¸­é—´ä»¶çš„é”™è¯¯å¼‚å¸¸æ•è·ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜ç¼ºå°‘æ¡†æ¶å±‚å‘ç”Ÿé”™è¯¯çš„æ•è·æœºåˆ¶ã€‚æˆ‘ä»¬å¯ä»¥è®©<code>Application</code>ç»§æ‰¿åŸç”Ÿçš„<code>Emitter</code>ï¼Œä»è€Œå®ç°<code>error</code>ç›‘å¬</p><p><code>kao/application.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">Emitter</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;events&#39;</span><span class=\"p\">);</span>\n\n<span class=\"c1\">// ç»§æ‰¿Emitter\n</span><span class=\"c1\"></span><span class=\"k\">class</span> <span class=\"nx\">Application</span> <span class=\"k\">extends</span> <span class=\"nx\">Emitter</span> <span class=\"p\">{</span>\n  <span class=\"nx\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// è°ƒç”¨super\n</span><span class=\"c1\"></span>    <span class=\"k\">super</span><span class=\"p\">();</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">middleware</span> <span class=\"o\">=</span> <span class=\"p\">[];</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">context</span> <span class=\"o\">=</span> <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"nx\">context</span><span class=\"p\">);</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">request</span> <span class=\"o\">=</span> <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"nx\">request</span><span class=\"p\">);</span>\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">response</span> <span class=\"o\">=</span> <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">create</span><span class=\"p\">(</span><span class=\"nx\">response</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div><p><code>kao/context.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">proto</span> <span class=\"o\">=</span> <span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"nx\">onerror</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">const</span> <span class=\"p\">{</span> <span class=\"nx\">res</span> <span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"p\">;</span>\n\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"s1\">&#39;ENOENT&#39;</span> <span class=\"o\">==</span> <span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">code</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">status</span> <span class=\"o\">=</span> <span class=\"mi\">404</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n      <span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">status</span> <span class=\"o\">=</span> <span class=\"mi\">500</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">status</span> <span class=\"o\">=</span> <span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">status</span><span class=\"p\">;</span>\n\n    <span class=\"c1\">// è§¦å‘erroräº‹ä»¶\n</span><span class=\"c1\"></span>    <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">emit</span><span class=\"p\">(</span><span class=\"s1\">&#39;error&#39;</span><span class=\"p\">,</span> <span class=\"nx\">err</span><span class=\"p\">,</span> <span class=\"k\">this</span><span class=\"p\">);</span>\n\n    <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">end</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">message</span> <span class=\"o\">||</span> <span class=\"s1\">&#39;Internal error&#39;</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"k\">const</span> <span class=\"nx\">Kao</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;./application&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Kao</span><span class=\"p\">();</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"kr\">async</span> <span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"c1\">// æŠ¥é”™å¯ä»¥æ•è·\n</span><span class=\"c1\"></span>  <span class=\"nx\">a</span><span class=\"p\">.</span><span class=\"nx\">b</span><span class=\"p\">.</span><span class=\"nx\">c</span> <span class=\"o\">=</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n  <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">body</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;hello tc&#39;</span><span class=\"p\">;</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">listen</span><span class=\"p\">(</span><span class=\"mi\">3001</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;server start at 3001&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n\n<span class=\"c1\">// ç›‘å¬erroräº‹ä»¶\n</span><span class=\"c1\"></span><span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"s1\">&#39;error&#39;</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">stack</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n</code></pre></div><p>è‡³æ­¤æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°Koaå¼‚å¸¸æ•è·çš„ä¸¤ç§æ–¹å¼ï¼š </p><ul><li><i>ä¸­é—´ä»¶æ•è·(Promise catch) </i> </li><li>æ¡†æ¶æ•è·(Emitter error)</li></ul><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"c1\">// æ•è·å…¨å±€å¼‚å¸¸çš„ä¸­é—´ä»¶\n</span><span class=\"c1\"></span><span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"kr\">async</span> <span class=\"p\">(</span><span class=\"nx\">ctx</span><span class=\"p\">,</span> <span class=\"nx\">next</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"k\">try</span> <span class=\"p\">{</span>\n    <span class=\"kr\">await</span> <span class=\"nx\">next</span><span class=\"p\">()</span>\n  <span class=\"p\">}</span> <span class=\"k\">catch</span> <span class=\"p\">(</span><span class=\"nx\">error</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">body</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;error&#39;</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n<span class=\"p\">)</span>\n<span class=\"c1\">// äº‹ä»¶ç›‘å¬\n</span><span class=\"c1\"></span><span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">on</span><span class=\"p\">(</span><span class=\"s1\">&#39;error&#39;</span><span class=\"p\">,</span> <span class=\"nx\">err</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;error happends: &#39;</span><span class=\"p\">,</span> <span class=\"nx\">err</span><span class=\"p\">.</span><span class=\"nx\">stack</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n</code></pre></div><h3>æ€»ç»“</h3><p>Koaæ•´ä¸ªæµç¨‹å¯ä»¥åˆ†æˆä¸‰æ­¥:</p><p><b>åˆå§‹åŒ–é˜¶æ®µ:</b></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">Koa</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;koa&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Koa</span><span class=\"p\">();</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"kr\">async</span> <span class=\"nx\">ctx</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">ctx</span><span class=\"p\">.</span><span class=\"nx\">body</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;Hello World&#39;</span><span class=\"p\">;</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">listen</span><span class=\"p\">(</span><span class=\"mi\">3000</span><span class=\"p\">);</span>\n</code></pre></div><p><code>new</code>åˆå§‹åŒ–ä¸€ä¸ªå®ä¾‹ï¼Œ<code>use</code>æœé›†ä¸­é—´ä»¶åˆ°middlewareæ•°ç»„ï¼Œ<code>listen</code> åˆæˆä¸­é—´ä»¶<code>fnMiddleware</code>ï¼Œè¿”å›ä¸€ä¸ªcallbackå‡½æ•°ç»™<code>http.createServer</code>ï¼Œå¼€å¯æœåŠ¡å™¨ï¼Œç­‰å¾…httpè¯·æ±‚ã€‚</p><p><b>è¯·æ±‚é˜¶æ®µ:</b></p><p>æ¯æ¬¡è¯·æ±‚ï¼Œ<code>createContext</code>ç”Ÿæˆä¸€ä¸ªæ–°çš„<code>ctx</code>ï¼Œä¼ ç»™<code>fnMiddleware</code>ï¼Œè§¦å‘ä¸­é—´ä»¶çš„æ•´ä¸ªæµç¨‹</p><p><b>å“åº”é˜¶æ®µ:</b></p><p>æ•´ä¸ªä¸­é—´ä»¶å®Œæˆåï¼Œè°ƒç”¨<code>respond</code>æ–¹æ³•ï¼Œå¯¹è¯·æ±‚åšæœ€åçš„å¤„ç†ï¼Œè¿”å›å“åº”ç»™å®¢æˆ·ç«¯ã€‚</p><p>å‚è€ƒä¸‹é¢çš„æµç¨‹å›¾: </p><figure data-size=\"normal\"><noscript><img src=\"https://pic2.zhimg.com/v2-c386db23fa78521f0570e90efca1ed51_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1106\" data-rawheight=\"712\" class=\"origin_image zh-lightbox-thumb\" width=\"1106\" data-original=\"https://pic2.zhimg.com/v2-c386db23fa78521f0570e90efca1ed51_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;1106&#39; height=&#39;712&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1106\" data-rawheight=\"712\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1106\" data-original=\"https://pic2.zhimg.com/v2-c386db23fa78521f0570e90efca1ed51_r.jpg\" data-actualsrc=\"https://pic2.zhimg.com/v2-c386db23fa78521f0570e90efca1ed51_b.jpg\"/></figure><p></p>", 
            "topic": [
                {
                    "tag": "Node.js", 
                    "tagLink": "https://api.zhihu.com/topics/19569535"
                }, 
                {
                    "tag": "koa2", 
                    "tagLink": "https://api.zhihu.com/topics/20219631"
                }
            ], 
            "comments": [
                {
                    "userName": "çŸ¥ä¹ç”¨æˆ·", 
                    "userLink": "https://www.zhihu.com/people/0", 
                    "content": "<p>æ„Ÿè°¢~æ˜¯æˆ‘çœ‹åˆ°çš„è§£ækoaæœ€å¥½çš„æ–‡ç« äº†</p>", 
                    "likes": 1, 
                    "childComments": []
                }
            ]
        }, 
        {
            "url": "https://zhuanlan.zhihu.com/p/68136798", 
            "userName": "æ·±çº¢", 
            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
            "upvote": 6, 
            "title": "å‚»å‚»åˆ†ä¸æ¸…çš„Manifest", 
            "content": "<p>åœ¨å‰ç«¯ï¼Œè¯´åˆ°<code>manifest</code>ï¼Œå…¶å®æ˜¯æœ‰æ­§ä¹‰çš„ï¼Œå°±æˆ‘äº†è§£çš„æƒ…å†µæ¥è¯´ï¼Œ<code>manifest</code>å¯ä»¥æŒ‡ä»£ä¸‹åˆ—å«ä¹‰ï¼š</p><ol><li><code>html</code>æ ‡ç­¾çš„<code>manifest</code>å±æ€§: <a href=\"https://link.zhihu.com/?target=https%3A//developer.mozilla.org/zh-CN/docs/Web/HTML/Using_the_application_cache\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">ç¦»çº¿ç¼“å­˜</a>ï¼ˆç›®å‰å·²è¢«åºŸå¼ƒï¼‰</li><li><a href=\"https://link.zhihu.com/?target=https%3A//developer.mozilla.org/zh-CN/docs/Web/Manifest\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">PWA</a>: å°†Webåº”ç”¨ç¨‹åºå®‰è£…åˆ°è®¾å¤‡çš„ä¸»å±å¹•</li><li>webpackä¸­<a href=\"https://link.zhihu.com/?target=https%3A//www.npmjs.com/package/webpack-manifest-plugin\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">webpack-manifest-plugin</a>æ’ä»¶æ‰“åŒ…å‡ºæ¥çš„<code>manifest.json</code>æ–‡ä»¶ï¼Œç”¨æ¥ç”Ÿæˆä¸€ä»½èµ„æºæ¸…å•ï¼Œä¸ºåç«¯æ¸²æŸ“æœåŠ¡ </li><li>webpackä¸­<a href=\"https://link.zhihu.com/?target=https%3A//webpack.js.org/plugins/dll-plugin/%23root\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">DLL</a>æ‰“åŒ…æ—¶,è¾“å‡ºçš„<code>manifest.json</code>æ–‡ä»¶ï¼Œç”¨æ¥åˆ†æå·²ç»æ‰“åŒ…è¿‡çš„æ–‡ä»¶ï¼Œä¼˜åŒ–æ‰“åŒ…é€Ÿåº¦å’Œå¤§å°</li></ol><p>ä¸‹é¢æˆ‘ä»¬æ¥ä¸€ä¸€ä»‹ç»ä¸‹ </p><h3>htmlå±æ€§</h3><div class=\"highlight\"><pre><code class=\"language-html\"><span class=\"cp\">&lt;!DOCTYPE html&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">html</span> <span class=\"na\">lang</span><span class=\"o\">=</span><span class=\"s\">&#34;en&#34;</span> <span class=\"na\">manifest</span><span class=\"o\">=</span><span class=\"s\">&#34;/tc.mymanifest&#34;</span><span class=\"p\">&gt;</span>\n\n<span class=\"p\">&lt;</span><span class=\"nt\">head</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">meta</span> <span class=\"na\">charset</span><span class=\"o\">=</span><span class=\"s\">&#34;UTF-8&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">meta</span> <span class=\"na\">name</span><span class=\"o\">=</span><span class=\"s\">&#34;viewport&#34;</span> <span class=\"na\">content</span><span class=\"o\">=</span><span class=\"s\">&#34;width=device-width, initial-scale=1.0&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">meta</span> <span class=\"na\">http-equiv</span><span class=\"o\">=</span><span class=\"s\">&#34;X-UA-Compatible&#34;</span> <span class=\"na\">content</span><span class=\"o\">=</span><span class=\"s\">&#34;ie=edge&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">title</span><span class=\"p\">&gt;</span>Document<span class=\"p\">&lt;/</span><span class=\"nt\">title</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">link</span> <span class=\"na\">rel</span><span class=\"o\">=</span><span class=\"s\">&#34;stylesheet&#34;</span> <span class=\"na\">href</span><span class=\"o\">=</span><span class=\"s\">&#34;/theme.css&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">script</span> <span class=\"na\">src</span><span class=\"o\">=</span><span class=\"s\">&#34;/main.js&#34;</span><span class=\"p\">&gt;&lt;/</span><span class=\"nt\">script</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">script</span> <span class=\"na\">src</span><span class=\"o\">=</span><span class=\"s\">&#34;/main2.js&#34;</span><span class=\"p\">&gt;&lt;/</span><span class=\"nt\">script</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;/</span><span class=\"nt\">head</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">body</span><span class=\"p\">&gt;</span>\n\n<span class=\"p\">&lt;/</span><span class=\"nt\">body</span><span class=\"p\">&gt;</span>\n\n<span class=\"p\">&lt;/</span><span class=\"nt\">html</span><span class=\"p\">&gt;</span></code></pre></div><p>æµè§ˆå™¨è§£æè¿™æ®µhtmlæ ‡ç­¾æ—¶ï¼Œå°±ä¼šå»è®¿é—®<code>tc.mymanifest</code>è¿™ä¸ªæ–‡ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ªç¼“å­˜æ¸…å•æ–‡ä»¶</p><p><code>tc.mymanifest</code></p><div class=\"highlight\"><pre><code class=\"language-text\"># v1 è¿™æ˜¯æ³¨é‡Š\nCACHE MANIFEST\n/theme.css\n/main.js\n\nNETWORK:\n*\n\nFALLBACK:\n/html5/ /404.html</code></pre></div><p><code>CACHE MANIFEST</code>æŒ‡å®šéœ€è¦ç¼“å­˜çš„æ–‡ä»¶ï¼Œç¬¬ä¸€æ¬¡ä¸‹è½½å®Œæˆä»¥åï¼Œæ–‡ä»¶éƒ½ä¸ä¼šå†ä»ç½‘ç»œè¯·æ±‚äº†ï¼Œå³ä½¿ç”¨æˆ·ä¸æ˜¯ç¦»çº¿çŠ¶æ€ï¼Œé™¤é<code>tc.mymanifest</code>æ›´æ–°äº†ï¼Œç¼“å­˜æ¸…å•æ›´æ–°ä¹‹åï¼Œæ‰ä¼šå†æ¬¡ä¸‹è½½ã€‚æ ‡è®°äº†manifestçš„htmlæœ¬èº«ä¹Ÿè¢«ç¼“å­˜</p><p><code>NETWORK</code>æŒ‡å®šéç¼“å­˜æ–‡ä»¶ï¼Œæ‰€æœ‰ç±»ä¼¼èµ„æºçš„è¯·æ±‚éƒ½ä¼šç»•è¿‡ç¼“å­˜ï¼Œå³ä½¿ç”¨æˆ·å¤„äºç¦»çº¿çŠ¶æ€ï¼Œä¹Ÿä¸ä¼šè¯»ç¼“å­˜</p><p><code>FALLBACK</code>æŒ‡å®šäº†ä¸€ä¸ªåå¤‡é¡µé¢ï¼Œå½“èµ„æºæ— æ³•è®¿é—®æ—¶ï¼Œæµè§ˆå™¨ä¼šä½¿ç”¨è¯¥é¡µé¢ã€‚ æ¯”å¦‚ç¦»çº¿è®¿é—®/html5/ç›®å½•æ—¶ï¼Œå°±ä¼šç”¨æœ¬åœ°çš„/404.htmlé¡µé¢</p><p>ç¼“å­˜æ¸…å•å¯ä»¥æ˜¯ä»»æ„åç¼€åï¼Œä¸è¿‡å¿…é¡»æŒ‡å®š<code>content-type</code>å±æ€§ä¸º<code>text/cache-manifest</code></p><p>é‚£å¦‚ä½•æ›´æ–°ç¼“å­˜ï¼Ÿä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š</p><ul><li>ç”¨æˆ·æ¸…ç©ºæµè§ˆå™¨ç¼“å­˜</li><li>manifest æ–‡ä»¶è¢«ä¿®æ”¹(å³ä½¿æ³¨é‡Šè¢«ä¿®æ”¹)</li><li>ç”±ç¨‹åºæ¥æ›´æ–°åº”ç”¨ç¼“å­˜</li></ul><p>éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼šç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®è¯¥ç½‘é¡µï¼Œç¼“å­˜æ–‡ä»¶ä¹‹åï¼Œç¬¬äºŒæ¬¡è¿›å…¥è¯¥é¡µé¢ï¼Œå‘ç°<code>tc.mymanifest</code>ç¼“å­˜æ¸…å•æ›´æ–°äº†ï¼Œäºæ˜¯ä¼šé‡æ–°ä¸‹è½½ç¼“å­˜æ–‡ä»¶ï¼Œä½†æ˜¯ï¼Œ<b>ç¬¬äºŒæ¬¡è¿›å…¥æ˜¾ç¤ºçš„é¡µé¢ä»ç„¶æ‰§è¡Œçš„æ˜¯æ—§æ–‡ä»¶ï¼Œä¸‹è½½çš„æ–°æ–‡ä»¶ï¼Œåªä¼šåœ¨ç¬¬ä¸‰æ¬¡è¿›å…¥è¯¥é¡µé¢åæ‰§è¡Œï¼ï¼ï¼</b></p><p>å¦‚æœå¸Œæœ›ç”¨æˆ·ç«‹å³çœ‹åˆ°æ–°å†…å®¹ï¼Œéœ€è¦jsç›‘å¬æ›´æ–°äº‹ä»¶ï¼Œé‡æ–°åŠ è½½é¡µé¢</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"nb\">window</span><span class=\"p\">.</span><span class=\"nx\">addEventListener</span><span class=\"p\">(</span><span class=\"s1\">&#39;load&#39;</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n\n  <span class=\"nb\">window</span><span class=\"p\">.</span><span class=\"nx\">applicationCache</span><span class=\"p\">.</span><span class=\"nx\">addEventListener</span><span class=\"p\">(</span><span class=\"s1\">&#39;updateready&#39;</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">e</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nb\">window</span><span class=\"p\">.</span><span class=\"nx\">applicationCache</span><span class=\"p\">.</span><span class=\"nx\">status</span> <span class=\"o\">==</span> <span class=\"nb\">window</span><span class=\"p\">.</span><span class=\"nx\">applicationCache</span><span class=\"p\">.</span><span class=\"nx\">UPDATEREADY</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"c1\">// æ›´æ–°ç¼“å­˜\n</span><span class=\"c1\"></span>      <span class=\"c1\">// é‡æ–°åŠ è½½\n</span><span class=\"c1\"></span>      <span class=\"nb\">window</span><span class=\"p\">.</span><span class=\"nx\">applicationCache</span><span class=\"p\">.</span><span class=\"nx\">swapCache</span><span class=\"p\">();</span>\n      <span class=\"nb\">window</span><span class=\"p\">.</span><span class=\"nx\">location</span><span class=\"p\">.</span><span class=\"nx\">reload</span><span class=\"p\">();</span>\n\n    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n\n    <span class=\"p\">}</span>\n\n  <span class=\"p\">},</span> <span class=\"kc\">false</span><span class=\"p\">);</span>\n\n<span class=\"p\">},</span> <span class=\"kc\">false</span><span class=\"p\">);</span>\n</code></pre></div><p>å»ºè®®å¯¹<code>tc.mymanifest</code>ç¼“å­˜æ¸…å•è®¾ç½®æ°¸ä¸ç¼“å­˜</p><p>ä¸è¿‡ï¼Œmanifestä¹Ÿæœ‰å¾ˆå¤š<a href=\"https://www.zhihu.com/question/29876535\" class=\"internal\">ç¼ºç‚¹</a>ï¼Œæ¯”å¦‚éœ€è¦æ‰‹åŠ¨ä¸€ä¸ªä¸ªå¡«å†™ç¼“å­˜çš„æ–‡ä»¶ï¼Œæ›´æ–°æ–‡ä»¶ä¹‹åéœ€è¦äºŒæ¬¡åˆ·æ–°ï¼Œå¦‚æœæ›´æ–°çš„èµ„æºä¸­æœ‰ä¸€ä¸ªèµ„æºæ›´æ–°å¤±è´¥äº†ï¼Œå°†å¯¼è‡´å…¨éƒ¨æ›´æ–°å¤±è´¥ï¼Œå°†ç”¨å›ä¸Šä¸€ç‰ˆæœ¬çš„ç¼“å­˜</p><p>HTML5è§„èŒƒä¹ŸåºŸå¼ƒäº†è¿™ä¸ªå±æ€§ï¼Œå› æ­¤ä¸å»ºè®®ä½¿ç”¨</p><h3>PWA</h3><p>ä¸ºäº†å®ç°PWAåº”ç”¨æ·»åŠ è‡³æ¡Œé¢çš„åŠŸèƒ½ï¼Œé™¤äº†è¦æ±‚ç«™ç‚¹æ”¯æŒHTTPSä¹‹å¤–ï¼Œè¿˜éœ€è¦å‡†å¤‡ <code>manifest.json</code>æ–‡ä»¶å»é…ç½®åº”ç”¨çš„å›¾æ ‡ã€åç§°ç­‰ä¿¡æ¯</p><div class=\"highlight\"><pre><code class=\"language-html\"><span class=\"p\">&lt;</span><span class=\"nt\">link</span> <span class=\"na\">rel</span><span class=\"o\">=</span><span class=\"s\">&#34;manifest&#34;</span> <span class=\"na\">href</span><span class=\"o\">=</span><span class=\"s\">&#34;/manifest.json&#34;</span><span class=\"p\">&gt;</span>\n</code></pre></div><p><i>manifest.json</i></p><div class=\"highlight\"><pre><code class=\"language-text\">{ \n&#34;name&#34; : &#34;Minimal PWA&#34; , \n&#34;short_name&#34; : &#34;PWA Demo&#34; , \n&#34;display&#34; : &#34;standalone&#34; , \n&#34;start_url&#34; : &#34;/&#34; , \n&#34;theme_color&#34; : &#34;#313131&#34; , \n&#34;background_color&#34; : &#34;#313131&#34; , \n&#34;icons&#34; : [ \n  {\n    &#34;src&#34;: &#34;images/touch/homescreen48.png&#34;,\n    &#34;sizes&#34;: &#34;48x48&#34;,\n    &#34;type&#34;: &#34;image/png&#34;\n  }\n ] \n}</code></pre></div><p>é€šè¿‡ä¸€ç³»åˆ—é…ç½®ï¼Œå°±å¯ä»¥æŠŠä¸€ä¸ªPWAåƒAPPä¸€æ ·ï¼Œæ·»åŠ ä¸€ä¸ªå›¾æ ‡åˆ°æ‰‹æœºå±å¹•ä¸Šï¼Œç‚¹å‡»å›¾æ ‡å³å¯æ‰“å¼€ç«™ç‚¹</p><h3>åŸºäºwebpackçš„reactå¼€å‘ç¯å¢ƒ</h3><p>æœ¬æ–‡é»˜è®¤ä½ å·²ç»äº†è§£æœ€åŸºæœ¬çš„webpacké…ç½®ï¼Œå¦‚æœå®Œå…¨ä¸ä¼šï¼Œå»ºè®®çœ‹ä¸‹è¿™ç¯‡<a href=\"https://link.zhihu.com/?target=http%3A//anata.me/2018/01/08/%25E4%25BB%258E%25E9%259B%25B6%25E5%25BC%2580%25E5%25A7%258B%25E6%2590%25AD%25E5%25BB%25BA%25E4%25B8%2580%25E4%25B8%25AA%25E7%25AE%2580%25E5%258D%2595%25E7%259A%2584%25E5%259F%25BA%25E4%25BA%258Ewebpack%25E7%259A%2584vue%25E5%25BC%2580%25E5%258F%2591%25E7%258E%25AF%25E5%25A2%2583/\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">æ–‡ç« </a></p><p>æˆ‘ä»¬é¦–å…ˆæ­å»ºä¸€ä¸ªæœ€ç®€å•çš„åŸºäºwebpackçš„reactå¼€å‘ç¯å¢ƒ</p><p><b>æºä»£ç åœ°å€</b>ï¼š<a href=\"https://link.zhihu.com/?target=https%3A//github.com/deepred5/learn-dll\" class=\" external\" target=\"_blank\" rel=\"nofollow noreferrer\"><span class=\"invisible\">https://</span><span class=\"visible\">github.com/deepred5/lea</span><span class=\"invisible\">rn-dll</span><span class=\"ellipsis\"></span></a></p><div class=\"highlight\"><pre><code class=\"language-bash\">mkdir learn-dll\n<span class=\"nb\">cd</span> learn-dll</code></pre></div><p>å®‰è£…ä¾èµ–</p><div class=\"highlight\"><pre><code class=\"language-bash\">npm init -y\nnpm install @babel/polyfill react react-dom --save\nnpm install webpack webpack-cli webpack-dev-server @babel/core @babel/preset-env @babel/preset-react add-asset-html-webpack-plugin autoprefixer babel-loader clean-webpack-plugin css-loader html-webpack-plugin mini-css-extract-plugin node-sass postcss-loader sass-loader style-loader --save-dev</code></pre></div><p>æ–°å»º<code>.bablerc</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"p\">{</span>\n  <span class=\"s2\">&#34;presets&#34;</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n    <span class=\"p\">[</span>\n      <span class=\"s2\">&#34;@babel/preset-env&#34;</span><span class=\"p\">,</span>\n      <span class=\"p\">{</span>\n        <span class=\"s2\">&#34;useBuiltIns&#34;</span><span class=\"o\">:</span> <span class=\"s2\">&#34;usage&#34;</span><span class=\"p\">,</span> <span class=\"c1\">// æ ¹æ®browsersliså¡«å†™çš„æµè§ˆå™¨ï¼Œè‡ªåŠ¨æ·»åŠ polyfill\n</span><span class=\"c1\"></span>        <span class=\"s2\">&#34;corejs&#34;</span><span class=\"o\">:</span> <span class=\"mi\">2</span><span class=\"p\">,</span>\n      <span class=\"p\">}</span>\n    <span class=\"p\">],</span>\n    <span class=\"s2\">&#34;@babel/preset-react&#34;</span> <span class=\"c1\">// ç¼–è¯‘react\n</span><span class=\"c1\"></span>  <span class=\"p\">],</span>\n  <span class=\"s2\">&#34;plugins&#34;</span><span class=\"o\">:</span> <span class=\"p\">[]</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>æ–°å»º<code>postcss.config.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"nx\">plugins</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n    <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;autoprefixer&#39;</span><span class=\"p\">)</span> <span class=\"c1\">// æ ¹æ®browsersliså¡«å†™çš„æµè§ˆå™¨ï¼Œè‡ªåŠ¨æ·»åŠ csså‰ç¼€\n</span><span class=\"c1\"></span>  <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>æ–°å»º<code>.browserslistrc</code></p><div class=\"highlight\"><pre><code class=\"language-text\">last 10 versions\nie &gt;= 11\nios &gt;= 9\nandroid &gt;= 6</code></pre></div><p>æ–°å»º<code>webpack.dev.js</code>(åŸºæœ¬é…ç½®ä¸å†è¯¦ç»†ä»‹ç»)</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">path</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;path&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">HtmlWebpackPlugin</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;html-webpack-plugin&#39;</span><span class=\"p\">);</span>\n\n<span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"nx\">mode</span><span class=\"o\">:</span> <span class=\"s1\">&#39;development&#39;</span><span class=\"p\">,</span>\n  <span class=\"nx\">devtool</span><span class=\"o\">:</span> <span class=\"s1\">&#39;cheap-module-eval-source-map&#39;</span><span class=\"p\">,</span>\n  <span class=\"nx\">entry</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">main</span><span class=\"o\">:</span> <span class=\"s1\">&#39;./src/index.js&#39;</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">output</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">path</span><span class=\"o\">:</span> <span class=\"nx\">path</span><span class=\"p\">.</span><span class=\"nx\">resolve</span><span class=\"p\">(</span><span class=\"nx\">__dirname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;./dist&#39;</span><span class=\"p\">),</span>\n    <span class=\"nx\">filename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name].js&#39;</span><span class=\"p\">,</span>\n    <span class=\"nx\">chunkFilename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name].chunk.js&#39;</span><span class=\"p\">,</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">devServer</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">historyApiFallback</span><span class=\"o\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n    <span class=\"nx\">overlay</span><span class=\"o\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n    <span class=\"nx\">port</span><span class=\"o\">:</span> <span class=\"mi\">9001</span><span class=\"p\">,</span>\n    <span class=\"nx\">open</span><span class=\"o\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n    <span class=\"nx\">hot</span><span class=\"o\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">module</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">rules</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n      <span class=\"p\">{</span>\n        <span class=\"nx\">test</span><span class=\"o\">:</span> <span class=\"sr\">/\\.js$/</span><span class=\"p\">,</span>\n        <span class=\"nx\">exclude</span><span class=\"o\">:</span> <span class=\"sr\">/node_modules/</span><span class=\"p\">,</span>\n        <span class=\"nx\">loader</span><span class=\"o\">:</span> <span class=\"s2\">&#34;babel-loader&#34;</span>\n      <span class=\"p\">},</span>\n      <span class=\"p\">{</span>\n        <span class=\"nx\">test</span><span class=\"o\">:</span> <span class=\"sr\">/\\.css$/</span><span class=\"p\">,</span>\n        <span class=\"nx\">use</span><span class=\"o\">:</span> <span class=\"p\">[</span><span class=\"s1\">&#39;style-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"s1\">&#39;css-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"s1\">&#39;postcss-loader&#39;</span>\n        <span class=\"p\">],</span>\n      <span class=\"p\">},</span>\n      <span class=\"p\">{</span>\n        <span class=\"nx\">test</span><span class=\"o\">:</span> <span class=\"sr\">/\\.scss$/</span><span class=\"p\">,</span>\n        <span class=\"nx\">use</span><span class=\"o\">:</span> <span class=\"p\">[</span><span class=\"s1\">&#39;style-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"p\">{</span>\n            <span class=\"nx\">loader</span><span class=\"o\">:</span> <span class=\"s1\">&#39;css-loader&#39;</span><span class=\"p\">,</span>\n            <span class=\"nx\">options</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n              <span class=\"nx\">modules</span><span class=\"o\">:</span> <span class=\"kc\">false</span><span class=\"p\">,</span>\n              <span class=\"nx\">importLoaders</span><span class=\"o\">:</span> <span class=\"mi\">2</span>\n            <span class=\"p\">}</span>\n          <span class=\"p\">},</span>\n          <span class=\"s1\">&#39;sass-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"s1\">&#39;postcss-loader&#39;</span>\n        <span class=\"p\">],</span>\n      <span class=\"p\">},</span>\n    <span class=\"p\">]</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">plugins</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n    <span class=\"k\">new</span> <span class=\"nx\">HtmlWebpackPlugin</span><span class=\"p\">({</span> <span class=\"nx\">template</span><span class=\"o\">:</span> <span class=\"s1\">&#39;./src/index.html&#39;</span> <span class=\"p\">}),</span> <span class=\"c1\">// indexæ‰“åŒ…æ¨¡æ¿\n</span><span class=\"c1\"></span>  <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>æ–°å»º<code>src</code>ç›®å½•ï¼Œå¹¶æ–°å»º<code>src/index.html</code></p><div class=\"highlight\"><pre><code class=\"language-html\"><span class=\"cp\">&lt;!DOCTYPE html&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">html</span> <span class=\"na\">lang</span><span class=\"o\">=</span><span class=\"s\">&#34;en&#34;</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">head</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">meta</span> <span class=\"na\">charset</span><span class=\"o\">=</span><span class=\"s\">&#34;UTF-8&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">meta</span> <span class=\"na\">name</span><span class=\"o\">=</span><span class=\"s\">&#34;viewport&#34;</span> <span class=\"na\">content</span><span class=\"o\">=</span><span class=\"s\">&#34;width=device-width, initial-scale=1.0&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">meta</span> <span class=\"na\">http-equiv</span><span class=\"o\">=</span><span class=\"s\">&#34;X-UA-Compatible&#34;</span> <span class=\"na\">content</span><span class=\"o\">=</span><span class=\"s\">&#34;ie=edge&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">title</span><span class=\"p\">&gt;</span>learn dll<span class=\"p\">&lt;/</span><span class=\"nt\">title</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;/</span><span class=\"nt\">head</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">body</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">div</span> <span class=\"na\">id</span><span class=\"o\">=</span><span class=\"s\">&#34;app&#34;</span><span class=\"p\">&gt;&lt;/</span><span class=\"nt\">div</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;/</span><span class=\"nt\">body</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;/</span><span class=\"nt\">html</span><span class=\"p\">&gt;</span></code></pre></div><p>æ–°å»º<code>src/Home.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">import</span> <span class=\"nx\">React</span> <span class=\"nx\">from</span> <span class=\"s1\">&#39;react&#39;</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"s1\">&#39;./Home.scss&#39;</span><span class=\"p\">;</span>\n\n<span class=\"k\">export</span> <span class=\"k\">default</span> <span class=\"p\">()</span> <span class=\"p\">=&gt;</span> <span class=\"o\">&lt;</span><span class=\"nx\">div</span> <span class=\"nx\">className</span><span class=\"o\">=</span><span class=\"s2\">&#34;home&#34;</span><span class=\"o\">&gt;</span><span class=\"nx\">home</span><span class=\"o\">&lt;</span><span class=\"err\">/div&gt;</span>\n</code></pre></div><p>æ–°å»º<code>src/Home.scss</code></p><div class=\"highlight\"><pre><code class=\"language-css\"><span class=\"p\">.</span><span class=\"nc\">home</span> <span class=\"p\">{</span>\n  <span class=\"k\">color</span><span class=\"p\">:</span> <span class=\"kc\">red</span><span class=\"p\">;</span>\n<span class=\"p\">}</span></code></pre></div><p>æ–°å»º<code>src/index.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">import</span> <span class=\"nx\">React</span><span class=\"p\">,</span> <span class=\"p\">{</span> <span class=\"nx\">Component</span> <span class=\"p\">}</span> <span class=\"nx\">from</span> <span class=\"s1\">&#39;react&#39;</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"nx\">ReactDom</span> <span class=\"nx\">from</span> <span class=\"s1\">&#39;react-dom&#39;</span><span class=\"p\">;</span>\n<span class=\"k\">import</span> <span class=\"nx\">Home</span> <span class=\"nx\">from</span> <span class=\"s1\">&#39;./Home&#39;</span><span class=\"p\">;</span>\n\n<span class=\"k\">class</span> <span class=\"nx\">Demo</span> <span class=\"k\">extends</span> <span class=\"nx\">Component</span> <span class=\"p\">{</span>\n  <span class=\"nx\">render</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"p\">(</span>\n      <span class=\"o\">&lt;</span><span class=\"nx\">Home</span> <span class=\"o\">/&gt;</span>\n    <span class=\"p\">)</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"nx\">ReactDom</span><span class=\"p\">.</span><span class=\"nx\">render</span><span class=\"p\">(</span><span class=\"o\">&lt;</span><span class=\"nx\">Demo</span><span class=\"o\">/&gt;</span><span class=\"p\">,</span> <span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">getElementById</span><span class=\"p\">(</span><span class=\"s1\">&#39;app&#39;</span><span class=\"p\">));</span>\n</code></pre></div><p>ä¿®æ”¹<code>package.json</code></p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"s2\">&#34;scripts&#34;</span>: <span class=\"o\">{</span>\n  <span class=\"s2\">&#34;dev&#34;</span>: <span class=\"s2\">&#34;webpack-dev-server --config webpack.dev.js&#34;</span>\n<span class=\"o\">}</span>,</code></pre></div><p>æœ€åï¼Œè¿è¡Œ<code>npm run dev</code>ï¼Œåº”è¯¥å¯ä»¥çœ‹è§æ•ˆæœ</p><p>æ–°å»º<code>webpack.prod.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">path</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;path&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"p\">{</span> <span class=\"nx\">CleanWebpackPlugin</span> <span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;clean-webpack-plugin&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">HtmlWebpackPlugin</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;html-webpack-plugin&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">MiniCssExtractPlugin</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;mini-css-extract-plugin&#39;</span><span class=\"p\">);</span>\n\n\n<span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"nx\">mode</span><span class=\"o\">:</span> <span class=\"s1\">&#39;production&#39;</span><span class=\"p\">,</span>\n  <span class=\"nx\">entry</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">main</span><span class=\"o\">:</span> <span class=\"s1\">&#39;./src/index.js&#39;</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">output</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">path</span><span class=\"o\">:</span> <span class=\"nx\">path</span><span class=\"p\">.</span><span class=\"nx\">resolve</span><span class=\"p\">(</span><span class=\"nx\">__dirname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;./dist&#39;</span><span class=\"p\">),</span>\n    <span class=\"nx\">filename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name].[contenthash:8].js&#39;</span><span class=\"p\">,</span>\n    <span class=\"nx\">chunkFilename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name].[contenthash:8].chunk.js&#39;</span><span class=\"p\">,</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">module</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">rules</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n      <span class=\"p\">{</span>\n        <span class=\"nx\">test</span><span class=\"o\">:</span> <span class=\"sr\">/\\.js$/</span><span class=\"p\">,</span>\n        <span class=\"nx\">exclude</span><span class=\"o\">:</span> <span class=\"sr\">/node_modules/</span><span class=\"p\">,</span>\n        <span class=\"nx\">loader</span><span class=\"o\">:</span> <span class=\"s2\">&#34;babel-loader&#34;</span>\n      <span class=\"p\">},</span>\n      <span class=\"p\">{</span>\n        <span class=\"nx\">test</span><span class=\"o\">:</span> <span class=\"sr\">/\\.css$/</span><span class=\"p\">,</span>\n        <span class=\"nx\">use</span><span class=\"o\">:</span> <span class=\"p\">[</span><span class=\"nx\">MiniCssExtractPlugin</span><span class=\"p\">.</span><span class=\"nx\">loader</span><span class=\"p\">,</span> <span class=\"c1\">// å•ç‹¬æå–cssæ–‡ä»¶\n</span><span class=\"c1\"></span>          <span class=\"s1\">&#39;css-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"s1\">&#39;postcss-loader&#39;</span>\n        <span class=\"p\">],</span>\n      <span class=\"p\">},</span>\n      <span class=\"p\">{</span>\n        <span class=\"nx\">test</span><span class=\"o\">:</span> <span class=\"sr\">/\\.scss$/</span><span class=\"p\">,</span>\n        <span class=\"nx\">use</span><span class=\"o\">:</span> <span class=\"p\">[</span><span class=\"nx\">MiniCssExtractPlugin</span><span class=\"p\">.</span><span class=\"nx\">loader</span><span class=\"p\">,</span>\n        <span class=\"p\">{</span>\n          <span class=\"nx\">loader</span><span class=\"o\">:</span> <span class=\"s1\">&#39;css-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"nx\">options</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n            <span class=\"nx\">modules</span><span class=\"o\">:</span> <span class=\"kc\">false</span><span class=\"p\">,</span>\n            <span class=\"nx\">importLoaders</span><span class=\"o\">:</span> <span class=\"mi\">2</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">},</span>\n          <span class=\"s1\">&#39;sass-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"s1\">&#39;postcss-loader&#39;</span>\n        <span class=\"p\">],</span>\n      <span class=\"p\">},</span>\n    <span class=\"p\">]</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">plugins</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n    <span class=\"k\">new</span> <span class=\"nx\">HtmlWebpackPlugin</span><span class=\"p\">({</span> <span class=\"nx\">template</span><span class=\"o\">:</span> <span class=\"s1\">&#39;./src/index.html&#39;</span> <span class=\"p\">}),</span>\n    <span class=\"k\">new</span> <span class=\"nx\">MiniCssExtractPlugin</span><span class=\"p\">({</span>\n      <span class=\"nx\">filename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name].[contenthash:8].css&#39;</span><span class=\"p\">,</span>\n      <span class=\"nx\">chunkFilename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[id].[contenthash:8].css&#39;</span><span class=\"p\">,</span>\n    <span class=\"p\">}),</span>\n    <span class=\"k\">new</span> <span class=\"nx\">CleanWebpackPlugin</span><span class=\"p\">(),</span> <span class=\"c1\">// æ‰“åŒ…å‰å…ˆåˆ é™¤ä¹‹å‰çš„distç›®å½•\n</span><span class=\"c1\"></span>  <span class=\"p\">]</span>\n<span class=\"p\">};</span>\n</code></pre></div><p>ä¿®æ”¹<code>package.json</code>ï¼Œæ·»åŠ ä¸€å¥<code>&#34;build&#34;: &#34;webpack --config webpack.prod.js&#34;</code></p><p>è¿è¡Œ<code>npm run build</code>ï¼Œå¯ä»¥çœ‹è§æ‰“åŒ…å‡ºæ¥çš„<code>dist</code>ç›®å½•</p><p>html,js,csséƒ½å•ç‹¬åˆ†ç¦»å‡ºæ¥äº†</p><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic1.zhimg.com/v2-e865054d25a81838113f4c6e3dfdab0c_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"282\" data-rawheight=\"86\" class=\"content_image\" width=\"282\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;282&#39; height=&#39;86&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"282\" data-rawheight=\"86\" class=\"content_image lazy\" width=\"282\" data-actualsrc=\"https://pic1.zhimg.com/v2-e865054d25a81838113f4c6e3dfdab0c_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>è‡³æ­¤ï¼Œä¸€ä¸ªåŸºäºwebpackçš„reactç¯å¢ƒæ­å»ºå®Œæˆ</p><h3>webpack-manifest-plugin</h3><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ‰“åŒ…å‡ºæ¥çš„js,csséƒ½æ˜¯å¸¦ä¸Šç‰ˆæœ¬å·çš„ï¼Œé€šè¿‡<code>HtmlWebpackPlugin</code>å¯ä»¥è‡ªåŠ¨å¸®æˆ‘ä»¬åœ¨<code>index.html</code>é‡Œé¢åŠ ä¸Šå¸¦ç‰ˆæœ¬å·çš„jså’Œcss</p><div class=\"highlight\"><pre><code class=\"language-html\"><span class=\"cp\">&lt;!DOCTYPE html&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">html</span> <span class=\"na\">lang</span><span class=\"o\">=</span><span class=\"s\">&#34;en&#34;</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">head</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">meta</span> <span class=\"na\">charset</span><span class=\"o\">=</span><span class=\"s\">&#34;UTF-8&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">meta</span> <span class=\"na\">name</span><span class=\"o\">=</span><span class=\"s\">&#34;viewport&#34;</span> <span class=\"na\">content</span><span class=\"o\">=</span><span class=\"s\">&#34;width=device-width, initial-scale=1.0&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">meta</span> <span class=\"na\">http-equiv</span><span class=\"o\">=</span><span class=\"s\">&#34;X-UA-Compatible&#34;</span> <span class=\"na\">content</span><span class=\"o\">=</span><span class=\"s\">&#34;ie=edge&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">title</span><span class=\"p\">&gt;</span>learn dll<span class=\"p\">&lt;/</span><span class=\"nt\">title</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">link</span> <span class=\"na\">href</span><span class=\"o\">=</span><span class=\"s\">&#34;main.198b3634.css&#34;</span> <span class=\"na\">rel</span><span class=\"o\">=</span><span class=\"s\">&#34;stylesheet&#34;</span><span class=\"p\">&gt;&lt;/</span><span class=\"nt\">head</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">body</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">div</span> <span class=\"na\">id</span><span class=\"o\">=</span><span class=\"s\">&#34;app&#34;</span><span class=\"p\">&gt;&lt;/</span><span class=\"nt\">div</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">script</span> <span class=\"na\">type</span><span class=\"o\">=</span><span class=\"s\">&#34;text/javascript&#34;</span> <span class=\"na\">src</span><span class=\"o\">=</span><span class=\"s\">&#34;main.d312f172.js&#34;</span><span class=\"p\">&gt;&lt;/</span><span class=\"nt\">script</span><span class=\"p\">&gt;&lt;/</span><span class=\"nt\">body</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;/</span><span class=\"nt\">html</span><span class=\"p\">&gt;</span></code></pre></div><p>ä½†æ˜¯åœ¨æŸäº›æƒ…å†µï¼Œ<code>index.html</code>æ¨¡æ¿ç”±åç«¯æ¸²æŸ“ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦ä¸€ä»½æ‰“åŒ…æ¸…å•ï¼ŒçŸ¥é“æ‰“åŒ…åçš„æ–‡ä»¶å¯¹åº”çš„çœŸæ­£è·¯å¾„</p><p>å®‰è£…æ’ä»¶<code>webpack-manifest-plugin</code></p><p><code>npm i webpack-manifest-plugin -D</code></p><p>ä¿®æ”¹<code>webpack.prod.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">ManifestPlugin</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;webpack-manifest-plugin&#39;</span><span class=\"p\">);</span>\n<span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// ...\n</span><span class=\"c1\"></span>    <span class=\"nx\">plugins</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n      <span class=\"k\">new</span> <span class=\"nx\">ManifestPlugin</span><span class=\"p\">()</span>\n    <span class=\"p\">]</span>\n<span class=\"p\">};</span>\n</code></pre></div><p>é‡æ–°æ‰“åŒ…ï¼Œå¯ä»¥çœ‹è§<code>dist</code>ç›®å½•æ–°ç”Ÿæˆäº†ä¸€ä¸ª<code>manifest.json</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"p\">{</span>\n  <span class=\"s2\">&#34;main.css&#34;</span><span class=\"o\">:</span> <span class=\"s2\">&#34;main.198b3634.css&#34;</span><span class=\"p\">,</span>\n  <span class=\"s2\">&#34;main.js&#34;</span><span class=\"o\">:</span> <span class=\"s2\">&#34;main.d312f172.js&#34;</span><span class=\"p\">,</span>\n  <span class=\"s2\">&#34;index.html&#34;</span><span class=\"o\">:</span> <span class=\"s2\">&#34;index.html&#34;</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>æ¯”å¦‚åœ¨SSRå¼€å‘æ—¶ï¼Œå‰ç«¯æ‰“åŒ…åï¼Œnodeåç«¯å°±å¯ä»¥é€šè¿‡è¿™ä¸ªjsonæ•°æ®ï¼Œè¿”å›æ­£ç¡®èµ„æºè·¯å¾„çš„htmlæ¨¡æ¿</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">buildPath</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;./dist/manifest.json&#39;</span><span class=\"p\">);</span>\n\n<span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">send</span><span class=\"p\">(</span><span class=\"sb\">`\n</span><span class=\"sb\">  &lt;!DOCTYPE html&gt;\n</span><span class=\"sb\">&lt;html lang=&#34;en&#34;&gt;\n</span><span class=\"sb\">&lt;head&gt;\n</span><span class=\"sb\">  &lt;meta charset=&#34;UTF-8&#34;&gt;\n</span><span class=\"sb\">  &lt;meta name=&#34;viewport&#34; content=&#34;width=device-width, initial-scale=1.0&#34;&gt;\n</span><span class=\"sb\">  &lt;meta http-equiv=&#34;X-UA-Compatible&#34; content=&#34;ie=edge&#34;&gt;\n</span><span class=\"sb\">  &lt;title&gt;ssr&lt;/title&gt;\n</span><span class=\"sb\">&lt;link href=&#34;</span><span class=\"si\">${</span><span class=\"nx\">buildPath</span><span class=\"p\">[</span><span class=\"s1\">&#39;main.css&#39;</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"sb\">&#34; rel=&#34;stylesheet&#34;&gt;&lt;/head&gt;\n</span><span class=\"sb\">&lt;body&gt;\n</span><span class=\"sb\">  &lt;div id=&#34;app&#34;&gt;&lt;/div&gt;\n</span><span class=\"sb\">&lt;script type=&#34;text/javascript&#34; src=&#34;</span><span class=\"si\">${</span><span class=\"nx\">buildPath</span><span class=\"p\">[</span><span class=\"s1\">&#39;main.js&#39;</span><span class=\"p\">]</span><span class=\"si\">}</span><span class=\"sb\">&#34;&gt;&lt;/script&gt;&lt;/body&gt;\n</span><span class=\"sb\">&lt;/html&gt;\n</span><span class=\"sb\">`</span><span class=\"p\">);</span>\n</code></pre></div><h3>ä»£ç åˆ†å‰²</h3><p>æˆ‘ä»¬ä¹‹å‰çš„æ‰“åŒ…æ–¹å¼ï¼Œæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯æŠŠä¸šåŠ¡ä»£ç å’Œåº“ä»£ç éƒ½ç»Ÿç»Ÿæ‰“åˆ°äº†ä¸€ä¸ª<code>main.js</code>é‡Œé¢ã€‚æ¯æ¬¡ä¸šåŠ¡ä»£ç æ”¹åŠ¨åï¼Œ<code>main.js</code>çš„hashå€¼å°±å˜äº†ï¼Œå¯¼è‡´å®¢æˆ·ç«¯åˆè¦é‡æ–°ä¸‹è½½ä¸€é<code>main.js</code>ï¼Œä½†æ˜¯é‡Œé¢çš„åº“ä»£ç å…¶å®æ˜¯æ²¡æ”¹å˜çš„ï¼</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œ<code>react</code> <code>react-dom</code>ä¹‹ç±»çš„åº“ï¼Œéƒ½æ˜¯ä¸ç»å¸¸æ”¹åŠ¨çš„ã€‚æˆ‘ä»¬å¸Œæœ›å•ç‹¬æŠŠè¿™äº›åº“ä»£ç æå–å‡ºæ¥ï¼Œç”Ÿæˆä¸€ä¸ª<code>vendor.js</code>ï¼Œè¿™æ ·æ¯æ¬¡æ”¹åŠ¨ä»£ç ï¼Œåªæ˜¯ä¸‹è½½<code>main.js</code>ï¼Œ<code>vendor.js</code>å¯ä»¥å……åˆ†ç¼“å­˜(ä¹Ÿå°±æ˜¯æ‰€è°“çš„ä»£ç åˆ†å‰²code splitting)</p><p>webpack4è‡ªå¸¦<a href=\"https://link.zhihu.com/?target=https%3A//webpack.js.org/guides/code-splitting/\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">ä»£ç åˆ†å‰²</a>åŠŸèƒ½ï¼Œåªè¦é…ç½®:</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"nx\">optimization</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n  <span class=\"nx\">splitChunks</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">chunks</span><span class=\"o\">:</span> <span class=\"s1\">&#39;all&#39;</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div><p><code>webpack.prod.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">path</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;path&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"p\">{</span> <span class=\"nx\">CleanWebpackPlugin</span> <span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;clean-webpack-plugin&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">HtmlWebpackPlugin</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;html-webpack-plugin&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">MiniCssExtractPlugin</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;mini-css-extract-plugin&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">ManifestPlugin</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;webpack-manifest-plugin&#39;</span><span class=\"p\">);</span>\n\n<span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"nx\">mode</span><span class=\"o\">:</span> <span class=\"s1\">&#39;production&#39;</span><span class=\"p\">,</span>\n  <span class=\"nx\">entry</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">main</span><span class=\"o\">:</span> <span class=\"s1\">&#39;./src/index.js&#39;</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">output</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">path</span><span class=\"o\">:</span> <span class=\"nx\">path</span><span class=\"p\">.</span><span class=\"nx\">resolve</span><span class=\"p\">(</span><span class=\"nx\">__dirname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;./dist&#39;</span><span class=\"p\">),</span>\n    <span class=\"nx\">filename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name].[contenthash:8].js&#39;</span><span class=\"p\">,</span>\n    <span class=\"nx\">chunkFilename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name].[contenthash:8].chunk.js&#39;</span><span class=\"p\">,</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">module</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">rules</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n      <span class=\"p\">{</span>\n        <span class=\"nx\">test</span><span class=\"o\">:</span> <span class=\"sr\">/\\.js$/</span><span class=\"p\">,</span>\n        <span class=\"nx\">exclude</span><span class=\"o\">:</span> <span class=\"sr\">/node_modules/</span><span class=\"p\">,</span>\n        <span class=\"nx\">loader</span><span class=\"o\">:</span> <span class=\"s2\">&#34;babel-loader&#34;</span>\n      <span class=\"p\">},</span>\n      <span class=\"p\">{</span>\n        <span class=\"nx\">test</span><span class=\"o\">:</span> <span class=\"sr\">/\\.css$/</span><span class=\"p\">,</span>\n        <span class=\"nx\">use</span><span class=\"o\">:</span> <span class=\"p\">[</span><span class=\"nx\">MiniCssExtractPlugin</span><span class=\"p\">.</span><span class=\"nx\">loader</span><span class=\"p\">,</span>\n          <span class=\"s1\">&#39;css-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"s1\">&#39;postcss-loader&#39;</span>\n        <span class=\"p\">],</span>\n      <span class=\"p\">},</span>\n      <span class=\"p\">{</span>\n        <span class=\"nx\">test</span><span class=\"o\">:</span> <span class=\"sr\">/\\.scss$/</span><span class=\"p\">,</span>\n        <span class=\"nx\">use</span><span class=\"o\">:</span> <span class=\"p\">[</span><span class=\"nx\">MiniCssExtractPlugin</span><span class=\"p\">.</span><span class=\"nx\">loader</span><span class=\"p\">,</span>\n        <span class=\"p\">{</span>\n          <span class=\"nx\">loader</span><span class=\"o\">:</span> <span class=\"s1\">&#39;css-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"nx\">options</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n            <span class=\"nx\">modules</span><span class=\"o\">:</span> <span class=\"kc\">false</span><span class=\"p\">,</span>\n            <span class=\"nx\">importLoaders</span><span class=\"o\">:</span> <span class=\"mi\">2</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">},</span>\n          <span class=\"s1\">&#39;sass-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"s1\">&#39;postcss-loader&#39;</span>\n        <span class=\"p\">],</span>\n      <span class=\"p\">},</span>\n    <span class=\"p\">]</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">plugins</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n    <span class=\"k\">new</span> <span class=\"nx\">HtmlWebpackPlugin</span><span class=\"p\">({</span> <span class=\"nx\">template</span><span class=\"o\">:</span> <span class=\"s1\">&#39;./src/index.html&#39;</span> <span class=\"p\">}),</span>\n    <span class=\"k\">new</span> <span class=\"nx\">MiniCssExtractPlugin</span><span class=\"p\">({</span>\n      <span class=\"nx\">filename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name].[contenthash:8].css&#39;</span><span class=\"p\">,</span>\n      <span class=\"nx\">chunkFilename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[id].[contenthash:8].css&#39;</span><span class=\"p\">,</span>\n    <span class=\"p\">}),</span>\n    <span class=\"k\">new</span> <span class=\"nx\">CleanWebpackPlugin</span><span class=\"p\">(),</span>\n    <span class=\"k\">new</span> <span class=\"nx\">ManifestPlugin</span><span class=\"p\">()</span>\n  <span class=\"p\">],</span>\n  <span class=\"nx\">optimization</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">splitChunks</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n      <span class=\"nx\">chunks</span><span class=\"o\">:</span> <span class=\"s1\">&#39;all&#39;</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">};</span>\n</code></pre></div><p>é‡æ–°æ‰“åŒ…ï¼Œå‘ç°æ–°ç”Ÿæˆäº†ä¸€ä¸ª<code>vendor.js</code>æ–‡ä»¶ï¼Œå…¬ç”¨çš„ä¸€äº›ä»£ç å°±è¢«æ‰“åŒ…è¿›å»äº†</p><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic1.zhimg.com/v2-0ef81504bdfdfa58c129c7b5aad1f2b0_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"299\" data-rawheight=\"136\" class=\"content_image\" width=\"299\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;299&#39; height=&#39;136&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"299\" data-rawheight=\"136\" class=\"content_image lazy\" width=\"299\" data-actualsrc=\"https://pic1.zhimg.com/v2-0ef81504bdfdfa58c129c7b5aad1f2b0_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>é‡æ–°ä¿®æ”¹<code>src/Home.js</code>,ç„¶åæ‰“åŒ…ï¼Œä½ ä¼šå‘ç°<code>vendor.js</code>çš„hashæ²¡æœ‰æ”¹å˜ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬å¸Œæœ›çš„</p><h3>DLLæ‰“åŒ…</h3><p>ä¸Šé¢çš„æ‰“åŒ…æ–¹å¼ï¼Œéšç€é¡¹ç›®çš„å¤æ‚åº¦ä¸Šå‡åï¼Œæ‰“åŒ…é€Ÿåº¦ä¼šå¼€å§‹å˜æ…¢ã€‚åŸå› æ˜¯ï¼Œæ¯æ¬¡æ‰“åŒ…ï¼Œwebpackéƒ½è¦åˆ†æå“ªäº›æ˜¯å…¬ç”¨åº“ï¼Œç„¶åæŠŠä»–æ‰“åŒ…åˆ°<code>vendor.js</code>é‡Œ</p><p>æˆ‘ä»¬å¯ä¸å¯ä»¥åœ¨ç¬¬ä¸€æ¬¡æ„å»º<code>vendor.js</code>ä»¥åï¼Œä¸‹æ¬¡æ‰“åŒ…ï¼Œå°±ç›´æ¥è·³è¿‡é‚£äº›è¢«æ‰“åŒ…åˆ°<code>vendor.js</code>é‡Œçš„ä»£ç å‘¢ï¼Ÿè¿™æ ·æ‰“åŒ…é€Ÿåº¦å¯ä»¥æ˜æ˜¾æå‡</p><p>è¿™å°±éœ€è¦<code>DllPlugin</code>ç»“åˆ<code>DllRefrencePlugin</code>æ’ä»¶çš„è¿ç”¨</p><p>dllæ‰“åŒ…åŸç†å°±æ˜¯ï¼š </p><p>1. æŠŠæŒ‡å®šçš„åº“ä»£ç æ‰“åŒ…åˆ°ä¸€ä¸ª<code>dll.js</code>,åŒæ—¶ç”Ÿæˆä¸€ä»½å¯¹åº”çš„<code>manifest.json</code>æ–‡ä»¶ </p><p>2. webpackæ‰“åŒ…æ—¶ï¼Œè¯»å–<code>manifest.json</code>,çŸ¥é“å“ªäº›ä»£ç å¯ä»¥ç›´æ¥å¿½ç•¥ï¼Œä»è€Œæé«˜æ„å»ºé€Ÿåº¦</p><p>æˆ‘ä»¬æ–°å»ºä¸€ä¸ª<code>webpack.dll.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">path</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;path&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">webpack</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;webpack&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"p\">{</span> <span class=\"nx\">CleanWebpackPlugin</span> <span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;clean-webpack-plugin&#39;</span><span class=\"p\">);</span>\n\n<span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"nx\">mode</span><span class=\"o\">:</span> <span class=\"s1\">&#39;production&#39;</span><span class=\"p\">,</span>\n  <span class=\"nx\">entry</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">vendors</span><span class=\"o\">:</span> <span class=\"p\">[</span><span class=\"s1\">&#39;react&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;react-dom&#39;</span><span class=\"p\">]</span> <span class=\"c1\">// æ‰‹åŠ¨æŒ‡å®šæ‰“åŒ…å“ªäº›åº“\n</span><span class=\"c1\"></span>  <span class=\"p\">},</span>\n  <span class=\"nx\">output</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">filename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name].[hash:8].dll.js&#39;</span><span class=\"p\">,</span>\n    <span class=\"nx\">path</span><span class=\"o\">:</span> <span class=\"nx\">path</span><span class=\"p\">.</span><span class=\"nx\">resolve</span><span class=\"p\">(</span><span class=\"nx\">__dirname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;./dll&#39;</span><span class=\"p\">),</span>\n    <span class=\"nx\">library</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name]&#39;</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">plugins</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n    <span class=\"k\">new</span> <span class=\"nx\">CleanWebpackPlugin</span><span class=\"p\">(),</span>\n    <span class=\"k\">new</span> <span class=\"nx\">webpack</span><span class=\"p\">.</span><span class=\"nx\">DllPlugin</span><span class=\"p\">({</span>\n      <span class=\"nx\">path</span><span class=\"o\">:</span> <span class=\"nx\">path</span><span class=\"p\">.</span><span class=\"nx\">join</span><span class=\"p\">(</span><span class=\"nx\">__dirname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;./dll/[name].manifest.json&#39;</span><span class=\"p\">),</span> <span class=\"c1\">// ç”Ÿæˆå¯¹åº”çš„manifest.jsonï¼Œç»™webpackæ‰“åŒ…ç”¨\n</span><span class=\"c1\"></span>      <span class=\"nx\">name</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name]&#39;</span><span class=\"p\">,</span>\n    <span class=\"p\">}),</span>\n  <span class=\"p\">],</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>æ·»åŠ ä¸€æ¡å‘½ä»¤:</p><p><code>&#34;build:dll&#34;: &#34;webpack --config webpack.dll.js&#34;</code></p><p>è¿è¡Œdllæ‰“åŒ…</p><p><code>npm run build:dll</code></p><p>å‘ç°ç”Ÿæˆä¸€ä¸ª<code>dll</code>ç›®å½•</p><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic4.zhimg.com/v2-b6f40e950e939c759f79486ecad82f43_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"293\" data-rawheight=\"72\" class=\"content_image\" width=\"293\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;293&#39; height=&#39;72&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"293\" data-rawheight=\"72\" class=\"content_image lazy\" width=\"293\" data-actualsrc=\"https://pic4.zhimg.com/v2-b6f40e950e939c759f79486ecad82f43_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>ä¿®æ”¹<code>webpack.prod.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">path</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;path&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"p\">{</span> <span class=\"nx\">CleanWebpackPlugin</span> <span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;clean-webpack-plugin&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">HtmlWebpackPlugin</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;html-webpack-plugin&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">MiniCssExtractPlugin</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;mini-css-extract-plugin&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">ManifestPlugin</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;webpack-manifest-plugin&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">webpack</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;webpack&#39;</span><span class=\"p\">);</span>\n\n<span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"nx\">mode</span><span class=\"o\">:</span> <span class=\"s1\">&#39;production&#39;</span><span class=\"p\">,</span>\n  <span class=\"nx\">entry</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">main</span><span class=\"o\">:</span> <span class=\"s1\">&#39;./src/index.js&#39;</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">output</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">path</span><span class=\"o\">:</span> <span class=\"nx\">path</span><span class=\"p\">.</span><span class=\"nx\">resolve</span><span class=\"p\">(</span><span class=\"nx\">__dirname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;./dist&#39;</span><span class=\"p\">),</span>\n    <span class=\"nx\">filename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name].[contenthash:8].js&#39;</span><span class=\"p\">,</span>\n    <span class=\"nx\">chunkFilename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name].[contenthash:8].chunk.js&#39;</span><span class=\"p\">,</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">module</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">rules</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n      <span class=\"p\">{</span>\n        <span class=\"nx\">test</span><span class=\"o\">:</span> <span class=\"sr\">/\\.js$/</span><span class=\"p\">,</span>\n        <span class=\"nx\">exclude</span><span class=\"o\">:</span> <span class=\"sr\">/node_modules/</span><span class=\"p\">,</span>\n        <span class=\"nx\">loader</span><span class=\"o\">:</span> <span class=\"s2\">&#34;babel-loader&#34;</span>\n      <span class=\"p\">},</span>\n      <span class=\"p\">{</span>\n        <span class=\"nx\">test</span><span class=\"o\">:</span> <span class=\"sr\">/\\.css$/</span><span class=\"p\">,</span>\n        <span class=\"nx\">use</span><span class=\"o\">:</span> <span class=\"p\">[</span><span class=\"nx\">MiniCssExtractPlugin</span><span class=\"p\">.</span><span class=\"nx\">loader</span><span class=\"p\">,</span>\n          <span class=\"s1\">&#39;css-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"s1\">&#39;postcss-loader&#39;</span>\n        <span class=\"p\">],</span>\n      <span class=\"p\">},</span>\n      <span class=\"p\">{</span>\n        <span class=\"nx\">test</span><span class=\"o\">:</span> <span class=\"sr\">/\\.scss$/</span><span class=\"p\">,</span>\n        <span class=\"nx\">use</span><span class=\"o\">:</span> <span class=\"p\">[</span><span class=\"nx\">MiniCssExtractPlugin</span><span class=\"p\">.</span><span class=\"nx\">loader</span><span class=\"p\">,</span>\n        <span class=\"p\">{</span>\n          <span class=\"nx\">loader</span><span class=\"o\">:</span> <span class=\"s1\">&#39;css-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"nx\">options</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n            <span class=\"nx\">modules</span><span class=\"o\">:</span> <span class=\"kc\">false</span><span class=\"p\">,</span>\n            <span class=\"nx\">importLoaders</span><span class=\"o\">:</span> <span class=\"mi\">2</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">},</span>\n          <span class=\"s1\">&#39;sass-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"s1\">&#39;postcss-loader&#39;</span>\n        <span class=\"p\">],</span>\n      <span class=\"p\">},</span>\n    <span class=\"p\">]</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">plugins</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n    <span class=\"k\">new</span> <span class=\"nx\">HtmlWebpackPlugin</span><span class=\"p\">({</span> <span class=\"nx\">template</span><span class=\"o\">:</span> <span class=\"s1\">&#39;./src/index.html&#39;</span> <span class=\"p\">}),</span>\n    <span class=\"k\">new</span> <span class=\"nx\">MiniCssExtractPlugin</span><span class=\"p\">({</span>\n      <span class=\"nx\">filename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name].[contenthash:8].css&#39;</span><span class=\"p\">,</span>\n      <span class=\"nx\">chunkFilename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[id].[contenthash:8].css&#39;</span><span class=\"p\">,</span>\n    <span class=\"p\">}),</span>\n    <span class=\"k\">new</span> <span class=\"nx\">webpack</span><span class=\"p\">.</span><span class=\"nx\">DllReferencePlugin</span><span class=\"p\">({</span>\n      <span class=\"nx\">manifest</span><span class=\"o\">:</span> <span class=\"nx\">path</span><span class=\"p\">.</span><span class=\"nx\">resolve</span><span class=\"p\">(</span><span class=\"nx\">__dirname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;./dll/vendors.manifest.json&#39;</span><span class=\"p\">)</span> <span class=\"c1\">// è¯»å–dllæ‰“åŒ…åçš„manifest.jsonï¼Œåˆ†æå“ªäº›ä»£ç è·³è¿‡\n</span><span class=\"c1\"></span>    <span class=\"p\">}),</span>\n    <span class=\"k\">new</span> <span class=\"nx\">CleanWebpackPlugin</span><span class=\"p\">(),</span>\n    <span class=\"k\">new</span> <span class=\"nx\">ManifestPlugin</span><span class=\"p\">()</span>\n  <span class=\"p\">],</span>\n  <span class=\"nx\">optimization</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">splitChunks</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n      <span class=\"nx\">chunks</span><span class=\"o\">:</span> <span class=\"s1\">&#39;all&#39;</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">};</span>\n</code></pre></div><p>é‡æ–°<code>npm run build</code>ï¼Œå‘ç°<code>dist</code>ç›®å½•é‡Œï¼Œ<code>vendor.js</code>æ²¡æœ‰äº†</p><p>è¿™æ˜¯å› ä¸º<code>react</code>,<code>react-dom</code>å·²ç»æ‰“åŒ…åˆ°<code>dll.js</code>é‡Œäº†ï¼Œ<code>webpack</code>è¯»å–<code>manifest.json</code>ä¹‹åï¼ŒçŸ¥é“å¯ä»¥å¿½ç•¥è¿™äº›ä»£ç ï¼Œäºæ˜¯å°±æ²¡æœ‰å†æ‰“åŒ…äº†</p><p>ä½†è¿™é‡Œè¿˜æœ‰ä¸ªé—®é¢˜ï¼Œæ‰“åŒ…åçš„<code>index.html</code>è¿˜éœ€è¦æ·»åŠ <code>dll.js</code>æ–‡ä»¶ï¼Œè¿™å°±éœ€è¦<code>add-asset-html-webpack-plugin</code>æ’ä»¶</p><p><code>npm i add-asset-html-webpack-plugin -D</code></p><p>ä¿®æ”¹<code>webpack.prod.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">path</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;path&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"p\">{</span> <span class=\"nx\">CleanWebpackPlugin</span> <span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;clean-webpack-plugin&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">HtmlWebpackPlugin</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;html-webpack-plugin&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">MiniCssExtractPlugin</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;mini-css-extract-plugin&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">ManifestPlugin</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;webpack-manifest-plugin&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">webpack</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;webpack&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">AddAssetHtmlPlugin</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;add-asset-html-webpack-plugin&#39;</span><span class=\"p\">);</span>\n\n<span class=\"nx\">module</span><span class=\"p\">.</span><span class=\"nx\">exports</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"nx\">mode</span><span class=\"o\">:</span> <span class=\"s1\">&#39;production&#39;</span><span class=\"p\">,</span>\n  <span class=\"nx\">entry</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">main</span><span class=\"o\">:</span> <span class=\"s1\">&#39;./src/index.js&#39;</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">output</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">path</span><span class=\"o\">:</span> <span class=\"nx\">path</span><span class=\"p\">.</span><span class=\"nx\">resolve</span><span class=\"p\">(</span><span class=\"nx\">__dirname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;./dist&#39;</span><span class=\"p\">),</span>\n    <span class=\"nx\">filename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name].[contenthash:8].js&#39;</span><span class=\"p\">,</span>\n    <span class=\"nx\">chunkFilename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name].[contenthash:8].chunk.js&#39;</span><span class=\"p\">,</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">module</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">rules</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n      <span class=\"p\">{</span>\n        <span class=\"nx\">test</span><span class=\"o\">:</span> <span class=\"sr\">/\\.js$/</span><span class=\"p\">,</span>\n        <span class=\"nx\">exclude</span><span class=\"o\">:</span> <span class=\"sr\">/node_modules/</span><span class=\"p\">,</span>\n        <span class=\"nx\">loader</span><span class=\"o\">:</span> <span class=\"s2\">&#34;babel-loader&#34;</span>\n      <span class=\"p\">},</span>\n      <span class=\"p\">{</span>\n        <span class=\"nx\">test</span><span class=\"o\">:</span> <span class=\"sr\">/\\.css$/</span><span class=\"p\">,</span>\n        <span class=\"nx\">use</span><span class=\"o\">:</span> <span class=\"p\">[</span><span class=\"nx\">MiniCssExtractPlugin</span><span class=\"p\">.</span><span class=\"nx\">loader</span><span class=\"p\">,</span>\n          <span class=\"s1\">&#39;css-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"s1\">&#39;postcss-loader&#39;</span>\n        <span class=\"p\">],</span>\n      <span class=\"p\">},</span>\n      <span class=\"p\">{</span>\n        <span class=\"nx\">test</span><span class=\"o\">:</span> <span class=\"sr\">/\\.scss$/</span><span class=\"p\">,</span>\n        <span class=\"nx\">use</span><span class=\"o\">:</span> <span class=\"p\">[</span><span class=\"nx\">MiniCssExtractPlugin</span><span class=\"p\">.</span><span class=\"nx\">loader</span><span class=\"p\">,</span>\n        <span class=\"p\">{</span>\n          <span class=\"nx\">loader</span><span class=\"o\">:</span> <span class=\"s1\">&#39;css-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"nx\">options</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n            <span class=\"nx\">modules</span><span class=\"o\">:</span> <span class=\"kc\">false</span><span class=\"p\">,</span>\n            <span class=\"nx\">importLoaders</span><span class=\"o\">:</span> <span class=\"mi\">2</span>\n          <span class=\"p\">}</span>\n        <span class=\"p\">},</span>\n          <span class=\"s1\">&#39;sass-loader&#39;</span><span class=\"p\">,</span>\n          <span class=\"s1\">&#39;postcss-loader&#39;</span>\n        <span class=\"p\">],</span>\n      <span class=\"p\">},</span>\n    <span class=\"p\">]</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">plugins</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n    <span class=\"k\">new</span> <span class=\"nx\">HtmlWebpackPlugin</span><span class=\"p\">({</span> <span class=\"nx\">template</span><span class=\"o\">:</span> <span class=\"s1\">&#39;./src/index.html&#39;</span> <span class=\"p\">}),</span>\n    <span class=\"k\">new</span> <span class=\"nx\">AddAssetHtmlPlugin</span><span class=\"p\">({</span> <span class=\"nx\">filepath</span><span class=\"o\">:</span> <span class=\"nx\">path</span><span class=\"p\">.</span><span class=\"nx\">resolve</span><span class=\"p\">(</span><span class=\"nx\">__dirname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;./dll/*.dll.js&#39;</span><span class=\"p\">)</span> <span class=\"p\">}),</span> <span class=\"c1\">// æŠŠdll.jsåŠ è¿›index.htmlé‡Œï¼Œå¹¶ä¸”æ‹·è´æ–‡ä»¶åˆ°distç›®å½•\n</span><span class=\"c1\"></span>    <span class=\"k\">new</span> <span class=\"nx\">MiniCssExtractPlugin</span><span class=\"p\">({</span>\n      <span class=\"nx\">filename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[name].[contenthash:8].css&#39;</span><span class=\"p\">,</span>\n      <span class=\"nx\">chunkFilename</span><span class=\"o\">:</span> <span class=\"s1\">&#39;[id].[contenthash:8].css&#39;</span><span class=\"p\">,</span>\n    <span class=\"p\">}),</span>\n    <span class=\"k\">new</span> <span class=\"nx\">webpack</span><span class=\"p\">.</span><span class=\"nx\">DllReferencePlugin</span><span class=\"p\">({</span>\n      <span class=\"nx\">manifest</span><span class=\"o\">:</span> <span class=\"nx\">path</span><span class=\"p\">.</span><span class=\"nx\">resolve</span><span class=\"p\">(</span><span class=\"nx\">__dirname</span><span class=\"p\">,</span> <span class=\"s1\">&#39;./dll/vendors.manifest.json&#39;</span><span class=\"p\">)</span> <span class=\"c1\">// è¯»å–dllæ‰“åŒ…åçš„manifest.jsonï¼Œåˆ†æå“ªäº›ä»£ç è·³è¿‡\n</span><span class=\"c1\"></span>    <span class=\"p\">}),</span>\n    <span class=\"k\">new</span> <span class=\"nx\">CleanWebpackPlugin</span><span class=\"p\">(),</span>\n    <span class=\"k\">new</span> <span class=\"nx\">ManifestPlugin</span><span class=\"p\">()</span>\n  <span class=\"p\">],</span>\n  <span class=\"nx\">optimization</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">splitChunks</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n      <span class=\"nx\">chunks</span><span class=\"o\">:</span> <span class=\"s1\">&#39;all&#39;</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">};</span>\n</code></pre></div><p>é‡æ–°<code>npm run build</code>ï¼Œå¯ä»¥çœ‹è§<code>dll.js</code>ä¹Ÿè¢«æ‰“åŒ…è¿›<code>dist</code>ç›®å½•äº†ï¼ŒåŒæ—¶<code>index.html</code>ä¹Ÿæ­£ç¡®å¼•ç”¨</p><div class=\"highlight\"><pre><code class=\"language-html\"><span class=\"cp\">&lt;!DOCTYPE html&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">html</span> <span class=\"na\">lang</span><span class=\"o\">=</span><span class=\"s\">&#34;en&#34;</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">head</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">meta</span> <span class=\"na\">charset</span><span class=\"o\">=</span><span class=\"s\">&#34;UTF-8&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">meta</span> <span class=\"na\">name</span><span class=\"o\">=</span><span class=\"s\">&#34;viewport&#34;</span> <span class=\"na\">content</span><span class=\"o\">=</span><span class=\"s\">&#34;width=device-width, initial-scale=1.0&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">meta</span> <span class=\"na\">http-equiv</span><span class=\"o\">=</span><span class=\"s\">&#34;X-UA-Compatible&#34;</span> <span class=\"na\">content</span><span class=\"o\">=</span><span class=\"s\">&#34;ie=edge&#34;</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">title</span><span class=\"p\">&gt;</span>learn dll<span class=\"p\">&lt;/</span><span class=\"nt\">title</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">link</span> <span class=\"na\">href</span><span class=\"o\">=</span><span class=\"s\">&#34;main.198b3634.css&#34;</span> <span class=\"na\">rel</span><span class=\"o\">=</span><span class=\"s\">&#34;stylesheet&#34;</span><span class=\"p\">&gt;&lt;/</span><span class=\"nt\">head</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">body</span><span class=\"p\">&gt;</span>\n  <span class=\"p\">&lt;</span><span class=\"nt\">div</span> <span class=\"na\">id</span><span class=\"o\">=</span><span class=\"s\">&#34;app&#34;</span><span class=\"p\">&gt;&lt;/</span><span class=\"nt\">div</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;</span><span class=\"nt\">script</span> <span class=\"na\">type</span><span class=\"o\">=</span><span class=\"s\">&#34;text/javascript&#34;</span> <span class=\"na\">src</span><span class=\"o\">=</span><span class=\"s\">&#34;vendors.8ec3d1ea.dll.js&#34;</span><span class=\"p\">&gt;&lt;/</span><span class=\"nt\">script</span><span class=\"p\">&gt;&lt;</span><span class=\"nt\">script</span> <span class=\"na\">type</span><span class=\"o\">=</span><span class=\"s\">&#34;text/javascript&#34;</span> <span class=\"na\">src</span><span class=\"o\">=</span><span class=\"s\">&#34;main.0bc9c924.js&#34;</span><span class=\"p\">&gt;&lt;/</span><span class=\"nt\">script</span><span class=\"p\">&gt;&lt;/</span><span class=\"nt\">body</span><span class=\"p\">&gt;</span>\n<span class=\"p\">&lt;/</span><span class=\"nt\">html</span><span class=\"p\">&gt;</span></code></pre></div><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic3.zhimg.com/v2-9bdcb82bc60bbd2f94434f940c94c4ea_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"289\" data-rawheight=\"201\" class=\"content_image\" width=\"289\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;289&#39; height=&#39;201&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"289\" data-rawheight=\"201\" class=\"content_image lazy\" width=\"289\" data-actualsrc=\"https://pic3.zhimg.com/v2-9bdcb82bc60bbd2f94434f940c94c4ea_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><h3>å°ç»“</h3><p>æˆ‘ä»¬ä»‹ç»äº†4ç§<code>manifest</code>ç›¸å…³çš„å‰ç«¯æŠ€æœ¯ã€‚<code>manifest</code>çš„è‹±æ–‡å«ä¹‰æ˜¯<b>åå•</b>, 4ç§æŠ€æœ¯çš„ç¡®éƒ½æ˜¯æŠŠ<code>manifest</code>å½“åšæ¸…å•ä½¿ç”¨ï¼š </p><p>1. ç¼“å­˜æ¸…å•</p><p>2. PWAæ¸…å• </p><p>3. æ‰“åŒ…èµ„æºè·¯å¾„æ¸…å• </p><p>4. dllæ‰“åŒ…æ¸…å•</p><p>åªä¸è¿‡æ˜¯åœ¨ä¸åŒçš„åœºæ™¯ä¸­ä½¿ç”¨ç‰¹å®šçš„æ¸…å•æ¥å®ŒæˆæŸäº›åŠŸèƒ½</p><p>æ‰€ä»¥ï¼Œå­¦å¥½è‹±æ–‡æ˜¯å¤šä¹ˆé‡è¦ï¼Œè¿™æ ·æ‰ä¸ä¼šå‚»å‚»åˆ†ä¸æ¸…<code>manifest</code>åˆ°åº•æ˜¯å¹²å•¥çš„ï¼</p>", 
            "topic": [
                {
                    "tag": "webpack", 
                    "tagLink": "https://api.zhihu.com/topics/20032877"
                }, 
                {
                    "tag": "æ¸è¿›å¼ç½‘ç»œåº”ç”¨ç¨‹åºï¼ˆPWAï¼‰", 
                    "tagLink": "https://api.zhihu.com/topics/20073560"
                }, 
                {
                    "tag": "JavaScript", 
                    "tagLink": "https://api.zhihu.com/topics/19552521"
                }
            ], 
            "comments": [
                {
                    "userName": "åˆ˜äº®", 
                    "userLink": "https://www.zhihu.com/people/7ab8a0ee81d6f4a2d6aa7984c18e8f05", 
                    "content": "<p>ã€Œwbbpackä¸­webpack-manifest-pluginæ’ä»¶æ‰“åŒ…å‡ºæ¥çš„manifest.jsonæ–‡ä»¶ï¼Œç”¨æ¥ç”Ÿæˆä¸€ä»½èµ„æºæ¸…å•ï¼Œä¸ºåç«¯æ¸²æŸ“æœåŠ¡ã€è¿™å¥è¯çš„ç¬¬ä¸€ä¸ªå•è¯ wbbpack å†™é”™å•¦</p>", 
                    "likes": 0, 
                    "childComments": [
                        {
                            "userName": "æ·±çº¢", 
                            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
                            "content": "<p>å·²æ”¹</p>", 
                            "likes": 0, 
                            "replyToAuthor": "åˆ˜äº®"
                        }
                    ]
                }
            ]
        }, 
        {
            "url": "https://zhuanlan.zhihu.com/p/60933824", 
            "userName": "æ·±çº¢", 
            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
            "upvote": 12, 
            "title": "ä»é›¶å¼€å§‹å†™ä¸€ä¸ªTelegram Bot", 
            "content": "<p>åŸæ–‡åœ°å€ï¼š</p><a href=\"https://link.zhihu.com/?target=http%3A//anata.me/2019/03/30/%25E4%25BB%258E%25E9%259B%25B6%25E5%25BC%2580%25E5%25A7%258B%25E5%2586%2599%25E4%25B8%2580%25E4%25B8%25AATelegram-Bot/\" data-draft-node=\"block\" data-draft-type=\"link-card\" data-image=\"https://pic1.zhimg.com/v2-7c06370bfdeedbf519fcb0aa1610f820_ipico.jpg\" data-image-width=\"200\" data-image-height=\"200\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">ä»é›¶å¼€å§‹å†™ä¸€ä¸ªTelegram Bot</a><p>Telegram(ç”µæŠ¥) æä¾›äº†ä¸°å¯Œçš„<a href=\"https://link.zhihu.com/?target=https%3A//core.telegram.org/bots/api\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">API</a>ï¼Œè®©æˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿çš„å¼€å‘ä¸€ä¸ªbotæœºå™¨äººã€‚åŒæ—¶ï¼Œ<a href=\"https://link.zhihu.com/?target=https%3A//core.telegram.org/bots/samples\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">ç¤¾åŒº</a>ä¹Ÿå·²ç»å¯¹åº•å±‚APIè¿›è¡Œäº†å„ç§è¯­è¨€çš„å°è£…ï¼Œå› æ­¤ï¼Œæœ¬æ–‡é‡‡ç”¨<a href=\"https://link.zhihu.com/?target=https%3A//github.com/yagop/node-telegram-bot-api\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">node-telegram-bot-api</a>æ¥å¿«é€Ÿå®ç°bot</p><h3>åˆ›å»ºä¸€ä¸ªæ–°Bot</h3><p>åœ¨Telegramå®¢æˆ·ç«¯æœç´¢<a href=\"https://link.zhihu.com/?target=https%3A//telegram.me/BotFather\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">@BotFather</a>ï¼Œç„¶åæŒ‰ç…§æ­¥éª¤åˆ›å»ºä¸€ä¸ªå±äºè‡ªå·±çš„botã€‚åˆ›å»ºæˆåŠŸåï¼ŒBotFatherä¼šè¿”å›ç»™ä½ ä¸€ä¸ªTokenï¼š</p><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic1.zhimg.com/v2-acafacc98568116d63d64a6f43ed0c0c_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"413\" data-rawheight=\"258\" class=\"content_image\" width=\"413\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;413&#39; height=&#39;258&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"413\" data-rawheight=\"258\" class=\"content_image lazy\" width=\"413\" data-actualsrc=\"https://pic1.zhimg.com/v2-acafacc98568116d63d64a6f43ed0c0c_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>æ¯”å¦‚æˆ‘åˆ›å»ºäº†ä¸€ä¸ªå«<code>hetai5_bot</code>çš„botï¼Œç°åœ¨åœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬<code>@hetai5_bot</code>è¿›è¡Œä»»ä½•å¯¹è¯ï¼Œbotå¹¶ä¸ä¼šè¿›è¡Œå“åº”ï¼š </p><figure data-size=\"normal\"><noscript><img src=\"https://pic1.zhimg.com/v2-33d60a89875fafa98e3ede0b2c1239a8_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"500\" data-rawheight=\"524\" class=\"origin_image zh-lightbox-thumb\" width=\"500\" data-original=\"https://pic1.zhimg.com/v2-33d60a89875fafa98e3ede0b2c1239a8_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;500&#39; height=&#39;524&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"500\" data-rawheight=\"524\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"500\" data-original=\"https://pic1.zhimg.com/v2-33d60a89875fafa98e3ede0b2c1239a8_r.jpg\" data-actualsrc=\"https://pic1.zhimg.com/v2-33d60a89875fafa98e3ede0b2c1239a8_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>æˆ‘ä»¬éœ€è¦åœ¨æœ¬åœ°ç¼–å†™é€»è¾‘ï¼Œæ‰èƒ½å“åº”ç”¨æˆ·çš„å„ç§è¾“å…¥</p><h3>å®ç°äº¤äº’</h3><p>æ–°å»ºä¸€ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹<code>mkdir bot</code>ï¼Œ<code>npm init -y</code> ç„¶åå®‰è£…ä¾èµ–<code>npm i node-telegram-bot-api</code></p><p>æ–°å»ºä¸€ä¸ª<code>index.js</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">TelegramBot</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;node-telegram-bot-api&#39;</span><span class=\"p\">);</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">token</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;å¡«å…¥ä½ çš„token&#39;</span><span class=\"p\">;</span>\n<span class=\"k\">const</span> <span class=\"nx\">bot</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">TelegramBot</span><span class=\"p\">(</span><span class=\"nx\">token</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n  <span class=\"nx\">polling</span><span class=\"o\">:</span> <span class=\"kc\">true</span>\n<span class=\"p\">});</span>\n\n\n\n<span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">onText</span><span class=\"p\">(</span><span class=\"sr\">/\\/hentai/</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"nx\">onLoveText</span><span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">.</span><span class=\"nx\">chat</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Are you a hetai?&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n\n\n<span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">onText</span><span class=\"p\">(</span><span class=\"sr\">/\\/echo (.+)/</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">,</span> <span class=\"nx\">match</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n\n  <span class=\"k\">const</span> <span class=\"nx\">chatId</span> <span class=\"o\">=</span> <span class=\"nx\">msg</span><span class=\"p\">.</span><span class=\"nx\">chat</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">;</span>\n  <span class=\"k\">const</span> <span class=\"nx\">resp</span> <span class=\"o\">=</span> <span class=\"nx\">match</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">];</span>\n  <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">chatId</span><span class=\"p\">,</span> <span class=\"nx\">resp</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n</code></pre></div><p>ç„¶å<code>node index.js</code>å¯åŠ¨æ–‡ä»¶ï¼Œè¿™æ ·å°±æˆåŠŸäº†å—ï¼Ÿ</p><p>å¾ˆå¯æƒœï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä»£ç é‡Œæ‰‹åŠ¨åŠ ä¸Šä»£ç†(æ¯”å¦‚ss)</p><p><code>npm i socks5-https-client</code></p><p>ä¿®æ”¹ä»£ç ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">TelegramBot</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;node-telegram-bot-api&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">Agent</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;socks5-https-client/lib/Agent&#39;</span><span class=\"p\">);</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">token</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;å¡«å…¥ä½ çš„token&#39;</span><span class=\"p\">;</span>\n<span class=\"k\">const</span> <span class=\"nx\">bot</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">TelegramBot</span><span class=\"p\">(</span><span class=\"nx\">token</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n  <span class=\"nx\">polling</span><span class=\"o\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n  <span class=\"nx\">request</span><span class=\"o\">:</span> <span class=\"p\">{</span> <span class=\"c1\">// è®¾ç½®ä»£ç†\n</span><span class=\"c1\"></span>    <span class=\"nx\">agentClass</span><span class=\"o\">:</span> <span class=\"nx\">Agent</span><span class=\"p\">,</span>\n    <span class=\"nx\">agentOptions</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n      <span class=\"nx\">socksPassword</span><span class=\"o\">:</span> <span class=\"s1\">&#39;å¡«å…¥ä½ ä»£ç†çš„å¯†ç &#39;</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">});</span>\n\n<span class=\"c1\">// åŒ¹é…/hentai\n</span><span class=\"c1\"></span><span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">onText</span><span class=\"p\">(</span><span class=\"sr\">/\\/hentai/</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"nx\">onLoveText</span><span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">.</span><span class=\"nx\">chat</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Are you a hetai?&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n\n\n<span class=\"c1\">// åŒ¹é…/echo\n</span><span class=\"c1\"></span><span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">onText</span><span class=\"p\">(</span><span class=\"sr\">/\\/echo (.+)/</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">,</span> <span class=\"nx\">match</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n\n  <span class=\"k\">const</span> <span class=\"nx\">chatId</span> <span class=\"o\">=</span> <span class=\"nx\">msg</span><span class=\"p\">.</span><span class=\"nx\">chat</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">;</span>\n  <span class=\"k\">const</span> <span class=\"nx\">resp</span> <span class=\"o\">=</span> <span class=\"nx\">match</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">];</span>\n  <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">chatId</span><span class=\"p\">,</span> <span class=\"nx\">resp</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n</code></pre></div><p>è¿™æ¬¡å†å’Œbotå¯¹è¯ï¼Œå°±å®ç°äº†å¯¹è¯åŠŸèƒ½äº†ï¼ </p><figure data-size=\"normal\"><noscript><img src=\"https://pic2.zhimg.com/v2-071dac7462c9dd2816eb5e02873fd321_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"503\" data-rawheight=\"471\" class=\"origin_image zh-lightbox-thumb\" width=\"503\" data-original=\"https://pic2.zhimg.com/v2-071dac7462c9dd2816eb5e02873fd321_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;503&#39; height=&#39;471&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"503\" data-rawheight=\"471\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"503\" data-original=\"https://pic2.zhimg.com/v2-071dac7462c9dd2816eb5e02873fd321_r.jpg\" data-actualsrc=\"https://pic2.zhimg.com/v2-071dac7462c9dd2816eb5e02873fd321_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>å½“ç„¶æˆ‘ä»¬å¯ä»¥å†åŠ ç‚¹åŠŸèƒ½ï¼Œæ¯”å¦‚ç”¨æˆ·è¾“å…¥<code>/prpr</code>ï¼Œå°±ä»ç½‘ä¸Šæ‰¾ä¸€å¼ å›¾ç‰‡å‘ç»™ç”¨æˆ·</p><p><code>npm i request</code></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">TelegramBot</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;node-telegram-bot-api&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">Agent</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;socks5-https-client/lib/Agent&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">request</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;request&#39;</span><span class=\"p\">);</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">token</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;å¡«å…¥ä½ çš„token&#39;</span><span class=\"p\">;</span>\n<span class=\"k\">const</span> <span class=\"nx\">bot</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">TelegramBot</span><span class=\"p\">(</span><span class=\"nx\">token</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n  <span class=\"nx\">polling</span><span class=\"o\">:</span> <span class=\"kc\">true</span><span class=\"p\">,</span>\n  <span class=\"nx\">request</span><span class=\"o\">:</span> <span class=\"p\">{</span> <span class=\"c1\">// è®¾ç½®ä»£ç†\n</span><span class=\"c1\"></span>    <span class=\"nx\">agentClass</span><span class=\"o\">:</span> <span class=\"nx\">Agent</span><span class=\"p\">,</span>\n    <span class=\"nx\">agentOptions</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n      <span class=\"nx\">socksPassword</span><span class=\"o\">:</span> <span class=\"s1\">&#39;å¡«å…¥ä½ ç™»æ¢¯å­æ—¶çš„å¯†ç &#39;</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">});</span>\n\n\n<span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">onText</span><span class=\"p\">(</span><span class=\"sr\">/\\/hentai/</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"nx\">onLoveText</span><span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">.</span><span class=\"nx\">chat</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Are you a hetai?&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">onText</span><span class=\"p\">(</span><span class=\"sr\">/\\/prpr/</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"nx\">onLoveText</span><span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">const</span> <span class=\"nx\">chatId</span> <span class=\"o\">=</span> <span class=\"nx\">msg</span><span class=\"p\">.</span><span class=\"nx\">chat</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">;</span>\n  <span class=\"nx\">request</span><span class=\"p\">(</span><span class=\"s1\">&#39;https://konachan.com/post.json?tags=ass&amp;limit=50&#39;</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">error</span><span class=\"p\">,</span> <span class=\"nx\">response</span><span class=\"p\">,</span> <span class=\"nx\">body</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"nx\">error</span> <span class=\"o\">&amp;&amp;</span> <span class=\"nx\">response</span><span class=\"p\">.</span><span class=\"nx\">statusCode</span> <span class=\"o\">==</span> <span class=\"mi\">200</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"k\">const</span> <span class=\"nx\">result</span> <span class=\"o\">=</span> <span class=\"nx\">JSON</span><span class=\"p\">.</span><span class=\"nx\">parse</span><span class=\"p\">(</span><span class=\"nx\">body</span><span class=\"p\">)</span> <span class=\"o\">||</span> <span class=\"p\">[];</span>\n      <span class=\"k\">const</span> <span class=\"nx\">index</span> <span class=\"o\">=</span> <span class=\"nb\">parseInt</span><span class=\"p\">(</span><span class=\"nb\">Math</span><span class=\"p\">.</span><span class=\"nx\">random</span><span class=\"p\">()</span> <span class=\"o\">*</span> <span class=\"nx\">result</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">);</span>\n      <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendPhoto</span><span class=\"p\">(</span><span class=\"nx\">chatId</span><span class=\"p\">,</span> <span class=\"nx\">result</span><span class=\"p\">[</span><span class=\"nx\">index</span><span class=\"p\">].</span><span class=\"nx\">file_url</span><span class=\"p\">,</span> <span class=\"p\">{</span> <span class=\"nx\">caption</span><span class=\"o\">:</span> <span class=\"s1\">&#39;æ‰‹å†²ä¸€æ—¶çˆ½ï¼Œä¸€ç›´æ‰‹å†²ä¸€ç›´çˆ½&#39;</span> <span class=\"p\">}).</span><span class=\"k\">catch</span><span class=\"p\">((</span><span class=\"nx\">err</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">chatId</span><span class=\"p\">,</span> <span class=\"s1\">&#39;æ‰‹å†²å¤±è´¥&#39;</span><span class=\"p\">);</span>\n      <span class=\"p\">})</span>\n    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n      <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">chatId</span><span class=\"p\">,</span> <span class=\"s1\">&#39;æ‰‹å†²å¤±è´¥&#39;</span><span class=\"p\">);</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">});</span>\n<span class=\"p\">});</span>\n\n\n<span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">onText</span><span class=\"p\">(</span><span class=\"sr\">/\\/echo (.+)/</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">,</span> <span class=\"nx\">match</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n\n  <span class=\"k\">const</span> <span class=\"nx\">chatId</span> <span class=\"o\">=</span> <span class=\"nx\">msg</span><span class=\"p\">.</span><span class=\"nx\">chat</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">;</span>\n  <span class=\"k\">const</span> <span class=\"nx\">resp</span> <span class=\"o\">=</span> <span class=\"nx\">match</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">];</span>\n  <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">chatId</span><span class=\"p\">,</span> <span class=\"nx\">resp</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n</code></pre></div><figure data-size=\"normal\"><noscript><img src=\"https://pic1.zhimg.com/v2-3482fd5f3f77414d9b540485123f80b8_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"501\" data-rawheight=\"389\" class=\"origin_image zh-lightbox-thumb\" width=\"501\" data-original=\"https://pic1.zhimg.com/v2-3482fd5f3f77414d9b540485123f80b8_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;501&#39; height=&#39;389&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"501\" data-rawheight=\"389\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"501\" data-original=\"https://pic1.zhimg.com/v2-3482fd5f3f77414d9b540485123f80b8_r.jpg\" data-actualsrc=\"https://pic1.zhimg.com/v2-3482fd5f3f77414d9b540485123f80b8_b.jpg\"/></figure><h3>polling VS webhook</h3><p>æˆ‘ä»¬å¼€å‘çš„botæ˜¯æ€ä¹ˆçŸ¥é“ç”¨æˆ·å‘é€äº†å“ªäº›å‘½ä»¤ï¼Ÿ</p><p>Telegram botæœ‰ä¸¤ç§è·å–ç”¨æˆ·å‘é€å‘½ä»¤çš„æ–¹å¼ï¼Œä¸€ç§æ˜¯<code>polling</code>æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯è½®è¯¢ã€‚æˆ‘ä»¬çš„botéœ€è¦æ¯éš”ä¸€æ®µæ—¶é—´ï¼Œå°±å‘TelegramæœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè¯¢é—®æœ€è¿‘ç”¨æˆ·å‘è¿‡æ¥äº†å“ªäº›å‘½ä»¤ã€‚è¿™ç§æ–¹å¼çš„å¥½å¤„å°±æ˜¯ä¾¿äºåœ¨æœ¬åœ°è°ƒè¯•ï¼Œæˆ‘ä»¬åˆšæ‰çš„ä»£ç ä½¿ç”¨çš„å°±æ˜¯è¿™ç§æ¨¡å¼ã€‚åå¤„å°±æ˜¯æ¯éš”ä¸€æ®µæ—¶é—´å°±è¦ä¸»åŠ¨å‘é€è¯·æ±‚ï¼Œå³ä½¿æœ€è¿‘å¯èƒ½æ²¡æœ‰ä»»ä½•ç”¨æˆ·å‘é€å‘½ä»¤ã€‚</p><p>å¦å¤–ä¸€ç§æ¨¡å¼å°±æ˜¯<code>webhook</code>ï¼Œæˆ‘ä»¬éœ€è¦ç»™botè®¾ç½®ä¸€ä¸ªwebhookåœ°å€ï¼Œæ¯”å¦‚è¯´<code>https://hentai.com/bot123</code>ã€‚è¿™æ ·ï¼Œæ¯æ¬¡å½“ç”¨æˆ·å‘botè¾“å…¥å‘½ä»¤æ—¶ï¼ŒTelegramå°±ä¼šæŠŠè¿™æ¬¡çš„å‘½ä»¤è½¬å‘åˆ°<code>https://hentai.com/bot123</code>ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨<code>https://hentai.com/bot123</code>éƒ¨ç½²æˆ‘ä»¬çš„botã€‚è¿™ç§æ¨¡å¼çš„å¥½å¤„å°±æ˜¯å¯ä»¥åŠæ—¶å“åº”ç”¨æˆ·çš„å‘½ä»¤ï¼Œåå¤„å°±æ˜¯æœ¬åœ°è°ƒè¯•éº»çƒ¦ï¼Œå¯èƒ½éœ€è¦<code>ngrock</code>è¿™ç§å†…ç½‘ç©¿é€å·¥å…·ã€‚åŒæ—¶åœ¨çº¿ä¸Šéƒ¨ç½²æ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æœ‰è‡ªå·±çš„åŸŸåå¹¶ä¸”è¦æ”¯æŒhttps!!!</p><h3>çº¿ä¸Šéƒ¨ç½²</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æœ‰ä¸€å°<b>å›½å¤–æœåŠ¡å™¨ï¼Œ</b>ä½ è¿˜éœ€è¦æœ‰ä¸€äº›ç®€å•çš„linuxåŸºç¡€çŸ¥è¯†ï¼Œå¦‚æœä½ å®Œå…¨ä¸ä¼šï¼Œæ¨èä½ çœ‹ä¸‹æˆ‘ä¹‹å‰å†™è¿‡çš„ä¸€ç¯‡æ–‡ç« </p><a href=\"https://link.zhihu.com/?target=http%3A//anata.me/2018/05/09/%25E5%2586%2599%25E7%25BB%2599%25E5%2589%258D%25E7%25AB%25AF%25E5%25B0%258F%25E7%2599%25BD%25E7%259C%258B%25E7%259A%2584linux%25E9%2583%25A8%25E7%25BD%25B2%25E5%259F%25BA%25E7%25A1%2580%25E7%259F%25A5%25E8%25AF%2586/\" data-draft-node=\"block\" data-draft-type=\"link-card\" data-image=\"https://pic1.zhimg.com/v2-51ae83bc59bbddc82faf75390ec33b30_180x120.jpg\" data-image-width=\"1514\" data-image-height=\"151\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">å†™ç»™å‰ç«¯å°ç™½çœ‹çš„linuxéƒ¨ç½²åŸºç¡€çŸ¥è¯†</a><p>æˆ‘è¿™é‡Œå®‰è£…çš„æ“ä½œç³»ç»Ÿæ˜¯centos 7 X64</p><p>å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†å›½å¤–çš„æœåŠ¡å™¨ï¼Œæ‰€ä»¥ä»£ç é‡Œé¢çš„httpä»£ç†å¯ä»¥å»æ‰äº†:</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">TelegramBot</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;node-telegram-bot-api&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">request</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;request&#39;</span><span class=\"p\">);</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">token</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;ä½ çš„token&#39;</span><span class=\"p\">;</span>\n<span class=\"k\">const</span> <span class=\"nx\">bot</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">TelegramBot</span><span class=\"p\">(</span><span class=\"nx\">token</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n  <span class=\"nx\">polling</span><span class=\"o\">:</span> <span class=\"kc\">true</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">onText</span><span class=\"p\">(</span><span class=\"sr\">/\\/hentai/</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"nx\">onLoveText</span><span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">.</span><span class=\"nx\">chat</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Are you a hetai?&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">onText</span><span class=\"p\">(</span><span class=\"sr\">/\\/prpr/</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"nx\">onLoveText</span><span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">const</span> <span class=\"nx\">chatId</span> <span class=\"o\">=</span> <span class=\"nx\">msg</span><span class=\"p\">.</span><span class=\"nx\">chat</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">;</span>\n  <span class=\"nx\">request</span><span class=\"p\">(</span><span class=\"s1\">&#39;https://konachan.com/post.json?tags=ass&amp;limit=50&#39;</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">error</span><span class=\"p\">,</span> <span class=\"nx\">response</span><span class=\"p\">,</span> <span class=\"nx\">body</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"nx\">error</span> <span class=\"o\">&amp;&amp;</span> <span class=\"nx\">response</span><span class=\"p\">.</span><span class=\"nx\">statusCode</span> <span class=\"o\">==</span> <span class=\"mi\">200</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"k\">const</span> <span class=\"nx\">result</span> <span class=\"o\">=</span> <span class=\"nx\">JSON</span><span class=\"p\">.</span><span class=\"nx\">parse</span><span class=\"p\">(</span><span class=\"nx\">body</span><span class=\"p\">)</span> <span class=\"o\">||</span> <span class=\"p\">[];</span>\n      <span class=\"k\">const</span> <span class=\"nx\">index</span> <span class=\"o\">=</span> <span class=\"nb\">parseInt</span><span class=\"p\">(</span><span class=\"nb\">Math</span><span class=\"p\">.</span><span class=\"nx\">random</span><span class=\"p\">()</span> <span class=\"o\">*</span> <span class=\"nx\">result</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">);</span>\n      <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendPhoto</span><span class=\"p\">(</span><span class=\"nx\">chatId</span><span class=\"p\">,</span> <span class=\"nx\">result</span><span class=\"p\">[</span><span class=\"nx\">index</span><span class=\"p\">].</span><span class=\"nx\">file_url</span><span class=\"p\">,</span> <span class=\"p\">{</span> <span class=\"nx\">caption</span><span class=\"o\">:</span> <span class=\"s1\">&#39;æ‰‹å†²ä¸€æ—¶çˆ½ï¼Œä¸€ç›´æ‰‹å†²ä¸€ç›´çˆ½&#39;</span> <span class=\"p\">}).</span><span class=\"k\">catch</span><span class=\"p\">((</span><span class=\"nx\">err</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">chatId</span><span class=\"p\">,</span> <span class=\"s1\">&#39;æ‰‹å†²å¤±è´¥&#39;</span><span class=\"p\">);</span>\n      <span class=\"p\">})</span>\n    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n      <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">chatId</span><span class=\"p\">,</span> <span class=\"s1\">&#39;æ‰‹å†²å¤±è´¥&#39;</span><span class=\"p\">);</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">});</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">onText</span><span class=\"p\">(</span><span class=\"sr\">/\\/echo (.+)/</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">,</span> <span class=\"nx\">match</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"k\">const</span> <span class=\"nx\">chatId</span> <span class=\"o\">=</span> <span class=\"nx\">msg</span><span class=\"p\">.</span><span class=\"nx\">chat</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">;</span>\n  <span class=\"k\">const</span> <span class=\"nx\">resp</span> <span class=\"o\">=</span> <span class=\"nx\">match</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">];</span>\n  <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">chatId</span><span class=\"p\">,</span> <span class=\"nx\">resp</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n</code></pre></div><p>å®‰è£…åŸºç¡€ç»„ä»¶,nvm,node,pm2</p><div class=\"highlight\"><pre><code class=\"language-bash\">yum -y install gcc gcc-c++ autoconf pcre-devel make automake\nyum -y install wget httpd-tools vim\ncurl -o- https://raw.githubusercontent.com/creationix/nvm/v0.34.0/install.sh <span class=\"p\">|</span> bash\nnvm install <span class=\"m\">11</span>.0.0\nnpm i pm2 -g</code></pre></div><p>æŠŠæœ¬åœ°é¡¹ç›®ä¸Šä¼ åˆ°æœåŠ¡å™¨åï¼Œç›´æ¥è¿è¡Œ<code>pm2 start index.js --name bot</code>å³å¯</p><h3>åŸŸåæ”¯æŒhttps</h3><p>å‰é¢æˆ‘ä»¬è¯´è¿‡äº†ï¼Œ<code>polling</code>æ¨¡å¼çš„åå¤„å°±æ˜¯æµªè´¹èµ„æºï¼Œè€Œä¸”ä¸èƒ½åŠæ—¶å“åº”ç”¨æˆ·è¯·æ±‚</p><p><code>webhook</code>æ¨¡å¼ä¸‹ï¼Œéƒ¨ç½²æ¯”è¾ƒéº»çƒ¦ï¼Œå¦‚æœä¸å¸Œæœ›ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œå¯ä»¥å¿½ç•¥ä¸‹æ–‡</p><p>ä½¿ç”¨<code>webhook</code>çš„å‰ææ˜¯æˆ‘ä»¬æœ‰ä¸€ä¸ªè‡ªå®šä¹‰åŸŸåï¼ŒåŒæ—¶éœ€è¦æŠŠåŸŸåæŒ‡å‘æˆ‘ä»¬çš„vps</p><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic2.zhimg.com/v2-7a10ea587a01d6ac33ad2e121df28915_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"636\" data-rawheight=\"457\" class=\"origin_image zh-lightbox-thumb\" width=\"636\" data-original=\"https://pic2.zhimg.com/v2-7a10ea587a01d6ac33ad2e121df28915_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;636&#39; height=&#39;457&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"636\" data-rawheight=\"457\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"636\" data-original=\"https://pic2.zhimg.com/v2-7a10ea587a01d6ac33ad2e121df28915_r.jpg\" data-actualsrc=\"https://pic2.zhimg.com/v2-7a10ea587a01d6ac33ad2e121df28915_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>å¦‚å›¾ï¼Œæˆ‘æŠŠä¸€ä¸ªå­åŸŸå<code>hentai.urusai.site</code>æŒ‡å‘æˆ‘å½“å‰çš„vps IPåœ°å€</p><p>å®‰è£…<code>nginx</code></p><div class=\"highlight\"><pre><code class=\"language-bash\">vim /etc/yum.repos.d/nginx.repo</code></pre></div><p>å†™å…¥ï¼š</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"o\">[</span>nginx<span class=\"o\">]</span>\n<span class=\"nv\">name</span><span class=\"o\">=</span>nginx repo\n<span class=\"nv\">baseurl</span><span class=\"o\">=</span>http://nginx.org/packages/centos/7/<span class=\"nv\">$basearch</span>/\n<span class=\"nv\">gpgcheck</span><span class=\"o\">=</span><span class=\"m\">0</span>\n<span class=\"nv\">enabled</span><span class=\"o\">=</span><span class=\"m\">1</span></code></pre></div><p><code>:wq!</code>ä¿å­˜é€€å‡º</p><div class=\"highlight\"><pre><code class=\"language-bash\">yum install nginx</code></pre></div><p>è¿™æ ·å°±å®‰è£…äº†æœ€æ–°ç‰ˆæœ¬çš„nginx</p><p>è®¾ç½®é˜²ç«å¢™è§„åˆ™ï¼š</p><div class=\"highlight\"><pre><code class=\"language-bash\">firewall-cmd --add-service<span class=\"o\">=</span>http\nfirewall-cmd --add-service<span class=\"o\">=</span>https\nfirewall-cmd --runtime-to-permanent</code></pre></div><p>ä¿®æ”¹nginxé…ç½®ï¼š</p><div class=\"highlight\"><pre><code class=\"language-bash\">vim /etc/nginx/conf.d/default.conf</code></pre></div><p>æŠŠ<code>server_name localhost;</code>ä¿®æ”¹æˆåŸŸå<code>hentai.urusai.site</code>å³å¯</p><p>å®Œæˆåï¼Œå¼€å¯nginx:</p><div class=\"highlight\"><pre><code class=\"language-text\">nginx -s reload</code></pre></div><p>æµè§ˆå™¨è¾“å…¥<code>http://hentai.urusai.site</code>ï¼Œå°±åº”è¯¥æœ‰nginxæ¬¢è¿é¡µé¢äº†</p><p>ç°åœ¨æˆ‘ä»¬éœ€è¦æ”¯æŒhttps:</p><p>å®‰è£…<code>certbot</code></p><div class=\"highlight\"><pre><code class=\"language-bash\">yum install epel-release\nyum install certbot-nginx</code></pre></div><p>è·å–SSLè¯ä¹¦</p><div class=\"highlight\"><pre><code class=\"language-bash\">certbot --nginx</code></pre></div><p>æˆåŠŸå®Œæˆä¹‹åï¼Œæˆ‘ä»¬è®¿é—®<code>https://hentai.urusai.site</code>å°±å¯ä»¥æ­£å¸¸è¯·æ±‚äº†ï¼</p><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic2.zhimg.com/v2-11cbd054380246629956f9e28e34b56d_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1254\" data-rawheight=\"373\" class=\"origin_image zh-lightbox-thumb\" width=\"1254\" data-original=\"https://pic2.zhimg.com/v2-11cbd054380246629956f9e28e34b56d_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;1254&#39; height=&#39;373&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1254\" data-rawheight=\"373\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1254\" data-original=\"https://pic2.zhimg.com/v2-11cbd054380246629956f9e28e34b56d_r.jpg\" data-actualsrc=\"https://pic2.zhimg.com/v2-11cbd054380246629956f9e28e34b56d_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>è®¾ç½®è¯ä¹¦è‡ªåŠ¨ç»­æœŸ certboté¢å‘çš„è¯ä¹¦ï¼Œé»˜è®¤åªæœ‰3ä¸ªæœˆæœ‰æ•ˆæœŸï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è®¾ç½®è‡ªåŠ¨ç»­æœŸ æ¯å¤©æ—©ä¸Š5:15æ‰§è¡Œä»»åŠ¡</p><div class=\"highlight\"><pre><code class=\"language-bash\">crontab -e</code></pre></div><p>è¾“å…¥</p><div class=\"highlight\"><pre><code class=\"language-bash\"><span class=\"m\">15</span> <span class=\"m\">5</span> * * * certbot renew --quiet</code></pre></div><h3>nginxé…ç½®webhook</h3><p>Telegram botä½¿ç”¨<code>webhook</code>æ¨¡å¼æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ç°æœ‰çš„ä»£ç :</p><div class=\"highlight\"><pre><code class=\"language-text\">npm i express body-parser</code></pre></div><p class=\"ztext-empty-paragraph\"><br/></p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">TelegramBot</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;node-telegram-bot-api&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">express</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;express&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">bodyParser</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;body-parser&#39;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">request</span> <span class=\"o\">=</span> <span class=\"nx\">require</span><span class=\"p\">(</span><span class=\"s1\">&#39;request&#39;</span><span class=\"p\">);</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">TOKEN</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;ä½ çš„token&#39;</span><span class=\"p\">;</span>\n<span class=\"k\">const</span> <span class=\"nx\">url</span> <span class=\"o\">=</span> <span class=\"s1\">&#39;https://hentai.urusai.site&#39;</span><span class=\"p\">;</span> <span class=\"c1\">// ä½ è‡ªå·±çš„åŸŸå\n</span><span class=\"c1\"></span><span class=\"k\">const</span> <span class=\"nx\">port</span> <span class=\"o\">=</span> <span class=\"mi\">9000</span><span class=\"p\">;</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">bot</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">TelegramBot</span><span class=\"p\">(</span><span class=\"nx\">TOKEN</span><span class=\"p\">);</span>\n<span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">setWebHook</span><span class=\"p\">(</span><span class=\"sb\">`</span><span class=\"si\">${</span><span class=\"nx\">url</span><span class=\"si\">}</span><span class=\"sb\">/bot</span><span class=\"si\">${</span><span class=\"nx\">TOKEN</span><span class=\"si\">}</span><span class=\"sb\">`</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">app</span> <span class=\"o\">=</span> <span class=\"nx\">express</span><span class=\"p\">();</span>\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">use</span><span class=\"p\">(</span><span class=\"nx\">bodyParser</span><span class=\"p\">.</span><span class=\"nx\">json</span><span class=\"p\">());</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;/&#39;</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">send</span><span class=\"p\">(</span><span class=\"s1\">&#39;Hello World!&#39;</span><span class=\"p\">));</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">post</span><span class=\"p\">(</span><span class=\"sb\">`/bot</span><span class=\"si\">${</span><span class=\"nx\">TOKEN</span><span class=\"si\">}</span><span class=\"sb\">`</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">,</span> <span class=\"nx\">res</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">processUpdate</span><span class=\"p\">(</span><span class=\"nx\">req</span><span class=\"p\">.</span><span class=\"nx\">body</span><span class=\"p\">);</span>\n  <span class=\"nx\">res</span><span class=\"p\">.</span><span class=\"nx\">sendStatus</span><span class=\"p\">(</span><span class=\"mi\">200</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">app</span><span class=\"p\">.</span><span class=\"nx\">listen</span><span class=\"p\">(</span><span class=\"nx\">port</span><span class=\"p\">,</span> <span class=\"p\">()</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n  <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"sb\">`Express server is listening on </span><span class=\"si\">${</span><span class=\"nx\">port</span><span class=\"si\">}</span><span class=\"sb\">`</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n\n\n<span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">onText</span><span class=\"p\">(</span><span class=\"sr\">/\\/hentai/</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"nx\">onLoveText</span><span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">.</span><span class=\"nx\">chat</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Are you a hetai?&#39;</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n\n<span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">onText</span><span class=\"p\">(</span><span class=\"sr\">/\\/prpr/</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"nx\">onLoveText</span><span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">const</span> <span class=\"nx\">chatId</span> <span class=\"o\">=</span> <span class=\"nx\">msg</span><span class=\"p\">.</span><span class=\"nx\">chat</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">;</span>\n  <span class=\"nx\">request</span><span class=\"p\">(</span><span class=\"s1\">&#39;https://konachan.com/post.json?tags=ass&amp;limit=50&#39;</span><span class=\"p\">,</span> <span class=\"kd\">function</span> <span class=\"p\">(</span><span class=\"nx\">error</span><span class=\"p\">,</span> <span class=\"nx\">response</span><span class=\"p\">,</span> <span class=\"nx\">body</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"o\">!</span><span class=\"nx\">error</span> <span class=\"o\">&amp;&amp;</span> <span class=\"nx\">response</span><span class=\"p\">.</span><span class=\"nx\">statusCode</span> <span class=\"o\">==</span> <span class=\"mi\">200</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n      <span class=\"k\">const</span> <span class=\"nx\">result</span> <span class=\"o\">=</span> <span class=\"nx\">JSON</span><span class=\"p\">.</span><span class=\"nx\">parse</span><span class=\"p\">(</span><span class=\"nx\">body</span><span class=\"p\">)</span> <span class=\"o\">||</span> <span class=\"p\">[];</span>\n      <span class=\"k\">const</span> <span class=\"nx\">index</span> <span class=\"o\">=</span> <span class=\"nb\">parseInt</span><span class=\"p\">(</span><span class=\"nb\">Math</span><span class=\"p\">.</span><span class=\"nx\">random</span><span class=\"p\">()</span> <span class=\"o\">*</span> <span class=\"nx\">result</span><span class=\"p\">.</span><span class=\"nx\">length</span><span class=\"p\">);</span>\n      <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendPhoto</span><span class=\"p\">(</span><span class=\"nx\">chatId</span><span class=\"p\">,</span> <span class=\"nx\">result</span><span class=\"p\">[</span><span class=\"nx\">index</span><span class=\"p\">].</span><span class=\"nx\">file_url</span><span class=\"p\">,</span> <span class=\"p\">{</span> <span class=\"nx\">caption</span><span class=\"o\">:</span> <span class=\"s1\">&#39;æ‰‹å†²ä¸€æ—¶çˆ½ï¼Œä¸€ç›´æ‰‹å†²ä¸€ç›´çˆ½&#39;</span> <span class=\"p\">}).</span><span class=\"k\">catch</span><span class=\"p\">((</span><span class=\"nx\">err</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n        <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">chatId</span><span class=\"p\">,</span> <span class=\"s1\">&#39;æ‰‹å†²å¤±è´¥&#39;</span><span class=\"p\">);</span>\n      <span class=\"p\">})</span>\n    <span class=\"p\">}</span> <span class=\"k\">else</span> <span class=\"p\">{</span>\n      <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">chatId</span><span class=\"p\">,</span> <span class=\"s1\">&#39;æ‰‹å†²å¤±è´¥&#39;</span><span class=\"p\">);</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">});</span>\n<span class=\"p\">});</span>\n\n\n<span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">onText</span><span class=\"p\">(</span><span class=\"sr\">/\\/echo (.+)/</span><span class=\"p\">,</span> <span class=\"p\">(</span><span class=\"nx\">msg</span><span class=\"p\">,</span> <span class=\"nx\">match</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"p\">{</span>\n\n  <span class=\"k\">const</span> <span class=\"nx\">chatId</span> <span class=\"o\">=</span> <span class=\"nx\">msg</span><span class=\"p\">.</span><span class=\"nx\">chat</span><span class=\"p\">.</span><span class=\"nx\">id</span><span class=\"p\">;</span>\n  <span class=\"k\">const</span> <span class=\"nx\">resp</span> <span class=\"o\">=</span> <span class=\"nx\">match</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">];</span>\n  <span class=\"nx\">bot</span><span class=\"p\">.</span><span class=\"nx\">sendMessage</span><span class=\"p\">(</span><span class=\"nx\">chatId</span><span class=\"p\">,</span> <span class=\"nx\">resp</span><span class=\"p\">);</span>\n<span class=\"p\">});</span>\n</code></pre></div><p>ç„¶åé‡æ–°å¯åŠ¨pm2 </p><div class=\"highlight\"><pre><code class=\"language-text\">pm2 restart bot</code></pre></div><p>ä¿®æ”¹nginxé…ç½®</p><div class=\"highlight\"><pre><code class=\"language-text\">vim /etc/nginx/conf.d/default.conf</code></pre></div><p>æŠŠ<code>https://hentai.urusai.site</code>è½¬å‘åˆ°æˆ‘ä»¬åˆšæ‰expresså¯åŠ¨çš„æœåŠ¡å™¨ä¸Š</p><div class=\"highlight\"><pre><code class=\"language-text\">location / {\n    proxy_pass http://127.0.0.1:9000;\n    proxy_http_version 1.1;\n    proxy_set_header X_FORWARDED_PROTO https;\n    proxy_set_header X-Real-IP $remote_addr;\n    proxy_set_header X-Forwarded-For $remote_addr;\n    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    proxy_set_header Host $host;\n\n}</code></pre></div><p class=\"ztext-empty-paragraph\"><br/></p><div class=\"highlight\"><pre><code class=\"language-text\">nginx -s reload</code></pre></div><p>é‡å¯nginxæˆåŠŸåï¼Œè®¿é—®<code>https://hentai.urusai.site/</code>åº”è¯¥å°±å±•ç¤ºexpressæœåŠ¡å™¨è¿”å›çš„<code>hello world</code></p><p>åŒæ—¶ï¼Œæˆ‘ä»¬Telegram botçš„<code>webhook</code>æ¨¡å¼ä¹Ÿè®¾ç½®æˆåŠŸäº†</p><p>å†æ¬¡è®¿é—®botï¼Œè¾“å…¥<code>/prpr</code>ï¼Œä¾ç„¶å¯ä»¥æ‰‹å†²äº†</p><h3>botå®šæ—¶å‘é€æ¶ˆæ¯</h3><p>boté™¤äº†å½“ç”¨æˆ·è¾“å…¥å‘½ä»¤æ—¶ï¼Œæˆ‘ä»¬åšå‡ºç›¸åº”çš„æ“ä½œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®šæ—¶è®©botå‘ç‰¹å®šçš„æ¸ é“å‘é€æ¶ˆæ¯</p><p>æ¯”å¦‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªchannelï¼Œç„¶åé‚€è¯·botæˆä¸ºç®¡ç†å‘˜ï¼Œè®©botæ¯å¤©10ç‚¹å‘é€ä¸€æ¡å¤©æ°”é¢„æŠ¥ï¼Œè¿™æ ·æ‰€æœ‰è®¢é˜…äº†è¿™ä¸ªchannelçš„ç”¨æˆ·ï¼Œéƒ½å¯ä»¥æ”¶åˆ°æ¶ˆæ¯äº†ï¼</p><h3>æœ€å</h3><p>æœ€è¿‘æˆ‘ä¹Ÿåšäº†ä¸€ä¸ª<a href=\"https://link.zhihu.com/?target=https%3A//github.com/deepred5/yande-telegram-bot\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">Telegram Bot</a>ï¼Œç”¨äºæŠ“å–<a href=\"https://link.zhihu.com/?target=https%3A//yande.re/post\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">yande.re</a>ä¸Šé¢çš„å›¾ç‰‡</p><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic4.zhimg.com/v2-088023a20325339aec412d0df2a84e2f_b.png\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"484\" data-rawheight=\"75\" class=\"origin_image zh-lightbox-thumb\" width=\"484\" data-original=\"https://pic4.zhimg.com/v2-088023a20325339aec412d0df2a84e2f_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;484&#39; height=&#39;75&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"484\" data-rawheight=\"75\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"484\" data-original=\"https://pic4.zhimg.com/v2-088023a20325339aec412d0df2a84e2f_r.jpg\" data-actualsrc=\"https://pic4.zhimg.com/v2-088023a20325339aec412d0df2a84e2f_b.png\"/></figure><p></p>", 
            "topic": [
                {
                    "tag": "Telegram", 
                    "tagLink": "https://api.zhihu.com/topics/19924266"
                }, 
                {
                    "tag": "chatbot", 
                    "tagLink": "https://api.zhihu.com/topics/20062496"
                }
            ], 
            "comments": [
                {
                    "userName": "æ‰©æ•£æ€§ç™¾ä¸‡ç”œé¢åŒ…", 
                    "userLink": "https://www.zhihu.com/people/c5f581c2e6cac28fe4ee1cacf9f82c44", 
                    "content": "<p>å¥½å›¾</p>", 
                    "likes": 1, 
                    "childComments": [
                        {
                            "userName": "æ·±çº¢", 
                            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
                            "content": "<p>è‰²å›¾è™½å¥½ï¼Œå¯ä¸è¦æ‰‹å†²ã€‚åˆšè¢«äººä¸¾æŠ¥äº†ï¼Œåªèƒ½æŠŠå›¾ç‰‡å…¨æ’¤äº†ã€‚ã€‚ã€‚ã€‚</p>", 
                            "likes": 2, 
                            "replyToAuthor": "æ‰©æ•£æ€§ç™¾ä¸‡ç”œé¢åŒ…"
                        }
                    ]
                }, 
                {
                    "userName": "åœ°ç“œ", 
                    "userLink": "https://www.zhihu.com/people/7b68a9fc1a5d081a77342cf6251eb208", 
                    "content": "<p>æ”¶è—äº†</p>", 
                    "likes": 0, 
                    "childComments": [
                        {
                            "userName": "æ·±çº¢", 
                            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
                            "content": "<p>ä¸€æ—©èµ·æ¥ï¼Œå‘ç°æ–‡ç« è¢«ä¸¾æŠ¥ï¼Œå¿§ä¼¤</p>", 
                            "likes": 0, 
                            "replyToAuthor": "åœ°ç“œ"
                        }, 
                        {
                            "userName": "åœ°ç“œ", 
                            "userLink": "https://www.zhihu.com/people/7b68a9fc1a5d081a77342cf6251eb208", 
                            "content": "å“­äº†ï¼Œå›¾è¿˜æ²¡ä¿å­˜", 
                            "likes": 0, 
                            "replyToAuthor": "æ·±çº¢"
                        }
                    ]
                }
            ]
        }, 
        {
            "url": "https://zhuanlan.zhihu.com/p/59770940", 
            "userName": "æ·±çº¢", 
            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
            "upvote": 6, 
            "title": "é‡æ‹¾JSX", 
            "content": "<p><b>React.createElementè¯­æ³•ç³–</b></p><p><a href=\"https://link.zhihu.com/?target=https%3A//reactjs.org/docs/introducing-jsx.html\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">JSX</a>æ˜¯ä¸€ç§JavaScriptçš„è¯­æ³•æ‹“å±•ï¼Œå¯ä»¥ä½¿ç”¨å®ƒæ¥è¿›è¡ŒUIçš„å±•ç¤ºï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">element</span> <span class=\"o\">=</span> <span class=\"o\">&lt;</span><span class=\"nx\">h1</span><span class=\"o\">&gt;</span><span class=\"nx\">Hello</span><span class=\"p\">,</span> <span class=\"nx\">world</span><span class=\"o\">!&lt;</span><span class=\"err\">/h1&gt;;</span>\n</code></pre></div><p>æˆ‘ä»¬ä¸€èˆ¬ä¼šåœ¨ç»„ä»¶çš„<code>render</code>æ–¹æ³•é‡Œä½¿ç”¨JSXè¿›è¡Œå¸ƒå±€å’Œäº‹ä»¶ç»‘å®š:</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">class</span> <span class=\"nx\">Home</span> <span class=\"k\">extends</span> <span class=\"nx\">Component</span> <span class=\"p\">{</span>\n  <span class=\"nx\">render</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"p\">(</span>\n      <span class=\"o\">&lt;</span><span class=\"nx\">div</span> <span class=\"nx\">onClick</span><span class=\"o\">=</span><span class=\"p\">{()</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;hello&#39;</span><span class=\"p\">)}</span><span class=\"o\">&gt;</span>\n        <span class=\"o\">&lt;</span><span class=\"nx\">h1</span><span class=\"o\">&gt;</span><span class=\"nx\">Hello</span><span class=\"p\">,</span> <span class=\"nx\">world</span><span class=\"o\">!&lt;</span><span class=\"err\">/h1&gt;</span>\n        <span class=\"o\">&lt;</span><span class=\"nx\">Blog</span> <span class=\"nx\">title</span><span class=\"o\">=</span><span class=\"s2\">&#34;deepred&#34;</span> <span class=\"o\">/&gt;</span>\n      <span class=\"o\">&lt;</span><span class=\"err\">/div&gt;</span>\n    <span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>Reactçš„æ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€å°±æ˜¯å¯ä»¥åˆ›å»ºè™šæ‹Ÿçš„DOMå…ƒç´ ï¼Œåˆ©ç”¨è™šæ‹ŸDOMæ¥å‡å°‘å¯¹å®é™…DOMçš„æ“ä½œä»è€Œæå‡æ€§èƒ½ï¼ŒJSXæ­£æ˜¯ä¸ºäº†è™šæ‹ŸDOMè€Œå­˜åœ¨çš„è¯­æ³•ç³–</p><p>æˆ‘ä»¬åœ¨å¹³æ—¶çš„ç»„ä»¶ç¼–å†™ä¸­ï¼Œé€šå¸¸éƒ½è¿™ä¹ˆå†™:</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">import</span> <span class=\"nx\">React</span><span class=\"p\">,</span> <span class=\"p\">{</span> <span class=\"nx\">Component</span> <span class=\"p\">}</span> <span class=\"nx\">from</span> <span class=\"s1\">&#39;react&#39;</span><span class=\"p\">;</span>\n\n<span class=\"k\">class</span> <span class=\"nx\">Demo</span> <span class=\"k\">extends</span> <span class=\"nx\">Component</span> <span class=\"p\">{</span>\n  <span class=\"nx\">render</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"p\">(</span>\n      <span class=\"o\">&lt;</span><span class=\"nx\">h1</span><span class=\"o\">&gt;</span><span class=\"nx\">Hello</span><span class=\"p\">,</span> <span class=\"nx\">world</span><span class=\"o\">!&lt;</span><span class=\"err\">/h1&gt;</span>\n    <span class=\"p\">)</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>ç„¶è€Œä»£ç é‡Œé¢å¹¶æ²¡æœ‰ç”¨åˆ°Reactï¼Œä¸ºä»€ä¹ˆè¦å¼•å…¥è¿™ä¸ªå˜é‡å‘¢ï¼Ÿ</p><p>å› ä¸ºJSXæ˜¯<code>React.createElement</code>è¿™ä¸ªæ–¹æ³•çš„è¯­æ³•ç³–ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">element</span> <span class=\"o\">=</span> <span class=\"o\">&lt;</span><span class=\"nx\">h1</span> <span class=\"nx\">id</span><span class=\"o\">=</span><span class=\"s2\">&#34;container&#34;</span> <span class=\"nx\">className</span><span class=\"o\">=</span><span class=\"s2\">&#34;home&#34;</span><span class=\"o\">&gt;</span><span class=\"nx\">Hello</span><span class=\"o\">&lt;</span><span class=\"err\">/h1&gt;;</span>\n\n<span class=\"c1\">// ç­‰ä»·äº\n</span><span class=\"c1\"></span><span class=\"k\">const</span> <span class=\"nx\">element</span> <span class=\"o\">=</span> <span class=\"nx\">React</span><span class=\"p\">.</span><span class=\"nx\">createElement</span><span class=\"p\">(</span><span class=\"s2\">&#34;h1&#34;</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n  <span class=\"nx\">id</span><span class=\"o\">:</span> <span class=\"s2\">&#34;container&#34;</span><span class=\"p\">,</span>\n  <span class=\"nx\">className</span><span class=\"o\">:</span> <span class=\"s2\">&#34;home&#34;</span>\n<span class=\"p\">},</span> <span class=\"s2\">&#34;Hello&#34;</span><span class=\"p\">);</span>\n</code></pre></div><p>æ¨èå¤§å®¶åœ¨<a href=\"https://link.zhihu.com/?target=https%3A//babeljs.io/repl\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">babeljs.io</a>ä¸Šçœ‹ä¸‹JSXç¼–è¯‘åçš„å®é™…æ•ˆæœ </p><figure data-size=\"normal\"><noscript><img src=\"https://pic3.zhimg.com/v2-2293b675a872cdec9c7f9cc5423afb22_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1183\" data-rawheight=\"207\" class=\"origin_image zh-lightbox-thumb\" width=\"1183\" data-original=\"https://pic3.zhimg.com/v2-2293b675a872cdec9c7f9cc5423afb22_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;1183&#39; height=&#39;207&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1183\" data-rawheight=\"207\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1183\" data-original=\"https://pic3.zhimg.com/v2-2293b675a872cdec9c7f9cc5423afb22_r.jpg\" data-actualsrc=\"https://pic3.zhimg.com/v2-2293b675a872cdec9c7f9cc5423afb22_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p><a href=\"https://link.zhihu.com/?target=https%3A//reactjs.org/docs/react-api.html%23createelement\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">React.createElement</a>æœ‰ä¸‰ä¸ªå‚æ•°ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"nx\">React</span><span class=\"p\">.</span><span class=\"nx\">createElement</span><span class=\"p\">(</span>\n  <span class=\"nx\">type</span><span class=\"p\">,</span> <span class=\"c1\">// domç±»å‹ï¼Œæ¯”å¦‚divï¼Œh1\n</span><span class=\"c1\"></span>  <span class=\"p\">[</span><span class=\"nx\">props</span><span class=\"p\">],</span> <span class=\"c1\">// domå±æ€§ï¼Œæ¯”å¦‚idï¼Œclassï¼Œäº‹ä»¶\n</span><span class=\"c1\"></span>  <span class=\"p\">[...</span><span class=\"nx\">children</span><span class=\"p\">]</span> <span class=\"c1\">// å­èŠ‚ç‚¹ï¼Œå­—ç¬¦ä¸²æˆ–è€…React.createElementç”Ÿæˆçš„ä¸€ä¸ªå¯¹è±¡\n</span><span class=\"c1\"></span><span class=\"p\">)</span>\n</code></pre></div><p>JSXç”¨ä¸€ç§ç±»ä¼¼HTMLçš„è¯­æ³•æ›¿ä»£äº†æ¯”è¾ƒç¹ççš„<code>React.createElement</code>çº¯JSæ–¹æ³•ï¼Œè€Œ<code>@babel/preset-react</code>æ’ä»¶å°±èµ·åˆ°äº†æœ€å…³é”®çš„ä¸€æ­¥ï¼šè´Ÿè´£åœ¨webpackç¼–è¯‘æ—¶ï¼ŒæŠŠæ‰€æœ‰çš„JSXéƒ½æ”¹æˆ<code>React.createElement</code>:</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">class</span> <span class=\"nx\">Home</span> <span class=\"k\">extends</span> <span class=\"nx\">Component</span> <span class=\"p\">{</span>\n  <span class=\"nx\">render</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"p\">(</span>\n      <span class=\"o\">&lt;</span><span class=\"nx\">div</span> <span class=\"nx\">onClick</span><span class=\"o\">=</span><span class=\"p\">{()</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;hello&#39;</span><span class=\"p\">)}</span><span class=\"o\">&gt;</span>\n        <span class=\"o\">&lt;</span><span class=\"nx\">h1</span><span class=\"o\">&gt;</span><span class=\"nx\">Hello</span><span class=\"p\">,</span> <span class=\"nx\">world</span><span class=\"o\">!&lt;</span><span class=\"err\">/h1&gt;</span>\n        <span class=\"o\">&lt;</span><span class=\"nx\">Blog</span> <span class=\"nx\">title</span><span class=\"o\">=</span><span class=\"s2\">&#34;deepred&#34;</span> <span class=\"o\">/&gt;</span>\n      <span class=\"o\">&lt;</span><span class=\"err\">/div&gt;</span>\n    <span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>ç¼–è¯‘åï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">class</span> <span class=\"nx\">Home</span> <span class=\"k\">extends</span> <span class=\"nx\">Component</span> <span class=\"p\">{</span>\n  <span class=\"nx\">render</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"nx\">React</span><span class=\"p\">.</span><span class=\"nx\">createElement</span><span class=\"p\">(</span><span class=\"s2\">&#34;div&#34;</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n      <span class=\"nx\">onClick</span><span class=\"o\">:</span> <span class=\"p\">()</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;hello&#39;</span><span class=\"p\">)</span>\n    <span class=\"p\">},</span> <span class=\"nx\">React</span><span class=\"p\">.</span><span class=\"nx\">createElement</span><span class=\"p\">(</span><span class=\"s2\">&#34;h1&#34;</span><span class=\"p\">,</span> <span class=\"kc\">null</span><span class=\"p\">,</span> <span class=\"s2\">&#34;Hello, world!&#34;</span><span class=\"p\">),</span> <span class=\"nx\">React</span><span class=\"p\">.</span><span class=\"nx\">createElement</span><span class=\"p\">(</span><span class=\"nx\">Blog</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n      <span class=\"nx\">title</span><span class=\"o\">:</span> <span class=\"s2\">&#34;deepred&#34;</span>\n    <span class=\"p\">}));</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>åœ¨å¼€å‘ä¸­ï¼Œæœ‰äº†JSXåæˆ‘ä»¬åŸºæœ¬ä¸æ€ä¹ˆéœ€è¦ç”¨åˆ°<code>createElement</code>æ–¹æ³•ï¼Œä½†å¦‚æœæˆ‘ä»¬éœ€è¦å®ç°è¿™æ ·ä¸€ä¸ªç»„ä»¶ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"c1\">// æ ¹æ®ä¼ å…¥çš„typeå±æ€§ï¼Œæ¸²æŸ“æˆç›¸åº”çš„htmlå…ƒç´ \n</span><span class=\"c1\"></span><span class=\"o\">&lt;</span><span class=\"nx\">Tag</span> <span class=\"nx\">type</span><span class=\"o\">=</span><span class=\"s2\">&#34;h1&#34;</span> <span class=\"nx\">id</span><span class=\"o\">=</span><span class=\"s2\">&#34;hello&#34;</span> <span class=\"nx\">onClick</span><span class=\"o\">=</span><span class=\"p\">{()</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"s1\">&#39;hello&#39;</span><span class=\"p\">)}</span><span class=\"o\">&gt;</span><span class=\"k\">this</span> <span class=\"nx\">is</span> <span class=\"nx\">a</span> <span class=\"nx\">h1</span><span class=\"o\">&lt;</span><span class=\"err\">/Tag&gt;</span>\n<span class=\"o\">&lt;</span><span class=\"nx\">Tag</span> <span class=\"nx\">type</span><span class=\"o\">=</span><span class=\"s2\">&#34;p&#34;</span><span class=\"o\">&gt;</span><span class=\"k\">this</span> <span class=\"nx\">is</span> <span class=\"nx\">a</span> <span class=\"nx\">p</span><span class=\"o\">&lt;</span><span class=\"err\">/Tag&gt;</span>\n</code></pre></div><p>æˆ‘ä»¬ä¸å¤ªå¯èƒ½æ ¹æ®typeçš„å±æ€§ï¼Œä¸€ä¸ªä¸ª<code>if else</code>å»åˆ¤æ–­å¯¹åº”çš„æ ‡ç­¾ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"kd\">function</span> <span class=\"nx\">Tag</span><span class=\"p\">(</span><span class=\"nx\">props</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">const</span> <span class=\"p\">{</span> <span class=\"nx\">type</span><span class=\"p\">,</span> <span class=\"p\">...</span><span class=\"nx\">other</span> <span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nx\">props</span><span class=\"p\">;</span>\n\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">type</span> <span class=\"o\">===</span> <span class=\"s1\">&#39;h1&#39;</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"o\">&lt;</span><span class=\"nx\">h1</span> <span class=\"p\">{...</span><span class=\"nx\">other</span><span class=\"p\">}</span><span class=\"o\">&gt;</span><span class=\"p\">{</span><span class=\"nx\">props</span><span class=\"p\">.</span><span class=\"nx\">children</span><span class=\"p\">}</span><span class=\"o\">&lt;</span><span class=\"err\">/h1&gt;</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">type</span> <span class=\"o\">===</span> <span class=\"s1\">&#39;p&#39;</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">return</span> <span class=\"o\">&lt;</span><span class=\"nx\">p</span> <span class=\"p\">{...</span><span class=\"nx\">other</span><span class=\"p\">}</span><span class=\"o\">&gt;</span><span class=\"p\">{</span><span class=\"nx\">props</span><span class=\"p\">.</span><span class=\"nx\">children</span><span class=\"p\">}</span><span class=\"o\">&lt;</span><span class=\"err\">/p&gt;</span>\n  <span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>è¿™æ—¶ï¼Œå°±éœ€è¦ç”¨åˆ°åº•å±‚çš„apiäº†ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"kd\">function</span> <span class=\"nx\">Tag</span><span class=\"p\">(</span><span class=\"nx\">props</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">const</span> <span class=\"p\">{</span> <span class=\"nx\">type</span><span class=\"p\">,</span> <span class=\"p\">...</span><span class=\"nx\">other</span> <span class=\"p\">}</span> <span class=\"o\">=</span> <span class=\"nx\">props</span><span class=\"p\">;</span>\n\n  <span class=\"k\">return</span> <span class=\"nx\">React</span><span class=\"p\">.</span><span class=\"nx\">createElement</span><span class=\"p\">(</span><span class=\"nx\">type</span><span class=\"p\">,</span> <span class=\"nx\">other</span><span class=\"p\">,</span> <span class=\"nx\">props</span><span class=\"p\">.</span><span class=\"nx\">children</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div><h2><b>è‡ªå·±å®ç°ä¸€ä¸ªJSXæ¸²æŸ“å™¨</b></h2><p>è™šæ‹Ÿdomæœ¬è´¨å°±æ˜¯ä¸€ä¸ªjså¯¹è±¡ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">vnode</span> <span class=\"o\">=</span> <span class=\"p\">{</span>\n  <span class=\"nx\">tag</span><span class=\"o\">:</span> <span class=\"s1\">&#39;div&#39;</span><span class=\"p\">,</span>\n  <span class=\"nx\">attrs</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n    <span class=\"nx\">className</span><span class=\"o\">:</span> <span class=\"s1\">&#39;container&#39;</span>\n  <span class=\"p\">},</span>\n  <span class=\"nx\">children</span><span class=\"o\">:</span> <span class=\"p\">[</span>\n    <span class=\"p\">{</span>\n        <span class=\"nx\">tag</span><span class=\"o\">:</span> <span class=\"s1\">&#39;img&#39;</span><span class=\"p\">,</span>\n        <span class=\"nx\">attrs</span><span class=\"o\">:</span> <span class=\"p\">{</span>\n          <span class=\"nx\">src</span><span class=\"o\">:</span> <span class=\"s1\">&#39;1.png&#39;</span>\n        <span class=\"p\">},</span>\n        <span class=\"nx\">children</span><span class=\"o\">:</span> <span class=\"p\">[]</span>\n    <span class=\"p\">},</span>\n    <span class=\"p\">{</span>\n        <span class=\"nx\">tag</span><span class=\"o\">:</span> <span class=\"s1\">&#39;h3&#39;</span><span class=\"p\">,</span>\n        <span class=\"nx\">attrs</span><span class=\"o\">:</span> <span class=\"p\">{},</span>\n        <span class=\"nx\">children</span><span class=\"o\">:</span> <span class=\"p\">[</span><span class=\"s1\">&#39;hello&#39;</span><span class=\"p\">]</span>\n    <span class=\"p\">}</span>\n  <span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>å¯ä»¥é€šè¿‡åœ¨æ¯ä¸ªæ–‡ä»¶çš„ä¸Šæ–¹æ·»åŠ <code>/** @jsx h */</code>æ¥å‘Šè¯‰<code>@babel/preset-react</code>ç”¨<code>h</code>æ–¹æ³•åä»£æ›¿JSXï¼ˆé»˜è®¤æ–¹æ³•æ˜¯React.createElementï¼‰</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"cm\">/** @jsx h */</span>\n\n<span class=\"k\">const</span> <span class=\"nx\">element</span> <span class=\"o\">=</span> <span class=\"o\">&lt;</span><span class=\"nx\">h1</span> <span class=\"nx\">id</span><span class=\"o\">=</span><span class=\"s2\">&#34;container&#34;</span> <span class=\"nx\">className</span><span class=\"o\">=</span><span class=\"s2\">&#34;home&#34;</span><span class=\"o\">&gt;</span><span class=\"nx\">Hello</span><span class=\"o\">&lt;</span><span class=\"err\">/h1&gt;;</span>\n</code></pre></div><p class=\"ztext-empty-paragraph\"><br/></p><div class=\"highlight\"><pre><code class=\"language-text\">/** @jsx h */\nconst element = h(&#34;h1&#34;, {\n  id: &#34;container&#34;,\n  className: &#34;home&#34;\n}, &#34;Hello&#34;);</code></pre></div><figure data-size=\"normal\"><noscript><img src=\"https://pic2.zhimg.com/v2-a96556a39e588106253cbb99ee9289dd_b.png\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1113\" data-rawheight=\"148\" class=\"origin_image zh-lightbox-thumb\" width=\"1113\" data-original=\"https://pic2.zhimg.com/v2-a96556a39e588106253cbb99ee9289dd_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;1113&#39; height=&#39;148&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"1113\" data-rawheight=\"148\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"1113\" data-original=\"https://pic2.zhimg.com/v2-a96556a39e588106253cbb99ee9289dd_r.jpg\" data-actualsrc=\"https://pic2.zhimg.com/v2-a96556a39e588106253cbb99ee9289dd_b.png\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>ç°åœ¨è®©æˆ‘ä»¬å¼€å§‹åˆ›å»ºè‡ªå·±çš„<code>h</code>å‡½æ•°å§ï¼</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"kd\">function</span> <span class=\"nx\">h</span><span class=\"p\">(</span><span class=\"nx\">nodeName</span><span class=\"p\">,</span> <span class=\"nx\">attributes</span><span class=\"p\">,</span> <span class=\"p\">...</span><span class=\"nx\">args</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"c1\">// ä½¿ç”¨concatæ˜¯ä¸ºäº†æ‰å¹³åŒ–argsï¼Œå› ä¸ºargsæ•°ç»„é‡Œé¢çš„å…ƒç´ å¯èƒ½ä¹Ÿæ˜¯æ•°ç»„\n</span><span class=\"c1\"></span>  <span class=\"c1\">// h(&#39;div&#39;, {}, [1, 2, 3])  h(&#39;d&#39;, {}, 1, 2, 3) éƒ½æ˜¯åˆæ³•çš„è°ƒç”¨\n</span><span class=\"c1\"></span>  <span class=\"k\">const</span> <span class=\"nx\">children</span> <span class=\"o\">=</span> <span class=\"nx\">args</span><span class=\"p\">.</span><span class=\"nx\">length</span> <span class=\"o\">?</span> <span class=\"p\">[].</span><span class=\"nx\">concat</span><span class=\"p\">(...</span><span class=\"nx\">args</span><span class=\"p\">)</span> <span class=\"o\">:</span> <span class=\"kc\">null</span><span class=\"p\">;</span>\n\n  <span class=\"k\">return</span> <span class=\"p\">{</span> <span class=\"nx\">nodeName</span><span class=\"p\">,</span> <span class=\"nx\">attributes</span><span class=\"p\">,</span> <span class=\"nx\">children</span> <span class=\"p\">};</span>\n<span class=\"p\">}</span>\n<span class=\"k\">const</span> <span class=\"nx\">vnode</span> <span class=\"o\">=</span> <span class=\"nx\">h</span><span class=\"p\">(</span><span class=\"s2\">&#34;div&#34;</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n  <span class=\"nx\">id</span><span class=\"o\">:</span> <span class=\"s2\">&#34;urusai&#34;</span>\n<span class=\"p\">},</span> <span class=\"s2\">&#34;Hello!&#34;</span><span class=\"p\">);</span>\n\n<span class=\"c1\">// è¿”å›\n</span><span class=\"c1\">// {\n</span><span class=\"c1\">//  &#34;nodeName&#34;: &#34;div&#34;,\n</span><span class=\"c1\">//  &#34;attributes&#34;: {\n</span><span class=\"c1\">//   &#34;id&#34;: &#34;urusai&#34;\n</span><span class=\"c1\">//  },\n</span><span class=\"c1\">//  &#34;children&#34;: [\n</span><span class=\"c1\">//   &#34;Hello!&#34;\n</span><span class=\"c1\">//  ]\n</span><span class=\"c1\">// }\n</span></code></pre></div><p><code>h</code>çš„ä½œç”¨å°±æ˜¯è¿”å›ä¸€ä¸ªvnodeï¼Œæœ‰äº†vnodeï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠvnodeè½¬æˆçœŸå®çš„dom:</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"kd\">function</span> <span class=\"nx\">render</span><span class=\"p\">(</span><span class=\"nx\">vnode</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"k\">typeof</span> <span class=\"nx\">vnode</span> <span class=\"o\">===</span> <span class=\"s1\">&#39;string&#39;</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// ç”Ÿæˆæ–‡æœ¬èŠ‚ç‚¹\n</span><span class=\"c1\"></span>    <span class=\"k\">return</span> <span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">createTextNode</span><span class=\"p\">(</span><span class=\"nx\">vnode</span><span class=\"p\">);</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"c1\">// ç”Ÿæˆå…ƒç´ èŠ‚ç‚¹å¹¶è®¾ç½®å±æ€§\n</span><span class=\"c1\"></span>  <span class=\"k\">const</span> <span class=\"nx\">node</span> <span class=\"o\">=</span> <span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">createElement</span><span class=\"p\">(</span><span class=\"nx\">vnode</span><span class=\"p\">.</span><span class=\"nx\">nodeName</span><span class=\"p\">);</span>\n  <span class=\"k\">const</span> <span class=\"nx\">attributes</span> <span class=\"o\">=</span> <span class=\"nx\">vnode</span><span class=\"p\">.</span><span class=\"nx\">attributes</span> <span class=\"o\">||</span> <span class=\"p\">{};</span>\n  <span class=\"nb\">Object</span><span class=\"p\">.</span><span class=\"nx\">keys</span><span class=\"p\">(</span><span class=\"nx\">attributes</span><span class=\"p\">).</span><span class=\"nx\">forEach</span><span class=\"p\">(</span><span class=\"nx\">key</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">node</span><span class=\"p\">.</span><span class=\"nx\">setAttribute</span><span class=\"p\">(</span><span class=\"nx\">key</span><span class=\"p\">,</span> <span class=\"nx\">attributes</span><span class=\"p\">[</span><span class=\"nx\">key</span><span class=\"p\">]));</span>\n\n  <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">vnode</span><span class=\"p\">.</span><span class=\"nx\">children</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"c1\">// é€’å½’è°ƒç”¨renderç”Ÿæˆå­èŠ‚ç‚¹\n</span><span class=\"c1\"></span>    <span class=\"nx\">vnode</span><span class=\"p\">.</span><span class=\"nx\">children</span><span class=\"p\">.</span><span class=\"nx\">forEach</span><span class=\"p\">(</span><span class=\"nx\">child</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">node</span><span class=\"p\">.</span><span class=\"nx\">appendChild</span><span class=\"p\">(</span><span class=\"nx\">render</span><span class=\"p\">(</span><span class=\"nx\">child</span><span class=\"p\">)));</span>\n  <span class=\"p\">}</span>\n\n  <span class=\"k\">return</span> <span class=\"nx\">node</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>ç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨è¿™ä¸¤ä¸ªæ–¹æ³•å§ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"cm\">/** @jsx h */</span>\n<span class=\"k\">const</span> <span class=\"nx\">vnode</span> <span class=\"o\">=</span> <span class=\"o\">&lt;</span><span class=\"nx\">div</span> <span class=\"nx\">id</span><span class=\"o\">=</span><span class=\"s2\">&#34;urusai&#34;</span><span class=\"o\">&gt;</span><span class=\"nx\">Hello</span><span class=\"o\">!&lt;</span><span class=\"err\">/div&gt;;</span>\n<span class=\"k\">const</span> <span class=\"nx\">node</span> <span class=\"o\">=</span> <span class=\"nx\">render</span><span class=\"p\">(</span><span class=\"nx\">vnode</span><span class=\"p\">);</span>\n<span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">body</span><span class=\"p\">.</span><span class=\"nx\">appendChild</span><span class=\"p\">(</span><span class=\"nx\">node</span><span class=\"p\">);</span>\n</code></pre></div><p>ç¼–è¯‘è½¬ç åï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"cm\">/** @jsx h */</span>\n<span class=\"k\">const</span> <span class=\"nx\">vnode</span> <span class=\"o\">=</span> <span class=\"nx\">h</span><span class=\"p\">(</span><span class=\"s2\">&#34;div&#34;</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n  <span class=\"nx\">id</span><span class=\"o\">:</span> <span class=\"s2\">&#34;urusai&#34;</span>\n<span class=\"p\">},</span> <span class=\"s2\">&#34;Hello!&#34;</span><span class=\"p\">);</span>\n<span class=\"k\">const</span> <span class=\"nx\">node</span> <span class=\"o\">=</span> <span class=\"nx\">render</span><span class=\"p\">(</span><span class=\"nx\">vnode</span><span class=\"p\">);</span>\n<span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">body</span><span class=\"p\">.</span><span class=\"nx\">appendChild</span><span class=\"p\">(</span><span class=\"nx\">node</span><span class=\"p\">);</span>\n</code></pre></div><p>æˆ‘ä»¬è¿˜å¯ä»¥éå†æ•°ç»„ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"cm\">/** @jsx h */</span>\n<span class=\"k\">const</span> <span class=\"nx\">items</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s1\">&#39;baga&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;hentai&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;urusai&#39;</span><span class=\"p\">];</span>\n<span class=\"k\">const</span> <span class=\"nx\">vnode</span> <span class=\"o\">=</span> <span class=\"o\">&lt;</span><span class=\"nx\">ul</span><span class=\"o\">&gt;</span><span class=\"p\">{</span><span class=\"nx\">items</span><span class=\"p\">.</span><span class=\"nx\">map</span><span class=\"p\">((</span><span class=\"nx\">item</span><span class=\"p\">,</span> <span class=\"nx\">index</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"o\">&lt;</span><span class=\"nx\">li</span> <span class=\"nx\">key</span><span class=\"o\">=</span><span class=\"p\">{</span><span class=\"nx\">index</span><span class=\"p\">}</span><span class=\"o\">&gt;</span><span class=\"p\">{</span><span class=\"nx\">item</span><span class=\"p\">}</span><span class=\"o\">&lt;</span><span class=\"err\">/li&gt;)}&lt;/ul&gt;;</span>\n<span class=\"k\">const</span> <span class=\"nx\">list</span> <span class=\"o\">=</span> <span class=\"nx\">render</span><span class=\"p\">(</span><span class=\"nx\">vnode</span><span class=\"p\">);</span>\n<span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">body</span><span class=\"p\">.</span><span class=\"nx\">appendChild</span><span class=\"p\">(</span><span class=\"nx\">list</span><span class=\"p\">);</span>\n</code></pre></div><p>ç¼–è¯‘è½¬ç åï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"cm\">/** @jsx h */</span>\n<span class=\"k\">const</span> <span class=\"nx\">items</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s1\">&#39;baga&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;hentai&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;urusai&#39;</span><span class=\"p\">];</span>\n<span class=\"k\">const</span> <span class=\"nx\">vnode</span> <span class=\"o\">=</span> <span class=\"nx\">h</span><span class=\"p\">(</span><span class=\"s2\">&#34;ul&#34;</span><span class=\"p\">,</span> <span class=\"kc\">null</span><span class=\"p\">,</span> <span class=\"nx\">items</span><span class=\"p\">.</span><span class=\"nx\">map</span><span class=\"p\">((</span><span class=\"nx\">item</span><span class=\"p\">,</span> <span class=\"nx\">index</span><span class=\"p\">)</span> <span class=\"p\">=&gt;</span> <span class=\"nx\">h</span><span class=\"p\">(</span><span class=\"s2\">&#34;li&#34;</span><span class=\"p\">,</span> <span class=\"p\">{</span>\n  <span class=\"nx\">key</span><span class=\"o\">:</span> <span class=\"nx\">index</span>\n<span class=\"p\">},</span> <span class=\"nx\">item</span><span class=\"p\">)));</span>\n<span class=\"k\">const</span> <span class=\"nx\">list</span> <span class=\"o\">=</span> <span class=\"nx\">render</span><span class=\"p\">(</span><span class=\"nx\">vnode</span><span class=\"p\">);</span>\n<span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">body</span><span class=\"p\">.</span><span class=\"nx\">appendChild</span><span class=\"p\">(</span><span class=\"nx\">list</span><span class=\"p\">);</span>\n</code></pre></div><p>é€šè¿‡<code>h</code> <code>render</code>ä¸¤ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªå¾ˆç®€å•çš„JSXæ¸²æŸ“å™¨ï¼ï¼ï¼</p><h2><b>å‚è€ƒ</b></h2><a href=\"https://link.zhihu.com/?target=https%3A//jasonformat.com/wtf-is-jsx/\" data-draft-node=\"block\" data-draft-type=\"link-card\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">WTF is JSX</a><p class=\"ztext-empty-paragraph\"><br/></p><a href=\"https://link.zhihu.com/?target=https%3A//reactjs.org/docs/jsx-in-depth.html\" data-draft-node=\"block\" data-draft-type=\"link-card\" data-image=\"https://pic1.zhimg.com/v2-cba0b89d2bf2d96a1ed26edb5849f804_180x120.jpg\" data-image-width=\"1200\" data-image-height=\"630\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">JSX In Depth â€“ React</a><a href=\"https://link.zhihu.com/?target=https%3A//reactjs.org/docs/react-without-jsx.html\" data-draft-node=\"block\" data-draft-type=\"link-card\" data-image=\"https://pic1.zhimg.com/v2-cba0b89d2bf2d96a1ed26edb5849f804_180x120.jpg\" data-image-width=\"1200\" data-image-height=\"630\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">React Without JSX â€“ React</a><p></p>", 
            "topic": [
                {
                    "tag": "React", 
                    "tagLink": "https://api.zhihu.com/topics/20013159"
                }, 
                {
                    "tag": "JavaScript", 
                    "tagLink": "https://api.zhihu.com/topics/19552521"
                }
            ], 
            "comments": [
                {
                    "userName": "æ‰©æ•£æ€§ç™¾ä¸‡ç”œé¢åŒ…", 
                    "userLink": "https://www.zhihu.com/people/c5f581c2e6cac28fe4ee1cacf9f82c44", 
                    "content": "å°é¢å¥½è¯„", 
                    "likes": 1, 
                    "childComments": [
                        {
                            "userName": "æ·±çº¢", 
                            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
                            "content": "æˆ‘åªæ˜¯æ¥å‘è‰²å›¾çš„ï¼Œé¡ºä¾¿å†™ä¸‹æ•™ç¨‹", 
                            "likes": 0, 
                            "replyToAuthor": "æ‰©æ•£æ€§ç™¾ä¸‡ç”œé¢åŒ…"
                        }
                    ]
                }, 
                {
                    "userName": "ã€Œå·²æ³¨é”€ã€", 
                    "userLink": "https://www.zhihu.com/people/b5ceab718732992d82c6d0819f1d003e", 
                    "content": "hå‡½æ•°æœ‰æ—¶å€™å¾—åˆ¤æ–­ä¸€ä¸‹nodeNameå§ï¼Œæ¯”å¦‚é‡åˆ°å‡½æ•°ç»„ä»¶", 
                    "likes": 0, 
                    "childComments": [
                        {
                            "userName": "æ·±çº¢", 
                            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
                            "content": "å—¯ï¼Œè¿˜è¦åˆ¤æ–­æ˜¯ä¸æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ç»„ä»¶ï¼Œè€Œä¸”äº‹ä»¶ç»‘å®šä¹Ÿæ²¡å®ç°ï¼Œæ–‡ç« é‡Œçš„hå‡½æ•°åªæ˜¯å¾ˆç®€å•çš„å®ç°", 
                            "likes": 0, 
                            "replyToAuthor": "ã€Œå·²æ³¨é”€ã€"
                        }
                    ]
                }, 
                {
                    "userName": "é²å°å¤«", 
                    "userLink": "https://www.zhihu.com/people/37b16179eb39f5f21ecf6a6416350639", 
                    "content": "<p>ä½ æŠŠä½ å°é¢ç»™æˆ‘äº¤äº†</p>", 
                    "likes": 0, 
                    "childComments": []
                }, 
                {
                    "userName": "å¤§æ±Ÿå±±å²š", 
                    "userLink": "https://www.zhihu.com/people/36ddf904e3fcc0c5204532632326d63b", 
                    "content": "å¤©ç‹—å”¯ä¸€æŒ‡å®šå‰ç«¯æ¡†æ¶", 
                    "likes": 0, 
                    "childComments": []
                }
            ]
        }, 
        {
            "url": "https://zhuanlan.zhihu.com/p/43767228", 
            "userName": "æ·±çº¢", 
            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
            "upvote": 11, 
            "title": "ç”±ä¸€æ¬¡é‡æ„ä»£ç æ‰€æƒ³åˆ°çš„", 
            "content": "<p></p><a href=\"https://link.zhihu.com/?target=http%3A//anata.me/2018/09/04/%25E7%2594%25B1%25E4%25B8%2580%25E6%25AC%25A1%25E9%2587%258D%25E6%259E%2584%25E4%25BB%25A3%25E7%25A0%2581%25E6%2589%2580%25E6%2583%25B3%25E5%2588%25B0%25E7%259A%2584/\" data-draft-node=\"block\" data-draft-type=\"link-card\" data-image=\"https://pic3.zhimg.com/v2-510588b68ddc2b0bffa8ccadbbe99ffa_ipico.jpg\" data-image-width=\"640\" data-image-height=\"640\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">ç”±ä¸€æ¬¡é‡æ„ä»£ç æ‰€æƒ³åˆ°çš„</a><p>äº‹ä»¶çš„èµ·å› æºäºæˆ‘å¤§ä¸‰æ—¶å†™è¿‡çš„ä¸€ä¸ªchromeæ’ä»¶ï¼š<a href=\"https://link.zhihu.com/?target=https%3A//chrome.google.com/webstore/detail/%25E7%2581%25B5%25E6%25A2%25A6%25E5%25BE%25A1%25E6%2589%2580/fpiljkfgljdkhlgogfbanafflmibdloc\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">è€å¸æœºçš„å·¥å…·ç®±</a>ï¼Œå½“æ—¶å› ä¸ºæŸXXå¾¡æ‰€å¼€å¯äº†è€å¸æœºæ¨¡å¼ï¼Œå¯¼è‡´èµ„æºä¸‹è½½é“¾æ¥è¢«éšè—ï¼Œå†åŠ ä¸Šé‚£æ—¶æ— æ„é—´çœ‹äº†ä¸€ç¯‡æ•™ç¨‹<a href=\"https://link.zhihu.com/?target=http%3A//www.ituring.com.cn/book/1421\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">Chromeæ‰©å±•åŠåº”ç”¨å¼€å‘</a>ï¼Œäºæ˜¯æ€§è‡´å‹ƒå‹ƒçš„èŠ±äº†å‡ å¤©æ—¶é—´ï¼Œå†™å‡ºäº†è¿™ä¸ªæ’ä»¶ï¼šç”¨æ¥æ˜¾ç¤ºè¢«éšè—çš„ä¸‹è½½åœ°å€å’Œè‡ªåŠ¨å¡«å†™ç™¾åº¦ç½‘ç›˜å¯†ç ã€‚ä¹‹åæ’ä»¶ä¹Ÿé™†é™†ç»­ç»­è¿­ä»£äº†å‡ ä¸ªç‰ˆæœ¬ï¼Œä¸è¿‡æœ€åä¸äº†äº†ä¹‹ã€‚</p><p>æ’ä»¶å‘å¸ƒåˆ°å¦‚ä»Šï¼Œä¸¤å¹´æ—¶é—´é‡Œï¼Œä¹Ÿæœ‰å‡ åƒç”¨æˆ·äº†ï¼Œè¿™ç‚¹å€’æ˜¯è®©æˆ‘æŒºæ„å¤–çš„ï¼Œçœ‹æ¥ä¸–ä¸Šè¿˜æ˜¯ç»…å£«å¤šã€‚ã€‚ã€‚</p><p>å‰å‡ å¤©åœ¨å®¶æ— äº‹ï¼Œäºæ˜¯å°±reviewäº†ä»£ç (<a href=\"https://link.zhihu.com/?target=https%3A//github.com/deepred5/reimu-extension\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">é¡¹ç›®åœ°å€</a>): <b>ä¸¤å¹´å‰çš„ä»£ç çœ‹æ‡‚æ˜¯ä¸å¯èƒ½çœ‹æ‡‚çš„ï¼Œè¿™è¾ˆå­éƒ½ä¸èƒ½çœ‹æ‡‚ï¼Œåªèƒ½é‡æ„ä¸‹ä»£ç è¿™æ ·å­ã€‚</b> ä¸è¿‡åœ¨é‡æ„çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¸ç¦æ„Ÿå¹ä¸¤å¹´çš„æ—¶é—´ï¼Œå‰ç«¯è¿˜çœŸçš„æ˜¯é£äº‘å˜å¹»ï¼Œå½“å¹´çš„è‡ªå·±èœçš„æŠ è„šã€‚</p><h2><b>å‰ç«¯å·¥ç¨‹åŒ–</b></h2><p>é‡æ„æ—¶æœ€å¤§çš„åŒºåˆ«å°±æ˜¯å·¥ç¨‹åŒ–äº†ã€‚</p><p>ä¸¤å¹´å‰çš„ä»£ç ï¼Œæˆ‘è¿˜æ˜¯åœç•™åœ¨htmlé¡µé¢ç›´æ¥å¼•å…¥jsï¼Œcssï¼Œå†™ä»£ç å°±æ˜¯jQueryä¸€æŠŠæ¢­å­çš„å±‚é¢ã€‚</p><p>è€Œå¦‚ä»Šï¼Œåœ¨çœŸæ­£å†™ä»£ç å‰ï¼Œæˆ‘å¯èƒ½éœ€è¦èŠ±äº›æ—¶é—´ï¼Œæ¥é…ç½®ä¸€äº›è¯¸å¦‚webpackï¼Œbabelçš„æ„å»ºã€ç¼–è¯‘å·¥å…·ã€‚é…ç½®çš„ç¹çå¸¦æ¥çš„æ˜¯å¼€å‘æ—¶çš„ä¾¿æ·ï¼Œ2å¹´å‰æ²¡æœ‰æ¨¡å—åŒ–çš„jså’Œcssæ˜¯æˆ‘ç°åœ¨ä¸æ•¢æƒ³è±¡çš„ã€‚</p><h2><b>ä»£ç é£æ ¼</b></h2><p>ä¸¤å¹´å‰çš„ä»£ç åˆ°å¤„å……æ–¥ç€å„ç§å…¨å±€å˜é‡å’Œå‡½æ•°ï¼Œéšæ„çš„DOMæ“ä½œå’Œcallbackè°ƒç”¨ï¼Œä½¿å¾—é¢æ¡ä»£ç è®©äººçœ‹å¾—æ›´åŠ å‡Œä¹±ã€‚</p><p>è€Œå¦‚ä»Šï¼Œæˆ‘æ›´åŠ å€¾å‘äºé¢å‘å¯¹è±¡å’Œå‡½æ•°å¼ç¼–ç¨‹ã€‚</p><p>ä¸¤å¹´å‰æˆ‘åº”è¯¥ä¼šæ¯«ä¸çŠ¹è±«å†™å‡ºè¿™æ ·çš„ä»£ç ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"nb\">window</span><span class=\"p\">.</span><span class=\"nx\">addEventListener</span><span class=\"p\">(</span><span class=\"s1\">&#39;DOMContentLoaded&#39;</span><span class=\"p\">,</span> <span class=\"kd\">function</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"kd\">function</span> <span class=\"nx\">renderContainer</span><span class=\"p\">(</span><span class=\"nx\">data</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"c1\">// å¯¹æ•°æ®è¿›è¡Œä¸€äº›åŠ å·¥\n</span><span class=\"c1\"></span>        <span class=\"k\">return</span> <span class=\"nx\">newData</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"nx\">ajax</span><span class=\"p\">({</span>\n        <span class=\"nx\">url</span><span class=\"o\">:</span> <span class=\"nx\">api</span><span class=\"p\">,</span>\n        <span class=\"nx\">type</span><span class=\"o\">:</span> <span class=\"s1\">&#39;GET&#39;</span><span class=\"p\">,</span>\n        <span class=\"nx\">dataType</span><span class=\"o\">:</span> <span class=\"s1\">&#39;json&#39;</span><span class=\"p\">,</span>\n        <span class=\"nx\">success</span><span class=\"o\">:</span> <span class=\"kd\">function</span><span class=\"p\">(</span><span class=\"nx\">data</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n            <span class=\"k\">const</span> <span class=\"nx\">container</span> <span class=\"o\">=</span> <span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">querySelector</span><span class=\"p\">(</span><span class=\"s1\">&#39;#container&#39;</span><span class=\"p\">);</span>\n            <span class=\"nx\">container</span><span class=\"p\">.</span><span class=\"nx\">innerHTML</span> <span class=\"o\">=</span> <span class=\"nx\">renderContainer</span><span class=\"p\">(</span><span class=\"nx\">data</span><span class=\"p\">);</span>\n        <span class=\"p\">}</span>\n    <span class=\"p\">})</span>\n\n    <span class=\"k\">const</span> <span class=\"nx\">btn</span> <span class=\"o\">=</span> <span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">querySelector</span><span class=\"p\">(</span><span class=\"s1\">&#39;#btn&#39;</span><span class=\"p\">);</span>\n\n    <span class=\"nx\">btn</span><span class=\"p\">.</span><span class=\"nx\">addEventListener</span><span class=\"p\">(</span><span class=\"s1\">&#39;click&#39;</span><span class=\"p\">,</span> <span class=\"kd\">function</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n        <span class=\"c1\">// å¤„ç†äº‹ä»¶\n</span><span class=\"c1\"></span>    <span class=\"p\">})</span>\n<span class=\"p\">})</span>\n</code></pre></div><p>ç°åœ¨æˆ‘ä¼šè¿™æ ·å†™ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">class</span> <span class=\"nx\">Demo</span> <span class=\"p\">{</span>\n    <span class=\"nx\">constructor</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n        <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">container</span> <span class=\"o\">=</span> <span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">querySelector</span><span class=\"p\">(</span><span class=\"s1\">&#39;#container&#39;</span><span class=\"p\">);</span>\n        <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">btn</span> <span class=\"o\">=</span> <span class=\"nb\">document</span><span class=\"p\">.</span><span class=\"nx\">querySelector</span><span class=\"p\">(</span><span class=\"s1\">&#39;#btn&#39;</span><span class=\"p\">);</span>\n\n        <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">init</span><span class=\"p\">();</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"nx\">renderTemplate</span><span class=\"p\">(</span><span class=\"nx\">data</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"c1\">// å¯¹æ•°æ®è¿›è¡Œä¸€äº›åŠ å·¥\n</span><span class=\"c1\"></span>        <span class=\"k\">return</span> <span class=\"nx\">newData</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"nx\">init</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n        <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">renderContainer</span><span class=\"p\">();</span>\n        <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">bindHandler</span><span class=\"p\">();</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"kr\">async</span> <span class=\"nx\">renderContainer</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n        <span class=\"k\">const</span> <span class=\"nx\">data</span> <span class=\"o\">=</span> <span class=\"kr\">await</span> <span class=\"nx\">ajax</span><span class=\"p\">({</span>\n            <span class=\"nx\">url</span><span class=\"o\">:</span> <span class=\"nx\">api</span><span class=\"p\">,</span>\n            <span class=\"nx\">type</span><span class=\"o\">:</span> <span class=\"s1\">&#39;GET&#39;</span><span class=\"p\">,</span>\n            <span class=\"nx\">dataType</span><span class=\"o\">:</span> <span class=\"s1\">&#39;json&#39;</span>\n        <span class=\"p\">});</span>\n\n        <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">container</span><span class=\"p\">.</span><span class=\"nx\">innerHTML</span> <span class=\"o\">=</span> <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">renderTemplate</span><span class=\"p\">(</span><span class=\"nx\">data</span><span class=\"p\">);</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"nx\">bindHandler</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n        <span class=\"k\">this</span><span class=\"p\">.</span><span class=\"nx\">btn</span><span class=\"p\">.</span><span class=\"nx\">addEventListener</span><span class=\"p\">(</span><span class=\"s1\">&#39;click&#39;</span><span class=\"p\">,</span> <span class=\"kd\">function</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n            <span class=\"c1\">// å¤„ç†äº‹ä»¶\n</span><span class=\"c1\"></span>        <span class=\"p\">})</span>\n    <span class=\"p\">}</span>\n\n<span class=\"p\">}</span>\n\n<span class=\"nb\">window</span><span class=\"p\">.</span><span class=\"nx\">addEventListener</span><span class=\"p\">(</span><span class=\"s1\">&#39;DOMContentLoaded&#39;</span><span class=\"p\">,</span> <span class=\"kd\">function</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"k\">const</span> <span class=\"nx\">demo</span> <span class=\"o\">=</span> <span class=\"k\">new</span> <span class=\"nx\">Demo</span><span class=\"p\">();</span>\n<span class=\"p\">})</span>\n</code></pre></div><p>å…¶å®è¿™ç§å†™æ³•å·²ç»ç±»ä¼¼äºReactå’ŒVueäº†ã€‚MVVMæ¡†æ¶é™¤äº†å¸¦æ¥æ•°æ®é©±åŠ¨çš„ç†å¿µï¼Œå…¶å®ä¹Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šæ¨åŠ¨äº†é¢å‘å¯¹è±¡å’Œå‡½æ•°å¼ç¼–ç¨‹çš„æ€æƒ³ã€‚</p><h2><b>è§£å†³é—®é¢˜</b></h2><p>ä¸¤å¹´å‰æˆ‘å†™è¿™ä¸ªæ’ä»¶çš„æ—¶å€™ï¼Œé‡åˆ°äº†ä¸€ä¸ªå¾ˆè´¹è§£çš„bugï¼šå°±æ˜¯è¿›å…¥ç½‘ç«™é¦–é¡µï¼Œç‚¹å‡»æ–‡ç« æ ‡é¢˜è¿›å…¥è¯¦æƒ…é¡µé¢åï¼Œå¹¶ä¸èƒ½æ˜¾ç¤ºéšè—çš„ä¸‹è½½åœ°å€ï¼Œæ¯æ¬¡éƒ½éœ€è¦æˆ‘æ‰‹åŠ¨åˆ·æ–°ä¸€éé¡µé¢æ‰èƒ½æˆåŠŸã€‚</p><p>å½“æ—¶æ°´å¹³æœ‰é™ï¼Œæƒ³äº†åŠå¤©ä¹Ÿä¸æ˜ç™½ä¸ºå•¥ä¼šè¿™æ ·ï¼Œæ‹–ç€æ‹–ç€å°±å¿˜äº†ã€‚è¿™æ¬¡é‡æ„ï¼Œæƒ³èµ·äº†è¿™ä¸ªbugï¼Œåˆ†æäº†ä¸€ä¸‹ï¼Œå…¶å®å¾ˆç®€å•ï¼šç½‘ç«™é‡‡ç”¨äº†pjaxæŠ€æœ¯ï¼Œè¿›å…¥é¦–é¡µåï¼Œæ’ä»¶æ³¨å…¥çš„jså°±è¢«è§¦å‘ï¼Œå¯»æ‰¾è¢«éšè—çš„ä¸‹è½½åœ°å€domï¼Œç„¶è€Œè¿™æ—¶å¹¶æ²¡æœ‰è¿™ä¸ªdomã€‚ç‚¹å‡»æ ‡é¢˜è¿›å…¥è¯¦æƒ…é¡µï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦çš„domè¢«æ’å…¥äº†ï¼Œä½†æ˜¯ç”±äºä½¿ç”¨äº†pjaxï¼Œæ•´ä¸ªé¡µé¢å…¶å®å¹¶æ²¡æœ‰é‡æ–°åŠ è½½ï¼Œæ’ä»¶æ³¨å…¥çš„jså·²ç»è¢«æ‰§è¡Œè¿‡ä¸€æ¬¡äº†ï¼Œæ‰€ä»¥è¿™æ—¶å°±æ— æ³•æŠŠdomå±•ç¤ºå‡ºæ¥ï¼Œè€Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨åˆ·æ–°ï¼Œé‡æ–°æ‰§è¡Œä¸€éæ³¨å…¥çš„jsã€‚</p><p>è§£å†³æ–¹æ³•æ˜¯ï¼Œåˆ©ç”¨<code>MutationObserver</code>ç›‘å¬pjaxæ›´æ–°çš„domå…ƒç´ ï¼Œå¦‚æœå‘ç°æ›´æ–°äº†domï¼Œå°±å†æ¬¡æ‰§è¡Œjsæ–¹æ³•</p><p>è¿˜é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜:</p><div class=\"highlight\"><pre><code class=\"language-text\">var str = `ã€ç£åŠ›é“¾æ¥ã€‘\nmagnet:?xt=urn:btih:404d1cf190660dfd301e289411cfc3185fcb2c92\n\nã€ç™¾åº¦äº‘ã€‘\nä¼ é€é—¨ æå–ç ï¼šlmys\n`</code></pre></div><p>å¦‚ä½•åœ¨æŠŠlmysæå–å‡ºæ¥ï¼Ÿ</p><p>å½“æ—¶å¾ˆæ‹™åŠ£çš„ä½¿ç”¨äº†å­—ç¬¦ä¸²æˆªå–ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"kd\">function</span> <span class=\"nx\">getPwd</span><span class=\"p\">(</span><span class=\"nx\">str</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"kd\">var</span> <span class=\"nx\">index1</span> <span class=\"o\">=</span> <span class=\"nx\">str</span><span class=\"p\">.</span><span class=\"nx\">indexOf</span><span class=\"p\">(</span><span class=\"s1\">&#39;æå–ç &#39;</span><span class=\"p\">);</span>\n    <span class=\"kd\">var</span> <span class=\"nx\">index2</span> <span class=\"o\">=</span> <span class=\"nx\">str</span><span class=\"p\">.</span><span class=\"nx\">indexOf</span><span class=\"p\">(</span><span class=\"s1\">&#39;\\n&#39;</span><span class=\"p\">,</span> <span class=\"nx\">index1</span><span class=\"p\">);</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">index1</span> <span class=\"o\">!==</span> <span class=\"o\">-</span><span class=\"mi\">1</span> <span class=\"o\">&amp;&amp;</span> <span class=\"nx\">index2</span> <span class=\"o\">!==</span> <span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n        <span class=\"k\">return</span> <span class=\"nx\">str</span><span class=\"p\">.</span><span class=\"nx\">slice</span><span class=\"p\">(</span><span class=\"nx\">index1</span> <span class=\"o\">+</span> <span class=\"mi\">4</span><span class=\"p\">,</span> <span class=\"nx\">index2</span><span class=\"p\">).</span><span class=\"nx\">trim</span><span class=\"p\">();</span>\n    <span class=\"p\">}</span>\n    <span class=\"k\">return</span> <span class=\"s1\">&#39;&#39;</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div><p>ç°åœ¨çœ‹æ¥ï¼Œä¸€è¡Œæ­£åˆ™å°±æå®šçš„äº‹æƒ…ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">regPassword</span> <span class=\"o\">=</span> <span class=\"sr\">/æå–ç .*([a-zA-Z0-9]{4})/</span><span class=\"p\">;</span>\n</code></pre></div><h2>æ€»ç»“</h2><p>åºŸè¯äº†é‚£ä¹ˆå¤šï¼Œå…¶å®å°±æ˜¯æƒ³è¯´ï¼Œæ¯ä¸ªäººåœ¨æ¯ä¸ªé˜¶æ®µéƒ½ä¼šå—é™äºå½“æ—¶çš„æŠ€æœ¯æ°´å¹³å’Œçœ¼ç•Œæ ¼å±€ï¼Œè€Œå†™å‡ºåœ¨å½“æ—¶è‡ªè®¤ä¸ºæ˜¯æœ€å¥½çš„ä»£ç ã€‚</p><p>å¦‚æœä½ æœ€è¿‘è§‰å¾—è‡ªå·±æ°´å¹³ä¸€ç›´ä¸Šä¸å»ï¼ŒæŠ€æœ¯é‡åˆ°äº†ç“¶é¢ˆï¼Œè¿™æ—¶ä¸å¦¨---</p><p>æ‹”æ‰ç½‘çº¿ï¼Œå…³ä¸Šç”µè„‘ï¼Œè¯»å‡ é¡µã€ŠAngularä»å…¥é—¨åˆ°æ”¾å¼ƒã€‹ï¼Œå‡ºé—¨å»æ¼«å±•èµ°èµ°ï¼Œè¦ä¹ˆå»å¥³è£…ï¼Œå¤©é»‘äº†çº¦å‡ ä¸ªå¥½ä¹…ä¸è§çš„è‚¥å®…æ‰¾ä¸ªåœ°æ–¹å–ç‚¹å¿«ä¹æ°´ã€èŠèŠé‡Œç•ªï¼Œéšä¾¿åšäº›ä»€ä¹ˆã€‚ä¸€å¤©ä¸‹æ¥ï¼Œä½ å°±ä¼šå‘ç°ï¼Œè¿˜æ˜¯jQueryå†™çš„çˆ½ï¼</p><p>PS: æ–‡ç« é‡Œçš„ç£åŠ›é“¾æ¥é€ä½ äº†</p>", 
            "topic": [
                {
                    "tag": "ä»£ç é‡æ„", 
                    "tagLink": "https://api.zhihu.com/topics/19574586"
                }, 
                {
                    "tag": "JavaScript", 
                    "tagLink": "https://api.zhihu.com/topics/19552521"
                }
            ], 
            "comments": [
                {
                    "userName": "aug", 
                    "userLink": "https://www.zhihu.com/people/854b2bdf10ab30ca4fa5142c46f74ba3", 
                    "content": "é€ç£åŠ›é“¾ï¼Œ(à²¡Ï‰à²¡)hiahiahia", 
                    "likes": 0, 
                    "childComments": []
                }, 
                {
                    "userName": "çŸ¥ä¹ç”¨æˆ·", 
                    "userLink": "https://www.zhihu.com/people/0", 
                    "content": "<p>æ€§è‡´å‹ƒå‹ƒ</p><p></p>", 
                    "likes": 0, 
                    "childComments": []
                }, 
                {
                    "userName": "å°å¤œå‹ƒ", 
                    "userLink": "https://www.zhihu.com/people/b9257942d93b19dc12beed885dba52c8", 
                    "content": "<p>è°¢è°¢ å¾ˆæœ‰å¯å‘</p>", 
                    "likes": 0, 
                    "childComments": []
                }, 
                {
                    "userName": "tmomy", 
                    "userLink": "https://www.zhihu.com/people/5c5cf25dc7c8d1d2d490ea65849ff01c", 
                    "content": "æœ‹å‹ï¼Œä½ æœ€è¿‘æ€ä¹ˆäº†", 
                    "likes": 0, 
                    "childComments": []
                }, 
                {
                    "userName": "é‚£å°ä¼™å­æ˜¯ä¸ªç å†œ", 
                    "userLink": "https://www.zhihu.com/people/d2baffbe0884f60ef1909fa29f4d5356", 
                    "content": "<p>jqueryç”¨çš„çˆ½å§</p>", 
                    "likes": 0, 
                    "childComments": []
                }, 
                {
                    "userName": "å†°å‡Œ", 
                    "userLink": "https://www.zhihu.com/people/8cb3b34ac846afd811bfc0a7ead7d8a2", 
                    "content": "<p>å¤©å“ªï¼Œå±…ç„¶å‘ç°äº†ä½œè€…</p>", 
                    "likes": 0, 
                    "childComments": []
                }
            ]
        }, 
        {
            "url": "https://zhuanlan.zhihu.com/p/40917358", 
            "userName": "æ·±çº¢", 
            "userLink": "https://www.zhihu.com/people/ac74d402b6495d39eccf08f34bfc66b5", 
            "upvote": 3, 
            "title": "ç®€å•æ˜“æ‡‚çš„ç°ä»£é­”æ³•-é€’å½’", 
            "content": "<p>å¹³æ—¶åœ¨å‰ç«¯å¼€å‘ä¸­ï¼Œå¥½åƒä¹Ÿæ²¡å•¥ç”¨åˆ°é€’å½’çš„åœ°æ–¹ã€‚ä¸è¿‡è¿™å¹¶ä¸ä»£è¡¨é€’å½’ä¸é‡è¦ï¼Œå¦‚æœä½ çœ‹è¿‡ä¸€äº›æ¡†æ¶çš„æºç ï¼Œå°±ä¼šç»å¸¸è§åˆ°å®ƒçš„å½±å­ï¼šæ¯”å¦‚æ¸²æŸ“è™šæ‹ŸDOMçš„renderå‡½æ•°ï¼Œwebpackä¸­requireä¾èµ–åˆ†æï¼ŒKoa2æ´‹è‘±å¼çš„ä¸­é—´ä»¶æ¨¡å‹ï¼Œå…¶å®éƒ½è¿ç”¨åˆ°äº†é€’å½’ç®—æ³•ã€‚</p><p class=\"ztext-empty-paragraph\"><br/></p><p><a href=\"https://link.zhihu.com/?target=http%3A//anata.me/2018/07/30/%25E7%25AE%2580%25E5%258D%2595%25E6%2598%2593%25E6%2587%2582%25E7%259A%2584%25E7%258E%25B0%25E4%25BB%25A3%25E9%25AD%2594%25E6%25B3%2595-%25E9%2580%2592%25E5%25BD%2592/\" class=\" wrap external\" target=\"_blank\" rel=\"nofollow noreferrer\">åšå®¢åŸæ–‡</a></p><h2>é€’å½’æ¦‚å¿µ</h2><p>é‚£ä¹ˆé€’å½’åˆ°åº•æ˜¯å•¥ï¼Ÿå…ˆä¸Šä¸¤å¼ å›¾ï¼š</p><p>å›¾1ï¼š</p><figure data-size=\"normal\"><noscript><img src=\"https://pic3.zhimg.com/v2-15e0aaf1d3ed17c62d67783b021861a6_b.gif\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"427\" data-rawheight=\"540\" data-thumbnail=\"https://pic3.zhimg.com/v2-15e0aaf1d3ed17c62d67783b021861a6_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"427\" data-original=\"https://pic3.zhimg.com/v2-15e0aaf1d3ed17c62d67783b021861a6_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;427&#39; height=&#39;540&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"427\" data-rawheight=\"540\" data-thumbnail=\"https://pic3.zhimg.com/v2-15e0aaf1d3ed17c62d67783b021861a6_b.jpg\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"427\" data-original=\"https://pic3.zhimg.com/v2-15e0aaf1d3ed17c62d67783b021861a6_r.jpg\" data-actualsrc=\"https://pic3.zhimg.com/v2-15e0aaf1d3ed17c62d67783b021861a6_b.gif\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>å›¾2ï¼š</p><figure data-size=\"normal\"><noscript><img src=\"https://pic3.zhimg.com/v2-179d5334f7891d73dd668e02831887f2_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"960\" data-rawheight=\"600\" class=\"origin_image zh-lightbox-thumb\" width=\"960\" data-original=\"https://pic3.zhimg.com/v2-179d5334f7891d73dd668e02831887f2_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;960&#39; height=&#39;600&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"960\" data-rawheight=\"600\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"960\" data-original=\"https://pic3.zhimg.com/v2-179d5334f7891d73dd668e02831887f2_r.jpg\" data-actualsrc=\"https://pic3.zhimg.com/v2-179d5334f7891d73dd668e02831887f2_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><blockquote><b>é€’å½’ï¼Œå°±æ˜¯åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­è°ƒç”¨è‡ªå·±</b></blockquote><p>æˆ‘ä»¬æ¥çœ‹ä¸ªæœ€ç®€å•çš„é˜¶ä¹˜å‡½æ•°ï¼š</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"mi\">5</span><span class=\"o\">!</span> <span class=\"o\">=</span> <span class=\"mi\">5</span> <span class=\"o\">*</span> <span class=\"mi\">4</span> <span class=\"o\">*</span> <span class=\"mi\">3</span> <span class=\"o\">*</span> <span class=\"mi\">2</span> <span class=\"o\">*</span> <span class=\"mi\">1</span>\n<span class=\"kd\">function</span> <span class=\"nx\">factorial</span><span class=\"p\">(</span><span class=\"nx\">num</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"k\">if</span> <span class=\"p\">(</span><span class=\"nx\">num</span> <span class=\"o\">===</span> <span class=\"mi\">1</span><span class=\"p\">)</span> <span class=\"p\">{</span> <span class=\"c1\">// åŸºçº¿æ¡ä»¶\n</span><span class=\"c1\"></span>        <span class=\"k\">return</span> <span class=\"mi\">1</span><span class=\"p\">;</span>\n    <span class=\"p\">}</span>\n\n    <span class=\"c1\">// é€’å½’æ¡ä»¶\n</span><span class=\"c1\"></span>    <span class=\"k\">return</span> <span class=\"nx\">num</span> <span class=\"o\">*</span> <span class=\"nx\">factorial</span><span class=\"p\">(</span><span class=\"nx\">num</span><span class=\"o\">-</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"nx\">factorial</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">);</span>\n</code></pre></div><p>ä¸€ä¸ªå¸¸è§„çš„é€’å½’å‡½æ•°éƒ½æœ‰ä¸¤éƒ¨åˆ†ï¼š<br/>1. åŸºçº¿æ¡ä»¶(<code>if (num === 1)</code>)ï¼šä¿è¯å‡½æ•°ä¸å†è°ƒç”¨è‡ªå·±ï¼Œé¿å…æ— é™å¾ªç¯<br/>2. é€’å½’æ¡ä»¶(<code>num * factorial(num-1)</code>)ï¼šä¿è¯å‡½æ•°èƒ½å¤Ÿè°ƒç”¨è‡ªå·±</p><h2>è°ƒç”¨æ ˆ</h2><p>æ ˆæ˜¯ä¸€ç§å…ˆè¿›åå‡ºçš„æ•°æ®ç»“æ„ï¼Œå®ƒåªæœ‰ä¸¤ç§æ“ä½œï¼Œå‡ºæ ˆå’Œå…¥æ ˆ</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"k\">const</span> <span class=\"nx\">nekopara</span> <span class=\"o\">=</span> <span class=\"p\">[</span><span class=\"s1\">&#39;chocolat&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;Coconut&#39;</span><span class=\"p\">];</span>\n<span class=\"nx\">nekopara</span><span class=\"p\">.</span><span class=\"nx\">push</span><span class=\"p\">(</span><span class=\"s1\">&#39;vanilla&#39;</span><span class=\"p\">);</span> <span class=\"c1\">// å…¥æ ˆ\n</span><span class=\"c1\"></span><span class=\"nx\">nekopara</span><span class=\"p\">.</span><span class=\"nx\">pop</span><span class=\"p\">();</span> <span class=\"c1\">// å‡ºæ ˆ\n</span></code></pre></div><p>ä»£ç åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰ä¸€ä¸ªå«åšè°ƒç”¨æ ˆ(call stack)çš„æ¦‚å¿µã€‚</p><div class=\"highlight\"><pre><code class=\"language-js\"><span class=\"kd\">function</span> <span class=\"nx\">greet</span><span class=\"p\">(</span><span class=\"nx\">name</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"sb\">`hello, </span><span class=\"si\">${</span><span class=\"nx\">name</span><span class=\"si\">}</span><span class=\"sb\">!`</span><span class=\"p\">)</span>\n    <span class=\"nx\">greet2</span><span class=\"p\">(</span><span class=\"nx\">name</span><span class=\"p\">);</span>\n    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"sb\">`getting ready to say bye`</span><span class=\"p\">);</span>\n    <span class=\"nx\">bye</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n\n<span class=\"kd\">function</span> <span class=\"nx\">greet2</span><span class=\"p\">(</span><span class=\"nx\">name</span><span class=\"p\">)</span> <span class=\"p\">{</span>\n    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"sb\">`how are you, </span><span class=\"si\">${</span><span class=\"nx\">name</span><span class=\"si\">}</span><span class=\"sb\">?`</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"kd\">function</span> <span class=\"nx\">bye</span><span class=\"p\">()</span> <span class=\"p\">{</span>\n    <span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"sb\">`bye`</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"nx\">greet</span><span class=\"p\">(</span><span class=\"s1\">&#39;deepred&#39;</span><span class=\"p\">);</span>\n</code></pre></div><p>è°ƒç”¨<code>greet(&#39;deepred&#39;)</code>æ—¶ï¼Œè®¡ç®—æœºä¼šé¦–å…ˆç»™è¯¥å‡½æ•°åˆ†é…ä¸€å—å†…å­˜ï¼Œå¹¶å°†å˜é‡å<code>name</code>è®¾ç½®ä¸º<code>deepred</code></p><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic2.zhimg.com/v2-8b67de652c00e765f107beccebaceab1_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"290\" data-rawheight=\"129\" class=\"content_image\" width=\"290\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;290&#39; height=&#39;129&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"290\" data-rawheight=\"129\" class=\"content_image lazy\" width=\"290\" data-actualsrc=\"https://pic2.zhimg.com/v2-8b67de652c00e765f107beccebaceab1_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>æ¯å½“è°ƒç”¨å‡½æ•°æ—¶ï¼Œéƒ½ä¼šåˆ†é…ä¸€ä¸ªå†…å­˜å—å¹¶å°†æ¶‰åŠåˆ°çš„å˜é‡å€¼å­˜å‚¨åˆ°å†…å­˜ä¸­ã€‚</p><p>æ‰“å°<code>hello, deepred</code>åï¼Œè°ƒç”¨äº†<code>greet2(&#39;deepred&#39;)</code>ã€‚åŒæ ·ï¼Œè®¡ç®—æœºå†æ¬¡åˆ†é…äº†ä¸€å—å†…å­˜ï¼Œå¹¶ä¸”è¯¥å†…å­˜å—ä½äºç¬¬ä¸€ä¸ªå†…å­˜å—ä¸Šé¢ã€‚</p><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic3.zhimg.com/v2-8c157b0f035630e0b8d93acf6787fd7a_b.jpg\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"571\" data-rawheight=\"352\" class=\"origin_image zh-lightbox-thumb\" width=\"571\" data-original=\"https://pic3.zhimg.com/v2-8c157b0f035630e0b8d93acf6787fd7a_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;571&#39; height=&#39;352&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"571\" data-rawheight=\"352\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"571\" data-original=\"https://pic3.zhimg.com/v2-8c157b0f035630e0b8d93acf6787fd7a_r.jpg\" data-actualsrc=\"https://pic3.zhimg.com/v2-8c157b0f035630e0b8d93acf6787fd7a_b.jpg\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><p>è°ƒç”¨æ ˆçš„æœ€ä¸Šé¢è¡¨ç¤ºå½“å‰è¿è¡Œçš„å‡½æ•°ï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œç°åœ¨æ­£åœ¨è¿è¡Œçš„æ˜¯greet2å‡½æ•°ï¼Œæ‰“å°è¾“å‡º<code>how are you, deepred?</code>åï¼Œå‡½æ•°greet2æ‰§è¡Œå®Œæ¯•ï¼Œæ ˆé¡¶çš„å†…å­˜å—è¢«å¼¹å‡ºã€‚</p><p>ç°åœ¨æ ˆé¡¶çš„å†…å­˜å—åˆå˜å›greetï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä»greet2çš„å‡½æ•°ä¸­è·³å‡ºï¼Œå†æ¬¡è¿”å›åˆ°äº†greetã€‚</p><p>æˆ‘ä»¬åœ¨greetä¸­è°ƒç”¨äº†greet2æ—¶ï¼Œgreetåªæ‰§è¡Œäº†ä¸€éƒ¨åˆ†ã€‚</p><p>ç‰¹åˆ«æ³¨æ„ï¼š<b>è°ƒç”¨å¦å¤–ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œå½“å‰å‡½æ•°æš‚åœå¹¶ä¸”å¤„äºæœªå®ŒæˆçŠ¶æ€ï¼Œæš‚åœå‡½æ•°çš„æ‰€æœ‰å˜é‡çš„å€¼ä»ç„¶åœ¨å†…å­˜ä¸­</b>ã€‚</p><p>æ‰§è¡Œå®Œgreet2åï¼Œæˆ‘ä»¬å›åˆ°äº†greetï¼Œå¹¶ä»ç¦»å¼€çš„åœ°æ–¹å¼€å§‹æ¥ç€å¾€ä¸‹æ‰§è¡Œï¼šé¦–å…ˆæ‰“å°<code>getting ready to say bye</code>ï¼Œç„¶åè°ƒç”¨byeå‡½æ•°ã€‚</p><p>åœ¨æ ˆé¡¶æ·»åŠ äº†byeå‡½æ•°çš„å†…å­˜å—åï¼Œå¼€å§‹æ‰§è¡Œbyeå‡½æ•°ï¼Œæ‰“å°<code>bye</code>ï¼Œç„¶åå‡½æ•°è¿”å›ï¼Œå†…å­˜å—è¢«å¼¹å‡ºã€‚</p><p>æˆ‘ä»¬åˆå†æ¬¡å›åˆ°äº†greetä¸­ï¼Œè¿™æ¬¡æ²¡æœ‰å…¶ä»–è¦è¿è¡Œçš„ä»£ç äº†ï¼Œäºæ˜¯ä»greetå‡½æ•°ä¸­è¿”å›ï¼Œå†…å­˜å—è¢«å¼¹å‡ºï¼Œè°ƒç”¨æ ˆæœ€åä¸ºç©ºã€‚</p><p><b>å®Œæ•´çš„ä¸€æ¬¡è°ƒç”¨æµç¨‹</b>ï¼š</p><p class=\"ztext-empty-paragraph\"><br/></p><figure data-size=\"normal\"><noscript><img src=\"https://pic1.zhimg.com/v2-52128c893759e90ab052f4a9f5db13cc_b.gif\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"309\" data-rawheight=\"354\" data-thumbnail=\"https://pic1.zhimg.com/v2-52128c893759e90ab052f4a9f5db13cc_b.jpg\" class=\"content_image\" width=\"309\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;309&#39; height=&#39;354&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"309\" data-rawheight=\"354\" data-thumbnail=\"https://pic1.zhimg.com/v2-52128c893759e90ab052f4a9f5db13cc_b.jpg\" class=\"content_image lazy\" width=\"309\" data-actualsrc=\"https://pic1.zhimg.com/v2-52128c893759e90ab052f4a9f5db13cc_b.gif\"/></figure><p class=\"ztext-empty-paragraph\"><br/></p><h2>é€’å½’è°ƒç”¨æ ˆ</h2><p><br/>é€’å½’åŒæ ·ä½¿ç”¨è°ƒç”¨æ ˆ</p><div class=\"highlight\"><pre><code class=\"language-text\">æˆ‘ä»¬æ¥åˆ†æä¸‹é˜¶ä¹˜fact(3)çš„è°ƒç”¨æ ˆ\nfunction fact(num) {\n    if (num === 1) { \n        return 1;\n    }\n    return num * fact(num-1);\n}\nfact(3);\n</code></pre></div><p>ç›´æ¥çœ‹å›¾:</p><figure data-size=\"normal\"><noscript><img src=\"https://pic3.zhimg.com/v2-033f87bdbf9734e59ffb2e4803f993da_b.gif\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"697\" data-rawheight=\"399\" data-thumbnail=\"https://pic3.zhimg.com/v2-033f87bdbf9734e59ffb2e4803f993da_b.jpg\" class=\"origin_image zh-lightbox-thumb\" width=\"697\" data-original=\"https://pic3.zhimg.com/v2-033f87bdbf9734e59ffb2e4803f993da_r.jpg\"/></noscript><img src=\"data:image/svg+xml;utf8,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; width=&#39;697&#39; height=&#39;399&#39;&gt;&lt;/svg&gt;\" data-caption=\"\" data-size=\"normal\" data-rawwidth=\"697\" data-rawheight=\"399\" data-thumbnail=\"https://pic3.zhimg.com/v2-033f87bdbf9734e59ffb2e4803f993da_b.jpg\" class=\"origin_image zh-lightbox-thumb lazy\" width=\"697\" data-original=\"https://pic3.zhimg.com/v2-033f87bdbf9734e59ffb2e4803f993da_r.jpg\" data-actualsrc=\"https://pic3.zhimg.com/v2-033f87bdbf9734e59ffb2e4803f993da_b.gif\"/></figure><h2>é€’å½’æ³¨æ„äº‹é¡¹</h2><p>é€’å½’ä¼šå¯¼è‡´ç¨‹åºçš„æ€§èƒ½å˜ä½</p><p>å¦‚æœé€’å½’åµŒå¥—å¾ˆæ·±ï¼Œé‚£ä¹ˆè°ƒç”¨æ ˆä¼šå¾ˆé•¿ï¼Œè¿™å°†å ç”¨å¤§é‡å†…å­˜ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ ˆæº¢å‡º</p>", 
            "topic": [
                {
                    "tag": "é€’å½’", 
                    "tagLink": "https://api.zhihu.com/topics/19631498"
                }, 
                {
                    "tag": "ç®—æ³•", 
                    "tagLink": "https://api.zhihu.com/topics/19553510"
                }, 
                {
                    "tag": "å‰ç«¯å¼€å‘", 
                    "tagLink": "https://api.zhihu.com/topics/19550901"
                }
            ], 
            "comments": []
        }
    ], 
    "url": "https://zhuanlan.zhihu.com/mahou"
}
